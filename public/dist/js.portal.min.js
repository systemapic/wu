function darktheme(){}function lighttheme(){}function initSVGpatterns(){var a='<!-- SVG fill properties: url(#diagonal-dots) // url(#dots) url(#diagonal-circles) url(#diagonal-stripes) url(#grid) --><svg xmlns="http://www.w3.org/2000/svg"><defs><pattern id="diagonal-dots" x="0" y="0" width="11" height="11" patternUnits="userSpaceOnUse" patternTransform="rotate(45)"><circle cx="5" cy="5" r="4" style="stroke:none; fill:blue;" /></pattern></defs><defs><pattern id="dots" x="0" y="0" width="11" height="11" patternUnits="userSpaceOnUse"><circle cx="5" cy="5" r="4" style="stroke:none; fill:red;" /></pattern><pattern id="diagonal-circles" x="0" y="0" width="11" height="11" patternUnits="userSpaceOnUse" patternTransform="rotate(45)"><circle cx="5" cy="5" r="4" style="stroke-width:2; stroke:green; fill:none;" /></pattern><pattern id="diagonal-stripes" x="0" y="0" width="8" height="8" patternUnits="userSpaceOnUse" patternTransform="rotate(30)"><rect x="0" y="0" width="4" height="8" style="stroke:none; fill:purple;" /></pattern><pattern id="grid" x="0" y="0" width="10" height="10" patternUnits="userSpaceOnUse"><rect x="0" y="0" width="10" height="4" style="stroke:none; fill:orange;" /><rect x="3" y="3" width="4" height="10" style="stroke:none; fill:orange;" /></pattern></defs></svg>';Wu.DomUtil.get("styletag").innerHTML=a}Wu={},Wu.Class=function(){},Wu.Class.extend=function(a){var b=function(){this.initialize&&this.initialize.apply(this,arguments),this._initHooks.length&&this.callInitHooks()},c=b.__super__=this.prototype,d=Wu.Util.create(c);d.constructor=b,b.prototype=d;for(var e in this)this.hasOwnProperty(e)&&"prototype"!==e&&(b[e]=this[e]);return a.statics&&(Wu.extend(b,a.statics),delete a.statics),a.includes&&(Wu.Util.extend.apply(null,[d].concat(a.includes)),delete a.includes),d.options&&(a.options=Wu.Util.extend(Wu.Util.create(d.options),a.options)),Wu.extend(d,a),d._initHooks=[],d.callInitHooks=function(){if(!this._initHooksCalled){c.callInitHooks&&c.callInitHooks.call(this),this._initHooksCalled=!0;for(var a=0,b=d._initHooks.length;b>a;a++)d._initHooks[a].call(this)}},b},Wu.Class.include=function(a){Wu.extend(this.prototype,a)},Wu.Class.mergeOptions=function(a){Wu.extend(this.prototype.options,a)},Wu.Class.addInitHook=function(a){var b=Array.prototype.slice.call(arguments,1),c="function"==typeof a?a:function(){this[a].apply(this,b)};this.prototype._initHooks=this.prototype._initHooks||[],this.prototype._initHooks.push(c)},Wu.Util={extend:function(a){var b,c,d,e,f=Array.prototype.slice.call(arguments,1);for(c=0,d=f.length;d>c;c++){e=f[c];for(b in e)a[b]=e[b]}return a},create:Object.create||function(){function a(){}return function(b){return a.prototype=b,new a}}(),bind:function(a,b){var c=Array.prototype.slice;if(a.bind)return a.bind.apply(a,c.call(arguments,1));var d=c.call(arguments,2);return function(){return a.apply(b,d.length?d.concat(c.call(arguments)):arguments)}},stamp:function(a){return a._leaflet_id=a._leaflet_id||++Wu.Util.lastId,a._leaflet_id},lastId:0,throttle:function(a,b,c){var d,e,f,g;return g=function(){d=!1,e&&(f.apply(c,e),e=!1)},f=function(){d?e=arguments:(a.apply(c,arguments),setTimeout(g,b),d=!0)}},wrapNum:function(a,b,c){var d=b[1],e=b[0],f=d-e;return a===d&&c?a:((a-e)%f+f)%f+e},falseFn:function(){return!1},formatNum:function(a,b){var c=Math.pow(10,b||5);return Math.round(a*c)/c},trim:function(a){return a.trim?a.trim():a.replace(/^\s+|\s+$/g,"")},trimAll:function(a){return a.replace(/\s+/g,"")},splitWords:function(a){return Wu.Util.trim(a).split(/\s+/)},setOptions:function(a,b){a.hasOwnProperty("options")||(a.options=a.options?Wu.Util.create(a.options):{});for(var c in b)a.options[c]=b[c];return a.options},getParamString:function(a,b,c){var d=[];for(var e in a)d.push(encodeURIComponent(c?e.toUpperCase():e)+"="+encodeURIComponent(a[e]));return(b&&-1!==b.indexOf("?")?"&":"?")+d.join("&")},template:function(a,b){return a.replace(Wu.Util.templateRe,function(a,c){var d=b[c];if(void 0===d)throw new Error("No value provided for variable "+a);return"function"==typeof d&&(d=d(b)),d})},templateRe:/\{ *([\w_]+) *\}/g,emptyImageUrl:"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=",isArray:Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},isObject:function(a){return"[object Object]"===Object.prototype.toString.call(a)},capitalize:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},setAddressBar:function(a){window.history.pushState({},"",a)},checkDisconnect:function(a){var b=a.substring(0,15);return"<!doctype html>"==b?(app.feedback.setError({title:"You have been logged out.",description:"Please reload the page to log back in.",clearTimer:!1}),!1):!0},debugXML:function(a){Wu.parse(a)},verifyResponse:function(a){return app.debug&&Wu.Util.debugXML(a),Wu.Util.checkDisconnect(a)},post:function(a,b){var c=new XMLHttpRequest,d=Wu.Util._getServerUrl();d+=a,c.open("POST",d,!0),c.setRequestHeader("Content-type","application/json"),c.setRequestHeader("Authorization","Bearer "+app.tokens.access_token),c.onreadystatechange=function(){if(4==c.readyState&&200==c.status){Wu.verify(c.responseText)}},c.send(b)},postcb:function(a,b,c,d,e){var f=new XMLHttpRequest,g=e||Wu.Util._getServerUrl();g+=a,f.open("POST",g,!0),f.setRequestHeader("Content-type","application/json"),f.setRequestHeader("Authorization","Bearer "+app.tokens.access_token),f.onreadystatechange=function(){if(4==f.readyState&&200==f.status){var a=Wu.verify(f.responseText);c&&a&&c(d,f.responseText)}},Wu.Util.isObject(b)&&(b=JSON.stringify(b)),f.send(b)},send:function(a,b,c){var d=new XMLHttpRequest,e=Wu.Util._getServerUrl();e+=a,d.open("POST",e,!0),d.setRequestHeader("Content-type","application/json"),d.setRequestHeader("Authorization","Bearer "+app.tokens.access_token),d.onreadystatechange=function(){if(4==d.readyState){var a=Wu.verify(d.responseText);200==d.status&&a?c&&c(null,d.responseText):c&&c(d.status)}},Wu.Util.isObject(b)&&(b=JSON.stringify(b)),d.send(b)},_getServerUrl:function(){return app.options.servers.portal.slice(0,-1)},_getJSON:function(a,b){var c=new XMLHttpRequest;c.open("GET",a,!0),c.setRequestHeader("Content-type","application/json"),c.onreadystatechange=function(){if(4==c.readyState&&200==c.status){var a=Wu.verify(c.responseText);a&&b(c.responseText)}},c.send(null)},_parse:function(a){try{var b=JSON.parse(a);return b}catch(c){return!1}},_getParentClientID:function(a){var b="";for(c in Wu.app.Clients){var d=Wu.app.Clients[c];d.projects.forEach(function(c,e,f){c==a&&(b=d.uuid)})}return b||(b=Wu.app._activeClient.uuid),b},guid:function(a){var b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)});return a?a+"-"+b:b},createRandom:function(a){return Math.random().toString(36).slice(-1*a).toUpperCase()},getRandomChars:function(a,b){b=b||"abcdefghijklmnopqrstuvwxyz";for(var c="",d=0;a>d;d++){var e=Math.floor(Math.random()*b.length);c+=b.substring(e,e+1)}return c},deselectText:function(){var a="getSelection"in window?window.getSelection():"selection"in document?document.selection:null;"removeAllRanges"in a?a.removeAllRanges():"empty"in a&&a.empty()},generateZip:function(a){var b=LZString.compress(a);return b},zipSave:function(a,b){var c,c=b,d=new LZMA("//85.10.202.87:8080/js/lib/lzma/lzma_worker.js");d.compress(c,1,function(b){var c=JSON.stringify(b),d=new XMLHttpRequest,e=window.location.origin;e+=a,d.open("POST",e,!0),d.onreadystatechange=function(){4==d.readyState&&200==d.status},d.send(c)},function(a){})},zippedSave:function(){},setColorTheme:function(){injectCSS()},prettyDate:function(a,b){function c(a,b){var c=.1;return a>=b&&b*(1+c)>=a?b:a}if(a){var d,e={ago:"Ago",from:"",now:"Just Now",minute:"Minute",minutes:"Minutes",hour:"Hour",hours:"Hours",day:"Day",days:"Days",week:"Week",weeks:"Weeks",month:"Month",months:"Months",year:"Year",years:"Years"},f=[[60,e.now],[3600,e.minute,e.minutes,60],[86400,e.hour,e.hours,3600],[604800,e.day,e.days,86400],[2628e3,e.week,e.weeks,604800],[31536e3,e.month,e.months,2628e3],[1/0,e.year,e.years,31536e3]],g="string"==typeof a,a=g?new Date((""+a).replace(/-/g,"/").replace(/T|(?:\.\d+)?Z/g," ")):a,b=b||new Date,h=(b-a+6e4*(b.getTimezoneOffset()-(g?0:a.getTimezoneOffset())))/1e3;0>h?(h=Math.abs(h),d=e.from?" "+e.from:""):d=e.ago?" "+e.ago:"";for(var i=0,j=f[0];f[i];j=f[++i])if(h<j[0]){if(0===i)return j[1];var k=Math.ceil(c(h,j[3])/j[3]);return k+" "+(1!=k?j[2]:j[1])+(i>0?d:"")}}},stripAccents:function(a){var b={"À":"A","Á":"A","Â":"A","Ã":"A","Ä":"A","Å":"A","Æ":"AE","Ç":"C","È":"E","É":"E","Ê":"E","Ë":"E","Ì":"I","Í":"I","Î":"I","Ï":"I","Ð":"D","Ñ":"N","Ò":"O","Ó":"O","Ô":"O","Õ":"O","Ö":"O","Ø":"O","Ù":"U","Ú":"U","Û":"U","Ü":"U","Ý":"Y","ß":"s","à":"a","á":"a","â":"a","ã":"a","ä":"a","å":"a","æ":"ae","ç":"c","è":"e","é":"e","ê":"e","ë":"e","ì":"i","í":"i","î":"i","ï":"i","ñ":"n","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o","ø":"o","ù":"u","ú":"u","û":"u","ü":"u","ý":"y","ÿ":"y","Ā":"A","ā":"a","Ă":"A","ă":"a","Ą":"A","ą":"a","Ć":"C","ć":"c","Ĉ":"C","ĉ":"c","Ċ":"C","ċ":"c","Č":"C","č":"c","Ď":"D","ď":"d","Đ":"D","đ":"d","Ē":"E","ē":"e","Ĕ":"E","ĕ":"e","Ė":"E","ė":"e","Ę":"E","ę":"e","Ě":"E","ě":"e","Ĝ":"G","ĝ":"g","Ğ":"G","ğ":"g","Ġ":"G","ġ":"g","Ģ":"G","ģ":"g","Ĥ":"H","ĥ":"h","Ħ":"H","ħ":"h","Ĩ":"I","ĩ":"i","Ī":"I","ī":"i","Ĭ":"I","ĭ":"i","Į":"I","į":"i","İ":"I","ı":"i","Ĳ":"IJ","ĳ":"ij","Ĵ":"J","ĵ":"j","Ķ":"K","ķ":"k","Ĺ":"L","ĺ":"l","Ļ":"L","ļ":"l","Ľ":"L","ľ":"l","Ŀ":"L","ŀ":"l","Ł":"l","ł":"l","Ń":"N","ń":"n","Ņ":"N","ņ":"n","Ň":"N","ň":"n","ŉ":"n","Ō":"O","ō":"o","Ŏ":"O","ŏ":"o","Ő":"O","ő":"o","Œ":"OE","œ":"oe","Ŕ":"R","ŕ":"r","Ŗ":"R","ŗ":"r","Ř":"R","ř":"r","Ś":"S","ś":"s","Ŝ":"S","ŝ":"s","Ş":"S","ş":"s","Š":"S","š":"s","Ţ":"T","ţ":"t","Ť":"T","ť":"t","Ŧ":"T","ŧ":"t","Ũ":"U","ũ":"u","Ū":"U","ū":"u","Ŭ":"U","ŭ":"u","Ů":"U","ů":"u","Ű":"U","ű":"u","Ų":"U","ų":"u","Ŵ":"W","ŵ":"w","Ŷ":"Y","ŷ":"y","Ÿ":"Y","Ź":"Z","ź":"z","Ż":"Z","ż":"z","Ž":"Z","ž":"z","ſ":"s","ƒ":"f","Ơ":"O","ơ":"o","Ư":"U","ư":"u","Ǎ":"A","ǎ":"a","Ǐ":"I","ǐ":"i","Ǒ":"O","ǒ":"o","Ǔ":"U","ǔ":"u","Ǖ":"U","ǖ":"u","Ǘ":"U","ǘ":"u","Ǚ":"U","ǚ":"u","Ǜ":"U","ǜ":"u","Ǻ":"A","ǻ":"a","Ǽ":"AE","ǽ":"ae","Ǿ":"O","ǿ":"o"},c=/\W/g,d=function(a){return b[a]||a};return a.replace(c,d)},bytesToSize:function(a){var b=["Bytes","KB","MB","GB","TB"];if(0==a)return"0 Byte";var c=parseInt(Math.floor(Math.log(a)/Math.log(1024)));return Math.round(a/Math.pow(1024,c),2)+" "+b[c]},parseUrl:function(){var a=window.location.search.substr(1),b={};return a.split("&").forEach(function(a){var c=a.split("=");""!=c[0]&&(b[c[0]]=decodeURIComponent(c[1]))}),_.size(b)?b:!1},getWindowSize:function(){var a={width:window.innerWidth,height:window.innerHeight};return a},setStyle:function(a,b){jss.set(a,b)},getStyle:function(a){return jss.getAll(a)}},function(){function a(a){return window["webkit"+a]||window["moz"+a]||window["ms"+a]}function b(a){var b=+new Date,d=Math.max(0,16-(b-c));return c=b+d,window.setTimeout(a,d)}var c=0,d=window.requestAnimationFrame||a("RequestAnimationFrame")||b,e=window.cancelAnimationFrame||a("CancelAnimationFrame")||a("CancelRequestAnimationFrame")||function(a){window.clearTimeout(a)};Wu.Util.requestAnimFrame=function(a,c,e,f){return e&&d===b?void a.call(c):d.call(window,Wu.bind(a,c),f)},Wu.Util.cancelAnimFrame=function(a){a&&e.call(window,a)}}(),Wu.extend=Wu.Util.extend,Wu.bind=Wu.Util.bind,Wu.stamp=Wu.Util.stamp,Wu.setOptions=Wu.Util.setOptions,Wu.save=Wu.Util.post,Wu.post=Wu.Util.postcb,Wu.send=Wu.Util.send,Wu.parse=Wu.Util._parse,Wu.zip=Wu.Util.generateZip,Wu.zave=Wu.Util.zipSave,Wu.can=Wu.Util.can,Wu.setStyle=Wu.Util.setStyle,Wu.getStyle=Wu.Util.getStyle,Wu.verify=Wu.Util.verifyResponse,Wu.Evented=Wu.Class.extend({on:function(a,b,c){if("object"==typeof a)for(var d in a)this._on(d,a[d],b);else{a=Wu.Util.splitWords(a);for(var e=0,f=a.length;f>e;e++)this._on(a[e],b,c)}return this},off:function(a,b,c){if(a)if("object"==typeof a)for(var d in a)this._off(d,a[d],b);else{a=Wu.Util.splitWords(a);for(var e=0,f=a.length;f>e;e++)this._off(a[e],b,c)}else delete this._events;return this},_on:function(a,b,c){var d=this._events=this._events||{},e=c&&c!==this&&Wu.stamp(c);if(e){var f=a+"_idx",g=a+"_len",h=d[f]=d[f]||{},i=Wu.stamp(b)+"_"+e;h[i]||(h[i]={fn:b,ctx:c},d[g]=(d[g]||0)+1)}else d[a]=d[a]||[],d[a].push({fn:b})},_off:function(a,b,c){var d=this._events,e=a+"_idx",f=a+"_len";if(d){if(!b)return delete d[a],delete d[e],void delete d[f];var g,h,i,j,k,l=c&&c!==this&&Wu.stamp(c);if(l)k=Wu.stamp(b)+"_"+l,g=d[e],g&&g[k]&&(j=g[k],delete g[k],d[f]--);else if(g=d[a])for(h=0,i=g.length;i>h;h++)if(g[h].fn===b){j=g[h],g.splice(h,1);break}j&&(j.fn=Wu.Util.falseFn)}},fire:function(a,b,c){if(!this.listens(a,c))return this;var d=Wu.Util.extend({},b,{type:a,target:this}),e=this._events;if(e){var f,g,h,i,j=e[a+"_idx"];if(e[a])for(h=e[a].slice(),f=0,g=h.length;g>f;f++)h[f].fn.call(this,d);for(i in j)j[i].fn.call(j[i].ctx,d)}return c&&this._propagateEvent(d),this},listens:function(a,b){var c=this._events;if(c&&(c[a]||c[a+"_len"]))return!0;if(b)for(var d in this._eventParents)if(this._eventParents[d].listens(a,b))return!0;return!1},once:function(a,b,c){if("object"==typeof a){for(var d in a)this.once(d,a[d],b);return this}var e=Wu.bind(function(){this.off(a,b,c).off(a,e,c)},this);return this.on(a,b,c).on(a,e,c)},addEventParent:function(a){return this._eventParents=this._eventParents||{},this._eventParents[Wu.stamp(a)]=a,this},removeEventParent:function(a){return this._eventParents&&delete this._eventParents[Wu.stamp(a)],this},_propagateEvent:function(a){for(var b in this._eventParents)this._eventParents[b].fire(a.type,Wu.extend({layer:a.target},a),!0)},bytesToSize:function(a){var b=["Bytes","KB","MB","GB","TB"];if(0==a)return"0 Byte";var c=parseInt(Math.floor(Math.log(a)/Math.log(1024)));return Math.round(a/Math.pow(1024,c),2)+" "+b[c]}});var proto=Wu.Evented.prototype;proto.addEventListener=proto.on,proto.removeEventListener=proto.clearAllEventListeners=proto.off,proto.addOneTimeEventListener=proto.once,proto.fireEvent=proto.fire,proto.hasEventListeners=proto.listens,Wu.Mixin={Events:proto},Wu._on=proto.on,Wu._off=proto.off,Wu._fire=proto.fire,Wu.DomUtil={get:function(a){return"string"==typeof a?document.getElementById(a):a},getStyle:function(a,b){var c=a.style[b]||a.currentStyle&&a.currentStyle[b];if((!c||"auto"===c)&&document.defaultView){var d=document.defaultView.getComputedStyle(a,null);c=d?d[b]:null}return"auto"===c?null:c},create:function(a,b,c,d){var e=document.createElement(a);return e.className=b,c&&c.appendChild(e),d&&("input"==a?e.setAttribute("placeholder",d):"image"==a?e.src=d:"img"==a?e.src=d:e.innerHTML=d),e},makeit:function(a){var b=document.createElement(a.type);return a.id&&(b.id=a.id),a.cname&&(b.className=a.cname),a.style&&b.setAttribute("style",a.style),a.hlink&&b.setAttribute("href",a.hlink),a.source&&(b.src=a.source),a.inner&&(b.innerHTML=a.inner),a.appendto&&a.appendto.appendChild(b),a.attr&&a.attr.forEach(function(a){b.setAttribute(a[0],a[1])}),b},createId:function(a,b,c){var d=document.createElement(a);return d.id=b,c&&c.appendChild(d),d},remove:function(a){var b=a.parentNode;b&&b.removeChild(a)},toFront:function(a){a.parentNode.appendChild(a)},toBack:function(a){var b=a.parentNode;b.insertBefore(a,b.firstChild)},hasClass:function(a,b){if(void 0!==a.classList)return a.classList.contains(b);var c=Wu.DomUtil.getClass(a);return c.length>0&&new RegExp("(^|\\s)"+b+"(\\s|$)").test(c)},addClass:function(a,b){if(!a)return void 0;if(void 0!==a.classList)for(var c=Wu.Util.splitWords(b),d=0,e=c.length;e>d;d++)a.classList.add(c[d]);else if(!Wu.DomUtil.hasClass(a,b)){var f=Wu.DomUtil.getClass(a);Wu.DomUtil.setClass(a,(f?f+" ":"")+b)}},removeClass:function(a,b){return a?void(void 0!==a.classList?a.classList.remove(b):Wu.DomUtil.setClass(a,Wu.Util.trim((" "+Wu.DomUtil.getClass(a)+" ").replace(" "+b+" "," ")))):void 0},classed:function(a,b,c){c?this.addClass(a,b):this.removeClass(a,b)},clearChildClasses:function(a,b){for(var c=0;c<a.children.length;c++){var d=a.children[c];Wu.DomUtil.removeClass(d,b)}},setClass:function(a,b){void 0===a.className.baseVal?a.className=b:a.className.baseVal=b},getClass:function(a){return void 0===a.className.baseVal?a.className:a.className.baseVal},appendTemplate:function(a,b){if("string"==typeof b){var c=Wu.DomUtil.create("div");for(c.innerHTML=b,i=0;i<c.childNodes.length;i++)a.appendChild(c.childNodes[i])}return a},prependTemplate:function(a,b,c){if("string"==typeof b){var d=Wu.DomUtil.create("div");if(d.innerHTML=b,c)var e=a.firstChild;else var e=a.firstChild.nextSibling;for(i=0;i<d.childNodes.length;i++)a.insertBefore(d.childNodes[i],e)}return a},thumbAdjust:function(a,b){var c=new Image;c.src=a.src,c.onload=function(){var c=this.width,d=this.height,e=c/b,f=d/b,g=!0;c>=d&&(g=!1),g?(a.style.width="100%",a.style.top=-Math.floor(f)/2+"px"):(a.style.height="100%",a.style.left=-Math.floor(e)/2+"px")}}};var eventsKey="_leaflet_events";Wu.DomEvent={on:function(a,b,c,d){if("object"==typeof b)for(var e in b)this._on(a,e,b[e],c);else{b=Wu.Util.splitWords(b);for(var f=0,g=b.length;g>f;f++)this._on(a,b[f],c,d)}return this},off:function(a,b,c,d){if("object"==typeof b)for(var e in b)this._off(a,e,b[e],c);else{b=Wu.Util.splitWords(b);for(var f=0,g=b.length;g>f;f++)this._off(a,b[f],c,d)}return this},_on:function(a,b,c,d){var e=b+Wu.stamp(c)+(d?"_"+Wu.stamp(d):"");if(a[eventsKey]&&a[eventsKey][e])return this;var f=function(b){return c.call(d||a,b||window.event)},g=f;return Wu.Browser.pointer&&0===b.indexOf("touch")?this.addPointerListener(a,b,f,e):(Wu.Browser.touch&&"dblclick"===b&&this.addDoubleTapListener&&this.addDoubleTapListener(a,f,e),"addEventListener"in a?"mousewheel"===b?(a.addEventListener("DOMMouseScroll",f,!1),a.addEventListener(b,f,!1)):"mouseenter"===b||"mouseleave"===b?(f=function(b){return b=b||window.event,Wu.DomEvent._checkMouse(a,b)?g(b):void 0},a.addEventListener("mouseenter"===b?"mouseover":"mouseout",f,!1)):("click"===b&&Wu.Browser.android&&(f=function(a){return Wu.DomEvent._filterClick(a,g)}),a.addEventListener(b,f,!1)):"attachEvent"in a&&a.attachEvent("on"+b,f),a[eventsKey]=a[eventsKey]||{},a[eventsKey][e]=f,this)},_off:function(a,b,c,d){var e=b+Wu.stamp(c)+(d?"_"+Wu.stamp(d):""),f=a[eventsKey]&&a[eventsKey][e];return f?(Wu.Browser.pointer&&0===b.indexOf("touch")?this.removePointerListener(a,b,e):Wu.Browser.touch&&"dblclick"===b&&this.removeDoubleTapListener?this.removeDoubleTapListener(a,e):"removeEventListener"in a?"mousewheel"===b?(a.removeEventListener("DOMMouseScroll",f,!1),a.removeEventListener(b,f,!1)):a.removeEventListener("mouseenter"===b?"mouseover":"mouseleave"===b?"mouseout":b,f,!1):"detachEvent"in a&&a.detachEvent("on"+b,f),a[eventsKey][e]=null,this):this},stopPropagation:function(a){return a.stopPropagation?a.stopPropagation():a.cancelBubble=!0,Wu.DomEvent._skipped(a),this},disableScrollPropagation:function(a){return Wu.DomEvent.on(a,"mousewheel MozMousePixelScroll",Wu.DomEvent.stopPropagation)},preventDefault:function(a){return a.preventDefault?a.preventDefault():a.returnValue=!1,this},stop:function(a){return Wu.DomEvent.preventDefault(a).stopPropagation(a)},getWheelDelta:function(a){var b=0;return a.wheelDelta&&(b=a.wheelDelta/120),a.detail&&(b=-a.detail/3),b},_skipEvents:{},_fakeStop:function(a){Wu.DomEvent._skipEvents[a.type]=!0},_skipped:function(a){var b=this._skipEvents[a.type];return this._skipEvents[a.type]=!1,b},_checkMouse:function(a,b){var c=b.relatedTarget;if(!c)return!0;try{for(;c&&c!==a;)c=c.parentNode}catch(d){return!1}return c!==a},_filterClick:function(a,b){var c=a.timeStamp||a.originalEvent.timeStamp,d=Wu.DomEvent._lastClick&&c-Wu.DomEvent._lastClick;return d&&d>100&&500>d||a.target._simulatedClick&&!a._simulated?void Wu.DomEvent.stop(a):(Wu.DomEvent._lastClick=c,b(a))}},function(){var a=navigator.userAgent.toLowerCase(),b=document.documentElement,c="ActiveXObject"in window,d=-1!==a.indexOf("webkit"),e=-1!==a.indexOf("phantom"),f=-1!==a.search("android [23]"),g=-1!==a.indexOf("chrome"),h="undefined"!=typeof orientation,i=navigator.msPointerEnabled&&navigator.msMaxTouchPoints&&!window.PointerEvent,j=window.PointerEvent&&navigator.pointerEnabled&&navigator.maxTouchPoints||i,k=c&&"transition"in b.style,l="WebKitCSSMatrix"in window&&"m11"in new window.WebKitCSSMatrix&&!f,m="MozPerspective"in b.style,n="OTransition"in b.style,o="devicePixelRatio"in window&&window.devicePixelRatio>1;if(!o&&"matchMedia"in window){var p=window.matchMedia("(min-resolution:1.5dppx)");o=p&&p.matches}var q=!window.L_NO_TOUCH&&!e&&(j||"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch);Wu.Browser={ie:c,ielt9:c&&!document.addEventListener,webkit:d,gecko:-1!==a.indexOf("gecko")&&!d&&!window.opera&&!c,android:-1!==a.indexOf("android"),android23:f,chrome:g,safari:!g&&-1!==a.indexOf("safari"),ie3d:k,webkit3d:l,gecko3d:m,opera3d:n,any3d:!window.L_DISABLE_3D&&(k||l||m||n)&&!e,mobile:h,mobileWebkit:h&&d,mobileWebkit3d:h&&l,mobileOpera:h&&window.opera,touch:!!q,msPointer:!!i,pointer:!!j,retina:!!o}}(),Wu.extend(Wu.DomEvent,{POINTER_DOWN:Wu.Browser.msPointer?"MSPointerDown":"pointerdown",POINTER_MOVE:Wu.Browser.msPointer?"MSPointerMove":"pointermove",POINTER_UP:Wu.Browser.msPointer?"MSPointerUp":"pointerup",POINTER_CANCEL:Wu.Browser.msPointer?"MSPointerCancel":"pointercancel",_pointers:[],_pointerDocumentListener:!1,addPointerListener:function(a,b,c,d){switch(b){case"touchstart":return this.addPointerListenerStart(a,b,c,d);case"touchend":return this.addPointerListenerEnd(a,b,c,d);case"touchmove":return this.addPointerListenerMove(a,b,c,d);default:throw"Unknown touch event type"}},addPointerListenerStart:function(a,b,c,d){var e="_leaflet_",f=this._pointers,g=function(a){Wu.DomEvent.preventDefault(a);for(var b=!1,d=0;d<f.length;d++)if(f[d].pointerId===a.pointerId){b=!0;break}b||f.push(a),a.touches=f.slice(),a.changedTouches=[a],c(a)};if(a[e+"touchstart"+d]=g,a.addEventListener(this.POINTER_DOWN,g,!1),!this._pointerDocumentListener){var h=function(a){for(var b=0;b<f.length;b++)if(f[b].pointerId===a.pointerId){f.splice(b,1);break}};document.documentElement.addEventListener(this.POINTER_UP,h,!1),document.documentElement.addEventListener(this.POINTER_CANCEL,h,!1),this._pointerDocumentListener=!0}return this},addPointerListenerMove:function(a,b,c,d){function e(a){if(a.pointerType!==a.MSPOINTER_TYPE_MOUSE&&"mouse"!==a.pointerType||0!==a.buttons){for(var b=0;b<g.length;b++)if(g[b].pointerId===a.pointerId){g[b]=a;break}a.touches=g.slice(),a.changedTouches=[a],c(a)}}var f="_leaflet_",g=this._pointers;return a[f+"touchmove"+d]=e,a.addEventListener(this.POINTER_MOVE,e,!1),this},addPointerListenerEnd:function(a,b,c,d){var e="_leaflet_",f=this._pointers,g=function(a){for(var b=0;b<f.length;b++)if(f[b].pointerId===a.pointerId){f.splice(b,1);break}a.touches=f.slice(),a.changedTouches=[a],c(a)};return a[e+"touchend"+d]=g,a.addEventListener(this.POINTER_UP,g,!1),a.addEventListener(this.POINTER_CANCEL,g,!1),this},removePointerListener:function(a,b,c){var d="_leaflet_",e=a[d+b+c];switch(b){case"touchstart":a.removeEventListener(this.POINTER_DOWN,e,!1);break;case"touchmove":a.removeEventListener(this.POINTER_MOVE,e,!1);break;case"touchend":a.removeEventListener(this.POINTER_UP,e,!1),a.removeEventListener(this.POINTER_CANCEL,e,!1)}return this}}),Wu.DomEvent.addListener=Wu.DomEvent.on,Wu.DomEvent.removeListener=Wu.DomEvent.off,Array.prototype.diff=function(a){return this.filter(function(b){return a.indexOf(b)<0})},Array.prototype.move=function(a,b){this.splice(b,0,this.splice(a,1)[0])},Array.prototype.moveUp=function(a,b){var c=this.indexOf(a),d=c-(b||1);if(-1===c)throw new Error("Element not found in array");0>d&&(d=0),this.splice(c,1),this.splice(d,0,a)},Array.prototype.moveDown=function(a,b){var c=this.indexOf(a),d=c+(b||1);if(-1===c)throw new Error("Element not found in array");d>=this.length&&(d=this.length),this.splice(c,1),this.splice(d,0,a)},String.prototype.camelize=function(){return this.replace(/(?:^|[_])(\w)/g,function(a,b){return b?b.toUpperCase():""})},Function.prototype.bind=Function.prototype.bind||function(a){var b=this;return function(){return b.apply(a,arguments)}},Wu.Socket=Wu.Class.extend({initialize:function(){this._socket=io.connect(),this._listen(),this._addLoops()},_addLoops:function(){setInterval(function(){this._getServerStats()}.bind(this),2e3)},_getServerStats:function(){var a=this._socket;a.emit("get_server_stats")},sendUserEvent:function(a){a.user=a.user||app.Account.getFullName(),a.timestamp=a.timestamp||Date.now();var b=this._socket;b.emit("user_event",a)},_listen:function(){var a=this._socket;a.on("server_stats",function(a){var b=a.server_stats;app.Chrome&&app.Chrome.Top.updateCPUclock(b.cpu_usage)}),a.on("connect",function(){a.emit("ready","koko")}),a.on("event",function(a){}),a.on("disconnect",function(){}),a.on("hola",function(a){}),a.on("processingProgress",function(a){Wu.Mixin.Events.fire("processingProgress",{detail:a})}),a.on("stats",function(a){}),a.on("uploadDone",function(a){}),a.on("downloadReady",function(a){var b="downloadReady-"+a.file_id;Wu.Mixin.Events.fire(b,{detail:a})}),a.on("processingDone",function(a){var b=a.file_id,c=a.import_took_ms;app.Data._onImportedFile(b,c)}),a.on("errorMessage",function(a){var b=a.error;app.FeedbackPane.setError({title:b.title,description:b.description})})},getSocket:function(){return this._socket}}),Wu.Controller=Wu.Class.extend({initialize:function(){this._listen()},_listen:function(){Wu.Mixin.Events.on("projectSelected",this._projectSelected,this)},_projectSelected:function(a){var b=a.detail.projectUuid;return b?(this._project=app.activeProject=app.Projects[b],void this._setUrl()):Wu.Util.setAddressBar("")},_projectChanged:function(a){var b=a.detail.projectUuid,c=app.Projects[b];c.getSettings().saveState},_loadState:function(){var a=this._project,b=a.getState(),c=a.getSettings().saveState;if(c&&b){var d={projectUuid:this._project.getUuid(),id:b};Wu.post("/api/project/hash/get",JSON.stringify(d),function(a,b){var c=Wu.parse(b),d=c.hash;app.MapPane.setPosition(d.position);var e=d.layers;_.each(e,function(a){app.MapPane.getControls().layermenu._enableLayerByUuid(a)})}.bind(this),this)}},_saveState:function(a){var b=a.project||app.activeProject,c=app.MapPane.getZIndexControls().l._index,d=[];_.each(c,function(a){d.push(a.store.uuid)});var e={projectUuid:b.getUuid(),hash:{id:Wu.Util.createRandom(6),position:app.MapPane.getPosition(),layers:d},saveState:!0};Wu.post("/api/project/hash/set",JSON.stringify(e),function(a,b){},this)},_setUrl:function(){var a="/";a+=this._project.getSlug(),Wu.Util.setAddressBar(a)},hideControls:function(){var a=app.MapPane.getControls().layermenu;a&&a.hide();var b=app.MapPane.getControls().inspect;b&&b.hide();var c=app.MapPane.getControls().legends;c&&c.hide();var d=app.MapPane.getControls().description;d&&d.hide()},showControls:function(){var a=app.MapPane.getControls().layermenu;a&&a.show();var b=app.MapPane.getControls().inspect;b&&b.show();var c=app.MapPane.getControls().legends;c&&c.show();var d=app.MapPane.getControls().description;d&&d.show()},showStartPane:function(){app.MapPane._flush(),app.HeaderPane._flush(),app.HeaderPane._hide();var a=app.MapPane.getControls();for(c in a){var b=a[c];b._off()}app.StatusPane.close(),app.StartPane.activate()},createProject:function(){var a=(app.options.defaults.project.position,{name:"Project title",description:"Project description",createdByName:app.Account.getName(),keywords:"",position:app.options.defaults.project.position||{},bounds:{northEast:{lat:0,lng:0},southWest:{lat:0,lng:0},minZoom:1,maxZoom:22},header:{height:50},folders:[]}),b=new Wu.Project(a);b.editMode=!0;var c={store:a,callback:this._projectCreated,context:this};b.create(c)},_projectCreated:function(a,b){var c=Wu.parse(b),d=c.error,e=c.project;return d?app.feedback.setError({title:"There was an error creating new project!",description:d}):(app.Projects[e.uuid]=a,a.setNewStore(e),void Wu.Mixin.Events.fire("projectSelected",{detail:{projectUuid:a.getUuid()}}))},openLastUpdatedProject:function(){var a=_.first(_.sortBy(_.toArray(app.Projects),function(a){return a.store.lastUpdated}).reverse());a&&a.selectProject()},openFirstProject:function(){var a=_.first(_.sortBy(_.toArray(app.Projects),function(a){return a.getName().toLowerCase()}));a&&a.selectProject()}}),Wu.Data=Wu.Class.extend({initialize:function(){this._initResumable()},_initResumable:function(){this._resumable=new Wu.Resumable({onUploadDone:this._onUploadDone})},getUploadButton:function(a,b){this._buttonContainer=b;var c=this._uploadButton=Wu.DomUtil.create("div",a);return this._buttonContainer.appendChild(c),this._resumable.assignBrowse(c),c},_onUploadButtonClick:function(){},_onImportedFile:function(a,b){app.Data._setFeedbackImportTime(b),app.Data._getFile(a,app.Data._gotFile.bind(app.Data))},_onUploadDone:function(){},_setFeedbackImportTime:function(a){var b=parseInt(a/1e3)+" seconds",c="Import took "+b;app.feedback.setMessage({title:"Upload successful!",description:c})},_getFile:function(a,b){var c=new XMLHttpRequest,d=(new FormData,app.options.servers.portal+"api/upload/get");d+="?fileUuid="+a,d+="&access_token="+app.tokens.access_token,c.open("GET",d,!0),c.onreadystatechange=function(){if(4==c.readyState&&200==c.status){var a=Wu.parse(c.responseText);if(a&&a.file)return b(a)}},c.send(null)},_gotFile:function(a){var b=a.file,c=(a.layer,app.Account),d=c.setFile(b);Wu.Mixin.Events.fire("fileImported",{detail:{file:d}})},disableUploader:function(){},enableUploader:function(){}}),Wu.Evented=Wu.Class.extend({initialize:function(a){Wu.setOptions(this,a),this._listen(),this._initialize()},_listen:function(){Wu.Mixin.Events.on("projectSelected",this._projectSelected,this),Wu.Mixin.Events.on("projectDeleted",this._onProjectDeleted,this),Wu.Mixin.Events.on("editEnabled",this._editEnabled,this),Wu.Mixin.Events.on("editDisabled",this._editDisabled,this),Wu.Mixin.Events.on("layerEnabled",this._layerEnabled,this),Wu.Mixin.Events.on("layerDisabled",this._layerDisabled,this),Wu.Mixin.Events.on("fileImported",this._onFileImported,this),Wu.Mixin.Events.on("fileDeleted",this._onFileDeleted,this),Wu.Mixin.Events.on("layerAdded",this._onLayerAdded,this),Wu.Mixin.Events.on("layerEdited",this._onLayerEdited,this),Wu.Mixin.Events.on("layerDeleted",this._onLayerDeleted,this)},_projectSelected:function(){},_initialize:function(){},_initContainer:function(){},_editEnabled:function(){},_editDisabled:function(){},_layerEnabled:function(){},_layerDisabled:function(){},_updateView:function(){},_refresh:function(){},_onFileImported:function(){},_onFileDeleted:function(){},_onLayerAdded:function(){},_onLayerEdited:function(){},_onLayerDeleted:function(){},_onProjectDeleted:function(){}}),Wu.Resumable=Wu.Class.extend({options:{target:"/api/data/upload/chunked",chunkSize:2097152,simultaneousUploads:5,testChunks:!0,maxFiles:5,fileType:["zip","gz","geojson","tif","tiff","jp2","ecw"],fileTypeErrorCallback:this._fileTypeErrorCallback},initialize:function(a){Wu.setOptions(this,a),this.options.generateUniqueIdentifier=this._generateUniqueIdentifier,this.options.query=this._generateQuery,this.options.maxFilesErrorCallback=this._maxFilesErrorCallback,this._create(),this._set_id()},_create:function(){this.r=new Resumable(this.options);this._addResumableEvents()},destroy:function(){},_assign:function(){this.options.drop&&this.r.assignDrop(this.options.drop),this.options.browse&&this.r.assignBrowse(this.options.browse)},assignDrop:function(a){this.r.assignDrop(a)},assignBrowse:function(a){this.r.assignBrowse(a)},_unassign:function(){this.r.unAssignDrop(this.options.drop)},_disableUploadButton:function(){},_enableUploadButton:function(){},_uploadDone:function(){this.options.onUploadDone()},_addResumableEvents:function(){var a=this.r;a.on("fileAdded",function(b){Wu.Mixin.Events.fire("fileProcessing",{detail:{file:b}}),a._startTime=(new Date).getTime(),a.upload(),this.feedbackUploadStarted(b)}.bind(this)),a.on("fileSuccess",function(a,b){this.feedbackUploadSuccess(a,b),
app.ProgressBar.hideProgress(),this._uploadDone()}.bind(this)),a.on("fileProgress",function(a){var b=100*a.progress();b>99&&(b=100),app.ProgressBar.setProgress(b),Wu.Mixin.Events.fire("processingProgress",{detail:{text:"Uploading...",error:null,percent:parseInt(b),uniqueIdentifier:a.uniqueIdentifier}})}.bind(this)),a.on("cancel",function(){this._uploadDone()}.bind(this)),a.on("uploadStart",function(){}.bind(this)),a.on("complete",function(a){this._uploadDone()}.bind(this)),a.on("pause",function(){}.bind(this)),a.on("fileError",function(a,b){}.bind(this))},_removeEvents:function(){},_enableDrop:function(){},_disableDrop:function(){},_dragLeave:function(){this.options.drop.style.display="none"},_dragEnter:function(){this.options.drop.style.display="block"},disable:function(){},enable:function(){},feedbackUploadStarted:function(a){Wu.Util.bytesToSize(a.size),a.fileName;Wu.Mixin.Events.fire("processingProgress",{detail:{text:"Uploading...",error:null,percent:0,uniqueIdentifier:a.uniqueIdentifier}})},feedbackUploadSuccess:function(a,b){var c=Wu.parse(b),d=this.r,e=(c.file_id,(new Date).getTime(),d._startTime,a.size/1e3/1e3),f=(1*e).toFixed(0)+" seconds",b=(a.fileName.split(".").reverse()[0],"Estimated time: "+f);Wu.Mixin.Events.fire("processingProgress",{detail:{text:"Uploaded!",error:null,percent:100,uniqueIdentifier:a.uniqueIdentifier}})},_set_id:function(){this._id=Wu.Util.getRandomChars(5)},_get_id:function(){return this._id},_generateUniqueIdentifier:function(a){var b=a.size+"-"+a.lastModified+"-"+app.Account.getUuid()+"-"+a.name;return b},_generateQuery:function(){var a={fileUuid:Wu.Util.guid("r"),access_token:app.tokens.access_token};return a},_maxFilesErrorCallback:function(){app.feedback.setError({title:"Please only upload one file at a time."})},_fileTypeErrorCallback:function(a,b){var c="The file <strong>"+a.name+"</strong> is not a geodata file. We only allow geodata at this time.",d=a.name.split(".").reverse()[0];"shp"==d&&(c="Please zip shapefiles before uploading. Mandatory files are .shp, .shx, .dbf, .prj."),app.feedback.setError({title:"Sorry, you can't do that!",description:c})}}),Wu.Pane=Wu.Class.extend({initialize:function(a){Wu.setOptions(this,a),this._initialize(),this._initContainer(),this._listen()},_listen:function(){Wu.Mixin.Events.on("projectSelected",this._projectSelected,this),Wu.Mixin.Events.on("editEnabled",this._editEnabled,this),Wu.Mixin.Events.on("editDisabled",this._editDisabled,this),Wu.Mixin.Events.on("layerEnabled",this._layerEnabled,this),Wu.Mixin.Events.on("layerDisabled",this._layerDisabled,this),Wu.Mixin.Events.on("closeMenuTabs",this._onCloseMenuTabs,this)},_projectSelected:function(a){var b=a.detail.projectUuid;b&&(this._project=app.activeProject=app.Projects[b],this._refresh())},_initialize:function(){},_editEnabled:function(){},_editDisabled:function(){},_layerEnabled:function(){},_layerDisabled:function(){},_updateView:function(){},_refresh:function(){},_initContainer:function(){},_onCloseMenuTabs:function(){}}),Wu.HeaderPane=Wu.Pane.extend({_:"headerpane",_initContainer:function(){},_refresh:function(a){},addHooks:function(){},_addTooltips:function(){},_show:function(){},_hide:function(){},setLogo:function(a){},_getPixelLogo:function(a){},setTitle:function(a){},setSubtitle:function(a){},setRole:function(){},_getRole:function(){},getContainer:function(){},addedLogo:function(a){},_flush:function(){}}),Wu.ProgressPane=Wu.Class.extend({options:{color:"white"},initialize:function(a){Wu.setOptions(this,a),this.initContainer()},initContainer:function(){this._progressBar=app._progressBar=app._progressBar||Wu.DomUtil.create("div","status-progress-bar",app._appPane),this.options.addTo&&this.addTo(this.options.addTo)},addTo:function(){var a=this.options.addTo;a.appendChild(this._progressBar)},setProgress:function(a){if(!(a<this._current+2)){var b=this._progressBar;b.style.opacity=1,b.style.width=a+"%",b.style.backgroundColor=this.options.color,this._current=a}},hideProgress:function(){var a=this._progressBar;a.style.opacity=0,this._current=0,a.style.width=0,this._progressTimer&&clearTimeout(this._progressTimer)},timedProgress:function(a){var b=this,c=a||5e3,d=100,e=0,f=parseInt(parseInt(c)/d);b._timedProgress(e,f,d),app._progressBar.style.backgroundColor="red"},_timedProgress:function(a,b,c){var d=this;a+=100/c,d.setProgress(a),d._progressTimer=setTimeout(function(){return 100>a?d._timedProgress(a,b,c):void d.hideProgress()},b)}}),Wu.MapPane=Wu.Pane.extend({_:"mappane",options:{controls:["description","layermenu","zoom","measure","geolocation","mouseposition","draw"]},_initialize:function(){this._baselayerZIndex=new Wu.ZIndexControl.Baselayers,this._layermenuZIndex=new Wu.ZIndexControl.Layermenu,this._activeLayers=[]},_initContainer:function(){this._container=app._mapPane=Wu.DomUtil.createId("div","map",app._mapContainer),Wu.DomUtil.addClass(this._container,"click-to-start"),this._initLeaflet(),this._initControls(),this._registerEvents(),this._adjustLayout()},_projectSelected:function(a){var b=a.detail.projectUuid;b&&(this._project=app.activeProject=app.Projects[b],this._refresh(),app._map.fire("projectSelected"))},_refresh:function(){this._flush(),this.setBaseLayers(),this.setMaxBounds(),this.setPosition()},_flush:function(){this._flushLayers(),this._activeLayers=null,this._activeLayers=[]},_flushLayers:function(){var a=app._map,b=_.clone(this._activeLayers);b.forEach(function(b){b.layer&&a.removeLayer(b.layer),b._flush()},this)},_initLeaflet:function(){var a=this._map=app._map=L.map("map",{worldCopyJump:!0,attributionControl:!1,maxZoom:19,minZoom:0,zoomControl:!1,inertia:!1});this._addAttribution(a),a.on("zoomstart",function(b){a.eachLayer(function(a){if(a.options){var b=a.options.layerUuid;if(b){var c=app.activeProject.getPostGISLayer(b);c&&c._invalidateTiles()}}}),this._invalidateTiles()},this),a.on("projectSelected",function(a){setTimeout(function(){var a=app.MapPane.getControls().layermenu;a&&a._enableDefaultLayers()},10)})},_addAttribution:function(a){this._attributionControl=L.control.attribution({position:"bottomleft",prefix:!1}),a.addControl(this._attributionControl),this._attributionControl.addAttribution('<a class="systemapic-attribution-logo" href="http://systemapic.com" target="_blank"><img src="../images/systemapic-attribution-logo-white.png"></a>'),this._attributionControl.removeAttribution("Leaflet"),Wu.DomEvent.on(this._attributionControl._container,"click",function(){app.Analytics.onAttributionClick()},this)},_invalidateTiles:function(){({access_token:app.tokens.access_token})},_initControls:function(){var a=this.options.controls;this._controls={},_.each(a,function(a){this._controls[a]=new(L.Control[a.camelize()])},this)},getControls:function(){return this._controls},_adjustLayout:function(){},_registerEvents:function(){app._map.on("moveend",this._onMove,this),app._map.on("zoomend",this._onZoom,this)},_onMove:function(){var a=this._project||app.activeProject;Wu.Mixin.Events.fire("projectChanged",{detail:{projectUuid:a.getUuid()}})},_onZoom:function(){var a=this._project||app.activeProject;Wu.Mixin.Events.fire("projectChanged",{detail:{projectUuid:a.getUuid()}})},resizeEvent:function(a){this._updateWidth(a)},_updateWidth:function(a){var b=this._map;b&&a&&(b._container.style.width=a.width-parseInt(b._container.offsetLeft)+"px",setTimeout(function(){b&&b.reframe()},300))},getZIndexControls:function(){var a={b:this._baselayerZIndex,l:this._layermenuZIndex};return a},clearBaseLayers:function(){this.baseLayers&&(this.baseLayers.forEach(function(a){app._map.removeLayer(a.layer)}),this.baseLayers={})},setBaseLayers:function(){var a=this._project.getBaselayers();a&&a.forEach(function(a){this.addBaseLayer(a)},this)},addBaseLayer:function(a){var b=this._project.layers[a.uuid];b&&b.add("baselayer")},removeBaseLayer:function(a){map.removeLayer(base.layer)},_setLeft:function(a){this._container.style.left=a+"px",this._container.style.width=parseInt(window.innerWidth)-a+"px"},setHeaderPadding:function(){var a=this._map,b=a._controlContainer;b.style.paddingTop=this._project.getHeaderHeight()+"px"},setPosition:function(a){var b=this._map,c=a||this._project.getLatLngZoom(),d=c.lat,e=c.lng,f=c.zoom;void 0!=d&&void 0!=e&&void 0!=f&&b.setView([d,e],f)},getPosition:function(){var a=this._map.getCenter(),b={lat:a.lat,lng:a.lng,zoom:this._map.getZoom()};return b},getActiveLayermenuLayers:function(){if(this.layerMenu){var a=app.zIndex,b=this.layerMenu.getLayers(),c=_.filter(b,function(a){return a.on}),d=_.sortBy(c,function(b){return a.get(b.layer)});return d}},getActiveLayers:function(){return this._activeLayers},addActiveLayer:function(a){this._activeLayers.push(a)},clearActiveLayers:function(){this._activeLayers=[]},removeActiveLayer:function(a){_.remove(this._activeLayers,function(b){return b.getUuid()==a.getUuid()},this)},setMaxBounds:function(){var a=app._map,b=this._project.getBounds();if(b){var c=L.latLng(b.southWest.lat,b.southWest.lng),d=L.latLng(b.northEast.lat,b.northEast.lng),e=L.latLngBounds(c,d);a.setMaxBounds(e),a.options.minZoom=b.minZoom,a.options.maxZoom=b.maxZoom>19?19:b.maxZoom}},addEditableLayer:function(a){this.editableLayers=new L.FeatureGroup,a.addLayer(this.editableLayers)},updateControlCss:function(){var a=this._project.getControls(),b=(a.legends,app._map._controlCorners),c=(b.topleft,b.bottomright);b.topright;if(a.layermenu&&(a.inspect?Wu.DomUtil.removeClass(c,"no-inspector"):Wu.DomUtil.addClass(c,"no-inspector")),a.legends){var d=a.legends._legendsContainer;a.layermenu?d&&Wu.DomUtil.removeClass(d,"legends-padding-right"):d&&Wu.DomUtil.addClass(d,"legends-padding-right"),a.description}a.mouseposition,a.vectorstyle,a.zoom,a.baselayertoggle,a.description,a.draw,a.geolocation,a.inspect},resetControls:function(){this.cartoCss&&this.cartoCss.destroy(),this.cartoCss=null,this._drawControl=null,this._drawControlLayer=null,this._scale=null,this.vectorStyle=null,this.layerMenu=null,this.legendsControl=null,this.descriptionControl=null,this.inspectControl=null,this.mousepositionControl=null,this.baselayerToggle=null,this.geolocationControl=null,delete this._drawControl,delete this._drawControlLayer,delete this._scale,delete this.vectorStyle,delete this.layerMenu,delete this.legendsControl,delete this.descriptionControl,delete this.inspectControl,delete this.mousepositionControl,delete this.baselayerToggle,delete this.geolocationControl,delete this.cartoCss},refreshControls:function(){},hideControls:function(){Wu.DomUtil.addClass(app._map._controlContainer,"displayNone")},showControls:function(){Wu.DomUtil.removeClass(app._map._controlContainer,"displayNone")},addLayer:function(a){var b=L.mapbox.tileLayer(a);b.addTo(this._map)},_addLayer:function(a){a.addto(this._map)},disableInteraction:function(a){var b=this._map||app._map;a&&b.dragging.disable(),b.touchZoom.disable(),b.doubleClickZoom.disable(),b.scrollWheelZoom.disable(),b.boxZoom.disable(),b.keyboard.disable()},enableInteraction:function(a){var b=this._map||app._map;a&&b.dragging.enable(),b.touchZoom.enable(),b.doubleClickZoom.enable(),b.scrollWheelZoom.enable(),b.boxZoom.enable(),b.keyboard.enable()},getEditableLayerParent:function(a){var b=this.editableLayers._layers;for(l in b)for(m in b[l]._layers){if(m==a)return b[l];var c=b[l]._layers[m];for(n in c){var d=c[n];if(n==a)return c;for(o in d)if(o==a)return d}}return!1},_addPopupContentDraw:function(a){this._addPopupContent(!1,a)},_addPopupContent:function(a,b){var c={e:a,multiPopUp:b};this._chart=new Wu.Control.Chart(c)},_clearPopup:function(){this._chart&&this._chart._refresh()}}),Wu.StatusPane=Wu.Class.extend({_:"statuspane",initialize:function(a){Wu.setOptions(this,a),this.initContainer(),this.addHooks()},initContainer:function(){},addHooks:function(){},tab:function(a){9==a.keyCode&&this.toggle()},toggle:function(){this.isOpen?this.close():this.open()},open:function(a){this.isOpen=!0,app.SidePane&&app.SidePane.expand(),app.Chrome.Left.open(),this._addAutoCloseEvents()},close:function(a){a&&Wu.DomEvent.stop(a),this.isOpen=!1,app.SidePane&&app.SidePane.collapse(),app.Chrome.Left.close(),Wu.DomUtil.removeClass(app.MapPane._container,"map-blur"),this._removeAutoCloseEvents()},_addAutoCloseEvents:function(){Wu.DomEvent.on(app.MapPane._container,"click",this.close,this),app.StartPane._container&&(Wu.DomEvent.on(app.StartPane._container,"click",this.close,this),app.StartPane.disableHooks())},_removeAutoCloseEvents:function(){Wu.DomEvent.off(app.MapPane._container,"click",this.close,this),app.StartPane._container&&(Wu.DomEvent.off(app.StartPane._container,"click",this.close,this),app.StartPane.enableHooks())},setHeight:function(a){this._container.style.height=parseInt(a)+"px"},updateContent:function(a){this.project=a,this.close()}}),Wu.StartPane=Wu.Pane.extend({dimensions:{screenW:0,screenH:0,boxW:350,boxH:233,sizeMode:"",projectNo:0},projectContainers:[],_projectSelected:function(a){this.deactivate()},activate:function(){this.isOpen=!0,this.initContainer(),this.addHooks(),this.refreshProjects()},deactivate:function(){this.isOpen=!1,this.removeHooks(),this._spinner&&this._spinner.disable(),this._container&&Wu.DomUtil.remove(this._container)},initContainer:function(){this._container=Wu.DomUtil.create("div","startpane-canvas-container",app._appPane);var a=this._initContent();this._wrapper=Wu.DomUtil.create("div","spinning-wrapper",this._container),this._wrapper.appendChild(a)},initSpinner:function(){this._spinner=new L.SpinningMap({autoStart:!0,accessToken:"pk.eyJ1Ijoic3lzdGVtYXBpYyIsImEiOiJkV2JONUNVIn0.TJrzQrsehgz_NAfuF8Sr1Q",layer:"systemapic.kcjonn12",logo:"images/griffon_logo_drop.png",content:content,container:this._container,wrapper:this._wrapper,speed:1e3,tileFormat:"png",interactivity:!1,gl:!1,position:{lat:-33.83214,lng:151.22299,zoom:[4,17]},circle:!1})},_initContent:function(){var a=Wu.DomUtil.create("div","startpane-spinning-content");if(this._bannerContainer=Wu.DomUtil.create("div","startpane-banner-container",a),this._banner=Wu.DomUtil.create("div","startpane-banner",this._bannerContainer),this._recentProjectsContainer=Wu.DomUtil.create("div","startpane-recent-projects-container",this._banner),this._getLatestProjects().length>1)this._recentProjectsHeader=Wu.DomUtil.create("h1","startpane-header-title",this._recentProjectsContainer,"Latest projects:");else if(app.access.to.create_project()){this._recentProjectsHeader=Wu.DomUtil.create("h1","startpane-header-title",this._recentProjectsContainer,"Get started:"),this._hasAccessMessage=Wu.DomUtil.create("p","startpane-has-access",this._recentProjectsContainer,"Hello "+app.Account.getFirstName()+".<br/>You have no projects yet. Choose one of your clients and click the respective button below to start a project."),this._clientsContainer=Wu.DomUtil.create("div","startpane-client-container",this._recentProjectsContainer);for(c in app.Clients){var b=app.Clients[c],d=this._getPixelLogo(b.getLogo())||"/css/images/grayLight-systemapic-logo-circle-240x240.png?access_token="+app.tokens.access_token,e=b.getName();this._singleClientContainer=Wu.DomUtil.create("div","startpane-single-client-container",this._clientsContainer),this._logoContainer=Wu.DomUtil.create("div","startpane-client-logo",this._singleClientContainer,"<img src="+d+">"),this._clientDiv=Wu.DomUtil.create("div","startpane-client-name",this._singleClientContainer,"<p>"+e+"</p>"),this._createProjectLink=Wu.DomUtil.create("div","startpane-new-project",this._singleClientContainer,"<p>Create new project.</p>"),Wu.DomEvent.on(this._createProjectLink,"mousedown",function(){this.createProjectFromClient(b)},this),app.Tooltip.add(this._logoContainer,"Click to create new project.")}}else this._recentProjectsHeader=Wu.DomUtil.create("h1","startpane-header-title",this._recentProjectsContainer,"No current projects."),this._hasNoAccessMessage=Wu.DomUtil.create("p","startpane-has-no-access",this._recentProjectsContainer,"Hello "+app.Account.getFirstName()+",<br/>You are currently not participating in any projects, and you are not allowed to create a project. <br/>Please wait for an invitation.");return this._projectList=Wu.DomUtil.create("div","startpane-project-list",this._recentProjectsContainer),a},refreshProjects:function(){if(this._projectList.innerHTML="",this.projects=this._getLatestProjects(),this.dimensions.projectNo=this.projects.length,this.projects){this.projects.forEach(function(a,b){b>5||this.createStartProject(a)},this);var a=app._getDimensions();this.dimensions.screenW=a.width,this.dimensions.screenH=a.height,this.positionSpinner(a),this.addHooks()}},_getLatestProjects:function(){var a=app.Projects,b=_.sortBy(a,function(a){return a.getLastUpdated()});return b.reverse(),b},createStartProject:function(a){if(a){var b={};b._projectContainer=Wu.DomUtil.create("div","start-panne-recent-projects",this._projectList),b._projectThumb=Wu.DomUtil.create("img","",b._projectContainer);var c=new Image,d=(a.getLogo()||app.options.servers.portal+"css/images/default-thumbs/default-thumb-"+Math.floor(10*Math.random())+".jpg")+"?access_token="+app.tokens.access_token;c.src=d;var e=this.dimensions.boxW,f=this.dimensions.boxH;c.onload=function(){var a=c.width/e,g=c.height/f;a>=g?(b._projectThumb.style.height="100%",b._projectThumb.style.width="auto"):(b._projectThumb.style.height="auto",b._projectThumb.style.width="100%"),b._projectThumb.src=d},b._projectTitle=Wu.DomUtil.create("div","start-project-name",b._projectContainer),b._projectTitle.innerHTML=a.getName(),this.projectContainers.push(b),a.getName().length<22&&Wu.DomUtil.addClass(b._projectTitle,"short-name"),Wu.DomEvent.on(b._projectContainer,"click",function(){this.selectProject(a)},this)}},addHooks:function(){},removeHooks:function(){},enableHooks:function(){this._hooksDisabled=!1},disableHooks:function(){this._hooksDisabled=!0},selectProject:function(a){this._hooksDisabled||(Wu.Mixin.Events.fire("projectSelected",{detail:{projectUuid:a.getUuid()}}),this.deactivate())},update:function(){},createImage:function(){var a=this;app.setHash(function(b,c){Wu.post("/api/util/snapshot",c,a.createdImage,a)})},createdImage:function(a,b){var c=JSON.parse(b),d=c.image,e=app.options.servers.portal;e+="pixels/",e+=d;e+="?width=250",e+="&height=150";var f='url("';f+=e,f+='")'},resizeEvent:function(a){this.positionSpinner(a)},positionSpinner:function(a){var b=a.width,c=a.height;if(c!=this.dimensions.screenH&&(this.dimensions.screenH=c,this.changeHeight(a)),b>=1091){if("full"==this.dimensions.sizeMode)return;this.dimensions.sizeMode="full",this.setYposition(a)}if(1090>=b&&b>=761){if("medium"==this.dimensions.sizeMode)return;this.dimensions.sizeMode="medium",this.setYposition(a)}if(760>=b){if("small"==this.dimensions.sizeMode)return;this.dimensions.sizeMode="small",this.setYposition(a)}},changeHeight:function(a){this.setYposition(a)},setYposition:function(a){var b=(a.width,a.height);if("full"==this.dimensions.sizeMode){if(b>=691&&this.showBoxes(6),690>=b&&this.showBoxes(3),this.dimensions.projectNo>=4)var c=2*this.dimensions.boxH;else var c=this.dimensions.boxH;this.calcPadding(b,c)}if("medium"==this.dimensions.sizeMode){if(b>=921&&this.showBoxes(6),920>=b&&b>=661&&this.showBoxes(4),660>=b&&this.showBoxes(2),this.dimensions.projectNo>=5)var c=3*this.dimensions.boxH;else if(this.dimensions.projectNo>=3&&this.dimensions.projectNo<=4)var c=2*this.dimensions.boxH;else var c=this.dimensions.boxH;this.calcPadding(b,c)}if("small"==this.dimensions.sizeMode){if(b>=921&&this.showBoxes(3),920>=b&&b>=661&&this.showBoxes(2),660>=b&&this.showBoxes(1),this.dimensions.projectNo>=3)var c=3*this.dimensions.boxH;else if(2==this.dimensions.projectNo)var c=2*this.dimensions.boxH;else if(1==this.dimensions.projectNo)var c=this.dimensions.boxH;this.calcPadding(b,c)}},showBoxes:function(a){this.dimensions.projectNo=a;for(var b=0;b<this.projects.length;b++)if(a>b){var c=this.projectContainers[b];c&&Wu.DomUtil.removeClass(c._projectContainer,"displayNone")}else{var c=this.projectContainers[b];c&&Wu.DomUtil.addClass(c._projectContainer,"displayNone")}},calcPadding:function(a,b){var c=Math.floor((a-b)/2);100>=c&&(c=100),this._wrapper.style.paddingTop=c+"px"},createProjectFromClient:function(a){var b=app.options.defaults.project.position,c={name:"Project title",description:"Project description",createdByName:app.Account.getName(),keywords:"",client:a.getUuid(),position:b||{},bounds:{northEast:{lat:0,lng:0},southWest:{lat:0,lng:0},minZoom:1,maxZoom:22},header:{height:50},folders:[]},d=new Wu.Project(c);d.editMode=!0;var e=this._getSidepaneClient(a),f={store:c,callback:e._projectCreated,context:e};d._saveNew(f),app.Analytics.setGaEvent(["Start Pane","Clients: new project"]),this.deactivate()},_projectCreated:function(a,b){var c=Wu.parse(b),d=c.error,e=c.project;return d?app.feedback.setError({title:"There was an error creating new project!",description:d}):(app.Projects[e.uuid]=a,a.setNewStore(e),void this._createNewProject(a))},_getSidepaneClient:function(a){var b=app.SidePane.Clients.clients,a=_.find(b,function(b){return b.client.getUuid()==a.getUuid()});return a},_getPixelLogo:function(a){if(!a)return!1;var b;b=a.split("/")[2];var c="/pixels/image/"+b+"?width=250&height=250&format=png&access_token="+app.tokens.access_token;return c}}),Wu.FeedbackPane=Wu.Class.extend({initialize:function(){this.initContainer(),app.feedback=this,this._messages={},this._messagesArray=[]},initContainer:function(){var a=app.MapPane._map._controlCorners.topleft;this._container=Wu.DomUtil.create("div","feedback-pane",a),this._innerWrapper=Wu.DomUtil.create("div","feedback-pane-inner-wrapper",this._container),Wu.DomEvent.on(this._container,"click",Wu.DomEvent.stopPropagation)},set:function(a){this.add(a)},setMessage:function(a){this.add(a,1)},setSuccess:function(a){this.add(a,1)},setError:function(a){this.add(a,3)},setAction:function(a){this.add(a,4)},add:function(a,b){var c=Wu.Util.createRandom(5);a.id&&(c=a.id);var d={container:this._container,innerWrapper:this._innerWrapper,id:c,severity:b||3},e=this._messages[c];e?this.update(a,b):(this._messages[c]=new Wu.FeedbackPane.Message(Wu.extend(d,a)),this._messagesArray.push(this._messages[c])),this.checkOverflow()},checkOverflow:function(){var a=700,b=this._innerWrapper.offsetHeight,c=a-100-b;if(0>c){var d=this._messagesArray[0].options.id;this.remove(d),this._messagesArray.splice(0,1)}},update:function(a,b){var c=a.title,d=a.description,e=a.id;Wu.DomUtil.create("div","feedback-pane-title2",this._messages[e]._content,c),Wu.DomUtil.create("div","feedback-pane-description2",this._messages[e]._content,d);this._messages[e].options.severity=b,this._messages[e].setSeverity(b)},remove:function(a){var b=this._messages[a];if(b){var c=b._content;Wu.DomUtil.remove(c),delete this._messages[a]}}}),Wu.FeedbackPane.Message=Wu.Class.extend({options:{clearTimer:!0,clearDelay:4500,transitionDelay:.5,severityStyle:{1:"message",2:"success",3:"error",4:"action"}},initialize:function(a){Wu.setOptions(this,a),this.initLayout(),this.set()},initLayout:function(){this._content=Wu.DomUtil.create("div","feedback-pane-content",this.options.innerWrapper),this._title=Wu.DomUtil.create("div","feedback-pane-title",this._content),this._icon=Wu.DomUtil.create("div","feedback-pane-icon",this._content),this._iconImg=Wu.DomUtil.create("img","feedback-pane-icon-img",this._icon),this._description=Wu.DomUtil.create("div","feedback-pane-description",this._content),this._content.style.opacity=0,this._content.style.webkitTransition="opacity "+this.options.transitionDelay+"s",this._content.style.transition="opacity "+this.options.transitionDelay+"s",this._x=Wu.DomUtil.create("div","feedback-pane-x displayNone",this._content,"X"),this.addEvents()},addEvents:function(){Wu.DomEvent.on(this._x,"click",this.clear,this),Wu.DomEvent.on(this._content,"mouseenter",this._mouseEnter,this),Wu.DomEvent.on(this._content,"mouseleave",this._mouseLeave,this)},set:function(){this.setTitle(),this.setDescription(),this.setSeverity(),this.setIcon(),this.show(),this.clearTimer()},_mouseEnter:function(){this._cancelTimer()},_mouseLeave:function(){this.clearTimer(this.options.clearDelay/4)},_cancelTimer:function(){this._clearTimer&&!app.debug&&clearTimeout(this._clearTimer)},clearTimer:function(a){this.options.clearTimer&&!app.debug&&(this._clearTimer=setTimeout(this.clear.bind(this),a||this.options.clearDelay))},clear:function(){this.hide()},setTitle:function(){this._title.innerHTML=this.options.title},setDescription:function(){this._description.innerHTML=this.options.description||""},setIcon:function(){this.options.icon&&this._iconImg.setAttribute("src",this.options.icon)},setSeverity:function(a){var a=this.options.severity;a&&this.setStyle(this.options.severityStyle[a])},setStyle:function(a){var b=[];b[0]=this.options.severityStyle[1],b[1]=this.options.severityStyle[2],b[2]=this.options.severityStyle[3],b[3]=this.options.severityStyle[4],b.forEach(function(b){b==a?Wu.DomUtil.addClass(this._content,a):Wu.DomUtil.removeClass(this._content,b)},this)},setBackground:function(a){this._content.style.background=a},hide:function(){this._content.style.opacity=0,setTimeout(function(){app.feedback.remove(this.options.id)}.bind(this),1e3*this.options.transitionDelay)},show:function(){setTimeout(function(){this._content.style.opacity=1}.bind(this),5)}}),Wu.Share=Wu.Pane.extend({type:"share",title:"Share",options:{permissions:[{title:"View project",permission:"read_project",checked:!0,enabled:!1},{title:"Download data",permission:"download_file",checked:!1,enabled:!0},{title:"Invite others",permission:"share_project",checked:!0,enabled:!0}]},initialize:function(a){Wu.setOptions(this,a),this._initContent(),this._listen()},_initContent:function(){this._initLayout(),this._registerButton()},_initLayout:function(){this._shareDropdown=Wu.DomUtil.create("div","share-dropdown displayNone",app._appPane),this._shareImageButton=Wu.DomUtil.create("div","share-item",this._shareDropdown),this._sharePrintButton=Wu.DomUtil.create("div","share-item",this._shareDropdown),this._shareInviteButton=Wu.DomUtil.create("div","share-item",this._shareDropdown),this._processingPrint=Wu.DomUtil.create("i","fa fa-cog",this._sharePrintButton),Wu.DomEvent.on(this._shareImageButton,"click",this._shareImage,this),Wu.DomEvent.on(this._sharePrintButton,"click",this._sharePrint,this)},_registerButton:function(){var a=app.Chrome.Top;this._shareButton=a._registerButton({name:"share",className:"chrome-button share",trigger:this._togglePane,context:this,project_dependent:!0}),this._shareButton.innerHTML='<i class="fa fa-paper-plane"></i>'},_togglePane:function(){this._isOpen?this._close():this._open()},_open:function(){Wu.Mixin.Events.fire("closeMenuTabs"),Wu.DomUtil.removeClass(this._shareDropdown,"displayNone"),this._isOpen=!0,Wu.DomUtil.addClass(this._shareButton,"active"),this._fillTitles()},_close:function(){Wu.DomUtil.addClass(this._shareDropdown,"displayNone"),this._isOpen=!1,this._shareLinkWrapper&&Wu.DomUtil.remove(this._shareLinkWrapper),this._sharePDFInput&&Wu.DomUtil.remove(this._sharePDFInput),this._inviteWrapper&&Wu.DomUtil.remove(this._inviteWrapper),this._shareInviteButton.innerHTML="Invite users...",Wu.DomUtil.removeClass(this._shareDropdown,"wide-share"),Wu.DomUtil.removeClass(this._shareButton,"active")},_onCloseMenuTabs:function(){this._close()},_fillTitles:function(){this._shareImageButton.innerHTML="Share Image",this._sharePrintButton.innerHTML="Share PDF",this._shareInviteButton.innerHTML="Invite to project"},_clearTitles:function(){this._shareImageButton.innerHTML="",this._sharePrintButton.innerHTML="",this._shareInviteButton.innerHTML=""},_addGhost:function(){this._ghost=Wu.DomUtil.create("div","share-ghost",app._appPane),Wu.DomEvent.on(this._ghost,"click",this._close,this)},_removeGhost:function(){this._ghost&&(Wu.DomEvent.off(this._ghost,"click",this._close,this),Wu.DomUtil.remove(this._ghost))},_refresh:function(){var a=this._project;a.isShareable()?(Wu.DomUtil.removeClass(this._shareInviteButton,"disabled"),Wu.DomEvent.on(this._shareInviteButton,"click",this._shareInvite,this)):(Wu.DomUtil.addClass(this._shareInviteButton,"disabled"),Wu.DomEvent.off(this._shareInviteButton,"click",this._shareInvite,this))},_shareImage:function(){app.setHash(function(a,b){Wu.send("/api/util/snapshot",b,function(a,b){this._createdImage(a,b)}.bind(this),this)}.bind(this)),app.ProgressBar.timedProgress(5e3)},_createdImage:function(a,b,c){var d=Wu.parse(b),e=d.image,f=app.options.servers.portal;f+="pixels/",f+=e,f+="?raw=true",f+="&access_token="+app.tokens.access_token,window.open(f,"mywindow"),this._close();var g=app.activeProject;app.Analytics.onScreenshot({project_name:g.getName(),file_id:e})},_shareLink:function(){app.setHash(function(a,b){this._createLinkView(b)}.bind(this))},_createLinkView:function(a){var b=Wu.parse(a),c=window.location.href+"/"+b.hash.id;this._insertShareLink(c)},_insertShareLink:function(a){this._shareLinkInput&&Wu.DomUtil.remove(this._shareLinkInput),this._shareLinkWrapper=Wu.DomUtil.create("div","share-link-wrapper");Wu.DomUtil.create("div","share-copy-link-title",this._shareLinkWrapper,"Copy sharelink:");this._shareLinkInput=Wu.DomUtil.create("input","share-input",this._shareLinkWrapper),this._shareLinkInput.value=a,this._shareDropdown.appendChild(this._shareLinkWrapper),this._shareLinkInput.select(),this._clearTitles()},_sharePrint:function(){var a=this;app.setHash(function(b,c){var d=JSON.parse(c);d.hash.slug=app.activeProject.getName();var e=JSON.stringify(d);Wu.post("/api/util/pdfsnapshot",e,a._createdPrint,a)}),app.ProgressBar.timedProgress(5e3)},_createdPrint:function(a,b){var c=JSON.parse(b),d=c.pdf,e=app.options.servers.portal+"api/file/download?file="+d+"&type=pdf&access_token="+app.tokens.access_token;a._insertPDFLink(e),app.ProgressBar.hideProgress()},_insertPDFLink:function(a){this._sharePDFInput&&Wu.DomUtil.remove(this._sharePDFInput),this._sharePDFInput=Wu.DomUtil.create("a","share-link-pdf"),this._sharePDFInput.href=a,this._sharePDFInput.target="_blank",this._sharePDFInput.innerHTML="Open PDF",this._shareDropdown.appendChild(this._sharePDFInput)},_shareInvite:function(){app.Chrome.Left._tabs.projects.openShare(),this._close()},_getPermissions:function(){var a=[];return this._checkboxes.forEach(function(b){var c=b._switch,d=b.value,e=c.getAttribute("state");"true"==e&&a.push(d)}),a},_getInviteLink:function(a,b){var c=_.pluck(_.where(this.options.permissions,{checked:!0}),"permission"),a=a||c,d={project_id:this._project.getUuid(),project_name:this._project.getTitle(),access_type:"view",permissions:a};app.Analytics.onInvite(d),Wu.post("/api/invite/link",JSON.stringify(d),b)},_toggleInviteType:function(){var a=this._inviteTypeToggle.innerHTML;"view"==a&&(this._inviteTypeToggle.innerHTML="edit"),"edit"==a&&(this._inviteTypeToggle.innerHTML="view")}}),Wu.MapSettingsPane=Wu.Pane.extend({type:"mapsettingspane",title:"Map settings pane",options:{},_initialize:function(a){this._initContent()},_initContent:function(){this._initLayout(),this._registerButton()},_refresh:function(){this._flush(),this._checkAccess()&&(this.initSettings("Controls"),this.initBoundPos("Bounds & Position"))},_flush:function(){this._settingsDropdown&&(this._settingsDropdown.innerHTML="")},_checkAccess:function(){return this._project?this._project.isEditable()?(Wu.DomUtil.removeClass(this._settingsButton,"disabledBtn"),!0):(Wu.DomUtil.addClass(this._settingsButton,"disabledBtn"),!1):!1},_registerButton:function(){var a=app.Chrome.Top;this._settingsButton=a._registerButton({name:"settings",className:"chrome-button settings",trigger:this._togglePane,context:this,project_dependent:!0}),this._settingsButton.innerHTML='<i class="top-button fa fa-gear"></i>Options'},_initLayout:function(){this._settingsDropdown=Wu.DomUtil.create("div","settings-dropdown displayNone",app._appPane)},_togglePane:function(){this._project.isEditable()&&(this._isOpen?this._close():this._open())},_open:function(){Wu.Mixin.Events.fire("closeMenuTabs"),Wu.DomUtil.removeClass(this._settingsDropdown,"displayNone"),this._isOpen=!0,Wu.DomUtil.addClass(this._settingsButton,"active");
},_close:function(){Wu.DomUtil.addClass(this._settingsDropdown,"displayNone"),this._isOpen=!1,Wu.DomUtil.removeClass(this._settingsButton,"active")},_onCloseMenuTabs:function(){this._close()},_addGhost:function(){this._ghost=Wu.DomUtil.create("div","share-ghost",app._appPane),Wu.DomEvent.on(this._ghost,"click",this._close,this)},_removeGhost:function(){this._ghost&&(Wu.DomEvent.off(this._ghost,"click",this._close,this),Wu.DomUtil.remove(this._ghost))},_refreshDefaultPermission:function(){},initSettings:function(a){var b=Wu.DomUtil.create("div","chrome-content-section-wrapper",this._settingsDropdown),c=(Wu.DomUtil.create("div","chrome-content title",b,a),{zoom:{enable:!0,name:"Zoom"},draw:{enable:!0,name:"Draw"},description:{enable:!0,name:"Description/legend"},measure:{enable:!0,name:"Measure"},mouseposition:{enable:!0,name:"Mouse position"},geolocation:{enable:!0,name:"Geo search"},layermenu:{enable:!1,name:"Layer menu"},legends:{enable:!1,name:"Legend"},baselayertoggle:{enable:!1,name:"Base layer toggle"},cartocss:{enable:!1,name:"CartoCSS"}}),d=app.activeProject;for(var e in c){var f=c[e].enable;if(f){var a=c[e].name,g=new Wu.fieldLine({id:e,appendTo:b,title:a,input:!1});new Wu.button({id:e,type:"switch",isOn:d.store.controls[e],right:!1,appendTo:g.container,fn:this._saveSwitch.bind(this)})}}},initBoundPos:function(a){var b=Wu.DomUtil.create("div","chrome-content-section-wrapper",this._settingsDropdown),c=(Wu.DomUtil.create("div","chrome-content title",b,a),this.isBoundsSet()),d=new Wu.fieldLine({id:"bounds",appendTo:b,title:"Bounds",className:"no-padding",input:!1}),e=(new Wu.button({id:"bounds",type:"setclear",isOn:c,right:!1,appendTo:d.container,fn:this._saveSetClear.bind(this)}),new Wu.fieldLine({id:"position",appendTo:b,title:"Position",className:"no-padding",input:!1}));new Wu.button({id:"position",type:"set",isOn:!1,right:!1,appendTo:e.container,fn:this._saveSet.bind(this)})},isBoundsSet:function(){var a=app.activeProject.getBounds();if(!a)return!1;var b=a.maxZoom,c=a.minZoom,d=a.northEast.lat,e=a.northEast.lng,f=a.southWest.lat,g=a.southWest.lng;return 20==b&&1==c&&90==d&&180==e&&-90==f&&-180==g?!1:!0},_saveSwitch:function(a){var b=(a.target,a.target.getAttribute("state")),c="true"==b,d=a.target.getAttribute("key"),e=app.MapPane.getControls()[d];if(!e)return void 0;var f=app.activeProject;f.store.controls[d]=c,f._update("controls"),c?e._on():e._off()},_saveSetClear:function(a,b){"bounds"==a&&(b?this.setBounds():this.clearBounds())},_saveSet:function(a){"position"==a&&this.setPosition()},setPosition:function(){var a=app.activeProject;if(a){var b=Wu.app._map.getCenter(),c=Wu.app._map.getZoom(),d={lat:b.lat,lng:b.lng,zoom:c};a.setPosition(d)}},setBounds:function(a){var b=app.activeProject;if(b){var c=Wu.app._map.getBounds(),d=Wu.app._map.getZoom();b.setBounds({northEast:{lat:c._northEast.lat,lng:c._northEast.lng},southWest:{lat:c._southWest.lat,lng:c._southWest.lng},minZoom:d,maxZoom:18}),this.enforceBounds()}},clearBounds:function(){var a=Wu.app.activeProject,b=Wu.app._map,c={northEast:{lat:"90",lng:"180"},southWest:{lat:"-90",lng:"-180"},minZoom:"1",maxZoom:"20"};a.setBounds(c),this.enforceBounds(),b.setMaxBounds(!1)},enforceBounds:function(){var a=app.activeProject,b=app._map,c=a.getBounds();if(c){var d=L.latLng(c.southWest.lat,c.southWest.lng),e=L.latLng(c.northEast.lat,c.northEast.lng),f=L.latLngBounds(d,e),g=c.minZoom,h=c.maxZoom;c==this._nullBounds?b.setMaxBounds(!1):b.setMaxBounds(f),b.options.minZoom=g,b.options.maxZoom=h}b.invalidateSize()}}),Wu.Fullscreen=Wu.Evented.extend({_inputs:[],_initialize:function(){this._initContent(),this.addEvents()},_initContent:function(){this._container=Wu.DomUtil.create("div","smooth-fullscreen",app._appPane);var a=this.options.innerClassName||"smooth-fullscreen-inner";this._inner=Wu.DomUtil.create("div",a,this._container),this._closer=Wu.DomUtil.create("div","close-smooth-fullscreen",this._container,"x"),this._header=Wu.DomUtil.create("div","smooth-fullscreen-title",this._inner,this.options.title),this._content=Wu.DomUtil.create("div","smooth-fullscreen-content",this._inner)},addInput:function(a){var b=Wu.DomUtil.create("div","smooth-fullscreen-name-label",this._content,a.label),c=Wu.DomUtil.create("input","smooth-input",this._content);c.setAttribute("placeholder",a.placeholder),c.value=a.value;var d=Wu.DomUtil.create("div","smooth-fullscreen-error-label",this._content);this._inputs.push({label:b,input:c,error:d})},addEvents:function(){Wu.DomEvent.on(this._closer,"click",this.destroy,this),this._addEscapeKey()},removeEvents:function(){Wu.DomEvent.off(this._closer,"click",this.destroy,this),this._removeEscapeKey()},close:function(){this.destroy()},destroy:function(){this.removeEvents(),this._container.innerHTML="",Wu.DomUtil.remove(this._container);var a=this.options.closeCallback;return a&&a(),!1},_addEscapeKey:function(){keymaster("esc",this.destroy.bind(this))},_removeEscapeKey:function(){keymaster.unbind&&keymaster.unbind("esc")}}),Wu.Chrome=Wu.Class.extend({initialize:function(a){Wu.setOptions(this,a),this._listen(),this._initialize()},_listen:function(){Wu.Mixin.Events.on("projectSelected",this._projectSelected,this),Wu.Mixin.Events.on("projectDeleted",this._onProjectDeleted,this),Wu.Mixin.Events.on("editEnabled",this._editEnabled,this),Wu.Mixin.Events.on("editDisabled",this._editDisabled,this),Wu.Mixin.Events.on("layerEnabled",this._layerEnabled,this),Wu.Mixin.Events.on("layerDisabled",this._layerDisabled,this),Wu.Mixin.Events.on("fileImported",this._onFileImported,this),Wu.Mixin.Events.on("fileDeleted",this._onFileDeleted,this),Wu.Mixin.Events.on("layerAdded",this._onLayerAdded,this),Wu.Mixin.Events.on("layerEdited",this._onLayerEdited,this),Wu.Mixin.Events.on("layerDeleted",this._onLayerDeleted,this),Wu.Mixin.Events.on("closeMenuTabs",this._onCloseMenuTabs,this),Wu.Mixin.Events.on("fileProcessing",this._onFileProcessing,this),Wu.Mixin.Events.on("processingProgress",this._onProcessingProgress,this)},_projectSelected:function(a){a.detail.projectUuid&&(this._project=app.activeProject=app.Projects[a.detail.projectUuid],this._refresh())},updateMapSize:function(){var a=app.Chrome.Right,b=app.Chrome.Left,c=0,d=app._appPane.offsetWidth;if(a&&b){b._isOpen&&!a._isOpen&&(c+=b.options.defaultWidth,d-=b.options.defaultWidth),!b._isOpen&&a._isOpen&&(d-=a.options.defaultWidth,c+=a.options.defaultWidth),b._isOpen||a._isOpen||(d=app._appPane.offsetWidth,c=0);app._map.getContainer();app._map._controlCorners.topleft.style.left=c+"px",app._map._controlCorners.bottomleft.style.left=c+"px"}},_initialize:function(){},_initContainer:function(){},_editEnabled:function(){},_editDisabled:function(){},_layerEnabled:function(){},_layerDisabled:function(){},_updateView:function(){},_refresh:function(){},_onFileImported:function(){},_onFileDeleted:function(){},_onLayerAdded:function(){},_onLayerEdited:function(){},_onLayerDeleted:function(){},_onProjectDeleted:function(){},_onCloseMenuTabs:function(){},_onFileProcessing:function(){},_onProcessingProgress:function(){}}),Wu.Chrome.Top=Wu.Chrome.extend({_:"topchrome",_initialize:function(a){this.initContainer(),this.addHooks()},initContainer:function(){this._container=Wu.DomUtil.create("div","chrome chrome-container chrome-top",app._appPane),this._menuButton=Wu.DomUtil.create("div","chrome-menu-button active",this._container),this._menuButton.innerHTML='<i class="top-button fa fa-bars"></i>',this._projectTitleContainer=Wu.DomUtil.create("div","chrome-project-title-container",this._container),this._buttonWrapper=Wu.DomUtil.create("div","chrome-buttons",this._container),this._projectTitle=Wu.DomUtil.create("div","chrome-button chrome-project-title",this._buttonWrapper);var a=app.options.logos.clientLogo.image;a&&(this._clientLogo=Wu.DomUtil.create("div","chrome-button chrome-client-logo",this._buttonWrapper),this._clientLogo.style.backgroundImage="url("+app.options.servers.portal+a+")",this._clientLogo.style.backgroundSize=app.options.logos.clientLogo.size,this._clientLogo.style.backgroundPosition=app.options.logos.clientLogo.position,this._clientLogo.style.backgroundColor=app.options.logos.clientLogo.backgroundColor),this.initDefault()},_registerButton:function(a){var b=a.className,c=a.trigger,d=a.name,e=a.context,f=a.project_dependent;f&&(b+=" displayNone"),this._buttons=this._buttons||{};var g=Wu.DomUtil.create("div",b),h=app.options.logos.clientLogo.image?this._buttonWrapper.lastChild.previousSibling:this._buttonWrapper.lastChild;return this._buttonWrapper.insertBefore(g,h),this._buttons[d]={div:g,options:a},Wu.DomEvent.on(g,"click",c,e),g},_updateButtonVisibility:function(){if(app.activeProject){var a=_.filter(this._buttons,function(a){return a.options.project_dependent});a.forEach(function(a){Wu.DomUtil.removeClass(a.div,"displayNone")})}else{var a=_.filter(this._buttons,function(a){return a.options.project_dependent});a.forEach(function(a){Wu.DomUtil.addClass(a.div,"displayNone")})}},initDefault:function(){this._setPortalLogo(),this.initCPUclock(this._container)},initCPUclock:function(a){this._CPUwrapper=Wu.DomUtil.create("div","cpu-wrapper",a),this._CPUbars=[];for(var b=0;10>b;b++)this._CPUbars[b]=Wu.DomUtil.create("div","cpu-bar",this._CPUwrapper)},updateCPUclock:function(a){var b=app.activeProject;b&&b.isEditable()?this._CPUwrapper.style.display="block":this._CPUwrapper.style.display="none";for(var c=parseInt(a),d=Math.round(c/10),e=0;10>e;e++){var f=9-e;e>=d?Wu.DomUtil.removeClass(this._CPUbars[f],"cpu-on"):Wu.DomUtil.addClass(this._CPUbars[f],"cpu-on")}},_setHooks:function(a){Wu.DomEvent[a](this._menuButton,"click",this._toggleLeftPane,this)},addHooks:function(){this._setHooks("on")},removeHooks:function(){this._setHooks("off")},_projectSelected:function(a){this._updateButtonVisibility();var b=a.detail.projectUuid;b&&(this._project=app.activeProject=app.Projects[b],this._refresh())},_refresh:function(){this._setProjectTitle(),this._showHideLayerButton(),this.__layerMenu=app.MapPane.getControls().layermenu,setTimeout(function(){this.__layerMenu._open&&this._openLayerMenu()}.bind(this),50)},_showHideLayerButton:function(){},_setProjectTitle:function(){this._projectTitleName=this._project.getHeaderTitle(),this._projectTitle.innerHTML=this._projectTitleName.camelize()},_setPortalLogo:function(){},_toggleLeftPane:function(a){Wu.DomEvent.stop(a),this._leftPaneisOpen?this.closeLeftPane():this.openLeftPane()},openLeftPane:function(){Wu.Mixin.Events.fire("closeMenuTabs"),this._leftPaneisOpen=!0,Wu.DomUtil.addClass(this._menuButton,"active"),app.Chrome.Left.open()},closeLeftPane:function(){this._leftPaneisOpen=!1,Wu.DomUtil.removeClass(this._menuButton,"active"),app.Chrome.Left.close()},_addAutoCloseTriggers:function(){Wu.DomEvent.on(app.MapPane._container,"click",this.closeLeftPane,this),Wu.DomEvent.on(this._container,"click",this.closeLeftPane,this)},_removeAutoCloseTriggers:function(){Wu.DomEvent.off(app.MapPane._container,"click",this.closeLeftPane,this),Wu.DomEvent.on(this._container,"click",this.closeLeftPane,this)},setContentHeights:function(){var a=app.SidePane.Clients,b=app.SidePane.Options;a&&a.setContentHeight(),b&&b.setContentHeight()},_toggleLayermenu:function(){app.Tools.DataLibrary._isOpen||(this._layerMenuOpen?this._closeLayerMenu():this._openLayerMenu())},_openLayerMenu:function(){this._layerMenuOpen=!0,this.__layerMenu.openLayerPane()},_closeLayerMenu:function(){this._layerMenuOpen=!1,this.__layerMenu.closeLayerPane()},_onCloseMenuTabs:function(){this.closeLeftPane()}}),Wu.Chrome.Bottom=Wu.Chrome.extend({_:"bottomchrome",_initialize:function(a){this.initContainer(),this.addHooks()},initContainer:function(){this._container=Wu.DomUtil.create("div","chrome chrome-container chrome-bottom",app._appPane)},addHooks:function(){}}),Wu.Chrome.Left=Wu.Chrome.extend({_:"leftchrome",options:{defaultWidth:282,tabs:{projects:!0,users:!0}},_initialize:function(a){this.initContainer(),this._addEvents()},initContainer:function(){this._container=Wu.DomUtil.create("div","chrome chrome-container chrome-left",app._appPane),this._outerScroller=Wu.DomUtil.create("div","chrome-left-outer-scroller",this._container),this._innerScroller=Wu.DomUtil.create("div","chrome-left-inner-scroller",this._outerScroller),this._tabs={},this.options.tabs.projects&&(this._tabs.projects=new Wu.Chrome.Projects({appendTo:this._innerScroller,chrome:this})),this.options.tabs.users&&(this._tabs.users=new Wu.Chrome.Users({appendTo:this._innerScroller,chrome:this})),this.close(!0)},_addEvents:function(){},open:function(){this._isOpen||(this._isOpen=!0,this._container.style.width=this.options.defaultWidth+"px",this._container.style.display="block",this.updateMapSize())},close:function(a){(this._isOpen||a)&&(this._isOpen=!1,this._container.style.width="0",this._container.style.display="none",this.updateMapSize())},_onCloseMenuTabs:function(){this.close()},getDimensions:function(){var a={width:this.options.defaultWidth,height:this._container.offsetHeight};return a}}),Wu.Chrome.Right=Wu.Chrome.extend({_:"rightchrome",options:{defaultWidth:443,editingLayer:!1,tabs:{settings:!0,data:!0}},_initialize:function(){this.initContainer(),this._addEvents()},initContainer:function(){this._container=Wu.DomUtil.create("div","chrome chrome-container chrome-right",app._appPane),this._tabs={},this.options.tabs.data&&(this._tabs.data=new Wu.Chrome.Data({appendTo:this._container,chrome:this})),this.options.tabs.settings&&(this._tabs.settings=new Wu.Chrome.SettingsContent.SettingsSelector({appendTo:this._container,chrome:this}))},_addEvents:function(){Wu.DomEvent.on(window,"resize",_.throttle(this._onWindowResize,1e3),this)},_removeEvents:function(){Wu.DomEvent.off(window,"resize",this._onWindowResize,this)},_onWindowResize:function(){app._map&&app._map.invalidateSize()},getDimensions:function(){var a={width:this.options.defaultWidth,height:this._container.offsetHeight};return a},_forEachTab:function(a){for(var b in this._tabs){var c=this._tabs[b];a(c)}},open:function(a){Wu.Mixin.Events.fire("closeMenuTabs"),this._forEachTab(function(a){a._hide(),a.onClosed()}),a._show(),a.onOpened(),this._isOpen||(this._isOpen=!0,this._currentTab=a,this._container.style.width=this.options.defaultWidth+"px",this._container.style.display="block",this._container.style.height="100%",this.updateMapSize())},close:function(a){var a=a||this._currentTab;a&&a._hide&&a._hide(),a&&a.onClosed&&a.onClosed(),this._isOpen&&(this._isOpen=!1,this._container.style.width="0",this._container.style.display="none",this.updateMapSize())},_onCloseMenuTabs:function(){this.close()}}),Wu.Chrome.Data=Wu.Chrome.extend({_:"data",options:{defaultWidth:400},newLayer:!1,_initialize:function(){this._initContainer(),this._initContent(),this._registerButton(),this._hide(),app.Tools=app.Tools||{},app.Tools.DataLibrary=this},_onLayerAdded:function(a){var b=a.detail.layerUuid;this.newLayer=b;var c=this._project.getLayer(b),d=JSON.parse(c.store.metadata),e=app.Tools.Tooltip._buildTooltipMeta(d);c.setTooltip(e),this._refresh()},_onFileDeleted:function(){this._refresh()},_onLayerDeleted:function(){this._refresh()},_onLayerEdited:function(){this._refresh()},_initContainer:function(){this._container=Wu.DomUtil.create("div","chrome chrome-content data",this.options.appendTo),this._innerContainer=Wu.DomUtil.create("div","chrome-data-inner",this._container),this._listOuterScroller=Wu.DomUtil.create("div","chrome-data-outer-scroller",this._innerContainer),this._listOuterScroller.style.height="100%",this._listContainer=Wu.DomUtil.create("div","chrome-data-scroller",this._listOuterScroller),this._initLayerListContainer(),this._initFileListContainer(),this.topContainer=Wu.DomUtil.create("div","chrome-data-top",this._container),Wu.DomEvent.on(this._innerContainer,"click",this._closeActionPopUps,this)},_initLayerListContainer:function(){this._layerListWrapper=Wu.DomUtil.create("div","chrome-layer-list-wrapper",this._listContainer),this._layerListTitle=Wu.DomUtil.create("div","chrome-content-header layer-list-container-title",this._layerListWrapper,"Layers"),this._layersContainer=Wu.DomUtil.create("div","layers-container",this._layerListWrapper),this._baseLayers=Wu.DomUtil.create("div","chrome-content-header layer-list-container-title",this._layerListWrapper,"Background layer"),this._baseLayerDropdownContainer=Wu.DomUtil.create("div","base-layer-dropdown-container",this._layerListWrapper),this._fileListSeparator=Wu.DomUtil.create("div","file-list-separator",this._layerListWrapper)},_initFileListContainer:function(){this._fileListTitle=Wu.DomUtil.create("div","chrome-content-header layer-list-container-title",this._listContainer,"My Data"),this._uploadButtonContainer=Wu.DomUtil.create("div","upload-button-container",this._listContainer),this._filesContainer=Wu.DomUtil.create("div","files-container",this._listContainer)},_initContent:function(){this._addEvents()},_registerButton:function(){var a=app.Chrome.Top;this._topButton=a._registerButton({name:"data",className:"chrome-button datalib",trigger:this._togglePane,context:this,project_dependent:!0}),this._topButton.innerHTML='<i class="top-button fa fa-cloud"></i>Data'},_togglePane:function(){var a=this.options.chrome;this._isOpen?a.close(this):a.open(this),this._isOpen&&app.Socket.sendUserEvent({user:app.Account.getFullName(),event:"opened",description:"the data library",timestamp:Date.now()})},_show:function(){app.MapPane._controls.layermenu.open(),Wu.DomUtil.addClass(this._topButton,"active"),this._container.style.display="block",this._isOpen=!0;var a=app.MapPane.getControls().layermenu;this._project.isEditable()&&a.enableEditSwitch(),a._layerMenuOpen||app.Chrome.Top._openLayerMenu()},_hide:function(){if(Wu.DomUtil.removeClass(this._topButton,"active"),this._container.style.display="none",this._isOpen){var a=app.MapPane.getControls().layermenu;a&&a.disableEditSwitch()}this._isOpen=!1},onOpened:function(){},onClosed:function(){},_addEvents:function(){},_removeEvents:function(){},_onWindowResize:function(){},getDimensions:function(){var a={width:this.options.defaultWidth,height:this._container.offsetHeight};return a},_onFileImported:function(a){this._refresh();var b=a.detail.file;b._createLayer(this._project)},_refresh:function(){if(this._project){this._layersContainer&&(this._layersContainer.innerHTML=""),this._filesContainer&&(this._filesContainer.innerHTML=""),this._project.isEditable()&&(this._initLayerList(),this._refreshLayers(),this._refreshBaseLayerList()),this._refreshBaseLayerList(),this._initFileLists(),this._refreshFiles(),this._initUploadButton();var a=this._project.getTitle();this._layerListTitle.innerHTML="Layers for "+a,this._project.isEditable()?Wu.DomUtil.removeClass(this._layerListWrapper,"displayNone"):Wu.DomUtil.addClass(this._layerListWrapper,"displayNone")}},_initUploadButton:function(){this.uploadButton||(this.uploadButton=app.Data.getUploadButton("chrome-upload-button",this._uploadButtonContainer),this.uploadButton.innerHTML='<i class="fa fa-cloud-upload"></i>Upload data')},_closeActionPopUps:function(a){var b=a.target.classList,c=!1;b.forEach&&b.forEach(function(a){"file-action"==a&&(c=!0),"file-popup-trigger"==a&&(c=!0),"file-popup"==a&&(c=!0),"toggle-button"==a&&(c=!0)}),a.target.name==this.editingFileName&&(c=!0),a.target.name==this.editingLayerName&&(c=!0),c||(this.showFileActionFor=!1,this.selectedFiles=[],this.showLayerActionFor=!1,this.selectedLayers=[],this._refreshFiles(),this._refreshLayers())},_initFileLists:function(){this.fileListContainers={},this.selectedFiles=[],this.showFileActionFor=!1,this.editingFileName=!1,this.fileProviders={},this.fileProviders.postgis={name:"Data Library",data:[],getFiles:function(){return app.Account.getFiles()}};for(var a in this.fileProviders)this.fileListContainers[a]={},this.fileListContainers[a].wrapper=Wu.DomUtil.create("div","file-list-container",this._filesContainer),this.fileListContainers[a].fileList=Wu.DomUtil.create("div","file-list-container-file-list",this.fileListContainers[a].wrapper),this.fileListContainers[a].D3container=d3.select(this.fileListContainers[a].fileList)},_refreshFiles:function(){for(var a in this.fileProviders){var b=this.fileProviders[a],c=b.getFiles();b.data=_.sortBy(_.toArray(c),function(a){return a.store.lastUpdated}).reverse();var d=this.fileListContainers[a].D3container,e=this.fileProviders[a].data;this.initFileList(d,e,a)}},_onFileProcessing:function(a){var b=a.detail.file,c=b.uniqueIdentifier,d=b.fileName,e=(parseInt(b.size/1e3/1e3)+"MB",Wu.DomUtil.create("div","data-list-line processing")),f=(Wu.DomUtil.create("div","file-name-content processing",e,d),Wu.DomUtil.create("div","file-feedback processing",e)),g=Wu.DomUtil.create("div","file-feedback-percent processing",e);this._tempFiles=this._tempFiles||{},this._tempFiles[c]={feedback:f,percent:g,file:b};var h=this.fileListContainers.postgis.fileList;h.insertBefore(e,h.firstChild)},_onProcessingProgress:function(a){var b=a.detail,c=(b.error,b.percent),d=b.text,e=b.uniqueIdentifier,f=this._tempFiles[e];f.feedback.innerHTML=d,f.percent.innerHTML=c+"% done"},initFileList:function(a,b,c){var d=a.selectAll(".data-list-line").data(b);d.enter().append("div").classed("data-list-line",!0),d.classed("file-selected",function(a){var b=a.getUuid();return b==this.showFileActionFor?!0:!1}.bind(this)),d.classed("editingFileName",function(a){var b=a.getUuid();return this.editingFileName==b?!0:!1}.bind(this)),d.exit().remove(),this.createFileNameContent(d,c),this.createFileMetaContent(d,c),this.createFilePopUpTrigger(d,c),this.createFileActionPopUp(d,c)},createFileMetaContent:function(a,b){var c=a.selectAll(".file-meta-content").data(function(a){return[a]});c.enter().append("div").classed("file-meta-content",!0),c.html(function(a){var b="",c=a.getCreatedBy(),d=app.Users[c].getFullName();b+='<span class="file-meta-author">'+d+"</span>";var e=moment(a.getCreated()).format("DD MMMM YYYY");b+='<span class="file-meta-date">'+e+"</span>";var f=a.getStore().dataSize,g=Wu.Util.bytesToSize(f);return b+=' – <span class="file-meta-size">'+g+"</span>"}.bind(this)),c.exit().remove()},createFileNameContent:function(a,b){var c=a.selectAll(".file-name-content").data(function(a){return[a]});c.enter().append("div").classed("file-name-content",!0),c.html(function(a){return a.getTitle()}.bind(this)).on("dblclick",function(a){this.activateFileInput(a,b)}.bind(this)),c.exit().remove(),this.createFileInputField(c,b)},createFileInputField:function(a,b){var c=this,d=a.selectAll(".file-name-input").data(function(a){var b=a.getUuid();return this.editingFileName==b?[a]:!1}.bind(this));d.enter().append("input").attr("type","text").classed("file-name-input",!0),d.attr("placeholder",function(a){return"layers"==b?a.getTitle():a.getName()}).attr("name",function(a){return a.getUuid()}).html(function(a){return"layers"==b?a.getTitle():a.getName()}).classed("displayNone",function(a){var b=a.getUuid();return c.editingFileName==b?!1:!0}).on("blur",function(a){var d=this.value;c.saveFileName(d,a,b)}).on("keydown",function(a){var b=window.event.keyCode;this.value;13==b&&this.blur()}),d.exit().remove(),d&&d.forEach(function(a){return a[0]?void a[0].select():void 0})},createFilePopUpTrigger:function(a,b){var c=a.selectAll(".file-popup-trigger").data(function(a){return[a]});c.enter().append("div").classed("file-popup-trigger",!0),c.classed("active",function(a){var b=a.getUuid();return b==this.showFileActionFor?!0:!1}.bind(this)).on("click",function(a){var b=a.getUuid();this.enableFilePopUp(b)}.bind(this)),c.exit().remove()},createFileActionPopUp:function(a,b){var c=a.selectAll(".file-popup").data(function(a){return[a]});c.enter().append("div").classed("file-popup",!0),c.classed("displayNone",function(a){var b=a.getUuid();return b==this.showFileActionFor?!1:!0}.bind(this)),c.exit().remove(),this.initFileActions(c,b)},initFileActions:function(a,b){var c=this._project.isEditor(),d=(this._project.isDownloadable(),this),e={createLayer:{name:"Add To Project",disabled:!c},share:{name:"Share with...",disabled:!0},changeName:{name:"Change Name",disabled:!0},download:{name:"Download",disabled:!1},"delete":{name:"Delete",disabled:!1}};for(var f in e){var g=e[f].name,h="file-action-"+f,i=a.selectAll("."+h).data(function(a){return[a]});i.enter().append("div").classed(h,!0).classed("file-action",!0).classed("displayNone",e[f].disabled).attr("trigger",f).html(g).on("click",function(a){var c=this.getAttribute("trigger");d.fileActionTriggered(c,a,d,b)}),i.exit().remove()}},fileActionTriggered:function(a,b,c,d){return this._fileActionTriggered(a,b,c,d)},_fileActionTriggered:function(a,b,c,d){var e=b.getUuid(),f=c._project;"changeName"==a&&(c.editingFileName=e),"createLayer"==a&&b._createLayer(f),"share"==a&&b._shareFile(),"download"==a&&b._downloadFile(),"delete"==a&&b._deleteFile(),this.showFileActionFor=!1,this.selectedFiles=[],this._refreshFiles()},activateFileInput:function(a,b){this.editingFileName=a.getUuid(),this.showFileActionFor=!1,this.selectedFiles=[],this._refreshFiles()},enableFilePopUp:function(a){return this.showFileActionFor==a?(this.showFileActionFor=!1,this.selectedFiles=[],void this._refreshFiles()):(this.showFileActionFor=a,this.selectedFiles=a,void this._refreshFiles())},saveFileName:function(a,b,c){a&&""!=a||(a=b.getName()),b.setName(a),this.editingFileName=!1,this._refreshFiles()},_initLayerList:function(){this.layerListContainers={},this.selectedLayers=[],this.showLayerActionFor=!1,this.editingLayerName=!1,this.layerProviders={};var a=this.sortedLayers=this.sortLayers(this._project.layers);a.forEach(function(a){var b=a.key;if("postgis"==b||"raster"==b){var c=a.layers;if(c.length<=0)return this.createNoLayers();this.layerProviders[b]={name:b,layers:c},this.layerListContainers[b]={},this.layerListContainers[b].wrapper=Wu.DomUtil.create("div","layer-list-container",this._layersContainer),this.layerListContainers[b].layerList=Wu.DomUtil.create("div","layer-list-container-layer-list",this.layerListContainers[b].wrapper),this.layerListContainers[b].D3container=d3.select(this.layerListContainers[b].layerList)}}.bind(this))},createNoLayers:function(){},_refreshLayers:function(){for(var a in this.layerProviders){var b=this.layerProviders[a],c=b.layers;b.data=_.toArray(c);var d=this.layerListContainers[a].D3container,e=this.layerProviders[a].data;this.initLayerList(d,e,a)}},sortLayers:function(a){var b=["postgis","raster","google","norkart","geojson","mapbox"],c=[];return b.forEach(function(b){var d={key:b,layers:[]};for(var e in a){var f=a[e];f&&f.store&&f.store.data.hasOwnProperty(b)&&d.layers.push(f)}c.push(d)},this),this.numberOfProviders=c.length,c},_initBaseLayerList:function(){this._initLayout_activeLayers(!1,!1,this._baseLayerDropdownContainer,!1)},_refreshBaseLayerList:function(){this._baseLayerDropdownContainer.innerHTML="",this._project.isEditable()&&this._initLayout_activeLayers(!1,!1,this._baseLayerDropdownContainer,!1)},_initLayout_activeLayers:function(a,b,c,d){var e=this._activeLayersWrap=Wu.DomUtil.create("div","baselayer-dropdown-wrapper",c),f=Wu.DomUtil.create("div","chrome chrome-content active-layer select-wrap",e),g=this._select=Wu.DomUtil.create("select","active-layer-select",f);return this.sortedLayers.forEach(function(a){"postgis"!=a.key&&a.layers.forEach(function(b){var c=Wu.DomUtil.create("option","active-layer-option",g),d=b.getUuid();c.value=d;var e=this.isBaseLayerOn(d);e&&(c.selected=!0),c.innerHTML=b.getTitle()+" ("+a.key+")"}.bind(this))}.bind(this)),Wu.DomEvent.on(g,"change",this._selectedActiveLayer,this),g},_selectedActiveLayer:function(a){var b=this._project.getBaselayers(),c=_.isArray(b)?b:[b];c.forEach(function(a){var b=a.uuid,c=this._project.getLayer(b);c.disable()}.bind(this));var d=a.target.value,e=this._project.getLayer(d);e._addTo("baselayer"),this._project.setBaseLayer([{uuid:d,zIndex:1,opacity:1}])},initLayerList:function(a,b,c){var d=a.selectAll(".data-list-line").data(b);d.enter().append("div").classed("data-list-line",!0),d.classed("file-selected",function(a){var b=a.getUuid(),c=this.selectedLayers.indexOf(b);return c>-1?!0:b==this.showLayerActionFor?!0:!1}.bind(this)).classed("new-layer-list-item",function(a){var b=a.getUuid();return this.newLayer==b?!0:!1}.bind(this)).classed("editingName",function(a){var b=a.getUuid();return this.editingLayerName==b?!0:!1}.bind(this)),d.exit().remove(),this.createLayerToggleSwitch(d,c),this.createRadioButton(d,c),this.createLayerNameContent(d,c),this.createLayerPopUpTrigger(d,c),this.createLayerActionPopUp(d,c)},createRadioButton:function(a,b){var c=a.selectAll(".layer-on-radio-button-container").data(function(a){return[a]});c.enter().append("div").classed("layer-on-radio-button-container layer-radio",!0).on("click",function(a){this._toggleRadio(a)}.bind(this)),c.classed("displayNone",function(a){var b=a.getUuid(),c=this.isLayerOn(b);return!c}.bind(this)).classed("radio-on",function(a){var b=a.getUuid(),c=_.find(this._project.store.layermenu,function(a){return a.layer==b}),d=c&&c.enabled;return d}.bind(this)),c.exit().remove()},_toggleRadio:function(a){var b=a.getUuid(),c=_.find(this._project.store.layermenu,function(a){return a.layer==b}),d=c&&c.enabled;d?this.radioOff(b):this.radioOn(b)},radioOn:function(a){var b=app.MapPane.getControls().layermenu;b._setEnabledOnInit(a,!0)},radioOff:function(a){var b=app.MapPane.getControls().layermenu;b._setEnabledOnInit(a,!1)},createLayerToggleSwitch:function(a,b){var c=a.selectAll(".chrome-switch-container").data(function(a){return[a]});c.enter().append("div").classed("chrome-switch-container",!0),c.classed("switch-on",function(a){var b=a.getUuid(),c=this.isLayerOn(b);return c}.bind(this)),c.on("click",function(a){this.toggleLayer(a)}.bind(this)),c.exit().remove()},toggleLayer:function(a){var b=a.getUuid(),c=this.isLayerOn(b);c?this.removeLayer(a):this.addLayer(a),this._refreshLayers()},addLayer:function(a){var b=app.MapPane.getControls().layermenu;b.add(a)},removeLayer:function(a){var b=a.getUuid(),c=app.MapPane.getControls().layermenu;c._remove(b)},isLayerOn:function(a){var b=!1;return this._project.store.layermenu.forEach(function(c){a==c.layer&&(b=!0)},this),b},isBaseLayerOn:function(a){var b=!1;return this._project.store.baseLayers.forEach(function(c){a==c.uuid&&(b=!0)}.bind(this)),b},createLayerNameContent:function(a,b){var c=a.selectAll(".layer-name-content").data(function(a){return[a]});c.enter().append("div").classed("layer-name-content",!0),c.html(function(a){return a.getTitle()}.bind(this)).on("dblclick",function(a){"postgis"==b&&this.activateLayerInput(a,b)}.bind(this)),c.exit().remove(),this.createLayerInputField(c,b)},createLayerInputField:function(a,b){var c=this,d=a.selectAll(".layer-name-input").data(function(a){var b=a.getUuid();return this.editingLayerName==b?[a]:!1}.bind(this));d.enter().append("input").attr("type","text").classed("layer-name-input",!0),d.attr("placeholder",function(a){return a.getTitle()}).attr("name",function(a){return a.getUuid()}).html(function(a){return a.getTitle()}).classed("displayNone",function(a){var b=a.getUuid();return c.editingLayerName==b?!1:!0}).on("blur",function(a){var d=this.value;c.saveLayerName(d,a,b)}).on("keydown",function(a){var b=window.event.keyCode;this.value;13==b&&this.blur()}),d.exit().remove(),d&&d.forEach(function(a){return a[0]?void a[0].select():void 0})},createLayerPopUpTrigger:function(a,b){if("postgis"==b){var c=a.selectAll(".file-popup-trigger").data(function(a){return[a]});c.enter().append("div").classed("file-popup-trigger",!0),c.classed("active",function(a){var b=a.getUuid();return b==this.showLayerActionFor?!0:!1}.bind(this)).on("click",function(a){var b=a.getUuid();this.enableLayerPopup(b)}.bind(this)),c.exit().remove()}},createLayerActionPopUp:function(a,b){var c=a.selectAll(".file-popup").data(function(a){return[a]});c.enter().append("div").classed("file-popup",!0),c.classed("displayNone",function(a){var b=a.getUuid();return b==this.showLayerActionFor?!1:!0}.bind(this)),c.exit().remove(),this.initLayerActions(c,b)},initLayerActions:function(a,b){var c=this._project.isEditable(),d=this._project.isDownloadable(),e=this,f={
share:{name:"Share with...",disabled:!1},style:{name:"Style Layer",disabled:!c},changeName:{name:"Change Name",disabled:!c},download:{name:"Download",disabled:!d},"delete":{name:"Delete",disabled:!c}};for(var g in f){var h=f[g].name,i="file-action-"+g,j=a.selectAll("."+i).data(function(a){return[a]});j.enter().append("div").classed(i,!0).classed("file-action",!0).classed("displayNone",f[g].disabled).attr("trigger",g).html(h).on("click",function(a){var c=this.getAttribute("trigger");e.layerActionTriggered(c,a,e,b)}),j.exit().remove()}},layerActionTriggered:function(a,b,c,d){return this._layerActionTriggered(a,b,c,d)},_layerActionTriggered:function(a,b,c,d){"changeName"==a&&(c.editingLayerName=b.getUuid()),"share"==a&&b.shareLayer(),"download"==a&&b.downloadLayer(),"delete"==a&&b.deleteLayer(),"style"==a&&this.styleLayer(b),this.showLayerActionFor=!1,this.selectedLayers=[],this._refreshLayers()},styleLayer:function(a){var b=a.getUuid();this._togglePane(),app.Tools.Styler._storeActiveLayerUuid(b),app.Tools.SettingsSelector._togglePane()},activateLayerInput:function(a,b){this.editingLayerName=a.getUuid(),this.showLayerActionFor=!1,this.selectedLayers=[],this._refreshLayers()},enableLayerPopup:function(a){return this.showLayerActionFor==a?(this.showLayerActionFor=!1,this.selectedLayers=[],void this._refreshLayers()):(this.showLayerActionFor=a,this.selectedLayers=a,void this._refreshLayers())},saveLayerName:function(a,b,c){a&&""!=a||(a=b.getTitle()),b.setTitle(a),this.editingLayerName=!1,Wu.Mixin.Events.fire("layerEdited",{detail:{layer:b}})}}),Wu.Chrome.Projects=Wu.Chrome.extend({_:"projects",options:{defaultWidth:283,publicTooltipWidth:55,defaultAccess:{read:[],edit:[],options:{share:!0,download:!0,isPublic:!0}},labels:{private_project:"Only invited users can access project",public_project:"Anyone with a link can access project",download_on:"Allowed to download data",download_off:"Not allowed to download data",share_on:"Allowed to invite others (as spectators)",share_off:"Not allowed to invite others"}},_initialize:function(){this._initContainer(),this._initContent()},_initContainer:function(){this._container=Wu.DomUtil.create("div","chrome-left-section chrome-projects",this.options.appendTo)},_initContent:function(){var a=this._projectsContainer=Wu.DomUtil.create("div","chrome-left-container",this._container),b='Projects <span style="font-weight:400; font-size: 16px; color: gainsboro">('+_.size(app.Projects)+")</span> ",c=(Wu.DomUtil.create("div","chrome-left-title projects-title",a,b),Wu.DomUtil.create("div","chrome-left-new-button",a,"+"));Wu.DomEvent.on(c,"click",this._openNewProjectFullscreen,this),this._projects={};var d=_.sortBy(_.toArray(app.Projects),function(a){return a.getName().toLowerCase()}),e=Wu.DomUtil.create("div","chrome-left-project-wrapper",a);_.each(d,function(a){var a=app.Projects[a.getUuid()],b=Wu.DomUtil.create("div","chrome-left-itemcontainer chrome-project",e),c=Wu.DomUtil.create("div","chrome-left-item-name",b);if(a.isEditable()){var d=Wu.DomUtil.create("div","chrome-left-popup-trigger",b);Wu.DomEvent.on(d,"click",this._openEditProjectFullscreen.bind(this,a),this),Wu.DomUtil.addClass(c,"extra-padding-right")}var f="";if(a.store.createdBy!=app.Account.getUuid()){var g=a.store.createdByName,h="Shared with you by "+g,i=7*h.length+"px";f+='<i class="project-icon fa fa-arrow-circle-right"><div class="absolute"><div class="project-tooltip" style="width:'+i+'">'+h+"</div></div></i>"}if(f+=a.getName(),a.isPublic()){var h="Public",j=this.options.publicTooltipWidth+"px";f+='<i class="project-public-icon fa fa-globe"><div class="absolute"><div class="project-tooltip" style="width:'+j+'">'+h+"</div></div></i>"}c.innerHTML=f,Wu.DomEvent.on(b,"click",function(){a.selectProject()},a),this._projects[a.getUuid()]={wrapper:b,trigger:d}},this)},_refreshContent:function(){this._projectsContainer.innerHTML="",Wu.DomUtil.remove(this._projectsContainer),this._initContent()},_openNewProjectFullscreen:function(a){Wu.DomEvent.stop(a),this._fullscreen=new Wu.Fullscreen({title:'<span style="font-weight:200;">Create New Project</span>'}),this._resetAccess();var b=this._fullscreen._content,c=Wu.DomUtil.create("div","private-public-label smooth-fullscreen-sub-label");new Wu.button({id:"public-switch",type:"switch",isOn:this._access.options.isPublic,right:!1,disabled:!1,appendTo:b,fn:this._togglePrivatePublic.bind(this,c),className:"public-private-project-switch"});b.appendChild(c),c.innerHTML=this._access.options.isPublic?this.options.labels.public_project:this.options.labels.private_project;var d=(Wu.DomUtil.create("div","smooth-fullscreen-name-label clearboth",b,"Project name"),Wu.DomUtil.create("input","smooth-input",b));d.setAttribute("placeholder","Enter name here");var e=Wu.DomUtil.create("div","smooth-fullscreen-error-label",b),f=Wu.DomUtil.create("div","toggles-wrapper",b);this._createInviteUsersInput({type:"read",label:'Invite spectators to project <span class="optional-medium">(optional)</span>',content:f,container:this._fullscreen._inner,sublabel:"Spectators have read-only access to the project"});var g=Wu.DomUtil.create("div","toggle-wrapper",f),h=Wu.DomUtil.create("div","small-toggle-label smooth-fullscreen-sub-label");new Wu.button({id:"share-switch",type:"switch",isOn:!0,right:!1,disabled:!1,appendTo:g,fn:this._toggleShare.bind(this,h),className:"share-project-switch"});g.appendChild(h),h.innerHTML=this.options.labels.share_on;var i=Wu.DomUtil.create("div","toggle-wrapper",f),j=Wu.DomUtil.create("div","small-toggle-label smooth-fullscreen-sub-label");new Wu.button({id:"share-switch",type:"switch",isOn:!0,right:!1,disabled:!1,appendTo:i,fn:this._toggleDownload.bind(this,j),className:"download-project-switch"});i.appendChild(j),j.innerHTML=this.options.labels.download_on;var f=Wu.DomUtil.create("div","toggles-wrapper",b);this._createInviteUsersInput({type:"edit",label:'Invite editors to project <span class="optional-medium">(optional)</span>',content:f,container:this._fullscreen._inner,sublabel:"Editors can edit the project"});var k=Wu.DomUtil.create("div","smooth-fullscreen-save",b,"Create"),l={name_input:d,name_error:e};Wu.DomEvent.on(k,"click",this._createProject.bind(this,l),this)},openShare:function(){var a=app.activeProject;return a.isEditable()?this._openEditProjectFullscreen():void(a.isShareable()&&a.isShareable()&&this._openShare())},_openShare:function(){var a=app.activeProject;this._fullscreen=new Wu.Fullscreen({title:'<span style="font-weight:200;">Invite to</span> '+a.getName(),closeCallback:this._resetAccess.bind(this)}),this._resetAccess();var b=this._fullscreen._content,c=Wu.DomUtil.create("div","toggles-wrapper",b);this._createInviteUsersInput({type:"read",label:"Invite spectators to project",content:c,container:this._fullscreen._inner,sublabel:"Spectators have read-only access to the project",project:a,empty:!0});var d=Wu.DomUtil.create("div","invite-someone-wrapper",b),e=(Wu.DomUtil.create("div","smooth-fullscreen-name-label add-message",d,'Want to invite someone else? Send them <a id="invite_someone_btn">an invite!</a>'),Wu.DomUtil.get("invite_someone_btn"));Wu.DomEvent.on(e,"click",function(a){this._fullscreen.close();var b=app.Chrome.Left._tabs.users;b._openInvite()},this);var f={project:a},g=Wu.DomUtil.create("div","smooth-fullscreen-buttons-wrapper",b),h=Wu.DomUtil.create("div","smooth-fullscreen-save",g,"Invite");Wu.DomEvent.on(h,"click",this._addInvites.bind(this,f),this)},_addInvites:function(a){var b={read:[]};this._access.read.forEach(function(a){b.read.push(a.user.getUuid())});var c=app.activeProject;c.addInvites(b),this._fullscreen.close()},_openEditProjectFullscreen:function(a,b){var a=a||app.activeProject;b&&Wu.DomEvent.stop(b),this._fullscreen=new Wu.Fullscreen({title:'<span style="font-weight:200;">Edit</span> '+a.getName(),closeCallback:this._resetAccess.bind(this)}),this._resetAccess();var c=this._fullscreen._content,d=Wu.DomUtil.create("div","private-public-label smooth-fullscreen-sub-label");new Wu.button({id:"public-switch",type:"switch",isOn:a.isPublic(),right:!1,disabled:!1,appendTo:c,fn:this._togglePrivatePublic.bind(this,d),className:"public-private-project-switch"});c.appendChild(d),d.innerHTML=a.isPublic()?this.options.labels.public_project:this.options.labels.private_project;var e=(Wu.DomUtil.create("div","smooth-fullscreen-name-label clearboth",c,"Project name"),Wu.DomUtil.create("input","smooth-input",c));e.setAttribute("placeholder","Enter name here"),e.value=a.getName();var f=Wu.DomUtil.create("div","smooth-fullscreen-error-label",c),g=Wu.DomUtil.create("div","toggles-wrapper",c);this._createInviteUsersInput({type:"read",label:"Spectators of project",content:g,container:this._fullscreen._inner,sublabel:"Spectators have read-only access to the project",project:a});var h=Wu.DomUtil.create("div","toggle-wrapper",g),i=Wu.DomUtil.create("div","small-toggle-label smooth-fullscreen-sub-label");new Wu.button({id:"share-switch",type:"switch",isOn:a.isShareable(),right:!1,disabled:!1,appendTo:h,fn:this._toggleShare.bind(this,i),className:"share-project-switch"});h.appendChild(i),i.innerHTML=a.isShareable()?this.options.labels.share_on:this.options.labels.share_off,this._access.options.share=a.isShareable();var j=Wu.DomUtil.create("div","toggle-wrapper",g),k=Wu.DomUtil.create("div","small-toggle-label smooth-fullscreen-sub-label"),l=a.isDownloadable()||a.isEditor();new Wu.button({id:"download-switch",type:"switch",isOn:a.isDownloadable(),right:!1,disabled:!l,appendTo:j,fn:this._toggleDownload.bind(this,k),className:"download-project-switch"});j.appendChild(k),k.innerHTML=a.isDownloadable()?this.options.labels.download_on:this.options.labels.download_off,this._access.options.download=a.isDownloadable();var g=Wu.DomUtil.create("div","toggles-wrapper",c);this._createInviteUsersInput({type:"edit",label:"Editors of project",content:g,container:this._fullscreen._inner,sublabel:"Editors can edit the project",project:a});var m=Wu.DomUtil.create("div","invite-someone-wrapper",c),n=(Wu.DomUtil.create("div","smooth-fullscreen-name-label add-message",m,'Want to invite someone else? Send them <a id="invite_someone_btn">an invite!</a>'),Wu.DomUtil.get("invite_someone_btn"));Wu.DomEvent.on(n,"click",function(a){this._fullscreen.close();var b=app.Chrome.Left._tabs.users;b._openInvite()},this);var o={name_input:e,name_error:f,project:a},p=Wu.DomUtil.create("div","smooth-fullscreen-buttons-wrapper",c),q=Wu.DomUtil.create("div","smooth-fullscreen-save",p,"Update");if(Wu.DomEvent.on(q,"click",this._updateProject.bind(this,o),this),a.store.createdBy==app.Account.getUuid()){var r=Wu.DomUtil.create("div","smooth-fullscreen-delete",p,"Delete");Wu.DomEvent.on(r,"click",this._deleteProject.bind(this,o),this)}},_toggleShare:function(a,b,c){a.innerHTML=c?this.options.labels.share_on:this.options.labels.share_off,this._access.options.share=c},_toggleDownload:function(a,b,c){a.innerHTML=c?this.options.labels.download_on:this.options.labels.download_off,this._access.options.download=c},_togglePrivatePublic:function(a,b,c){a.innerHTML=c?this.options.labels.public_project:this.options.labels.private_project,this._access.options.isPublic=c},_divs:{read:{},edit:{}},_createInviteUsersInput:function(a){var b=a.content||this._fullscreen._content,c=this._fullscreen._container,d=a.project,e=a.label,f=Wu.DomUtil.create("div","smooth-fullscreen-name-label",b,e),g=Wu.DomUtil.create("div","invite-container",b),h=(Wu.DomUtil.create("div","smooth-fullscreen-sub-label",b,a.sublabel),Wu.DomUtil.create("div","invite-inner",g)),i=Wu.DomUtil.create("div","invite-input-container",h),j=Wu.DomUtil.create("input","invite-input-form",i),k=Wu.DomUtil.create("div","invite-list-container",g),l=Wu.DomUtil.create("div","invite-list-inner",k);this._divs[a.type].invite_list_container=k;var m=(Wu.DomUtil.create("div","monkey-scroll-bar",l),Wu.DomUtil.create("div","monkey-scroll-hider",l)),n=Wu.DomUtil.create("div","monkey-scroll-inner",m),o=Wu.DomUtil.create("div","monkey-scroll-list",n),p=_.sortBy(_.toArray(app.Users),function(a){return a.store.firstName});if(_.each(p,function(b){var c=Wu.DomUtil.create("div","monkey-scroll-list-item-container",o),d=Wu.DomUtil.create("div","monkey-scroll-list-item-avatar-container",c),e=(Wu.DomUtil.create("div","monkey-scroll-list-item-avatar default-avatar",d),Wu.DomUtil.create("div","monkey-scroll-list-item-name-container",c)),f=Wu.DomUtil.create("div","monkey-scroll-list-item-name-bold",e),g=Wu.DomUtil.create("div","monkey-scroll-list-item-name-subtle",e);f.innerHTML=b.getFullName(),g.innerHTML=b.getEmail(),Wu.DomEvent.on(c,"click",function(){("read"!=a.type||b.getUuid()!=app.Account.getUuid())&&this._addUserAccessItem({input:j,user:b,type:a.type})},this)},this),Wu.DomEvent.on(j,"focus",function(){this._closeInviteInputs(),k.style.display="block"},this),Wu.DomEvent.on(i,"click",function(){j.focus()},this),Wu.DomEvent.on(j,"keydown",function(b){var c=event.which?event.which:event.keyCode,d=j.value,e=d.length;if(0>=e&&(e=1),j.style.width=30+20*e+"px",8==c&&0==d.length&&this._access[a.type].length){var f=_.last(this._access[a.type]);if("edit"==a.type&&f&&f.user&&f.user.getUuid()==app.Account.getUuid())return;var g=this._access[a.type].pop();Wu.DomUtil.remove(g.user_container)}(13==c||27==c)&&(j.blur(),j.value="",this._closeInviteInputs())},this),Wu.DomEvent.on(c,"click",function(a){var b=a.target==c||a.target==this._fullscreen._inner||a.target==f||a.target==this._fullscreen._content;b&&this._closeInviteInputs()},this),d){var q=d.getAccess();q&&q[a.type]&&!a.empty&&q[a.type].forEach(function(b){var c=app.Users[b];c&&this._addUserAccessItem({input:j,user:c,type:a.type})},this),k.style.display="none",j.blur()}},_closeInviteInputs:function(){var a=this._divs.edit.invite_list_container;a&&(a.style.display="none");var a=this._divs.read.invite_list_container;a&&(a.style.display="none")},_addUserAccessItem:function(a){var b=a.input,c=a.user;if(c){b.focus();var d=_.find(this._access[a.type],function(a){return a.user==c});if(!d){var e=Wu.DomUtil.create("div","mini-user-container"),f=Wu.DomUtil.create("div","mini-user-inner",e),g=(Wu.DomUtil.create("div","mini-user-avatar default-avatar",f),Wu.DomUtil.create("div","mini-user-name",f,c.getFullName()),Wu.DomUtil.create("div","mini-user-kill",f,"x"),b.parentNode);g.insertBefore(e,b),c.getUuid()!=app.Account.getUuid()?Wu.DomEvent.on(e,"click",function(){Wu.DomUtil.remove(e),_.remove(this._access[a.type],function(a){return a.user==c})},this):Wu.DomUtil.addClass(e,"itsme"),this._access[a.type].push({user:c,user_container:e});var h="edit"==a.type?"read":"edit",d=_.find(this._access[h],function(a){return a.user==c});d&&(Wu.DomUtil.remove(d.user_container),_.remove(this._access[h],function(a){return a==d}))}}},_deleteProject:function(a){var b=a.project,c=confirm("Are you sure you want to delete project "+b.getName()+"? This action cannot be undone!");c&&(b._delete(),b=null,this._activeProject=null,this._fullscreen.close())},_updateProject:function(a){var b=a.name_input.value,c=a.project,d={edit:[],read:[],options:{share:this._access.options.share,download:this._access.options.download,isPublic:this._access.options.isPublic}};return this._access.edit.forEach(function(a){d.edit.push(a.user.getUuid())},this),this._access.read.forEach(function(a){d.read.push(a.user.getUuid())},this),b?(this._logUpdate({access:d,project:c,projectName:b}),this._resetAccess(),c.setName(b),c.setAccess(d),this._refreshContent(),this._fullscreen.close(),void c.selectProject()):void(a.name_error.innerHTML="Please enter a project name")},_logUpdate:function(a){var b=a.access,c=a.project,d=a.projectName,e="";d!=c.getTitle()&&(e+=": changed name to "+d);var f=_.difference(b.read,this._access.read);f.length&&(e+=", added "+f.length+" readers");var g=_.difference(b.edit,this._access.edit);g.length&&(e+=", added "+g.length+" editors"),app.Socket.sendUserEvent({user:app.Account.getFullName(),event:"`updated project` "+c.getTitle(),description:e,timestamp:Date.now()})},_resetAccess:function(){this._access={read:[],edit:[],options:{share:!0,download:!0,isPublic:!0}}},_createProject:function(a){var b=a.name_input.value;if(!b)return void(a.name_error.innerHTML="Please enter a project name");var c={edit:[],read:[],options:{share:this._access.options.share,download:this._access.options.download,isPublic:this._access.options.isPublic}};this._access.edit.forEach(function(a){c.edit.push(a.user.getUuid())},this),this._access.read.forEach(function(a){c.read.push(a.user.getUuid())},this),this._resetAccess();var d={name:b,description:"Project description",createdByName:app.Account.getName(),access:c},a={store:d,callback:this._projectCreated,context:this},e=new Wu.Project(d);e.create(a,function(a,b){var d=Wu.parse(b),e=d.error,f=d.project;return e?app.feedback.setError({title:"There was an error creating new project!",description:e}):(app.Projects[f.uuid]=a,a.setNewStore(f),this._refreshContent(),this._fullscreen.close(),a.selectProject(),void a.setAccess(c))})},_refresh:function(){if(this._project){if(this._activeProject){var a=this._projects[this._activeProject.getUuid()].wrapper;Wu.DomUtil.removeClass(a,"active-project")}var a=this._projects[this._project.getUuid()].wrapper;Wu.DomUtil.addClass(a,"active-project"),this._activeProject=this._project}},_onProjectDeleted:function(a){a.detail.projectUuid&&(this._refreshContent(),app.Controller.openFirstProject())},_onLayerAdded:function(a){},_onFileDeleted:function(){},_onLayerDeleted:function(){},_onLayerEdited:function(){},_registerButton:function(){},_togglePane:function(){var a=this.options.chrome;this._isOpen?a.close(this):a.open(this),this._isOpen&&app.Socket.sendUserEvent({user:app.Account.getFullName(),event:"opened",description:"the left pane",timestamp:Date.now()})},_show:function(){this._container.style.display="block",this._isOpen=!0},_hide:function(){this._container.style.display="none",this._isOpen=!1},onOpened:function(){},onClosed:function(){},_addEvents:function(){},_removeEvents:function(){},_onWindowResize:function(){},getDimensions:function(){var a={width:this.options.defaultWidth,height:this._container.offsetHeight};return a}}),Wu.Chrome.Users=Wu.Chrome.extend({_:"users",options:{defaultWidth:400},_initialize:function(){this._initContainer(),this._initContent()},_initContainer:function(){this._container=Wu.DomUtil.create("div","chrome-left-section chrome-users",this.options.appendTo)},_initContent:function(){var a=Wu.DomUtil.create("div","chrome-left-container contacts",this._container);Wu.DomUtil.create("div","chrome-left-title users-title",a,"Contacts"),this.users=app.Users;this.D3container=d3.select(a),this.openUserCard=!1,this._refresh(),this._inviteButton=Wu.DomUtil.create("div","chrome-left-invite-users",this._container,"+ Invite People"),Wu.DomEvent.on(this._inviteButton,"click",this._openInvite,this)},_createEmailInput:function(a){var a=this._emailsWrapper,b={label:"Email Address",sublabel:"Just write the damn address"},c=b.label,d=(Wu.DomUtil.create("div","smooth-fullscreen-name-label invite-emails",a,c),Wu.DomUtil.create("div","invite-container narrow",a)),e=Wu.DomUtil.create("div","invite-inner",d),f=Wu.DomUtil.create("div","invite-input-container",e),g=Wu.DomUtil.create("input","invite-email-input-form",f);g.setAttribute("placeholder","name@domain.com");var h=Wu.DomUtil.create("div","smooth-fullscreen-error-label",a);this._emails.push({invite_input:g,invite_error:h})},_emails:[],_openInvite:function(a){a&&Wu.DomEvent.stop(a),this._fullscreen=new Wu.Fullscreen({title:'<span style="font-weight:200;">Invite people to Systemapic</span>',innerClassName:"smooth-fullscreen-inner invite"}),this._access={edit:[],read:[]};var b=this._fullscreen._content,c=Wu.DomUtil.create("div","smooth-fullscreen-link-label",b,'<a id="share-link"><i class="fa fa-share-alt"></i> Get shareable link</a>');this._emailsWrapper=Wu.DomUtil.create("div","invite-emails-wrapper",b),this._createEmailInput();var d=Wu.DomUtil.create("div","invite-add-another-wrapper",b),e=Wu.DomUtil.create("div","smooth-fullscreen-name-label add-another-email",d,"+ Add another");Wu.DomEvent.on(e,"click",this._createEmailInput,this);var f=Wu.DomUtil.create("div","invite-email-message-wrap",b),g=(Wu.DomUtil.create("div","smooth-fullscreen-name-label add-message",f,'Make your invite more personal by adding a <a id="custom_message_btn">custom message</a>'),Wu.DomUtil.get("custom_message_btn")),h=Wu.DomUtil.create("div","invite-custom-message-wrapper",f);Wu.DomUtil.create("div","invite-custom-message-wrapper-label",h,"Custom Message");this._customMessage=Wu.DomUtil.create("textarea","invite-custom-message-wrapper-textarea",h),Wu.DomEvent.on(g,"click",function(){Wu.DomUtil.addClass(f,"hideme"),Wu.DomUtil.addClass(h,"showme"),this._customMessage.focus()},this);var i=Wu.DomUtil.create("div","toggles-wrapper",b);this._createInviteInput({type:"read",label:'Invite people to view these projects <span class="optional-medium invite">(optional)</span>',content:i,container:this._fullscreen._inner,sublabel:"Users will get read-only access to these projects"}),this._createInviteInput({type:"edit",label:'Invite people to edit these projects <span class="optional-medium invite">(optional)</span>',content:i,container:this._fullscreen._inner,sublabel:"Users will get full edit access to these projects"});var j=Wu.DomUtil.create("div","smooth-fullscreen-save invite",b,"Send Invites");Wu.DomUtil.create("div","invite-success-message",b,"");Wu.DomEvent.on(j,"click",this._sendInvites,this),Wu.DomEvent.on(c,"click",this._openLinkShare,this)},_openLinkShare:function(a){this._fullscreen.close(),a&&Wu.DomEvent.stop(a),this._fullscreen=new Wu.Fullscreen({title:'<span style="font-weight:200;">Invite people to Systemapic</span>',innerClassName:"smooth-fullscreen-inner invite"}),this._access={edit:[],read:[]};var b=this._fullscreen._content;this._emailsWrapper=Wu.DomUtil.create("div","invite-emails-wrapper",b);var c=(Wu.DomUtil.create("div","smooth-fullscreen-name-label invite-emails",b,"Share this link"),Wu.DomUtil.create("div","invite-container narrow",b)),d=Wu.DomUtil.create("div","invite-inner",c),e=Wu.DomUtil.create("div","invite-input-container",d);this._shareLinkInput=Wu.DomUtil.create("input","invite-email-input-form",e),this._shareLinkInput.value=app.options.servers.portal+"invite",this._inviteFeedback=Wu.DomUtil.create("div","smooth-fullscreen-feedback-label",b);var f=Wu.DomUtil.create("div","clipboard-wrapper",e),g=Wu.DomUtil.create("div","clipboard-button",f);g.innerHTML='<i class="fa fa-clipboard"></i>',Wu.DomEvent.on(f,"mousedown",this._removeClipFeedback,this),Wu.DomEvent.on(f,"mouseup",this._copypasted,this);var h=Wu.DomUtil.create("div","toggles-wrapper",b);this._createInviteInput({type:"read",label:'Invite people to view these projects <span class="optional-medium invite">(optional)</span>',content:h,container:this._fullscreen._inner,sublabel:"Users will get read-only access to these projects",trigger:this._addedProject.bind(this)}),this._createInviteInput({type:"edit",label:'Invite people to edit these projects <span class="optional-medium invite">(optional)</span>',content:h,container:this._fullscreen._inner,sublabel:"Users will get full edit access to these projects",trigger:this._addedProject.bind(this)});var i=Wu.DomUtil.create("div","smooth-fullscreen-save invite",b,"Close");Wu.DomEvent.on(this._shareLinkInput,"focus click",function(){this._shareLinkInput.select()},this),Wu.DomEvent.on(i,"click",this._fullscreen.close.bind(this._fullscreen),this),this._createShareableInvite()},_copypasted:function(){this._shareLinkInput.focus(),this._shareLinkInput.select();var a=document.execCommand("copy"),b=a?"Link copied to the clipboard!":"Your browser doesn't support this. Please copy manually.";this._setClipFeedback(b)},_setClipFeedback:function(a){this._inviteFeedback.innerHTML=a,this._inviteFeedback.style.opacity=1},_removeClipFeedback:function(){this._inviteFeedback.innerHTML="",this._inviteFeedback.style.opacity=0},_addedProject:function(a){this._createShareableInvite(),this._removeClipFeedback()},_createShareableInvite:function(){var a={edit:[],read:[]};this._access.read.forEach(function(b){a.read.push(b.project.getUuid())}),this._access.edit.forEach(function(b){a.edit.push(b.project.getUuid())});var b=JSON.stringify({access:a});Wu.post("/api/invite/link",b,function(a,b){this._shareLinkInput.value=b}.bind(this),this)},_inviteToProject:function(a,b){b&&Wu.DomEvent.stop(b),this._fullscreen=new Wu.Fullscreen({title:'<span style="font-weight:200;">Invite '+a.getFullName()+" to projects</span>",innerClassName:"smooth-fullscreen-inner invite"}),this._access={edit:[],read:[]};var c=this._fullscreen._content,d=Wu.DomUtil.create("div","toggles-wrapper",c);this._createInviteInput({type:"read",label:"Invite "+a.getFullName()+" to view these projects",content:d,container:this._fullscreen._inner,sublabel:"The user will get read-only access to these project"}),this._createInviteInput({type:"edit",label:"Invite "+a.getFullName()+" to edit these projects",content:d,container:this._fullscreen._inner,sublabel:"The user will get full edit access to these project"});var e=Wu.DomUtil.create("div","smooth-fullscreen-save invite",c,"Invite");Wu.DomUtil.create("div","invite-success-message",c,"");Wu.DomEvent.on(e,"click",this._updateInvites,this),this._access.user=a},_updateInvites:function(){var a=[],b=[],c=this._access.user;this._access.read,this._access.edit;this._access.read.forEach(function(b){a.push(b.project.getUuid())}),this._access.edit.forEach(function(a){b.push(a.project.getUuid())}),c.inviteToProjects({read:a,edit:b}),this._fullscreen.close()},_divs:{read:{},edit:{},email:{}},_sendInvites:function(a){var b=[];if(this._emails.forEach(function(a,c){var d=a.invite_input,e=d.value;if(!e.length&&0==c){var f=a.invite_error;return void(f.innerHTML="Please enter an email address")}e.length&&b.push(e)}),b.length){var c=this._customMessage.value.replace(/\n/g,"<br>"),d={edit:[],read:[]};this._access.edit.forEach(function(a){d.edit.push(a.project.getUuid())}),this._access.read.forEach(function(a){d.read.push(a.project.getUuid())});var e={emails:b,customMessage:c,access:d};Wu.send("/api/user/invite",e,this._sentInvites.bind(this,a.target),this),this._logInvites(e)}},_logInvites:function(a){var b=[],c=[],d="";a.access.read.forEach(function(a){b.push(app.Projects[a].getTitle())}),a.access.edit.forEach(function(a){c.push(app.Projects[a].getTitle())}),b.length&&(d+="to read `"+b.join(", ")+"`"),b.length&&c.length&&(d+="and edit `"+c.join(", ")+"`"),!b.length&&c.length&&(d+="to edit `"+c.join(", ")+"`"),app.Socket.sendUserEvent({user:app.Account.getFullName(),event:"`invited` "+a.emails.join(", "),description:d,timestamp:Date.now()})},_sentInvites:function(a,b,c){this._fullscreen.close(),app.feedback.setMessage({title:"Invites sent!"})},_createInviteInput:function(a){var b=a.content||this._fullscreen._content,c=this._fullscreen._container,d=a.label,e=Wu.DomUtil.create("div","smooth-fullscreen-name-label invite",b,d),f=Wu.DomUtil.create("div","invite-container",b),g=(Wu.DomUtil.create("div","smooth-fullscreen-sub-label",b,a.sublabel),Wu.DomUtil.create("div","invite-inner",f)),h=Wu.DomUtil.create("div","invite-input-container",g),i=Wu.DomUtil.create("input","invite-input-form",h),j=Wu.DomUtil.create("div","invite-list-container",f),k=Wu.DomUtil.create("div","invite-list-inner",j);this._divs[a.type].invite_list_container=j;var l=(Wu.DomUtil.create("div","monkey-scroll-bar",k),Wu.DomUtil.create("div","monkey-scroll-hider",k)),m=Wu.DomUtil.create("div","monkey-scroll-inner",l),n=Wu.DomUtil.create("div","monkey-scroll-list",m),o=_.sortBy(_.toArray(app.Projects),function(a){return a.getTitle().toLowerCase()});_.each(o,function(b){var c=(b.getAccess(),b.isEditor(),b.isSpectator()),d=b.isShareable();if(("read"!=a.type||!c||d)&&("edit"!=a.type||!c)){var e=Wu.DomUtil.create("div","monkey-scroll-list-item-container project",n),f=Wu.DomUtil.create("div","monkey-scroll-list-item-avatar-container",e),g=(Wu.DomUtil.create("div","monkey-scroll-list-item-avatar project",f,'<i class="project fa fa-map-o"></i>'),Wu.DomUtil.create("div","monkey-scroll-list-item-name-container project",e)),h=Wu.DomUtil.create("div","monkey-scroll-list-item-name-bold project",g);h.innerHTML=b.getTitle(),Wu.DomEvent.on(e,"click",function(){this._addAccessItem({input:i,project:b,type:a.type,trigger:a.trigger}),a.trigger&&a.trigger({project:b})},this)}},this),Wu.DomEvent.on(i,"focus",function(){this._closeInviteInputs(),j.style.display="block"},this),Wu.DomEvent.on(h,"click",function(){i.focus()},this),Wu.DomEvent.on(i,"keydown",function(b){var c=event.which?event.which:event.keyCode,d=i.value,e=d.length;if(0>=e&&(e=1),i.style.width=30+20*e+"px",8==c&&0==d.length&&this._access[a.type].length){var f=this._access[a.type].pop();Wu.DomUtil.remove(f.user_container),a.trigger&&a.trigger({project:!1})}13==c&&(i.blur(),i.value="",this._closeInviteInputs())},this),Wu.DomEvent.on(c,"click",function(a){var b=a.target==c||a.target==this._fullscreen._inner||a.target==e||a.target==this._fullscreen._content;b&&this._closeInviteInputs()},this)},_closeInviteInputs:function(){var a=this._divs.edit.invite_list_container;a&&(a.style.display="none");var a=this._divs.read.invite_list_container;a&&(a.style.display="none")},_addAccessItem:function(a){var b=a.input,c=a.project;b.focus();var d=_.find(this._access[a.type],function(a){return a.project==c});if(!d){var e=Wu.DomUtil.create("div","mini-user-container"),f=Wu.DomUtil.create("div","mini-user-inner",e),g=(Wu.DomUtil.create("div","mini-project-avatar",f,'<i class="fa fa-map"></i>'),Wu.DomUtil.create("div","mini-user-name",f,c.getTitle()),Wu.DomUtil.create("div","mini-user-kill",f,"x"),b.parentNode);g.insertBefore(e,b),Wu.DomEvent.on(e,"click",function(){Wu.DomUtil.remove(e),_.remove(this._access[a.type],function(a){return a.project==c}),a.trigger&&a.trigger({project:!1})},this),this._access[a.type].push({project:c,user_container:e});var h="edit"==a.type?"read":"edit",d=_.find(this._access[h],function(a){return a.project==c});d&&(Wu.DomUtil.remove(d.user_container),_.remove(this._access[h],function(a){return a==d}))}},refreshUserList:function(a){var b=this.D3container.selectAll(".chrome-user").data(a);b.enter().append("div").classed("chrome-user",!0).classed("chrome-left-itemcontainer",!0),b.classed("contact",function(a){return a.isContact()}).classed("project-contact",function(a){return!a.isContact()}),b.exit().remove(),this.addUserName(b),this.create_inviteToProjectIcon(b),this.create_addContactIcon(b)},create_inviteToProjectIcon:function(a){var b=a.selectAll(".contact-invite-icon").data(function(a){var b=a.isContact()?[a]:[];return b});b.enter().append("i").classed("contact-invite-icon",!0).classed("fa",!0).classed("fa-arrow-circle-right",!0),b.on("click",function(a){this._inviteToProject(a)}.bind(this)),b.html(function(a){var b="123px",c="Invite to projects",d='<div class="absolute"><div class="project-tooltip contact-invite-tooltip" style="width:'+b+'">'+c+"</div></div>";return d}),b.exit().remove()},create_addContactIcon:function(a){var b=a.selectAll(".contact-list-icon").data(function(a){var b=a.isContact()?[]:[a];return b});b.enter().append("i").classed("contact-list-icon",!0).classed("fa",!0).classed("fa-user-plus",!0),b.on("click",function(a){this._requestContact(a)}.bind(this)),b.html(function(a){var b="110px",c="Add as contact",d='<div class="absolute"><div class="project-tooltip contact-add-tooltip" style="width:'+b+'">'+c+"</div></div>";return d}),b.exit().remove()},addUserName:function(a){var b=a.selectAll(".chrome-left-item-name").data(function(a){return[a]});b.enter().append("div").classed("chrome-left-item-name",!0),b.html(function(a){return a.getFullName()}),b.exit().remove()},_requestContact:function(a){app.Account.sendContactRequest(a)},_onLayerAdded:function(a){},_onFileDeleted:function(){},_onLayerDeleted:function(){},_onLayerEdited:function(){},_registerButton:function(){},_togglePane:function(){
var a=this.options.chrome;this._isOpen?a.close(this):a.open(this),this._isOpen&&app.Socket.sendUserEvent({user:app.Account.getFullName(),event:"opened",description:"the left pane",timestamp:Date.now()})},_show:function(){this._container.style.display="block",this._isOpen=!0},_hide:function(){this._container.style.display="none",this._isOpen=!1},onOpened:function(){},onClosed:function(){},_addEvents:function(){},_removeEvents:function(){},_onWindowResize:function(){},getDimensions:function(){var a={width:this.options.defaultWidth,height:this._container.offsetHeight};return a},_refresh:function(){var a=_.toArray(this.users);_.remove(a,function(a){return a.getUuid()==app.Account.getUuid()}),this.refreshUserList(a)}}),Wu.Chrome.SettingsContent=Wu.Chrome.extend({_initialize:function(){},initLayout:function(){},_addEvents:function(){var a=this.options.trigger;a&&Wu.DomEvent.on(a,"click",this.show,this),Wu.DomEvent.on(window,"resize",this._windowResize,this)},_removeEvents:function(){Wu.DomEvent.off(window,"resize",this._windowResize,this)},_windowResize:function(){},_onLayerAdded:function(){this._refresh()},_onLayerEdited:function(){this._refresh()},show:function(){this._inited||this._initLayout(),this.hideAll(),this._container.style.display="block",Wu.DomUtil.addClass(this.options.trigger,"active-tab")},hide:function(){this._container.style.display="none",Wu.DomUtil.removeClass(this.options.trigger,"active-tab")},hideAll:function(){if(!this.options||!this.options.parent)return void 0;var a=this.options.parent.getTabs();for(var b in a){var c=a[b];c.hide()}this._hideLayerEditor()},_hideLayerEditor:function(){var a=app.MapPane.getControls().layermenu;a&&a.disableEdit()},_projectSelected:function(a){var b=a.detail.projectUuid;b&&(this._project=app.activeProject=app.Projects[b],this._refresh())},_refresh:function(){},_initLayout_activeLayers:function(a,b,c,d){var a=a||"Layer",b=b||"Select a layer to style...",e=this._activeLayersWrap=Wu.DomUtil.create("div","chrome chrome-content styler-content active-layer wrapper",c),a=Wu.DomUtil.create("div","chrome chrome-content active-layer title",e,a),f=Wu.DomUtil.create("div","chrome chrome-content active-layer select-wrap",e),g=this._select=Wu.DomUtil.create("select","active-layer-select",f);if(!d)var d=this._project.getPostGISLayers();var h=Wu.DomUtil.create("option","",g);return h.innerHTML=b,h.setAttribute("disabled",""),h.setAttribute("selected",""),d.forEach(function(a){var b=Wu.DomUtil.create("option","active-layer-option",g);b.value=a.getUuid(),b.innerHTML=a.getTitle()}),Wu.DomEvent.on(g,"change",this._selectedActiveLayer,this),g},_storeActiveLayerUuid:function(a){app.Chrome.Right.options.editingLayer=a},_getActiveLayerUuid:function(){return app.Chrome.Right.options.editingLayer},opened:function(){},closed:function(){},_tempaddLayer:function(){this._temps=this._temps||[],this._tempRemoveLayers(),this._layer._added||(this._layer._addThin(),this._temps.push(this._layer),this._layer.flyTo())},_tempRemoveLayers:function(){this._temps&&(this._temps.forEach(function(a){a._removeThin()},this),this._temps=[])},_gradientStyle:function(a){var b="background: -webkit-linear-gradient(left, "+a.join()+");";return b+="background: -o-linear-gradient(right, "+a.join()+");",b+="background: -moz-linear-gradient(right, "+a.join()+");",b+="background: linear-gradient(to right, "+a.join()+");"},padToTwo:function(a){return a.length<2&&(a="0"+a),a},hexAverage:function(a){return a.reduce(function(a,b){return b.replace(/^#/,"").match(/.{2}/g).map(function(b,c){return a[c]+parseInt(b,16)})},[0,0,0]).reduce(function(b,c){var d=this.padToTwo(Math.floor(c/a.length).toString(16));return b+d}.bind(this),"#")},_validateDateFormat:function(a){if("the_geom_3857"==a||"the_geom_4326"==a||"_columns"==a)return!1;var b=moment(a,["YYYYMMDD",moment.ISO_8601]).format("YYYY-MM-DD");if("Invalid date"!=b)return b;var b=moment(a).format("YYYY-MM-DD");return"Invalid date"!=b?b:!1},_normalize:function(a,b,c){return normalized=(a-b)/(c-b),normalized},_normalizeOffset:function(a,b,c){return b>0&&(b=0),normalized=(a-b)/(c-b),normalized}}),Wu.Chrome.SettingsContent.Filters=Wu.Chrome.SettingsContent.extend({options:{num_buckets:50},_initialize:function(){this._initContainer(),this._addEvents()},_initContainer:function(){this._container=Wu.DomUtil.create("div","chrome chrome-content chrome-pane filters",this.options.appendTo)},_initLayout:function(){this._midSection=Wu.DomUtil.create("div","chrome-middle-section",this._container),this._midOuterScroller=Wu.DomUtil.create("div","chrome-middle-section-outer-scroller",this._midSection),this._midInnerScroller=Wu.DomUtil.create("div","chrome-middle-section-inner-scroller",this._midOuterScroller),this.layerSelector=this._initLayout_activeLayers("Datasets","Select a dataset to filter...",this._midInnerScroller),this._bottomContainer=Wu.DomUtil.create("div","sql-bottom-container",this._container),this._sqltitle=Wu.DomUtil.create("div","chrome chrome-content sql title",this._bottomContainer,"SQL"),this._sqlSave=Wu.DomUtil.create("div","sql-save",this._bottomContainer,"Save"),this._codeWrapOuter=Wu.DomUtil.create("div","chrome-content sql-wrapper-outer",this._bottomContainer),this._codewrap=Wu.DomUtil.create("input","chrome chrome-content cartocss code-wrapper",this._codeWrapOuter),this._createSqlEditor(),this._hideEditors(),this._updateDimensions(),this._inited=!0,this.initHooks()},initHooks:function(){Wu.DomEvent.on(this._sqlSave,"click",this._updateStyle,this),Wu.DomEvent.on(this._sqltitle,"click",this.toggleSql,this)},toggleSql:function(){this.sqlOpen?(Wu.DomUtil.removeClass(this._codeWrapOuter,"active"),Wu.DomUtil.removeClass(this._sqlSave,"active"),Wu.DomUtil.removeClass(this._bottomContainer,"active"),Wu.DomUtil.addClass(this._midSection,"no-sql"),this.sqlOpen=!1):(Wu.DomUtil.addClass(this._codeWrapOuter,"active"),Wu.DomUtil.addClass(this._sqlSave,"active"),Wu.DomUtil.addClass(this._bottomContainer,"active"),Wu.DomUtil.removeClass(this._midSection,"no-sql"),this.sqlOpen=!0)},_refresh:function(){this._flush(),this._initLayout()},_flush:function(){this._SQLEditor=null,this._container.innerHTML=""},_cleanup:function(){},_removeEvents:function(){},_windowResize:function(){app._map.invalidateSize()},_updateDimensions:function(){if(this._SQLEditor){var a=app.Chrome.Right.getDimensions(),b=this._SQLEditor.getWrapperElement();b&&(b.style.width=a.width+"px",b.style.height="1114px")}},_updateStyle:function(){if(!this._layer)return void 0;var a=this.getSQLValue(),b=this.getCartocssValue(),c={sql:a,css:b,layer:this._layer};this._updateLayer(c)},getCartocssValue:function(){return this._layer.getCartoCSS()},getSQLValue:function(){return this._SQLEditor.getValue()},_createSQL:function(a,b){return b?(b.replace("table",a),b="("+b+") as sub"):b="(SELECT * FROM  "+a+") as sub",b},_updateLayer:function(a,b){var c=this.getCartocssValue(),d=a.layer,e=d.getFileUuid(),f=a.sql,f=this._createSQL(e,f),g=(this._project,d.store.data.postgis);g.sql=f,g.css=c,g.file_id=e;var h={geom_column:"the_geom_3857",geom_type:"geometry",raster_band:"",srid:"",affected_tables:"",interactivity:"",attributes:"",access_token:app.tokens.access_token,cartocss_version:"2.0.1",cartocss:c,sql:f,file_id:e,return_model:!0,layerUuid:d.getUuid()};Wu.post("/api/db/createLayer",JSON.stringify(h),function(a,c){var e=Wu.parse(c);return e.error?void(b&&b()):(d.updateStyle(e),void(b&&b()))})},_refreshLayer:function(){},open:function(){},_selectedActiveLayer:function(a,b){var c=b?b:a.target.value;this._storeActiveLayerUuid(c),this._layer=this._project.getLayer(c),this._chart&&(this._chart.innerHTML="",this._chart=null),this._createFilterDropdown(),this._refreshEditor(),this._tempaddLayer(),this._bottomContainer.style.opacity=1,Wu.DomUtil.addClass(this._midSection,"middle-section-padding-bottom")},opened:function(){},closed:function(){this._tempRemoveLayers(),this._cleanup()},_refreshEditor:function(){this._refreshSQL(),this._showEditors(),this._SQLEditor.refresh()},_refreshCartoCSS:function(){},_refreshSQL:function(){if(this._layer&&this._layer.isPostgis()){var a=this._layer.getPostGISData(),b=a.sql,c=a.table_name,d=b.replace(c,"table").replace("  "," "),d=this._cleanSQL(d);this._SQLEditor.setValue(d)}},_cleanSQL:function(a){var b=a.substring(0,1),c=a.slice(-8);if("("==b&&") as sub"==c){var d=a.substr(1,a.length-9);return d}return a},show:function(){this._inited||this._initLayout(),this.hideAll(),this._container.style.display="block",Wu.DomUtil.addClass(this.options.trigger,"active-tab");var a=this._getActiveLayerUuid();a&&this._selectedActiveLayer(!1,a);var b=this.layerSelector.childNodes;for(var c in b)b[c].value==a&&(b[c].selected=!0)},_showEditors:function(){this._SQLEditor.getWrapperElement().style.opacity=1},_hideEditors:function(){this._SQLEditor.getWrapperElement().style.opacity=0},_createSqlEditor:function(){this._SQLEditor=CodeMirror.fromTextArea(this._codewrap,{lineNumbers:!0,mode:{name:"text/x-sql"},matchBrackets:!0,lineWrapping:!1,paletteHints:!0,gutters:["CodeMirror-linenumbers","errors"]})},_getSortedColumns:function(){if(!this._layer)return!1;if(!this._layer.getPostGISData)return!1;var a=Wu.parse(this._layer.getPostGISData().metadata),b=a.columns,c=Object.keys(b);c.sort();return c.reverse()},_createFilterDropdown:function(){this._filterDropdown&&Wu.DomUtil.remove(this._filterDropdown);var a="Columns",b="Select a column to filter by...",c=this._filterDropdown=Wu.DomUtil.create("div","chrome chrome-content styler-content active-layer wrapper");this._midInnerScroller.insertBefore(c,this._midInnerScroller.children[1]);var d=(Wu.DomUtil.create("div","chrome chrome-content active-layer title",c,a),Wu.DomUtil.create("div","chrome chrome-content active-layer select-wrap",c)),e=this._select=Wu.DomUtil.create("select","active-layer-select",d),f=this._getSortedColumns(),g=Wu.DomUtil.create("option","",e);g.innerHTML=b,g.setAttribute("disabled",""),g.setAttribute("selected","");var h=["_columns"];f&&f.forEach(function(a){if(-1==h.indexOf(a)){var b=Wu.DomUtil.create("option","active-layer-option",e);b.value=a,b.innerHTML=a}}),Wu.DomEvent.on(e,"change",this._selectedFilterColumn,this),this._clearFilterDiv(),this._autoSelectFilter()},_clearFilterDiv:function(){this._filterDiv&&(this._filterDiv.innerHTML="")},_selectNone:function(){this._select.selectedIndex=0},_autoSelectFilter:function(){if(this._layer){if(!this._layer.isPostgis())return this._selectNone();var a=Wu.parse(this._layer.getFilter());if(a.length){var b=a[0].column;this._createFilterChart(b),this._select.selectedIndex=this._getDropdownIndex(b)}}},_getDropdownIndex:function(a){for(var b=0;b<this._select.length;b++)if(this._select.options[b].value==a)return b;return 0},_selectedFilterColumn:function(a){var b=a.target.value;this._createFilterChart(b)},nullHistogram:function(){for(var a=[],b=0;b<this.options.num_buckets-1;b++)a.push({bucket:b+1,freq:0,range:!1,range_min:0,range_max:0});return a},_createFilterChart:function(a){this._chart||this._createHistogram(a),this._updateHistogram(a)},_createHistogram:function(a){this._filterDiv=Wu.DomUtil.createId("div","chrome-content-filter-chart");this._midInnerScroller.insertBefore(this._filterDiv,this._filterDropdown.nextSibling),this._filterLabel=Wu.DomUtil.create("div","chrome-content-filter-label",this._filterDiv),histogram=this.nullHistogram(),this._chart=dc.barChart(this._filterDiv),this._updateChart(histogram,a),this._chart.render()},_updateHistogram:function(a){this._getHistogram(a,function(b,c){return b?void 0:(c?Wu.DomUtil.removeClass(this._filterDiv,"null-histogram"):(c=this.nullHistogram(),Wu.DomUtil.addClass(this._filterDiv,"null-histogram")),this._updateChart(c,a),this._chart.filterAll(),this._chart.redraw(),void this._applyAlreadyStoredFilter(a))}.bind(this))},_updateChart:function(a,b){var c=crossfilter(a),d=c.dimension(function(a){return+a.bucket}),e=d.group().reduceSum(function(a){return a.freq}),f=this.options.num_buckets;this._chart.width(400).height(180).gap(2).x(d3.scale.linear().domain([0,f])).brushOn(!0).renderLabel(!0).dimension(d).group(e).elasticX(!0).elasticY(!0).margins({top:10,right:10,bottom:20,left:40}),this._chart.on("filtered",function(c,d){if(!d)return this._registerFilter(!1);var e=[Math.round(d[0]),Math.round(d[1])];this._registerFilter(b,e,a)}.bind(this));var g=this._getYAxisTicks(a);this._chart.yAxis().tickValues(g),this._chart.yAxis().tickFormat(function(a){return a>1e6?Math.round(a/1e6)+"M":a>1e3?Math.round(a/1e3)+"k":a});var h=this._getXAxisTickSpacing(a);this._chart.xAxis().tickValues(h),this._chart.xAxis().tickFormat(function(b){var c=this._getBucket(b,a),d=Math.round(100*c.range_min)/100;return d}.bind(this)),this._chart.renderlet(function(a){this._chart.select(".brush").on("mousedown",this._onBrushMousedown.bind(this))}.bind(this))},_onBrushMousedown:function(a){this._brushCatcher=Wu.DomUtil.create("div","brush-catcher",app._appPane),Wu.DomEvent.on(this._brushCatcher,"mouseup",this._onBrushMouseup,this),Wu.DomEvent.on(this._brushCatcher,"mouseout",this._onBrushMouseup,this)},_onBrushMouseup:function(a){Wu.DomEvent.off(this._brushCatcher,"mouseup",this._onBrushMouseup,this),Wu.DomEvent.off(this._brushCatcher,"mouseout",this._onBrushMouseup,this),Wu.DomUtil.remove(this._brushCatcher),setTimeout(this._applyFilter.bind(this),500)},_applyAlreadyStoredFilter:function(a){var b=this._layer.getFilter();if(b){var c=Wu.parse(b),d=_.find(c,function(b){return b.column==a});d&&(this._chart.filter([d.bucket_min,d.bucket_max]),this._chart.redraw())}},_getYAxisTicks:function(a){for(var b=_.max(a,function(a){return a.freq}),c=b.freq,d=3,e=[],f=1;d+1>f;f++){var g=c/d*f,h=100*Math.round(g/100);e.push(h)}return e},_getXAxisTickSpacing:function(a){var b=0;a.forEach(function(a){var c=Math.round(100*a.range_max)/100,d=Math.round(100*a.range_min)/100,e=c.toString().length,f=d.toString().length;e>b&&(b=e),f>b&&(b=f)});var c=this._getSpacedTicks(b);return c},_getSpacedTicks:function(a){function b(a,b){return a/=b,a=Math.ceil(a)*b}for(var c=[],d=this.options.num_buckets,e=parseInt(45/a),f=d/e,g=b(f,5),h=1;e>h;h++){var i=g*h;d>=i&&c.push(i)}return c},_clearFilter:function(){var a=this._SQLEditor.getValue(),b="SELECT * FROM table";a!=b&&(this._SQLEditor.setValue(b),this._updateStyle(),this._layer.setFilter(JSON.stringify([])))},_setFilterLabel:function(a){this._filterLabel.innerHTML=a},_registerFilter:function(a,b,c){if(!a)return this._setFilterLabel("No filter."),this._filters=!1;this._filters={},this._filters.column=a,this._filters.buckets=b,this._filters.histogram=c;var d=this._calculateBuckets(a,b,c),e="Filtering "+a.toUpperCase()+" from "+d.min+" to "+d.max+".";this._setFilterLabel(e)},_getBucket:function(a,b,c){for(var d=_.find(b,function(b){return b.bucket==a}),e=c?0:this.options.num_buckets;!d;)e=c?e+1:e-1,d=_.find(b,function(b){return c?b.bucket==a-e:b.bucket==a+e}),e>100&&(d=!0);return d},_calculateBuckets:function(a,b,c){var d=b[0],e=b[1],f=this._getBucket(d,c,!0),g=this._getBucket(e,c),h=Math.round(100*f.range_min)/100,i=Math.round(100*g.range_max)/100,j={min:h,max:i,bottom:d,top:e};return j},_applyFilter:function(a,b,c){if(!this._filters)return this._clearFilter();var a=this._filters.column,b=this._filters.buckets,c=this._filters.histogram,d=this._calculateBuckets(a,b,c),e="SELECT * FROM table";e+=" \nwhere "+a+" > "+d.min+"\nand "+a+" < "+d.max,this._SQLEditor.setValue(e),this._updateStyle(),this._layer.setFilter(JSON.stringify([{column:a,bucket_min:d.bottom,bucket_max:d.top}]))},_getHistogram:function(a,b,c){var c=!0;if(c)return this._getFreshHistogram(a,b);var d=this._layer.getPostGISData(),e=d.file_id,f=app.Account.getFile(e),g=f.getHistogram(a);b(null,g)},_getFreshHistogram:function(a,b){if(this._layer){var c=this._layer.getPostGISData(),d={layer_id:c.layer_id,file_id:c.file_id,column:a,access_token:app.tokens.access_token,num_buckets:this.options.num_buckets};Wu.post("/api/db/fetchHistogram",JSON.stringify(d),function(a,c){var d=Wu.parse(c);b&&b(null,d)})}}}),Wu.Chrome.SettingsContent.Cartocss=Wu.Chrome.SettingsContent.extend({_initialize:function(){this._initContainer(),this._addEvents()},_initContainer:function(){this._container=Wu.DomUtil.create("div","chrome chrome-content chrome-pane cartocss",this.options.appendTo)},_initLayout:function(){this._midSection=Wu.DomUtil.create("div","chrome-middle-section",this._container),this.layerSelector=this._initLayout_activeLayers(!1,!1,this._midSection),this._codewrap=Wu.DomUtil.create("input","chrome chrome-content cartocss code-wrapper",this._midSection),this._createCartoEditor(),this._setKeymap(),this._createRefresh(),this._createTitles(),this._hideEditors(),this._updateDimensions(),this._inited=!0},_refresh:function(){this._flush(),this._initLayout()},_flush:function(){this._removeKeymaps(),this._removeEvents(),this._cartoEditor=null,this._container.innerHTML=""},_cleanup:function(){this._select&&(this._select.selectedIndex=0),this._cartoEditor&&this._cartoEditor.setValue(""),this._hideEditors(),this._removeKeymaps(),this._removeEvents()},_removeEvents:function(){},_createTitles:function(){this._cartotitle=Wu.DomUtil.create("div","chrome chrome-content cartocss title"),this._cartotitle.innerHTML="CartoCSS";var a=this._cartoEditor.getWrapperElement();a.parentElement.insertBefore(this._cartotitle,a)},_createCartoEditor:function(){this._cartoEditor=CodeMirror.fromTextArea(this._codewrap,{lineNumbers:!0,mode:{name:"carto",reference:window.cartoRef},matchBrackets:!0,lineWrapping:!1,paletteHints:!0,gutters:["CodeMirror-linenumbers","errors"]})},_setKeymap:function(){this._keymap={"Cmd-S":function(a){this._updateStyle()}.bind(this),"Ctrl-S":function(a){this._updateStyle()}.bind(this),"Cmd-R":function(a){this._refreshLayer()}.bind(this),"Ctrl-R":function(a){this._refreshLayer()}.bind(this)},this._cartoEditor.addKeyMap(this._keymap)},_removeKeymaps:function(){this._cartoEditor&&this._cartoEditor.removeKeyMap(this._keymap),keymaster.unbind&&keymaster.unbind("⌘+s, ctrl+s"),keymaster.unbind&&keymaster.unbind("⌘+r, ctrl+r")},_updateDimensions:function(){if(this._cartoEditor){var a=app.Chrome.Right.getDimensions(),b=this._cartoEditor.getWrapperElement();b&&(b.style.width=a.width+"px",b.style.height=a.height-325+"px")}},_windowResize:function(){this._updateDimensions(),app._map.invalidateSize()},_createRefresh:function(){this._bottomContainer=Wu.DomUtil.create("div","chrome-content-bottom-container displayNone",this._container);var a="MacIntel"==navigator.platform?"Save (⌘-S)":"Save (Ctrl-S)";this._refreshButton=Wu.DomUtil.create("div","chrome-right-big-button",this._bottomContainer,a),Wu.DomEvent.on(this._refreshButton,"click",this._updateStyle,this)},_updateStyle:function(){if(!this._layer)return void 0;var a=this.getCartocssValue();if(!a)return void 0;var b=this.getSQLValue(),c={css:a,sql:b,layer:this._layer};this._updateLayer(c)},getCartocssValue:function(){return this._cartoEditor.getValue()},getSQLValue:function(){return this._layer.getSQL()},_createSQL:function(a,b){return b?(b.replace("table",a),b="("+b+") as sub"):b="(SELECT * FROM  "+a+") as sub",b},_updateLayer:function(a,b){var c=a.css,d=a.layer,e=d.getFileUuid(),f=this.getSQLValue(),g=(this._project,d.store.data.postgis);g.css=c,g.file_id=e;var h={geom_column:"the_geom_3857",geom_type:"geometry",raster_band:"",srid:"",affected_tables:"",interactivity:"",attributes:"",access_token:app.tokens.access_token,cartocss_version:"2.0.1",cartocss:c,sql:f,file_id:e,return_model:!0,layerUuid:d.getUuid()};Wu.post("/api/db/createLayer",JSON.stringify(h),function(a,c){var e=Wu.parse(c);return e.error?void(b&&b()):(d.setStyle(e.options),d.update({enable:!0}),void(b&&b()))})},_refreshLayer:function(){},open:function(){},_selectedActiveLayer:function(a,b){var c=b?b:a.target.value;this._storeActiveLayerUuid(c),this._layer=this._project.getLayer(c),this._layer&&this._layer.isPostgis()&&(this._refreshEditor(),this._tempaddLayer(),Wu.DomUtil.removeClass(this._bottomContainer,"displayNone"))},opened:function(){},closed:function(){this._tempRemoveLayers(),this._cleanup()},_refreshEditor:function(){this._refreshCartoCSS(),this._showEditors(),this._cartoEditor.refresh()},_refreshCartoCSS:function(){var a=this._layer.getCartoCSS();this._cartoEditor.setValue(a)},_showEditors:function(){return this._cartoEditor?(this._cartoEditor.getWrapperElement().style.opacity=1,this._cartotitle.style.opacity=1,void(this._refreshButton.style.opacity=1)):void 0},_hideEditors:function(){return this._cartoEditor?(this._cartoEditor.getWrapperElement().style.opacity=0,this._cartotitle.style.opacity=0,void(this._refreshButton.style.opacity=0)):void 0},show:function(){this._inited||this._initLayout(),this.hideAll(),this._container.style.display="block",Wu.DomUtil.addClass(this.options.trigger,"active-tab");var a=this._getActiveLayerUuid();a&&this._selectedActiveLayer(!1,a);var b=this.layerSelector.childNodes;for(var c in b)b[c].value==a&&(b[c].selected=!0)}}),Wu.Chrome.SettingsContent.Tooltip=Wu.Chrome.SettingsContent.extend({_initialize:function(){this._initContainer(),this._addEvents(),app.Tools=app.Tools||{},app.Tools.Tooltip=this},_initContainer:function(){this._container=Wu.DomUtil.create("div","chrome chrome-content chrome-pane chrome-tooltip",this.options.appendTo)},_initLayout:function(){this._project&&(this._midSection=Wu.DomUtil.create("div","chrome-middle-section",this._container),this._midOuterScroller=Wu.DomUtil.create("div","chrome-middle-section-outer-scroller",this._midSection),this._midInnerScroller=Wu.DomUtil.create("div","chrome-middle-section-inner-scroller",this._midOuterScroller),this.layerSelector=this._initLayout_activeLayers(!1,!1,this._midInnerScroller),this._fieldsWrapper=Wu.DomUtil.create("div","chrome-field-wrapper",this._midInnerScroller),this._inited=!0)},_refresh:function(){this._inited&&this._flush(),this._initLayout()},_flush:function(){this._midSection.innerHTML=""},show:function(){this._inited||this._initLayout(),this._fieldsWrapper.innerHTML="",this.hideAll(),this._container.style.display="block",Wu.DomUtil.addClass(this.options.trigger,"active-tab");var a=this._getActiveLayerUuid();a&&this._selectedActiveLayer(!1,a);var b=this.layerSelector.childNodes;for(var c in b)b[c].value==a&&(b[c].selected=!0)},_selectedActiveLayer:function(a,b){var c=b?b:a.target.value;if(this._layer=this._project.getLayer(c),this._layer){this._storeActiveLayerUuid(c),this.tooltipMeta=this._layer.getTooltip();var d=JSON.parse(this._layer.store.metadata);this.tooltipMeta||(this.tooltipMeta=this.createTooltipMeta(d)),this._fieldsWrapper.innerHTML="",this.initTitle(),this.initDescription(),this.initFields()}},initTitle:function(){var a=this.tooltipMeta.title,b=Wu.DomUtil.create("div","chrome-content-section-wrapper",this._fieldsWrapper),c=(Wu.DomUtil.create("div","chrome-content-header",b,"Title"),Wu.DomUtil.create("input","chrome-content-tooltip-title-field",b));c.id="tooltip-title-input",c.name="tooltip-title-input",c.setAttribute("placeholder",this._layer.store.title),a&&(c.value=a),Wu.DomEvent.on(c,"blur",this.saveTitle,this)},initDescription:function(){},initFields:function(){this.fieldListFromObject("Fields"),this.tooltipMeta.timeSeries&&this.initTimeSeries()},fieldListFromObject:function(a,b){var c=b?this.tooltipMeta.timeSeries:this.tooltipMeta.metaFields,d=Wu.DomUtil.create("div","chrome-content-section-wrapper",this._fieldsWrapper),e=(Wu.DomUtil.create("div","chrome-content-header",d,a),b?this._saveSwitchTimeSeries:this._saveSwitch),f=b?!1:!0;for(var g in c){var h=c[g].on,a=c[g].title;if("enable"==g||"minmaxRange"==g||"graphstyle"==g)return;var i=new Wu.fieldLine({id:g,appendTo:d,title:a,input:f,fn:this._saveFromBlur.bind(this)});new Wu.button({id:g,type:"switch",isOn:h,right:!1,appendTo:i.container,fn:e.bind(this)})}},initTimeSeries:function(){var a=(this.tooltipMeta.timeSeries,Wu.DomUtil.create("div","chrome-content-section-wrapper",this._fieldsWrapper)),b=Wu.DomUtil.create("div","chrome-content-header",a,"Time series"),c=(Wu.DomUtil.create("span","chrome-content-header-gray",b," (auto detected)"),new Wu.fieldLine({id:"enable",appendTo:a,title:"Enable time series",input:!1})),d=(new Wu.button({id:"enable",type:"switch",isOn:this.tooltipMeta.timeSeries.enable,right:!1,appendTo:c.container,fn:this._saveSwitch.bind(this)}),new Wu.fieldLine({id:"minmaxRange",appendTo:a,title:"Range",input:!1}));new Wu.button({id:"minmaxRange",type:"miniInput",right:!1,isOn:!0,appendTo:d.container,value:this.tooltipMeta.timeSeries.minmaxRange,placeholder:"auto",tabindex:1,fn:this._saveMiniBlur.bind(this)});this.fieldListFromObject("Time Series Fields",!0)},saveTitle:function(a){this.tooltipMeta.title=a.target.value,this._layer.setTooltip(this.tooltipMeta)},_saveMiniBlur:function(a){var b=a.target.id.substring(17,a.target.id.length),c=a.target.value;this._saveToServer(b,c)},_saveFromBlur:function(a){var b=a.target.id.substring(12,a.target.id.length),c=a.target.value,d=Wu.DomUtil.get("switch_"+b),e=d.getAttribute("state");if("true"==e)var f=!0;else var f=!1;this._saveToServer(b,f,c)},_saveSwitch:function(a,b){var c=a.target,d=c.getAttribute("key"),e=Wu.DomUtil.get("field_input_"+d),f=e?e.value:!1,f=e?e.value:!1;this._saveToServer(d,b,f)},_saveSwitchTimeSeries:function(a,b){var c=a.target,d=c.getAttribute("key"),e=Wu.DomUtil.get("field_input_"+d),f=e?e.value:!1,f=e?e.value:!1;this._saveToServer(d,b,f)},_saveToServer:function(a,b,c){if("enable"==a||"minmaxRange"==a||"graphstyle"==a)this.tooltipMeta.timeSeries[a]=b,this._layer.setTooltip(this.tooltipMeta);else{var d=this._validateDateFormat(a);if(d)var e=this.updateTimeSeriesMeta(a,c,b);e&&d||this.updateMeta(a,c,b)}this._layer.setTooltip(this.tooltipMeta)},updateTimeSeriesMeta:function(a,b,c){var d=this.tooltipMeta.timeSeries,e=!1;for(var f in d)f==a&&(d[f].title=!1,d[f].on=c,e=!0);return e},updateMeta:function(a,b,c){var d=this.tooltipMeta.metaFields;for(var e in d)if(e==a)return d[e].title=b,void(d[e].on=c)},open:function(){},_buildTooltipMeta:function(a){return this.createTooltipMeta(a)},createTooltipMeta:function(a){var b=a.columns,c=this.buildTimeSeries(b);return c[1]>5?c[0]:this.cleanColumns(b)},cleanColumns:function(a){var b={title:"",description:!1,metaFields:{},timeSeries:!1};for(var c in a)b.metaFields[c]={title:!1,on:!0};return b},buildTimeSeries:function(a){var b={title:"",description:!1,timeSeries:{},metaFields:{}},c=0;for(var d in a){var e=this._validateDateFormat(d);e?(b.timeSeries[d]={title:!1,on:!0},c++):b.metaFields[d]={title:!1,on:!0}}return b.timeSeries.enable=!0,[b,c]}}),Wu.Chrome.SettingsContent.SettingsSelector=Wu.Chrome.SettingsContent.extend({_:"settingsSelector",options:{tabs:{styler:{enabled:!0,text:"Style"},tooltip:{enabled:!0,text:"Popup"},filters:{enabled:!0,text:"Filters"},cartocss:{enabled:!0,text:"CartoCSS"},extras:{enabled:!0,text:"Extras"}}},_initialize:function(a){Wu.setOptions(this,a),this._initContainer(),this._initContent(),this._registerButton(),this._hide(),app.Tools=app.Tools||{},app.Tools.SettingsSelector=this},_refresh:function(){app.activeProject.isEditable()?Wu.DomUtil.removeClass(this._settingsButton,"disabledBtn"):Wu.DomUtil.addClass(this._settingsButton,"disabledBtn")},_initContainer:function(){this._container=Wu.DomUtil.create("div","chrome chrome-content settingsSelector",this.options.appendTo),this._header=Wu.DomUtil.create("div","settingsSelector-header",this._container),this._tabsWrapper=Wu.DomUtil.create("div","chrome chrome-content settings-tabs-wrapper",this._container)},_initContent:function(){this._initTabs()},_registerButton:function(){var a=app.Chrome.Top;this._settingsButton=a._registerButton({name:"settingsSelector",className:"chrome-button settingsSelector",trigger:this._togglePane,context:this,project_dependent:!0}),this._settingsButton.innerHTML='<i class="top-button fa fa-paint-brush"></i>Style'},_initTabs:function(){this._tabs={},this._buttonWrapper=Wu.DomUtil.create("div","chrome chrome-content settings-button-wrapper",this._header);for(var a in this.options.tabs)if(this.options.tabs[a].enabled){var b=this.options.tabs[a].text,c=a.camelize();if(Wu.Chrome.SettingsContent[c]){var d=Wu.DomUtil.create("div","chrome chrome-content settings-button",this._buttonWrapper,b);this._tabs[c]=new Wu.Chrome.SettingsContent[c]({options:this._options,trigger:d,appendTo:this._tabsWrapper,parent:this})}}},getTabs:function(){return this._tabs},_togglePane:function(){if(app.activeProject.isEditable()){var a=this.options.chrome;this._isOpen?a.close(this):a.open(this),this._isOpen&&app.Socket.sendUserEvent({user:app.Account.getFullName(),event:"opened",description:"the settings",timestamp:Date.now()})}},_show:function(){Wu.DomUtil.addClass(this._settingsButton,"active"),this._container.style.display="block",this._isOpen=!0,Wu.DomUtil.addClass(this._settingsButton,"active")},_hide:function(){Wu.DomUtil.removeClass(this._settingsButton,"active"),this._container.style.display="none",this._isOpen=!1,Wu.DomUtil.removeClass(this._settingsButton,"active")},onOpened:function(){this._tabs.Styler.show()},onClosed:function(){for(var a in this._tabs)this._tabs[a].closed();var b=app.MapPane.getControls().layermenu;b&&b.disableEdit()},_refreshAll:function(){for(var a in this._tabs)this._tabs[a]._refresh()}}),Wu.Chrome.SettingsContent.Styler=Wu.Chrome.SettingsContent.extend({_carto:{},options:{dropdown:{staticText:"Fixed value",staticDivider:"-"}},_initialize:function(){this._initContainer(),this._addEvents(),this._shortcut()},_shortcut:function(){app.Tools=app.Tools||{},app.Tools.Styler=this},_initContainer:function(){this._container=Wu.DomUtil.create("div","chrome chrome-content chrome-pane styler",this.options.appendTo)},_initLayout:function(){if(this._project){this._midSection=Wu.DomUtil.create("div","chrome-middle-section",this._container),this._midOuterScroller=Wu.DomUtil.create("div","chrome-middle-section-outer-scroller",this._midSection),this._midInnerScroller=Wu.DomUtil.create("div","chrome-middle-section-inner-scroller",this._midOuterScroller),this.layerSelector=this._initLayout_activeLayers(!1,!1,this._midInnerScroller),this._fieldsWrapper=Wu.DomUtil.create("div","chrome-field-wrapper",this._midInnerScroller);var a=Wu.DomUtil.create("div","button-wrapper",this._midInnerScroller);this._updateStyleButton=Wu.DomUtil.create("div","smooth-fullscreen-save update-style",a,"Update Style"),Wu.DomEvent.on(this._updateStyleButton,"click",this._updateStyle,this),this._inited=!0}},_initStyle:function(){this.getLayerMeta();var a={carto:this._carto,layer:this._layer,project:this._project,styler:this,meta:this._meta,columns:this._columns,container:this._fieldsWrapper};this._pointStyler=new Wu.Styler.Point(a),this._polygonStyler=new Wu.Styler.Polygon(a),this._lineStyler=new Wu.Styler.Line(a)},markChanged:function(){Wu.DomUtil.addClass(this._updateStyleButton,"marked-changed")},_updateStyle:function(){this._pointStyler.updateStyle(),this._polygonStyler.updateStyle(),this._lineStyler.updateStyle(),Wu.DomUtil.removeClass(this._updateStyleButton,"marked-changed")},_refresh:function(){this._flush(),this._initLayout()},_flush:function(){this._container.innerHTML=""},show:function(){this._inited||this._initLayout(),this.hideAll(),this._container.style.display="block",Wu.DomUtil.addClass(this.options.trigger,"active-tab");var a=this._getActiveLayerUuid();a&&this._selectedActiveLayer(!1,a);var b=this.layerSelector.childNodes;for(var c in b)b[c].value==a&&(b[c].selected=!0)},closed:function(){this._tempRemoveLayers()},_selectedActiveLayer:function(a,b){if(this._fieldsWrapper.innerHTML="",this.layerUuid=b?b:a.target.value,this._layer=this._project.getLayer(this.layerUuid),this._layer&&this._layer.isPostGIS()){this._storeActiveLayerUuid(this.layerUuid);var c=this._layer.getStyling();this.tabindex=1,this._carto=c||{},this._initStyle(),this._tempaddLayer()}},getLayerMeta:function(){var a=this._project.getLayer(this.layerUuid),b=(a.getTooltip(),a.getMeta());this._columns=b.columns,this._columns._columns=null,delete this._columns._columns,this._meta=[this.options.dropdown.staticText,this.options.dropdown.staticDivider];
for(var c in this._columns){var d=this._validateDateFormat(c);d||this._meta.push(c)}},createCarto:function(a,b){var c={style:a,columns:this._columns};Wu.post("/api/geo/json2carto",JSON.stringify(c),b.bind(this),this)}}),Wu.Styler=Wu.Class.extend({options:{defaults:{range:["#ff0000","#ffff00","#00ff00","#00ffff","#0000ff"],color:"#FF33FF",opacity:.5},dropdown:{staticText:"Fixed value",staticDivider:"-"},palettes:[["#ff0000","#ffff00","#00ff00","#00ffff","#0000ff"],["#0000ff","#00ffff","#00ff00","#ffff00","#ff0000"],["#f0f9e8","#bae4bc","#7bccc4","#43a2ca","#0868ac"],["#0868ac","#43a2ca","#7bccc4","#bae4bc","#f0f9e8"],["#ffffb2","#fecc5c","#fd8d3c","#f03b20","#bd0026"],["#bd0026","#f03b20","#fd8d3c","#fecc5c","#ffffb2"],["#feebe2","#fbb4b9","#f768a1","#c51b8a","#7a0177"],["#7a0177","#c51b8a","#f768a1","#fbb4b9","#feebe2"],["#d7191c","#fdae61","#ffffbf","#abdda4","#2b83ba"],["#2b83ba","#abdda4","#ffffbf","#fdae61","#d7191c"],["#d01c8b","#f1b6da","#f7f7f7","#b8e186","#4dac26"],["#4dac26","#b8e186","#f7f7f7","#f1b6da","#d01c8b"],["#e66101","#fdb863","#f7f7f7","#b2abd2","#5e3c99"],["#5e3c99","#b2abd2","#f7f7f7","#fdb863","#e66101"],["#ca0020","#f4a582","#f7f7f7","#92c5de","#0571b0"],["#0571b0","#92c5de","#f7f7f7","#f4a582","#ca0020"],["#ff00ff","#ffff00","#00ffff"],["#00ffff","#ffff00","#ff00ff"],["#ff0000","#ffff00","#00ff00"],["#00ff00","#ffff00","#ff0000"]],blendModes:["color","color-burn","color-dodge","contrast","darken","difference","dst","dst-atop","dst-in","dst-out","dst-over","exclusion","grain-extract","grain-merge","hard-light","hue","invert","invert-rgb","lighten","minus","multiply","overlay","plus","saturation","screen","soft-light","src","src-atop","src-in","src-out","src-over","value","xor"]},_content:{},carto:function(){return this.options.carto[this.type]},initialize:function(a){Wu.setOptions(this,a),this._initContainer()},_initContainer:function(){this.options.carto[this.type]=this.carto()||{},this._content[this.type]={};var a=this.carto().enabled;this._wrapper=Wu.DomUtil.create("div","chrome-content-section-wrapper toggles-wrapper",this.options.container);var b=new Wu.fieldLine({id:this.type,appendTo:this._wrapper,title:"<b>"+this.type.camelize()+"s</b>",input:!1});new Wu.button({id:this.type,type:"switch",isOn:a,right:!0,appendTo:b.container,fn:this._switch.bind(this)});this._toggle(a)},_switch:function(a,b){this._toggle(b),this.markChanged()},_toggle:function(a){a?this._enable():this._disable()},_enable:function(){this.carto().enabled=!0,this._createOptions(),this._preSelectOptions()},_disable:function(){this.carto().enabled=!1,this._clearOptions()},markChanged:function(){this._changed=!0,this.options.styler.markChanged()},updateStyle:function(){this._changed&&(this._createCarto(this.options.carto,this._saveCarto.bind(this)),this._changed=!1)},_createColor:function(){this.carto().color=this.carto().color||{};var a=this.carto().color.column===!1,b=this.carto().color.staticVal||this.options.defaults.color,c=this.carto().color.value||this.options.defaults.range,d=this.carto().color.column,e=this.carto().color.range,f=new Wu.fieldLine({id:"color",appendTo:this._wrapper,title:"<b>Color</b>",input:!1,childWrapper:"point-color-children"}),g=new Wu.button({id:"color",type:"dropdown",isOn:a,right:!0,appendTo:f.container,fn:this._dropdownSelected.bind(this),array:this.options.meta,selected:d}),h=new Wu.button({id:"color",type:"colorball",right:!0,isOn:a,appendTo:f.container,fn:this._updateColor.bind(this),value:b,colors:this.options.palettes,className:"target-color-box"});this._content[this.type].color={line:f,dropdown:g,ball:h},this.carto().color={column:d,range:e,staticVal:b,value:c}},_createOpacity:function(){this.carto().opacity=this.carto().opacity||{};var a=this.carto().opacity.column===!1,b=this.carto().opacity.staticVal,c=this.carto().opacity.column,d=this.carto().opacity.range,e=new Wu.fieldLine({id:"opacity",appendTo:this._wrapper,title:"<b>Opacity</b>",input:!1,childWrapper:"point-color-children"}),f=new Wu.button({id:"opacity",type:"dropdown",right:!0,appendTo:e.container,fn:this._dropdownSelected.bind(this),array:this.options.meta,selected:c}),g=new Wu.button({id:"opacity",type:"miniInput",right:!0,isOn:a,appendTo:e.container,value:b,placeholder:"auto",tabindex:this.tabindex++,fn:this._updateOpacity.bind(this)});this._content[this.type].opacity={line:e,dropdown:f,input:g},this.carto().opacity={column:c,range:d,staticVal:b}},_createBlendMode:function(){this.carto().blend=this.carto().blend||{};var a=this.carto().blend.mode||"screen",b=new Wu.fieldLine({id:"blendmode",appendTo:this._wrapper,title:"<b>Blend mode</b>",input:!1,childWrapper:"point-size-children"}),c=new Wu.button({id:"blendmode",type:"dropdown",right:!0,appendTo:b.container,fn:this._blendmodeSelected.bind(this),array:this.options.blendModes,selected:a});this._content[this.type].blendmode={line:b,dropdown:c},this.carto().blend={mode:a}},_blendmodeSelected:function(a){var b=a.target,c=b.options[b.selectedIndex].value;this.carto().blend.mode=c,this.markChanged()},_createPointsize:function(){this.carto().pointsize=this.carto().pointsize||{};var a=this.carto().pointsize.column===!1,b=this.carto().pointsize.staticVal||1.2,c=this.carto().pointsize.column,d=this.carto().pointsize.range,e=new Wu.fieldLine({id:"pointsize",appendTo:this._wrapper,title:"<b>Point size</b>",input:!1,childWrapper:"point-size-children"}),f=new Wu.button({id:"pointsize",type:"dropdown",right:!0,appendTo:e.container,fn:this._dropdownSelected.bind(this),array:this.options.meta,selected:c}),g=new Wu.button({id:"pointsize",type:"miniInput",right:!0,isOn:a,appendTo:e.container,value:b,placeholder:"auto",tabindex:this.tabindex++,fn:this._updatePointsize.bind(this)});this._content[this.type].pointsize={line:e,dropdown:f,input:g},this.carto().pointsize={column:c,range:d,staticVal:b}},_createWidth:function(){this.carto().width=this.carto().width||{};var a=this.carto().width.column===!1,b=this.carto().width.staticVal||1.2,c=this.carto().width.column,d=this.carto().width.range,e=new Wu.fieldLine({id:"width",appendTo:this._wrapper,title:"<b>Line width</b>",input:!1,childWrapper:"line-width-children"}),f=new Wu.button({id:"width",type:"dropdown",right:!0,appendTo:e.container,fn:this._dropdownSelected.bind(this),array:this.options.meta,selected:c}),g=new Wu.button({id:"width",type:"miniInput",right:!0,isOn:a,appendTo:e.container,value:b,placeholder:"auto",tabindex:this.tabindex++,fn:this._updateWidth.bind(this)});this._content[this.type].width={line:e,dropdown:f,input:g},this.carto().width={column:c,range:d,staticVal:b}},_addColorFields:function(a){var b=this.carto().color.value||this.options.defaults.range;if(_.isArray(b)){var c=this._content[this.type].color.line.childWrapper;c.innerHTML="";var d=Math.floor(10*this.options.columns[a].max)/10,e=Math.floor(10*this.options.columns[a].min)/10,f=this._content[this.type].color.range;f?f.line.container:!1;b.length<5&&(values=this._convertToFiveColors(b));var g=new Wu.fieldLine({id:"colorrange",appendTo:c,title:"Color range",input:!1,className:"sub-line"}),h=new Wu.button({id:"colorrange",type:"colorrange",right:!0,appendTo:g.container,presetFn:this.selectColorPreset.bind(this),value:b,colors:this.options.palettes});this._content[this.type].color.range={line:g,dropdown:h},this.carto().color.column=a,this.carto().color.value=b;var b=this.carto().color.range||[e,d];isNaN(b[0])&&(b[0]=e),isNaN(b[1])&&(b[1]=d);var g=new Wu.fieldLine({id:"minmaxcolorrange",appendTo:c,title:"Range",input:!1,className:"sub-line"}),i=new Wu.button({id:"minmaxcolorrange",type:"dualinput",right:!0,appendTo:g.container,value:b,fn:this.saveColorRangeDualBlur.bind(this),minmax:[e,d],tabindex:[this.tabindex++,this.tabindex++]});this._content[this.type].color.minmax={line:g,input:i},this.carto().color.range=b,this.markChanged()}},_addOpacityFields:function(a){var b=this._content[this.type].opacity.line.childWrapper;b.innerHTML="";var c=Math.floor(10*this.options.columns[a].max)/10,d=Math.floor(10*this.options.columns[a].min)/10,e=this.carto().opacity.range||[d,c],f=new Wu.fieldLine({id:"minmaxopacity",appendTo:b,title:"Range",input:!1,className:"sub-line"}),g=new Wu.button({id:"minmaxopacity",type:"dualinput",right:!0,appendTo:f.container,value:e,fn:this.saveOpacityDualBlur.bind(this),minmax:e,tabindex:[this.tabindex++,this.tabindex++]});this._content[this.type].opacity.minmax={line:f,input:g},this.carto().opacity.column=a,this.carto().opacity.range=e,this.markChanged()},_addWidthFields:function(a){var b=this._content[this.type].width.line.childWrapper;b.innerHTML="";var c=Math.floor(10*this.options.columns[a].max)/10,d=Math.floor(10*this.options.columns[a].min)/10,e=this.carto().width.range||[d,c],f=new Wu.fieldLine({id:"minmaxwidth",appendTo:b,title:"Range",input:!1,className:"sub-line"}),g=new Wu.button({id:"minmaxwidth",type:"dualinput",right:!0,appendTo:f.container,value:e,fn:this.saveWidthDualBlur.bind(this),minmax:e,tabindex:[this.tabindex++,this.tabindex++]});this._content[this.type].width.minmax={line:f,input:g},this.carto().width.column=a,this.carto().width.range=e,this.markChanged()},_updateColor:function(a,b,c){this.carto().color.staticVal=a,this._closeColorRangeSelector(),this.markChanged(),app.Socket.sendUserEvent({event:"`styled the "+this.type+"-color` on",description:this.options.layer.getTitle()+" (in project "+this.options.project.getName()+")"})},_updateWidth:function(){var a=this._content[this.type].width.input.input;this.carto().width.staticVal=a.value,this.markChanged(),app.Socket.sendUserEvent({event:"`styled the "+this.type+"-width` on",description:this.options.layer.getTitle()+" (in project "+this.options.project.getName()+")"})},_updateOpacity:function(a){var b=parseFloat(a.target.value),c=this._content[this.type].opacity.input.input;b>1&&10>b&&(b=1),b>10&&100>b&&(b/=100),b>100&&(b=1),c.value=b,this.carto().opacity.staticVal!=b&&(this.carto().opacity.staticVal=b,this.markChanged(),app.Socket.sendUserEvent({event:"`styled the "+this.type+"-opacity` on",description:this.options.layer.getTitle()+" (in project "+this.options.project.getName()+")"}))},_updatePointsize:function(a){var b=parseFloat(a.target.value),c=this._content[this.type].pointsize.input.input;c.value=b,this.carto().pointsize.staticVal!=b&&(this.carto().pointsize.staticVal=b,this.markChanged(),app.Socket.sendUserEvent({event:"`styled the "+this.type+"-size` on",description:this.options.layer.getTitle()+" (in project "+this.options.project.getName()+")"}))},_updateRange:function(a,b,c){var d=this._content[this.type].color.range.dropdown._colorball1,e=this._content[this.type].color.range.dropdown._colorball2,f=this._content[this.type].color.range.dropdown._colorball3;c.setAttribute("hex",a);var g=d.getAttribute("hex"),h=e.getAttribute("hex"),i=f.getAttribute("hex"),j=this._convertToFiveColors([g,h,i]),k=this._content[this.type].color.range.dropdown._color,l=this._gradientStyle(j);k.setAttribute("style",l),this.carto().color.value!=j&&(this.carto().color.value=j,this._closeColorRangeSelector(),this.markChanged(),app.Socket.sendUserEvent({event:"`styled the "+this.type+"-color range` on",description:this.options.layer.getTitle()+" (in project "+this.options.project.getName()+")"}))},saveColorRangeDualBlur:function(a,b,c,d){var e=[parseFloat(b||d),parseFloat(a||c)];_.isEqual(this.carto().color.range,e)||(this.carto().color.range=e,this.markChanged())},selectColorPreset:function(a){var b=a.target,c=b.getAttribute("hex"),d=c.split(","),e=this._convertToFiveColors(d),f=this._content[this.type].color.range.dropdown._color,g=this._content[this.type].color.range.dropdown._colorball1,h=this._content[this.type].color.range.dropdown._colorball2,i=this._content[this.type].color.range.dropdown._colorball3,j=this._gradientStyle(e);f.setAttribute("style",j),g.style.background=e[0],h.style.background=e[2],i.style.background=e[4],g.setAttribute("hex",e[0]),h.setAttribute("hex",e[2]),i.setAttribute("hex",e[4]),this._closeColorRangeSelector(),(this.carto().color.value[0]!=e[0]||this.carto().color.value[1]!=e[1]||this.carto().color.value[2]!=e[2]||this.carto().color.value[3]!=e[3]||this.carto().color.value[4]!=e[4])&&(this.carto().color.value=e,this.markChanged(),app.Socket.sendUserEvent({event:"`styled the "+this.type+"-color range` on",description:this.options.layer.getTitle()+" (in project "+this.options.project.getName()+")"}))},_dropdownSelected:function(a){var b=a.target.getAttribute("key"),c=a.target.value,d=a.target.parentElement,e=c==this.options.dropdown.staticText,f=c==this.options.dropdown.staticDivider,g=e||f;g?this._unselectField(b,d):this._selectField(b,d,c)},_selectField:function(a,b,c){if(Wu.DomUtil.addClass(b,"full-width"),this.carto()[a].column!=c){var d=this.carto()[a].staticVal;this.carto()[a]={},this.carto()[a].staticVal=d}if("opacity"==a){var e=this._content[this.type].opacity.input.input;Wu.DomUtil.addClass(e,"left-mini-kill")}if("pointsize"==a){var e=this._content[this.type].pointsize.input.input;Wu.DomUtil.addClass(e,"left-mini-kill")}if("color"==a){var f=this._content[this.type].color.ball.color;Wu.DomUtil.addClass(f,"disable-color-ball")}this.carto()[a].column=c,this._initSubfields(c,a),this.markChanged(),app.Socket.sendUserEvent({event:"`styled the "+this.type+"-"+a+"` by column `"+c+"` on layer",description:this.options.layer.getTitle()+" in project "+this.options.project.getName()})},_unselectField:function(a,b){if("opacity"==a){var c=this._content[this.type].opacity.input.input;Wu.DomUtil.removeClass(c,"left-mini-kill")}if("pointsize"==a){var c=this._content[this.type].pointsize.input.input;Wu.DomUtil.removeClass(c,"left-mini-kill")}if("color"==a){var d=this._content[this.type].color.ball.color;Wu.DomUtil.removeClass(d,"disable-color-ball")}if("width"==a){var d=this._content[this.type].width.input.input;Wu.DomUtil.removeClass(d,"left-mini-kill")}this._removeSubfields(a),Wu.DomUtil.removeClass(b,"full-width"),this.carto()[a].column=!1,this.markChanged()},_removeSubfields:function(a){var b=this._content[this.type][a].minmax,c=b?b.line.container:!1;if(c&&Wu.DomUtil.remove(c),"color"==a){var d=this._content[this.type].color.range,c=d?d.line.container:!1;c&&Wu.DomUtil.remove(c)}},_initSubfields:function(a,b){var c=this.options.carto[this.type][b].column,d=this.options.dropdown;c&&c!=d.staticText&&c!=d.staticDivider&&this._addSubfields(c,b)},_addSubfields:function(a,b){"color"==b&&this._addColorFields(a),"pointsize"==b&&this._addPointSizeFields(a),"opacity"==b&&this._addOpacityFields(a),"width"==b&&this._addWidthFields(a)},_getDefaultRange:function(a,b){var c=Math.floor(10*this.options.columns[a].max)/10,d=Math.floor(10*this.options.columns[a].min)/10,e=this.carto()[b].range||[d,c];return isNaN(e[0])&&(e[0]=d),isNaN(e[1])&&(e[1]=c),e},savePointSizeDualBlur:function(a,b,c,d){var a=a||c,b=b||d;this.carto().pointsize.range!=[b,a]&&(this.carto().pointsize.range=[b,a],this.markChanged(),app.Socket.sendUserEvent({event:"`styled the "+this.type+"-size` on",description:this.options.layer.getTitle()+" (in project "+this.options.project.getName()+")"}))},saveOpacityDualBlur:function(a,b,c,d){var b=parseFloat(b||d),a=parseFloat(a||c);this.carto().opacity.range!=[b,a]&&(this.carto().opacity.range=[b,a],this.markChanged(),app.Socket.sendUserEvent({event:"`styled the "+this.type+"-opacity` on",description:this.options.layer.getTitle()+" (in project "+this.options.project.getName()+")"}))},saveWidthDualBlur:function(a,b,c,d){var b=parseFloat(b||d),a=parseFloat(a||c);this.carto().width.range!=[b,a]&&(this.carto().width.range=[b,a],this.markChanged(),app.Socket.sendUserEvent({event:"`styled the "+this.type+"-width` on",description:this.options.layer.getTitle()+" (in project "+this.options.project.getName()+")"}))},_closeColorRangeSelector:function(){var a=this._content[this.type].color.range;if(a){var b=a.dropdown._colorSelectorWrapper,c=a.dropdown._clicker;b&&Wu.DomUtil.addClass(b,"displayNone"),c&&Wu.DomUtil.addClass(c,"displayNone")}},_createCarto:function(a,b){this.options.styler.createCarto(a,b)},_saveCarto:function(a,b){var c=this.options.layer;c.setStyling(this.options.carto);var d=c.getSQL(),e={css:b,sql:d,layer:c};this._updateLayer(e)},_updateLayer:function(a,b){var c=a.css,d=a.layer,e=d.getFileUuid(),f=a.sql,g=(this.options.project,d.store.data.postgis);g.sql=f,g.css=c,g.file_id=e;var h={geom_column:"the_geom_3857",geom_type:"geometry",raster_band:"",srid:"",affected_tables:"",interactivity:"",attributes:"",access_token:app.tokens.access_token,cartocss_version:"2.0.1",cartocss:c,sql:f,file_id:e,return_model:!0,layerUuid:d.getUuid()};Wu.post("/api/db/createLayer",JSON.stringify(h),function(a,c){var e=Wu.parse(c);return e.error?void(b&&b()):(d.updateStyle(e),void(b&&b()))}.bind(this))},_convertToFiveColors:function(a){if(2==a.length){var b=a[0],c=a[1],d=this.hexAverage([b,c]),e=this.hexAverage([b,d]),f=this.hexAverage([d,c]);a=[b,e,d,f,c]}if(3==a.length){var b=a[0],d=a[1],c=a[2],e=this.hexAverage([b,d]),f=this.hexAverage([d,c]);a=[b,e,d,f,c]}return 4==a.length&&a.pop(),a},hexAverage:function(a){return a.reduce(function(a,b){return b.replace(/^#/,"").match(/.{2}/g).map(function(b,c){return a[c]+parseInt(b,16)})},[0,0,0]).reduce(function(b,c){var d=this.padToTwo(Math.floor(c/a.length).toString(16));return b+d}.bind(this),"#")},padToTwo:function(a){return a.length<2&&(a="0"+a),a},_validateDateFormat:function(a){if("the_geom_3857"==a||"the_geom_4326"==a||"_columns"==a)return!1;var b=moment(a,["YYYYMMDD",moment.ISO_8601]).format("YYYY-MM-DD");if("Invalid date"!=b)return b;var b=moment(a).format("YYYY-MM-DD");return"Invalid date"!=b?b:!1},_gradientStyle:function(a){var b="background: -webkit-linear-gradient(left, "+a.join()+");";return b+="background: -o-linear-gradient(right, "+a.join()+");",b+="background: -moz-linear-gradient(right, "+a.join()+");",b+="background: linear-gradient(to right, "+a.join()+");"},_targetColumnSelected:function(a){var b=a.target,c=this._content[this.type].targets.selectors,d=_.findIndex(c,function(a){return a.column._select==b}),e=b.value;this.carto().targets[d].column=e,this.markChanged()},_targetColorSelected:function(a,b,c){var d=(c.target,this._content[this.type].targets.selectors),e=_.findIndex(d,function(a){return a.color.color==c});this.carto().targets[e].color=a,this.markChanged()},_targetValueSelected:function(a){var b=(a.target,this._content[this.type].targets.selectors),c=_.findIndex(b,function(b){return b.value==a.target}),d=a.target.value;this.carto().targets[c].value=d,this.markChanged()},_targetOpacitySelected:function(a){var b=(a.target,this._content[this.type].targets.selectors),c=_.findIndex(b,function(b){return b.opacity==a.target}),d=parseFloat(a.target.value);this.carto().targets[c].opacity=d,this.markChanged()},_targetWidthSelected:function(a){var b=(a.target,this._content[this.type].targets.selectors),c=_.findIndex(b,function(b){return b.width==a.target}),d=parseFloat(a.target.value);this.carto().targets[c].width=d,this.markChanged()},_removeTarget:function(a){var b=a.target,c=this._content[this.type].targets.selectors,d=_.findIndex(c,function(a){return a.wrapper==b.parentNode.parentNode||a.wrapper==b.parentNode}),e=c[d],f=e.wrapper;Wu.DomUtil.remove(f),_.pullAt(this.carto().targets,d),_.pullAt(c,d),this.markChanged()},_changeAddButtonText:function(){var a=Wu.DomUtil.get("target-text-"+this.type);a.innerHTML="Add column"},_addTargetColumn:function(a){var b=this.options.meta[2],c={column:b,value:"",color:"red",opacity:1,width:5,operator:"="};this.carto().targets.push({column:c.column,value:c.value,color:c.color,opacity:c.opacity,width:c.width,operator:c.operator}),this._createTargetColumn(null,c),this.markChanged(),this._changeAddButtonText()},_createTargets:function(){this.carto().targets=this.carto().targets||[];var a=Wu.DomUtil.create("div","add-target-wrapper",this._wrapper),b=Wu.DomUtil.create("div","add-target",a);b.innerHTML='<i class="fa fa-plus-circle add-target-icon"></i>',b.innerHTML+='<div id="target-text-'+this.type+'" class="add-target-text">Target specific columns</div>',Wu.DomEvent.on(b,"click",this._addTargetColumn,this),this._content[this.type].targets={wrapper:a,addTarget:b};var c=this.carto().targets;c.length&&(c.forEach(function(a){this._createTargetColumn(null,a)},this),this._changeAddButtonText())},_createTargetColumn:function(a,b){var c=this.options.columns,d=[];for(var e in c)d.push(e);var f=this._content[this.type].targets.wrapper,g=Wu.DomUtil.create("div","target-wrapper",f),h=Wu.DomUtil.create("div","target-remove",g);h.innerHTML='<i class="fa fa-minus-circle"></i>',Wu.DomEvent.on(h,"click",this._removeTarget,this);var i=Wu.DomUtil.create("div","target-column-wrapper",g),j=(Wu.DomUtil.create("div","target-column-title",i,"Column"),new Wu.button({id:"target",type:"dropdown",isOn:!0,right:!0,appendTo:i,fn:this._targetColumnSelected.bind(this),array:d,selected:b.column,className:"target-column-dropdown tiny"})),k=Wu.DomUtil.create("div","target-column-wrapper",g),l=new Wu.button({id:"equals_selection",type:"clicker",appendTo:k,fn:this._operatorSelected.bind(this),array:["<","=",">"],selected:b.operator,className:"target-equals-clicker"}),m=Wu.DomUtil.create("div","target-input-wrapper",g),n=(Wu.DomUtil.create("div","target-input-title",m,"Value"),Wu.DomUtil.create("input","target-input",m));n.value=b.value,Wu.DomEvent.on(n,"blur",this._targetValueSelected,this);var o=Wu.DomUtil.create("div","target-color-wrapper",g),p=(Wu.DomUtil.create("div","target-input-title",o,"Color"),new Wu.button({id:"target-color",type:"colorball",right:!0,isOn:!0,appendTo:o,fn:this._targetColorSelected.bind(this),value:b.color,colors:this.options.palettes,className:"target-color-box"})),q=Wu.DomUtil.create("div","target-opacity-wrapper",g),r=(Wu.DomUtil.create("div","target-input-title-opacity",q,"Opacity"),Wu.DomUtil.create("input","target-input opacity",q));r.value=b.opacity,Wu.DomEvent.on(r,"blur",this._targetOpacitySelected,this);var s=Wu.DomUtil.create("div","target-width-wrapper",g),t=(Wu.DomUtil.create("div","target-input-title-width",s,"Width"),Wu.DomUtil.create("input","target-input width",s));t.value=b.width,Wu.DomEvent.on(t,"blur",this._targetWidthSelected,this),this._content[this.type].targets.selectors=this._content[this.type].targets.selectors||[],this._content[this.type].targets.selectors.push({column:j,value:n,color:p,opacity:r,width:t,wrapper:g,operator:l});var u=this._content[this.type].targets.addTarget;this._content[this.type].targets.wrapper;f.appendChild(u)},_operatorSelected:function(a,b){var c=(a.target,this._content[this.type].targets.selectors),d=_.findIndex(c,function(b){return b.operator._button==a.target});this.carto().targets[d].operator=b,this.markChanged()}}),Wu.Styler.Polygon=Wu.Styler.extend({type:"polygon",_createOptions:function(){this._createColor(),this._createOpacity(),this._createTargets()},_preSelectOptions:function(){this._initSubfields(this.carto().color.column,"color"),this._initSubfields(this.carto().opacity.column,"opacity")},_clearOptions:function(){var a=this._content[this.type];if(!_.isEmpty(a)){var b=a.color.line.container,c=a.color.line.childWrapper,d=a.opacity.line.container,e=a.opacity.line.childWrapper,f=a.targets.wrapper;b&&Wu.DomUtil.remove(b),c&&Wu.DomUtil.remove(c),d&&Wu.DomUtil.remove(d),e&&Wu.DomUtil.remove(e),f&&Wu.DomUtil.remove(f)}},_createTargetColumn:function(a,b){var c=this.options.columns,d=[];for(var e in c)d.push(e);var f=this._content[this.type].targets.wrapper,g=Wu.DomUtil.create("div","target-wrapper",f),h=Wu.DomUtil.create("div","target-remove",g);h.innerHTML='<i class="fa fa-minus-circle"></i>',Wu.DomEvent.on(h,"click",this._removeTarget,this);var i=Wu.DomUtil.create("div","target-column-wrapper",g),j=(Wu.DomUtil.create("div","target-column-title",i,"Column"),new Wu.button({id:"target",type:"dropdown",isOn:!0,right:!0,appendTo:i,fn:this._targetColumnSelected.bind(this),array:d,selected:b.column,className:"target-column-dropdown tiny polygon"})),k=Wu.DomUtil.create("div","target-column-wrapper",g),l=new Wu.button({id:"equals_selection",type:"clicker",appendTo:k,fn:this._operatorSelected.bind(this),array:["<","=",">"],selected:b.operator,className:"target-equals-clicker"}),m=Wu.DomUtil.create("div","target-input-wrapper",g),n=(Wu.DomUtil.create("div","target-input-title",m,"Value"),Wu.DomUtil.create("input","target-input polygon",m));n.value=b.value,Wu.DomEvent.on(n,"blur",this._targetValueSelected,this);var o=Wu.DomUtil.create("div","target-color-wrapper",g),p=(Wu.DomUtil.create("div","target-input-title",o,"Color"),new Wu.button({id:"target-color",type:"colorball",right:!0,isOn:!0,appendTo:o,fn:this._targetColorSelected.bind(this),value:b.color,colors:this.options.palettes,className:"target-color-box"})),q=Wu.DomUtil.create("div","target-opacity-wrapper",g),r=(Wu.DomUtil.create("div","target-input-title-opacity",q,"Opacity"),Wu.DomUtil.create("input","target-input opacity",q));r.value=b.opacity,Wu.DomEvent.on(r,"blur",this._targetOpacitySelected,this),this._content[this.type].targets.selectors=this._content[this.type].targets.selectors||[],this._content[this.type].targets.selectors.push({column:j,value:n,color:p,opacity:r,wrapper:g,operator:l});var s=this._content[this.type].targets.addTarget;this._content[this.type].targets.wrapper;f.appendChild(s)}}),Wu.Styler.Point=Wu.Styler.extend({type:"point",_createOptions:function(){this._createColor(),this._createOpacity(),this._createPointsize(),this._createBlendMode(),this._createTargets()},_preSelectOptions:function(){this._initSubfields(this.carto().color.column,"color"),this._initSubfields(this.carto().opacity.column,"opacity"),this._initSubfields(this.carto().pointsize.column,"pointsize")},_clearOptions:function(){var a=this._content[this.type];if(!_.isEmpty(a)){var b=a.color.line.container,c=a.color.line.childWrapper,d=a.opacity.line.container,e=a.opacity.line.childWrapper,f=a.pointsize.line.container,g=a.pointsize.line.childWrapper,h=a.targets.wrapper;b&&Wu.DomUtil.remove(b),c&&Wu.DomUtil.remove(c),d&&Wu.DomUtil.remove(d),e&&Wu.DomUtil.remove(e),f&&Wu.DomUtil.remove(f),g&&Wu.DomUtil.remove(g),h&&Wu.DomUtil.remove(h)}},_addPointSizeFields:function(a){var b=this._content[this.type].pointsize.line.childWrapper;b.innerHTML="";var c=this.carto().pointsize.range||[1,10],d=new Wu.fieldLine({id:"minmaxpointsize",appendTo:b,title:"Min/max size",input:!1,className:"sub-line"}),e=new Wu.button({id:"minmaxpointsize",type:"dualinput",right:!0,appendTo:d.container,value:c,fn:this.savePointSizeDualBlur.bind(this),minmax:c,tabindex:[this.tabindex++,this.tabindex++]});this._content[this.type].pointsize.minmax={line:d,input:e},this.carto().pointsize.column=a,this.carto().pointsize.range=c,this.markChanged()}}),Wu.Styler.Line=Wu.Styler.extend({type:"line",_createOptions:function(){this._createColor(),this._createOpacity(),this._createWidth(),this._createTargets()},_preSelectOptions:function(){this._initSubfields(this.carto().color.column,"color"),this._initSubfields(this.carto().opacity.column,"opacity"),this._initSubfields(this.carto().width.column,"width")},_clearOptions:function(){var a=this._content[this.type];if(!_.isEmpty(a)){var b=a.color.line.container,c=a.color.line.childWrapper,d=a.opacity.line.container,e=a.opacity.line.childWrapper,f=a.width.line.container,g=a.width.line.childWrapper,h=a.targets.wrapper;b&&Wu.DomUtil.remove(b),c&&Wu.DomUtil.remove(c),d&&Wu.DomUtil.remove(d),e&&Wu.DomUtil.remove(e),f&&Wu.DomUtil.remove(f),g&&Wu.DomUtil.remove(g),h&&Wu.DomUtil.remove(h)}}}),Wu.Chrome.SettingsContent.Layers=Wu.Chrome.SettingsContent.extend({_initialize:function(){this._initContainer(),this._addEvents()},_initContainer:function(){this._container=Wu.DomUtil.create("div","chrome chrome-content chrome-pane layers",this.options.appendTo)},_initLayout:function(){this._project&&(this._topButtonWrapper=Wu.DomUtil.create("div","chrome-layers-top-button-wrapper",this._container),this._midSection=Wu.DomUtil.create("div","chrome-middle-section",this._container),this._midOuterScroller=Wu.DomUtil.create("div","chrome-middle-section-outer-scroller",this._midSection),this._midInnerScroller=Wu.DomUtil.create("div","chrome-middle-section-inner-scroller",this._midOuterScroller),this._fieldsWrapper=Wu.DomUtil.create("div","chrome-field-wrapper",this._midInnerScroller),this.initLayerBaselayerToggle(),this.initLayers(),this._inited=!0,this._mode="layer")},_refresh:function(){this._flush(),this._initLayout()},_flush:function(){this._container.innerHTML=""},show:function(){this._inited||this._initLayout(),this.hideAll(),this._container.style.display="block",Wu.DomUtil.addClass(this.options.trigger,"active-tab");var a=app.MapPane.getControls().layermenu;this._project.isEditable()&&a.enableEdit()},open:function(){},initLayerBaselayerToggle:function(){var a=Wu.DomUtil.create("div","chrome-layer-baselayer-toggle",this._topButtonWrapper);this.baselayerButton=Wu.DomUtil.create("div","chrome-layer-toggle-button chrome-baselayer",a,"BASE LAYERS"),this.layerButton=Wu.DomUtil.create("div","chrome-layer-toggle-button chrome-layer layer-toggle-active",a,"LAYERS"),Wu.DomEvent.on(this.layerButton,"click",this.toggleToLayers,this),Wu.DomEvent.on(this.baselayerButton,"click",this.toggleToBaseLayers,this)},toggleToBaseLayers:function(){Wu.DomUtil.addClass(this.baselayerButton,"layer-toggle-active"),Wu.DomUtil.removeClass(this.layerButton,"layer-toggle-active"),Wu.DomUtil.addClass(this._fieldsWrapper,"editing-baselayers"),this._mode="baselayer",this.update()},toggleToLayers:function(){Wu.DomUtil.removeClass(this.baselayerButton,"layer-toggle-active"),Wu.DomUtil.addClass(this.layerButton,"layer-toggle-active"),Wu.DomUtil.removeClass(this._fieldsWrapper,"editing-baselayers"),this._mode="layer",this.update()},initLayers:function(){this._layers={},_.isEmpty(this._project.layers)||(this.sortedLayers=this.sortLayers(this._project.layers),this.sortedLayers.forEach(function(a){var b=this.providerTitle(a.key),c=Wu.DomUtil.create("div","chrome-content-section-wrapper",this._fieldsWrapper);Wu.DomUtil.create("div","chrome-content-header",c,b);a.layers.forEach(function(a){this.addLayer(a,c)},this)},this),this.update())},addLayer:function(a,b){var c=a.getTitle(),d=a.store.uuid,e=!1;this._project.store.baseLayers.forEach(function(a){return d==a.uuid?void(e=!0):void 0}.bind(this)),layermenuItem=_.find(this._project.store.layermenu,function(a){return a.layer==d});var f=layermenuItem&&layermenuItem.enabled,g=new Wu.fieldLine({id:d,appendTo:b,title:c,input:!1});new Wu.button({id:d,type:"switch",isOn:e,right:!1,appendTo:g.container,fn:this._saveSwitch.bind(this)}),new Wu.button({id:d,type:"radio",isOn:f,right:!0,appendTo:g.container,fn:this._saveRadio.bind(this)})},providerTitle:function(a){if("postgis"==a)var b="Data Library";if("raster"==a)var b="Raster Overlays";if("mapbox"==a)var b="Mapbox";if("norkart"==a)var b="Norkart";if("google"==a)var b="Google";return"osm"==a?!1:b},sortLayers:function(a){var b=["postgis","raster","google","norkart","geojson","mapbox"],c=[];return b.forEach(function(b){var d={key:b,layers:[]};for(var e in a){var f=a[e];f&&f.store&&f.store.data.hasOwnProperty(b)&&d.layers.push(f)}c.push(d)},this),this.numberOfProviders=c.length,c},update:function(){this._mode||(this._mode="layer"),"baselayer"==this._mode&&this.markBaseLayerOccupied(),"layer"==this._mode&&this.markLayerOccupied(),this.updateSwitches(),this.updateRadios()},markBaseLayerOccupied:function(){var a=this._project.getLayermenuLayers(),b=this._project.getLayers();b.forEach(function(a){a.store&&this.activateLayer(a.store.uuid)},this),a.forEach(function(a){var c=_.find(b,function(b){return b.store?b.store.uuid==a.layer:!1});c&&this.deactivateLayer(c.store.uuid)},this)},markLayerOccupied:function(){var a=this._project,b=a.getBaselayers(),c=a.getLayers();c.forEach(function(a){this.activateLayer(a.store.uuid)},this),b.forEach(function(a){this.deactivateLayer(a.uuid)},this)},activateLayer:function(a){var b="field_wrapper_"+a,c=Wu.DomUtil.get(b);Wu.DomUtil.removeClass(c,"deactivated-layer");
},deactivateLayer:function(a){var b="field_wrapper_"+a,c=Wu.DomUtil.get(b);Wu.DomUtil.addClass(c,"deactivated-layer")},_saveRadio:function(a){var b=a.target,c=b.getAttribute("state");"true"==c?this.radioOn(b):this.radioOff(b)},radioOn:function(a){var b=a.id,c=b.slice(6,b.length),d=app.MapPane.getControls().layermenu;d._setEnabledOnInit(c,!0)},radioOff:function(a){var b=a.id,c=b.slice(6,b.length),d=app.MapPane.getControls().layermenu;d._setEnabledOnInit(c,!1)},updateRadios:function(){this.sortedLayers.forEach(function(a){a.layers.forEach(function(a){this.updateRadio(a)},this)},this)},updateRadio:function(a){var b=(a.getTitle(),a.store.uuid),c=!1;"layer"==this._mode&&this._project.store.layermenu.forEach(function(a){return b==a.layer?void(c=!0):void 0},this);var d=Wu.DomUtil.get("radio_"+b);c?Wu.DomUtil.removeClass(d,"displayNone"):Wu.DomUtil.addClass(d,"displayNone")},updateSwitches:function(){this.sortedLayers.forEach(function(a){a.layers.forEach(function(a){this.updateSwitch(a)},this)},this)},updateSwitch:function(a){var b=(a.getTitle(),a.store.uuid),c=!1;"baselayer"==this._mode&&this._project.store.baseLayers.forEach(function(a){return b==a.uuid?void(c=!0):void 0}.bind(this)),"layer"==this._mode&&this._project.store.layermenu.forEach(function(a){return b==a.layer?void(c=!0):void 0},this);var d=Wu.DomUtil.get("switch_"+b);c?(Wu.DomUtil.addClass(d,"switch-on"),d.setAttribute("state","true")):(Wu.DomUtil.removeClass(d,"switch-on"),d.setAttribute("state","false"))},_saveSwitch:function(a,b){var c=a.target.getAttribute("state"),d="true"==c,e=a.target.getAttribute("key");"baselayer"==this._mode?d?this.enableBaseLayer(e):this.disableBaseLayer(e):d?this.enableLayer(e):this.disableLayer(e),this.updateRadios()},enableBaseLayer:function(a){var b=this._project.layers[a];b&&b._addTo("baselayer"),this._project.addBaseLayer({uuid:a,zIndex:1,opacity:b.getOpacity()}),this.update()},disableBaseLayer:function(a){var b=this._project.layers[a];b&&b.disable(),this._project.removeBaseLayer(b),this.update()},enableLayer:function(a){var b=this._project.layers[a],c=app.MapPane.getControls().layermenu;c.add(b)},disableLayer:function(a){var b=this._project.layers[a],c=b.store.uuid,d=app.MapPane.getControls().layermenu;d._remove(c)}}),Wu.Chrome.SettingsContent.Extras=Wu.Chrome.SettingsContent.extend({_:"extras",options:{dropdown:{staticText:"None",staticDivider:"-"}},_initialize:function(){this._initContainer(),this._addEvents()},_initContainer:function(){this._container=Wu.DomUtil.create("div","chrome chrome-content chrome-pane extras",this.options.appendTo)},_initLayout:function(){this._layers=this._project.getDataLayers(),this._midSection=Wu.DomUtil.create("div","chrome-middle-section",this._container),this._midOuterScroller=Wu.DomUtil.create("div","chrome-middle-section-outer-scroller",this._midSection),this._midInnerScroller=Wu.DomUtil.create("div","chrome-middle-section-inner-scroller",this._midOuterScroller),this._initLayout_activeLayers("Layer","Select layer",this._midInnerScroller,this._layers),this._fieldsWrapper=Wu.DomUtil.create("div","chrome-field-wrapper",this._midInnerScroller)},_selectedActiveLayer:function(a,b){if(this.layerUuid=b?b:a.target.value,this._layer=this._project.getLayer(this.layerUuid),this._layer){this._storeActiveLayerUuid(this.layerUuid);var c=this._layer.getStyling();this.tabindex=1,this.cartoJSON=c||{},this.getLayerMeta(),this._tempaddLayer(),this._fieldsWrapper.innerHTML="",this.initGlobesarExtras()}},getLayerMeta:function(){var a=this._layer=this._project.getLayer(this.layerUuid);this.cartoJSON=a.getStyling();var b=(a.getTooltip(),a.getMeta());this.columns=b.columns,this.metaFields=[this.options.dropdown.staticText,this.options.dropdown.staticDivider];for(var c in this.columns){var d=this._validateDateFormat(c);d||this.metaFields.push(c)}},initGlobesarExtras:function(){this.cartoJSON.extras&&this.cartoJSON.extras.referencepoint||(this.cartoJSON.extras={referencepoint:{column:!1,value:!1}});var a=Wu.DomUtil.create("div","chrome-content-section-wrapper",this._fieldsWrapper);Wu.DomUtil.create("div","chrome-content-header globesar-extras",a,"Globesar Extras");this.layer=this._project.getLayer(this.layerUuid);var b=Wu.parse(this.layer.getSatellitePosition()),c=b.path?b.path:!1,d=b.angle?b.angle:!1,e=new Wu.fieldLine({id:"satelliteAngle",appendTo:a,title:"Satellite angle",input:!1}),f=(new Wu.button({id:"satelliteAngle",type:"miniInput",right:!0,isOn:!0,appendTo:e.container,value:d,placeholder:"none",className:"globesar-extras-input",tabindex:1,fn:this._saveMiniBlur.bind(this)}),new Wu.fieldLine({id:"satellitePath",appendTo:a,title:"Satellite path",input:!1})),g=(new Wu.button({id:"satellitePath",type:"miniInput",right:!0,isOn:!0,appendTo:f.container,value:c,placeholder:"none",className:"globesar-extras-input",tabindex:2,fn:this._saveMiniBlur.bind(this)}),new Wu.fieldLine({id:"referencepoint",appendTo:a,title:"Reference point",input:!1})),h=this.cartoJSON.extras.referencepoint.column,i=this.cartoJSON.extras.referencepoint.value,j=h?!1:!0;new Wu.button({id:"referencepoint",type:"dropdown",right:!0,appendTo:g.container,fn:this._selectedMiniDropDown.bind(this),array:this.metaFields,selected:h,reversed:!0,className:"globesar-extras-ref-point-dropdown"}),new Wu.button({id:"referencepoint",type:"miniInput",right:!0,isOn:!j,appendTo:g.container,value:i,placeholder:"value",tabindex:3,className:"globesar-extras-input",allowText:!0,fn:this._blurRefPointValue.bind(this)})},_selectedMiniDropDown:function(a){var b=(a.target.getAttribute("key"),a.target.value),c=a.target.parentElement,d=Wu.DomUtil.get("field_mini_input_referencepoint");return b==this.options.dropdown.staticText||b==this.options.dropdown.staticDivider?(this.selectedColumn=!1,this.cartoJSON.extras={referencepoint:!1},Wu.DomUtil.addClass(d,"left-mini-kill"),void Wu.DomUtil.addClass(c,"full-width")):(this.selectedColumn=b,this._saveRefPointValue(),Wu.DomUtil.removeClass(d,"left-mini-kill"),void Wu.DomUtil.removeClass(c,"full-width"))},_blurRefPointValue:function(a){this.selectedValue=a.target.value,this._saveRefPointValue()},_saveRefPointValue:function(){var a=this.selectedValue,b=this.selectedColumn;a&&""!=a&&b!=this.options.staticText&&b!=this.options.staticDivider?this.cartoJSON.extras={referencepoint:{column:b,value:a}}:this.cartoJSON.extras={referencepoint:!1},this._updateStyle()},_saveMiniBlur:function(a){var b=Wu.DomUtil.get("field_mini_input_satelliteAngle").value,c=Wu.DomUtil.get("field_mini_input_satellitePath").value;this.layer=this._project.getLayer(this.layerUuid),this.satpos={},c&&(this.satpos.path=c),b&&(this.satpos.angle=b);var d=this.satpos;this.layer.setSatellitePosition(JSON.stringify(d)),app.MapPane._controls.description.setHTMLfromStore(this.layerUuid)},_refresh:function(){this._flush(),this._initLayout()},_flush:function(){this._container.innerHTML=""},_updateStyle:function(){this.getCartoCSSFromJSON(this.cartoJSON,function(a,b){this.saveCartoJSON(b)})},getCartoCSSFromJSON:function(a,b){var c={styleJSON:a,columns:this.columns};Wu.post("/api/geo/json2carto",JSON.stringify(c),b.bind(this),this)},saveCartoJSON:function(a){this._layer.setStyling(this.cartoJSON);var b=this._layer.getSQL(),c={css:a,sql:b,layer:this._layer};this._updateLayer(c)},_updateLayer:function(a,b){var c=a.css,d=a.layer,e=d.getFileUuid(),f=a.sql,g=(this._project,d.store.data.postgis);g.sql=f,g.css=c,g.file_id=e;var h={geom_column:"the_geom_3857",geom_type:"geometry",raster_band:"",srid:"",affected_tables:"",interactivity:"",attributes:"",access_token:app.tokens.access_token,cartocss_version:"2.0.1",cartocss:c,sql:f,file_id:e,return_model:!0,layerUuid:d.getUuid()};Wu.post("/api/db/createLayer",JSON.stringify(h),function(a,c){var e=Wu.parse(c);return e.error?void(b&&b()):(d.updateStyle(e),void(b&&b()))}.bind(this))}}),Wu.Control=L.Control.extend({initialize:function(a){Wu.setOptions(this,a),this._listen(),this._initialize(a)},_listen:function(){Wu.Mixin.Events.on("projectSelected",this._projectSelected,this),Wu.Mixin.Events.on("editEnabled",this._editEnabled,this),Wu.Mixin.Events.on("editDisabled",this._editDisabled,this),Wu.Mixin.Events.on("layerEnabled",this._layerEnabled,this),Wu.Mixin.Events.on("layerDisabled",this._layerDisabled,this),Wu.Mixin.Events.on("layerAdded",this._onLayerAdded,this),Wu.Mixin.Events.on("layerEdited",this._onLayerEdited,this),Wu.Mixin.Events.on("layerStyleEdited",this._onLayerStyleEdited,this),Wu.Mixin.Events.on("layerDeleted",this._onLayerDeleted,this),Wu.Mixin.Events.on("fileImported",this._onFileImported,this),Wu.Mixin.Events.on("fileDeleted",this._onFileDeleted,this)},_projectSelected:function(a){var b=a.detail.projectUuid;return b?(this._project=app.activeProject=app.Projects[b],void this._refresh()):(this._project=null,this._off())},_initialize:function(){},_editEnabled:function(){},_editDisabled:function(){},_layerEnabled:function(){},_layerDisabled:function(){},_updateView:function(){},_refresh:function(){},_onFileImported:function(){},_onFileDeleted:function(){},_onLayerAdded:function(){},_onLayerEdited:function(){},_onLayerStyleEdited:function(){},_onLayerDeleted:function(){},_off:function(){}}),L.Control.Zoom=Wu.Control.extend({type:"zoom",options:{position:"topleft",zoomInText:"+",zoomInTitle:"Zoom in",zoomOutText:"-",zoomOutTitle:"Zoom out"},_on:function(){this._show()},_off:function(){this._hide()},_show:function(){this._container.style.display="block"},_hide:function(){this._container.style.display="none"},_addTo:function(){this.addTo(app._map),this._added=!0},_refresh:function(){this._added||this._addTo();var a=this._project.getControls()[this.type];return a?void this._flush():this._hide()},_flush:function(){},onAdd:function(a){var b="leaflet-control-zoom",c=L.DomUtil.create("div",b+" leaflet-bar");return this._map=a,this._zoomInButton=this._createButton(this.options.zoomInText,this.options.zoomInTitle,b+"-in",c,this._zoomIn,this),this._zoomOutButton=this._createButton(this.options.zoomOutText,this.options.zoomOutTitle,b+"-out",c,this._zoomOut,this),this._updateDisabled(),a.on("zoomend zoomlevelschange",this._updateDisabled,this),c},onRemove:function(a){a.off("zoomend zoomlevelschange",this._updateDisabled,this)},_zoomIn:function(a){this._map.zoomIn(a.shiftKey?3:1)},_zoomOut:function(a){this._map.zoomOut(a.shiftKey?3:1)},_createButton:function(a,b,c,d,e,f){var g=L.DomUtil.create("a",c,d);g.innerHTML=a,g.href="#",g.title=b;var h=L.DomEvent.stopPropagation;return L.DomEvent.on(g,"click",h).on(g,"mousedown",h).on(g,"dblclick",h).on(g,"click",L.DomEvent.preventDefault).on(g,"click",e,f).on(g,"click",this._refocusOnMap,f),g},_updateDisabled:function(){var a=this._map,b="leaflet-disabled";L.DomUtil.removeClass(this._zoomInButton,b),L.DomUtil.removeClass(this._zoomOutButton,b),a._zoom===a.getMinZoom()&&L.DomUtil.addClass(this._zoomOutButton,b),a._zoom===a.getMaxZoom()&&L.DomUtil.addClass(this._zoomInButton,b)}}),L.Map.mergeOptions({zoomControl:!0}),L.Map.addInitHook(function(){this.options.zoomControl&&(this.zoomControl=new L.Control.Zoom,this.addControl(this.zoomControl))}),L.control.zoom=function(a){return new L.Control.Zoom(a)},L.GeoJSON=L.FeatureGroup.extend({initialize:function(a,b){L.setOptions(this,b),this._layers={},a&&this.addData(a)},addData:function(a){var b,c,d,e=L.Util.isArray(a)?a:a.features;if(e){for(b=0,c=e.length;c>b;b++)d=e[b],(d.geometries||d.geometry||d.features||d.coordinates)&&this.addData(e[b]);return this}var f=this.options;if(!f.filter||f.filter(a)){var g=L.GeoJSON.geometryToLayer(a,f.pointToLayer,f.coordsToLatLng,f);return g.feature=L.GeoJSON.asFeature(a),g.defaultOptions=g.options,this.resetStyle(g),f.onEachFeature&&f.onEachFeature(a,g),this.addLayer(g)}},resetStyle:function(a){var b=this.options.style;b&&(L.Util.extend(a.options,a.defaultOptions),this._setLayerStyle(a,b))},setStyle:function(a){this.eachLayer(function(b){this._setLayerStyle(b,a)},this)},_setLayerStyle:function(a,b){"function"==typeof b&&(b=b(a.feature)),a.setStyle&&a.setStyle(b)}}),L.extend(L.GeoJSON,{geometryToLayer:function(a,b,c,d){var e,f,g,h,i="Feature"===a.type?a.geometry:a,j=i.coordinates,k=[];switch(c=c||this.coordsToLatLng,i.type.toLowerCase()){case"point":return e=c(j),b?b(a,e):new L.Marker(e);case"multipoint":for(g=0,h=j.length;h>g;g++)e=c(j[g]),k.push(b?b(a,e):new L.Marker(e));return new L.FeatureGroup(k);case"linestring":return f=this.coordsToLatLngs(j,0,c),new L.Polyline(f,d);case"polygon":if(2===j.length&&!j[1].length)throw new Error("Invalid GeoJSON object.");return f=this.coordsToLatLngs(j,1,c),new L.Polygon(f,d);case"multilinestring":return f=this.coordsToLatLngs(j,1,c),new L.MultiPolyline(f,d);case"multipolygon":return f=this.coordsToLatLngs(j,2,c),new L.MultiPolygon(f,d);case"geometrycollection":for(g=0,h=i.geometries.length;h>g;g++)k.push(this.geometryToLayer({geometry:i.geometries[g],type:"Feature",properties:a.properties},b,c,d));return new L.FeatureGroup(k);case"circle":var l=j[0];return e=new L.LatLng(l[1],l[0]),new L.Circle(e,i.radius);default:throw new Error("Invalid GeoJSON object.")}},coordsToLatLng:function(a){return new L.LatLng(a[1],a[0],a[2])},coordsToLatLngs:function(a,b,c){var d,e,f,g=[];for(e=0,f=a.length;f>e;e++)d=b?this.coordsToLatLngs(a[e],b-1,c):(c||this.coordsToLatLng)(a[e]),g.push(d);return g},latLngToCoords:function(a){var b=[a.lng,a.lat];return void 0!==a.alt&&b.push(a.alt),b},latLngsToCoords:function(a){for(var b=[],c=0,d=a.length;d>c;c++)b.push(L.GeoJSON.latLngToCoords(a[c]));return b},getFeature:function(a,b){return a.feature?L.extend({},a.feature,{geometry:b}):L.GeoJSON.asFeature(b)},asFeature:function(a){return"Feature"===a.type?a:{type:"Feature",properties:{},geometry:a}}});var PointToGeoJSON={toGeoJSON:function(){return L.GeoJSON.getFeature(this,{type:"Point",coordinates:L.GeoJSON.latLngToCoords(this.getLatLng())})}};L.Marker.include(PointToGeoJSON),L.CircleMarker.include(PointToGeoJSON),L.Circle.include({toGeoJSON:function(){return{type:"Circle",coordinates:[[this.getLatLng().lng,this.getLatLng().lat]],radius:this.getRadius()}}}),L.Polyline.include({toGeoJSON:function(){return L.GeoJSON.getFeature(this,{type:"LineString",coordinates:L.GeoJSON.latLngsToCoords(this.getLatLngs())})}}),L.Polygon.include({toGeoJSON:function(){var a,b,c,d=[L.GeoJSON.latLngsToCoords(this.getLatLngs())];if(d[0].push(d[0][0]),this._holes)for(a=0,b=this._holes.length;b>a;a++)c=L.GeoJSON.latLngsToCoords(this._holes[a]),c.push(c[0]),d.push(c);return L.GeoJSON.getFeature(this,{type:"Polygon",coordinates:d})}}),function(){function a(a){return function(){var b=[];return this.eachLayer(function(a){b.push(a.toGeoJSON().geometry.coordinates)}),L.GeoJSON.getFeature(this,{type:a,coordinates:b})}}L.LayerGroup.include({toGeoJSON:function(){var b,c=this.feature&&this.feature.geometry,d=[];if(c&&"MultiPoint"===c.type)return a("MultiPoint").call(this);var e=c&&"GeometryCollection"===c.type;return this.eachLayer(function(a){a.toGeoJSON&&(b=a.toGeoJSON(),d.push(e?b.geometry:L.GeoJSON.asFeature(b)))}),e?L.GeoJSON.getFeature(this,{geometries:d,type:"GeometryCollection"}):{type:"FeatureCollection",features:d}}})}(),L.geoJson=function(a,b){return new L.GeoJSON(a,b)},L.Control.Draw=Wu.Control.extend({options:{position:"topleft",draw:{polyline:!1,rectangle:!1,circle:!1,marker:!1,polygon:{showArea:!0,allowIntersection:!1,drawError:{color:"red",message:"<strong>Oh snap!<strong> you can't draw that!"},shapeOptions:{color:"blue"},smoothFactor:.5}}},type:"draw",_flush:function(){},_addTo:function(){app._map&&(this.addTo(app._map),this._addHooks(),this._added=!0)},_addHooks:function(){var a=app._map;a.on("draw:created",this._drawCreated.bind(this)),a.on("draw:edited",this._drawEdited.bind(this)),a.on("draw:deleted",this._drawDeleted.bind(this)),a.on("draw:editstart",this._drawEditstart.bind(this)),a.on("draw:editstop",this._drawEditstop.bind(this)),a.on("draw:drawstop",this._drawDrawstop.bind(this)),a.on("draw:drawstart",this._drawDrawstart.bind(this)),keymaster("d",this._toggleDraw.bind(this)),keymaster("e",this._toggleEdit.bind(this)),keymaster("c",this._clearAll.bind(this));var b=this._toolbars.edit._modes.remove.button;Wu.DomEvent.on(b,"click",this._clearAll,this)},_clearAll:function(){var a=this._toolbars.edit._modes.remove.handler,b=this._toolbars.edit._modes.edit.handler,c=a._deletableLayers.getLayers();c.forEach(function(c){a._deletableLayers.removeLayer(c),a.save(),a.disable(),b.disable(),app.MapPane._clearPopup()},this),c.length||app.MapPane._clearPopup()},_drawCreated:function(a){var b=(a.layerType,a.layer);this._layerContainer.addLayer(b),this._queryData(b),this._addLayerEvents(b)},_queryData:function(a){var b=a.toGeoJSON();this._fetchData({geojson:b,layer:a},function(b,c){var d=Wu.parse(c);d.center=a.getBounds().getCenter(),app.MapPane._addPopupContentDraw(d),app.MapPane._creatingPolygon=!1,this._latestFetch=d;var e=this._getPostGISLayerName(d.layer_id);app.Analytics.onPolygonQuery({result:d,layer_name:e})}.bind(this))},_getPostGISLayerName:function(a){var b=this._project.getPostGISLayer(a);return b?b.getTitle():"unknown"},_addLayerEvents:function(a){a.on("deleted",function(a){var b=this._toolbars.edit._modes.remove.handler;b.save(),b.disable()}.bind(this))},_drawEdited:function(a){var b=this._getEditedLayer(a);b&&this._queryData(b)},_getEditedLayer:function(a){var b=a.layers._layers;for(var c in b)return b[c]},_drawEditstart:function(a){app.MapPane._drawing=!0},_drawEditstop:function(a){app.MapPane._drawing=!1},_drawDrawstart:function(a){app.MapPane._drawing=!0},_drawDrawstop:function(a){app.MapPane._drawing=!1},_drawDeleted:function(a){},_fetchData:function(a,b){var c=this._getActiveLayerID();if(!c)return void app.FeedbackPane.setMessage({title:"No active layer to fetch data from."});var a={access_token:app.tokens.access_token,geojson:a.geojson,layer_id:c};Wu.send("/api/db/fetchArea",a,b,this)},_getActiveLayerID:function(){var a=app.MapPane._layermenuZIndex._index[0];if(!(a&&a.store&&a.store.data&&a.store.data.postgis))return!1;var b=a.store.data.postgis.layer_id;return b},_getActiveLayer:function(){var a=this._getActiveLayerID(),b=app.activeProject.getLayers(),c=_.find(b,function(b){return b.store&&b.store.data&&b.store.data.postgis?b.store.data.postgis==a:!1});return c},_getActiveLayerName:function(){var a=this._getActiveLayer();return a?a.getTitle():"No layer"},_toggleDraw:function(){this._drawEnabled?(this._toolbars.draw._modes.polygon.handler.disable(),this._drawEnabled=!1):(this._toolbars.draw._modes.polygon.handler.enable(),this._drawEnabled=!0)},_toggleEdit:function(){this._editEnabled?(this._toolbars.edit._modes.edit.handler.save(),this._toolbars.edit._modes.edit.handler.disable(),this._editEnabled=!1):(this._toolbars.edit._modes.edit.handler.enable(),this._editEnabled=!0)},_refresh:function(){this._added||this._addTo(app._map);var a=this._project.getControls()[this.type];return a?(this._flush(),void this._show()):this._hide()},_projectSelected:function(a){var b=a.detail.projectUuid;return b?(this._project=app.activeProject=app.Projects[b],void this._refresh()):(this._project=null,this._off())},_on:function(){this._refresh(),this._initContent()},_off:function(){this._hide()},_isActive:function(){return this._project?this._project.getControls()[this.type]:!1},_show:function(){this._container.style.display="block"},_hide:function(){this._container.style.display="none"},show:function(){this._container&&(this._isActive()?this._show():this._hide())},hide:function(){this._container&&this._hide()},_initContent:function(){},refresh:function(){this.addTo(app._map)},onRemove:function(a){},_initialize:function(a){this._layerContainer=new L.FeatureGroup,app._map.addLayer(this._layerContainer),this.options.edit={featureGroup:this._layerContainer};var b;this._toolbars={},L.DrawToolbar&&this.options.draw&&(b=new L.DrawToolbar(this.options.draw),this._toolbars[L.DrawToolbar.TYPE]=b,this._toolbars[L.DrawToolbar.TYPE].on("enable",this._toolbarEnabled,this)),L.EditToolbar&&this.options.edit&&(b=new L.EditToolbar(this.options.edit),this._toolbars[L.EditToolbar.TYPE]=b,this._toolbars[L.EditToolbar.TYPE].on("enable",this._toolbarEnabled,this))},onAdd:function(a){var b,c=L.DomUtil.create("div","leaflet-draw"),d=!1,e="leaflet-draw-toolbar-top";for(var f in this._toolbars)this._toolbars.hasOwnProperty(f)&&(b=this._toolbars[f].addToolbar(a),b&&(d||(L.DomUtil.hasClass(b,e)||L.DomUtil.addClass(b.childNodes[0],e),d=!0),c.appendChild(b)));return c},onRemove:function(){for(var a in this._toolbars)this._toolbars.hasOwnProperty(a)&&this._toolbars[a].removeToolbar()},setDrawingOptions:function(a){for(var b in this._toolbars)this._toolbars[b]instanceof L.DrawToolbar&&this._toolbars[b].setOptions(a)},_toolbarEnabled:function(a){var b=a.target;for(var c in this._toolbars)this._toolbars[c]!==b&&this._toolbars[c].disable()}}),L.drawControl=function(a){return new L.Control.Draw(a)},Wu.ZIndexControl=Wu.Class.extend({initialize:function(){this._index=[],app.zIndex=this},add:function(a){this._index.push(a),this.enforce()},remove:function(a){_.remove(this._index,function(b){return b==a}),this.enforce()},set:function(a,b){},get:function(a){return a?_.findIndex(this._index,function(b){return a==b}):this._index},getIndex:function(){var a=[];return this._index.forEach(function(b){a.push(b.getTitle())}),a},up:function(a){var b=this.get(a);this._move(b,b+1),this.enforce()},_move:function(a,b){this._index.splice(b,0,this._index.splice(a,1)[0])},down:function(a){var b=this.get(a);this._move(b,b-1),this.enforce()},top:function(a){},bottom:function(a){},enforce:function(){var a=this._index;a.forEach(function(a,b){var c=b+this._z;a._setZIndex(c)},this)}}),Wu.ZIndexControl.Baselayers=Wu.ZIndexControl.extend({_z:0,_me:"base"}),Wu.ZIndexControl.Layermenu=Wu.ZIndexControl.extend({_z:1e3,_me:"layermenu"}),L.Control.Measure=Wu.Control.extend({type:"measure",options:{position:"topright",maxWidth:100,metric:!0,imperial:!0,updateWhenIdle:!1},onAdd:function(a){this._map=a;var b="leaflet-control-scale",c=L.DomUtil.create("div",b),d=this.options;return this._addScales(d,b,c),a.on(d.updateWhenIdle?"moveend":"move",this._update,this),a.whenReady(this._update,this),c},onRemove:function(a){a.off(this.options.updateWhenIdle?"moveend":"move",this._update,this)},_addTo:function(){this.addTo(app._map),this._added=!0,this._addStops()},_addStops:function(){L.DomEvent.on(this._container,"dblclick",Wu.DomEvent.stop,this),L.DomEvent.on(this._container,"mousedown",Wu.DomEvent.stop,this),L.DomEvent.on(this._container,"mouseup",Wu.DomEvent.stop,this)},_refresh:function(){this._added||this._addTo();var a=this._project.getControls()[this.type];return a?void this._show():this._hide()},_show:function(){this._container.style.display="inline-block"},_hide:function(){this._container.style.display="none"},_on:function(){this._show()},_off:function(){this._hide()},_addScales:function(a,b,c){a.metric&&(this._mScale=L.DomUtil.create("div",b+"-line",c)),a.imperial&&(this._iScale=L.DomUtil.create("div",b+"-line",c))},_update:function(){var a=this._map.getBounds(),b=a.getCenter().lat,c=6378137*Math.PI*Math.cos(b*Math.PI/180),d=c*(a.getNorthEast().lng-a.getSouthWest().lng)/180,e=this._map.getSize(),f=this.options,g=0;e.x>0&&(g=d*(f.maxWidth/e.x)),this._updateScales(f,g)},_updateScales:function(a,b){a.metric&&b&&this._updateMetric(b),a.imperial&&b&&this._updateImperial(b)},_updateMetric:function(a){var b=this._getRoundNum(a);this._mScale.style.width=this._getScaleWidth(b/a)+"px",this._mScale.innerHTML=1e3>b?b+" m":b/1e3+" km"},_updateImperial:function(a){var b,c,d,e=3.2808399*a,f=this._iScale;e>5280?(b=e/5280,c=this._getRoundNum(b),f.style.width=this._getScaleWidth(c/b)+"px",f.innerHTML=c+" mi"):(d=this._getRoundNum(e),f.style.width=this._getScaleWidth(d/e)+"px",f.innerHTML=d+" ft")},_getScaleWidth:function(a){return Math.round(this.options.maxWidth*a)-10},_getRoundNum:function(a){var b=Math.pow(10,(Math.floor(a)+"").length-1),c=a/b;return c=c>=10?10:c>=5?5:c>=3?3:c>=2?2:1,b*c}}),L.control.scale=function(a){return new L.Control.Scale(a)},function(){L.Control.Geolocation=Wu.Control.extend({type:"geolocation",includes:L.Mixin.Events,options:{wrapper:"",url:"",jsonpParam:null,layer:null,callData:null,propertyName:"title",propertyLoc:"loc",callTip:null,filterJSON:null,minLength:3,initial:!0,autoType:!0,delayType:200,tooltipLimit:-1,tipAutoSubmit:!0,autoResize:!0,collapsed:!0,autoCollapse:!0,autoCollapseTime:1200,zoom:14,box:!0,text:"Enter address...",textCancel:"Cancel",textErr:"Unknown address.",position:"topleft",animateLocation:!1,circleLocation:!0,markerLocation:!1,markerIcon:new L.Icon.Default,url:"https://nominatim.openstreetmap.org/search?format=json&q={s}",jsonpParam:"json_callback",propertyName:"display_name",propertyLoc:["lat","lon"],boundingBox:"boundingbox",filterJSON:function(a){var b,c=[];for(b in a){var d=a[b];if(d.hasOwnProperty("type"))var e={address:d.display_name,boundingbox:d.boundingbox,latlng:L.latLng(d.lat,d.lon),type:d.type};c.push(e)}var f=_.unique(c,function(a){return a?a.address:void 0});return f}},_initialize:function(a){return this._inputMinSize=this.options.text?this.options.text.length:10,this._layer=this.options.layer||new L.LayerGroup,this._filterJSON=this.options.filterJSON||this._defaultFilterJSON,this._autoTypeTmp=this.options.autoType,this._countertips=0,this._recordsCache={},this},onAdd:function(b){this._map=b;var c=this._container=L.DomUtil.create("div","leaflet-control-search");return this._input=this._createInput(this.options.text,"search-input"),this._tooltip=this._createTooltip("search-tooltip"),this._cancel=this._createCancel(this.options.textCancel,"search-cancel"),this._button=this._createButton(this.options.text,"search-button"),this._alert=this._createAlert("search-alert"),this.options.collapsed===!1&&this.expand(),(this.options.circleLocation||this.options.markerLocation||this.options.markerIcon)&&(this._markerLoc=new a([0,0],{showCircle:this.options.circleLocation,showMarker:this.options.markerLocation,icon:this.options.markerIcon})),this.setLayer(this._layer),b.on({resize:this._handleAutoresize},this),app.Tooltip.add(this._container,"Search for address or location"),c},_on:function(){this._show()},_off:function(){this._hide()},_show:function(){this._container.style.display="block"},_hide:function(){this._container.style.display="none"},_addTo:function(){this.addTo(app._map),this._added=!0},_refresh:function(){this._added||this._addTo();var a=this._project.getControls()[this.type];return a?void this._flush():this._hide()},_flush:function(){},_getPath:function(a,b){var c=b.split("."),d=c.pop(),e=c.length,f=c[0],g=1;if(e>0)for(;(a=a[f])&&e>g;)f=c[g++];return a?a[d]:void 0},setLayer:function(a){return this._layer=a,this._layer.addTo(this._map),this._markerLoc&&this._layer.addLayer(this._markerLoc),this},showAlert:function(a){a=a||this.options.textErr,this._alert.style.display="block",this._alert.innerHTML=a,clearTimeout(this.timerAlert);var b=this;return this.timerAlert=setTimeout(function(){b.hideAlert()},this.options.autoCollapseTime),this},hideAlert:function(){return this._alert.style.display="none",this},cancel:function(){return this._input.value="",this._handleKeypress({keyCode:8}),this._input.size=this._inputMinSize,this._input.focus(),this._cancel.style.display="none",this},expand:function(){return this._input.style.display="block",L.DomUtil.addClass(this._container,"search-exp"),this._input.focus(),this._map.on("dragstart click",this.collapse,this),this},collapse:function(){return this._hideTooltip(),this.cancel(),this._alert.style.display="none",this._input.blur(),this.options.collapsed&&(this._input.style.display="none",this._cancel.style.display="none",L.DomUtil.removeClass(this._container,"search-exp"),this._markerLoc.hide(),this._map.off("dragstart click",this.collapse,this)),this.fire("search_collapsed"),this},collapseDelayed:function(){if(!this.options.autoCollapse)return this;var a=this;return clearTimeout(this.timerCollapse),this.timerCollapse=setTimeout(function(){a.collapse()},this.options.autoCollapseTime),this},collapseDelayedStop:function(){return clearTimeout(this.timerCollapse),this},_createAlert:function(a){var b=L.DomUtil.create("div",a,this._container);return b.style.display="none",L.DomEvent.on(b,"click",L.DomEvent.stop,this).on(b,"click",this.hideAlert,this),b},_createInput:function(a,b){var c=L.DomUtil.create("input",b,this._container);return c.type="text",c.size=this._inputMinSize,c.value="",c.autocomplete="off",c.autocorrect="off",c.autocapitalize="off",c.placeholder=a,c.style.display="none",L.DomEvent.disableClickPropagation(c).on(c,"keyup",this._handleKeypress,this).on(c,"keydown",this._handleAutoresize,this).on(c,"blur",this.collapseDelayed,this).on(c,"focus",this.collapseDelayedStop,this),c},_createCancel:function(a,b){var c=L.DomUtil.create("a",b,this._container);return c.href="#",c.title=a,c.style.display="none",c.innerHTML="<span>&otimes;</span>",L.DomEvent.on(c,"click",L.DomEvent.stop,this).on(c,"click",this.cancel,this),c},_createButton:function(a,b){var c=L.DomUtil.create("a",b,this._container);return c.href="#",c.title=a,L.DomEvent.on(c,"click",L.DomEvent.stop,this).on(c,"click",this._handleSubmit,this).on(c,"focus",this.collapseDelayedStop,this).on(c,"blur",this.collapseDelayed,this),c},_createTooltip:function(a){var b=L.DomUtil.create("div",a,this._container);b.style.display="none";var c=this;return L.DomEvent.disableClickPropagation(b).on(b,"blur",this.collapseDelayed,this).on(b,"mousewheel",function(a){c.collapseDelayedStop(),L.DomEvent.stopPropagation(a)},this).on(b,"mouseover",function(a){c.collapseDelayedStop()},this),b},_createTip:function(a,b){var c;if(this.options.callTip){if(c=this.options.callTip(a,b),"string"==typeof c){var d=L.DomUtil.create("div");d.innerHTML=c,c=d.firstChild}}else c=L.DomUtil.create("a",""),c.href="#",c.innerHTML=a;return L.DomUtil.addClass(c,"search-tip"),c._text=a,L.DomEvent.disableClickPropagation(c).on(c,"click",L.DomEvent.stop,this).on(c,"click",function(b){this._input.value=a,this._handleAutoresize(),this._input.focus(),this._hideTooltip(),this.options.tipAutoSubmit&&this._handleSubmit()},this),c},_filterRecords:function(a){var b,c,d=new RegExp("^[.]$|[[]|()*]","g"),e={};a=a.replace(d,""),b=this.options.initial?"^":"",c=new RegExp(b+a,"i");for(var f in this._recordsCache)c.test(f)&&(e[f]=this._recordsCache[f]);return e},showTooltip:function(){var a,b;return this._countertips=0,a=this.options.layer?this._filterRecords(this._input.value):this._recordsCache,this._tooltip.innerHTML="",this._tooltip.currentSelection=-1,a.forEach(function(a){++this._countertips!=this.options.tooltipLimit&&a&&(b=this._createTip(a.address,a.latlng),this._tooltip.appendChild(b))},this),this._countertips>0?(this._tooltip.style.display="block",this._autoTypeTmp&&this._autoType(),this._autoTypeTmp=this.options.autoType):this._hideTooltip(),this._tooltip.scrollTop=0,this._countertips},_hideTooltip:function(){return this._tooltip.style.display="none",this._tooltip.innerHTML="",0},_defaultFilterJSON:function(a){var b,c={},d=this.options.propertyName,e=this.options.propertyLoc;if(L.Util.isArray(e))for(b in a)c[this._getPath(a[b],d)]=L.latLng(a[b][e[0]],a[b][e[1]]);else for(b in a)c[this._getPath(a[b],d)]=L.latLng(this._getPath(a[b],e));return c},_recordsFromJsonp:function(a,b){var c=this;L.Control.Geolocation.callJsonp=function(a){var d=c._filterJSON(a);b(d)};var d=L.DomUtil.create("script","search-jsonp",document.getElementsByTagName("body")[0]),e=L.Util.template(this.options.url+"&"+this.options.jsonpParam+"=L.Control.Geolocation.callJsonp",{s:a});return d.type="text/javascript",d.src=e,this},_recordsFromAjax:function(a,b){void 0===window.XMLHttpRequest&&(window.XMLHttpRequest=function(){try{return new ActiveXObject("Microsoft.XMLHTTP.6.0")}catch(a){try{return new ActiveXObject("Microsoft.XMLHTTP.3.0")}catch(b){throw new Error("XMLHttpRequest is not supported")}}});var c=new XMLHttpRequest,d=L.Util.template(this.options.url,{s:a}),e={};c.open("GET",d);var f=this;return c.onreadystatechange=function(){
if(4===c.readyState&&200===c.status){e=JSON.parse(c.responseText);var a=f._filterJSON(e);b(a)}},c.send(),this},_recordsFromLayer:function(){var b,c=this,d={},e=this.options.propertyName;return this._layer.eachLayer(function(f){f instanceof a||(f instanceof L.Marker?c._getPath(f.options,e)?(b=f.getLatLng(),b.layer=f,d[c._getPath(f.options,e)]=b):c._getPath(f.feature.properties,e)&&(b=f.getLatLng(),b.layer=f,d[c._getPath(f.feature.properties,e)]=b):f.hasOwnProperty("feature")&&f.feature.properties.hasOwnProperty(e)&&(b=f.getBounds().getCenter(),b.layer=f,d[f.feature.properties[e]]=b))},this),d},_autoType:function(){if(this._tooltip.firstChild){var a=this._input.value.length,b=this._tooltip.firstChild._text,c=b.length;if(0===b.indexOf(this._input.value))if(this._input.value=b,this._handleAutoresize(),this._input.createTextRange){var d=this._input.createTextRange();d.collapse(!0),d.moveStart("character",a),d.moveEnd("character",c),d.select()}else this._input.setSelectionRange?this._input.setSelectionRange(a,c):this._input.selectionStart&&(this._input.selectionStart=a,this._input.selectionEnd=c)}},_hideAutoType:function(){var a;if((a=this._input.selection)&&a.empty)a.empty();else if(this._input.createTextRange){a=this._input.createTextRange(),a.collapse(!0);var b=this._input.value.length;a.moveStart("character",b),a.moveEnd("character",b),a.select()}else this._input.getSelection&&this._input.getSelection().removeAllRanges(),this._input.selectionStart=this._input.selectionEnd},_handleKeypress:function(a){switch(a.keyCode){case 27:this.collapse();break;case 13:this._keypressed||this._handleArrowSelect(1),this._handleSubmit();break;case 38:this._handleArrowSelect(-1),this._keypressed=!0;break;case 40:this._handleArrowSelect(1),this._keypressed=!0;break;case 37:case 39:case 16:case 17:break;case 8:case 46:this._autoTypeTmp=!1;break;default:if(this._input.value.length?this._cancel.style.display="block":this._cancel.style.display="none",this._input.value.length>=this.options.minLength){var b=this;clearTimeout(this.timerKeypress),this.timerKeypress=setTimeout(function(){b._fillRecordsCache()},this.options.delayType)}else this._hideTooltip()}},_fillRecordsCache:function(){var a,b=this._input.value;L.DomUtil.addClass(this._container,"search-load"),this.options.callData?(a=this,this.options.callData(b,function(b){a._recordsCache=a._filterJSON(b),a.showTooltip(),L.DomUtil.removeClass(a._container,"search-load")})):this.options.url?this.options.jsonpParam?(a=this,this._recordsFromJsonp(b,function(b){a._recordsCache=b,a.showTooltip(),L.DomUtil.removeClass(a._container,"search-load")})):(a=this,this._recordsFromAjax(b,function(b){a._recordsCache=b,a.showTooltip(),L.DomUtil.removeClass(a._container,"search-load")})):this.options.layer&&(this._recordsCache=this._recordsFromLayer(),this.showTooltip(),L.DomUtil.removeClass(this._container,"search-load"))},_handleAutoresize:function(){var a=this._map||app._map;a&&a._container&&(this._input.style.maxWidth!=a._container.offsetWidth&&(this._input.style.maxWidth=L.DomUtil.getStyle(a._container,"width")),this.options.autoResize&&this._container.offsetWidth+45<a._container.offsetWidth&&(this._input.size=this._input.value.length<this._inputMinSize?this._inputMinSize:this._input.value.length))},_handleArrowSelect:function(a){var b=this._tooltip.hasChildNodes()?this._tooltip.childNodes:[];for(i=0;i<b.length;i++)L.DomUtil.removeClass(b[i],"search-tip-select");if(1==a&&this._tooltip.currentSelection>=b.length-1)L.DomUtil.addClass(b[this._tooltip.currentSelection],"search-tip-select");else if(-1==a&&this._tooltip.currentSelection<=0)this._tooltip.currentSelection=-1;else if("none"!=this._tooltip.style.display){this._tooltip.currentSelection+=a,L.DomUtil.addClass(b[this._tooltip.currentSelection],"search-tip-select"),this._input.value=b[this._tooltip.currentSelection]._text;var c=b[this._tooltip.currentSelection].offsetTop;c+b[this._tooltip.currentSelection].clientHeight>=this._tooltip.scrollTop+this._tooltip.clientHeight?this._tooltip.scrollTop=c-this._tooltip.clientHeight+b[this._tooltip.currentSelection].clientHeight:c<=this._tooltip.scrollTop&&(this._tooltip.scrollTop=c)}},_handleSubmit:function(){if(this._keypressed=!1,this._hideAutoType(),this.hideAlert(),this._hideTooltip(),"none"==this._input.style.display)this.expand();else if(""===this._input.value)this.collapse();else{var a=this._getRecord(this._input.value);this._showLocation(a),this.fire("search_locationfound",{latlng:a.latlng,text:this._input.value,layer:null})}},_getRecord:function(a){var b=_.filter(this._recordsCache,function(b){return b?b.address==a:!1});return b[0]},_getLocation:function(a){var b=_.filter(this._recordsCache,function(b){return b.address==a});return b.latlng},_showLocation:function(a){var b=a.latlng,c=a.address;return this.showLocation(b,c)},showLocation:function(a,b){return this.options.zoom?this._map.setView(a,this.options.zoom):this._map.panTo(a),this._markerLoc&&(this._markerLoc.setLatLng(a),this._markerLoc.setTitle(b),this._markerLoc.show(),this.options.animateLocation&&this._markerLoc.animate()),this.options.autoCollapse&&this.collapse(),this}});var a=L.Marker.extend({includes:L.Mixin.Events,options:{radius:10,weight:3,color:"rgb(255, 114, 114)",stroke:!0,fill:!1,title:"",icon:new L.Icon.Default,showCircle:!0,showMarker:!1},initialize:function(a,b){L.setOptions(this,b),L.Marker.prototype.initialize.call(this,a,b),this.options.showCircle&&(this._circleLoc=new L.CircleMarker(a,this.options))},onAdd:function(a){L.Marker.prototype.onAdd.call(this,a),this._circleLoc&&a.addLayer(this._circleLoc),this.hide()},onRemove:function(a){L.Marker.prototype.onRemove.call(this,a),this._circleLoc&&a.removeLayer(this._circleLoc)},setLatLng:function(a){return L.Marker.prototype.setLatLng.call(this,a),this._circleLoc&&this._circleLoc.setLatLng(a),this},setTitle:function(a){return a=a||"",this.options.title=a,this._icon&&(this._icon.title=a),this},show:function(){return this.options.showMarker&&(this._icon&&(this._icon.style.display="block"),this._shadow&&(this._shadow.style.display="block")),this._circleLoc&&this._circleLoc.setStyle({fill:this.options.fill,stroke:this.options.stroke}),this},hide:function(){return this._icon&&(this._icon.style.display="none"),this._shadow&&(this._shadow.style.display="none"),this._circleLoc&&this._circleLoc.setStyle({fill:!1,stroke:!1}),this},animate:function(){if(this._circleLoc){var a=this._circleLoc,b=200,c=10,d=parseInt(a._radius/c),e=this.options.radius,f=2.5*a._radius,g=0;a._timerAnimLoc=setInterval(function(){g+=.5,d+=g,f-=d,a.setRadius(f),e>f&&(clearInterval(a._timerAnimLoc),a.setRadius(e))},b)}return this}});L.control.geolocation=function(a){return new L.Control.Geolocation(a)}}.call(this),L.Control.Layermenu=Wu.Control.extend({type:"layermenu",options:{position:"bottomright"},onAdd:function(a){this._innerContainer=Wu.DomUtil.create("div","leaflet-control-layermenu"),this._layermenuOuter=Wu.DomUtil.create("div","scroller-frame");var b=Wu.DomUtil.create("div","inner-scroller",this._layermenuOuter);return this._content=Wu.DomUtil.createId("div","layer-menu-inner-content",b),this._bottomContainer=Wu.DomUtil.create("div","layers-bottom-container",this._layermenuOuter),this._innerContainer.appendChild(this._layermenuOuter),this._isOpen=!0,this.registerTopButton(),this.initLayout(),Wu.DomEvent.on(this._innerContainer,"mouseup",Wu.DomEvent.stop,this),this._innerContainer},registerTopButton:function(){var a=app.Chrome.Top;this._layerButton=a._registerButton({name:"layer",className:"chrome-button layer",trigger:this.toggleLayerMenu,context:this,project_dependent:!1}),this._layerButton.innerHTML='<i class="top-button fa fa-bars"></i> Layers'},toggleLayerMenu:function(){this._isOpen?this.close():this.open()},open:function(){this._isOpen=!0,Wu.DomUtil.removeClass(this._innerContainer,"displayNone"),Wu.DomUtil.removeClass(this._layerButton,"rounded-layer-button")},close:function(){this._isOpen=!1,Wu.DomUtil.addClass(this._innerContainer,"displayNone"),Wu.DomUtil.addClass(this._layerButton,"rounded-layer-button")},_addTo:function(){this.addTo(app._map),this._addHooks(),this._added=!0},_flush:function(){this.layers={},this._content.innerHTML=""},_onLayerEdited:function(a){a.detail.layer;this._refresh()},_refresh:function(a){return this._added||this._addTo(),this._isActive()?(this._flush(),this._initContent(),!a&&this._show(),this.editMode||this.closeAll(),void(this.editMode&&this._forceOpen())):this._hide()},_forceOpen:function(){Wu.DomUtil.removeClass(this._parentWrapper,"displayNone")},_enableDefaultLayers:function(){for(var a in this.layers){var b=this.layers[a];b.item.enabled&&this._enableDefaultLayer(b)}},_refreshContent:function(a){this._refresh(a),this._addAlreadyActive()},_isActive:function(){return this._project?this._project.getControls()[this.type]:!1},_on:function(){this._refresh(),this._addAlreadyActive()},_off:function(){this._hide()},initLayout:function(){this._layerMenuHeader=Wu.DomUtil.createId("div","layer-menu-header"),this._openLayers=Wu.DomUtil.createId("div","open-layers"),this._openLayers.innerHTML="Layers",Wu.DomUtil.addClass(this._openLayers,"leaflet-control ol-collapsed"),app._map._controlCorners.bottomright.appendChild(this._openLayers),this._open=!0,app.mobile&&Wu.DomUtil.create("div","layers-mobile-arrow",this._innerContainer)},_addHooks:function(){Wu.DomEvent.on(this._container,"mouseenter",function(){app._map.scrollWheelZoom.disable()},this),Wu.DomEvent.on(this._container,"mouseleave",function(){app._map.scrollWheelZoom.enable()},this)},_initContent:function(){this._fill()},_fill:function(){return this._parentWrapper=this._container.parentNode,this._project.store.layermenu&&0!=this._project.store.layermenu.length?(Wu.DomUtil.removeClass(this._parentWrapper,"displayNone"),void this._project.store.layermenu.forEach(function(a){var b=this._project.layers[a.layer],c={item:a,layer:b};this._add(c)},this)):void Wu.DomUtil.addClass(this._parentWrapper,"displayNone")},_addAlreadyActive:function(){var a=app.MapPane.getActiveLayers(),b=_.filter(this.layers,function(b){if(!b.layer)return!1;var c=b.layer.getUuid(),d=_.find(a,function(a){return a.getUuid()==c});return d});b.forEach(function(a){this._enableLayer(a.layer.getUuid())},this)},_show:function(){this._container.style.display="block"},_hide:function(){this._container.style.display="none"},show:function(){this._container&&(this._isActive()?this._show():this._hide())},hide:function(){this._container&&this._hide()},_getOpenItems:function(){var a=this._content.childNodes,b=_.filter(a,function(a){var b=_.contains(a.classList,"layeritem-closed");return!b});return b.length},cancelEditClose:function(){if(this.editMode){var a=app.SidePane.Options.settings.layermenu.closeEditTimer;clearTimeout(a),setTimeout(function(){var a=app.SidePane.Options.settings.layermenu.closeEditTimer;clearTimeout(a)},301)}},timedEditClose:function(){if(this.editMode){var a=this;app.SidePane.Options.settings.layermenu.closeEditTimer=setTimeout(function(){a.disableEdit()},3e3)}},_GAtoggleLayerPane:function(){app.Analytics.setGaEvent(["Controls","Layers: toggle open/close"]),this.toggleLayerPane()},toggleLayerPane:function(){this._open?this.closeLayerPane():this.openLayerPane()},_GAcloseLayerPane:function(){app.Analytics.setGaEvent(["Controls","Layers: close"]),this.closeLayerPane()},closeLayerPane:function(){this._open=!1,Wu.DomUtil.addClass(this._innerContainer,"closed")},openLayerPane:function(){this._open=!0,Wu.DomUtil.removeClass(this._innerContainer,"closed")},enableEditSwitch:function(){if(Wu.DomUtil.removeClass(this._parentWrapper,"displayNone"),this.openAll(),this._editSwitchContainer)Wu.DomUtil.removeClass(this._editSwitchContainer,"displayNone");else{this._editSwitchContainer=Wu.DomUtil.create("div","enable-edit-switch-container-outer",this._innerContainer);var a=Wu.DomUtil.create("div","enable-edit-switch-container-inner",this._editSwitchContainer);Wu.DomUtil.create("div","enable-edit-switch-title",a,"Edit layer menu");this.editSwitch=new Wu.button({id:"editSwitch",type:"switch",isOn:!1,right:!0,appendTo:a,fn:this._enableEditing.bind(this),className:"edit-layers-switch"})}Wu.DomUtil.addClass(this._innerContainer,"enable-edit-mode")},disableEditSwitch:function(){this._editSwitchContainer&&(this._editSwitchContainer.innerHTML="",this._editSwitchContainer.remove(),this._editSwitchContainer=null,Wu.DomUtil.removeClass(this._innerContainer,"enable-edit-mode"),this.disableEdit(),this._isEmpty()&&Wu.DomUtil.addClass(this._parentWrapper,"displayNone"))},_enableEditing:function(a,b){b?this.enableEdit():this.disableEdit()},enableEdit:function(){this.editMode||(Wu.DomUtil.removeClass(this._parentWrapper,"displayNone"),this.editMode=!0,app.Data.disableUploader(),this.enableDraggable(),this.enableSortable(),Wu.DomUtil.addClass(this._innerContainer,"edit-mode"),this._insertMenuFolder(),this.openAll())},_isEmpty:function(){return!this._project.store.layermenu||0==this._project.store.layermenu.length},disableEdit:function(){this.editMode&&(this._isEmpty()&&Wu.DomUtil.addClass(this._parentWrapper,"displayNone"),this.editMode=!1,app.Data.enableUploader(),this.disableDraggable(),this.disableSortable(),Wu.DomUtil.removeClass(this._innerContainer,"edit-mode"),this._removeMenuFolder())},_insertMenuFolder:function(){this._menuFolder?(Wu.DomUtil.removeClass(this._menuFolder,"displayNone"),Wu.DomUtil.removeClass(this._editSwitchContainer,"displayNone")):(this._menuFolder=Wu.DomUtil.create("div","smap-button-white middle-item",this._bottomContainer,"Add folder"),Wu.DomEvent.on(this._menuFolder,"click",this.addMenuFolder,this))},_removeMenuFolder:function(){this._menuFolder&&Wu.DomUtil.addClass(this._menuFolder,"displayNone")},enableSortable:function(){this.initSortable()},disableSortable:function(){this._sortingEnabled&&this.resetSortable()},refreshSortable:function(){this._sortingEnabled&&this.resetSortable(),this.initSortable()},initSortable:function(){if(this._project.isEditor()){this._sortingEnabled=!0;for(var a=document.getElementsByClassName("layer-menu-item-wrap"),b=0;b<a.length;b++){var c=a[b];Wu.DomEvent.on(c,"dragstart",this.drag.start,this)}var d=this._content;d&&(Wu.DomEvent.on(d,"dragover",this.drag.over,this),Wu.DomEvent.on(d,"dragleave",this.drag.leave,this),Wu.DomEvent.on(d,"drop",this.drag.drop,this))}},resetSortable:function(){this._sortingEnabled=!1;var a=this._content;a&&(Wu.DomEvent.off(a,"dragover",this.drag.over,this),Wu.DomEvent.off(a,"dragleave",this.drag.leave,this),Wu.DomEvent.off(a,"drop",this.drag.drop,this))},enableDraggable:function(){for(var a=document.getElementsByClassName("layer-menu-item-wrap"),b=0;b<a.length;b++){var c=a[b];c.setAttribute("draggable",!0)}},disableDraggable:function(){for(var a=document.getElementsByClassName("layer-menu-item-wrap"),b=0;b<a.length;b++){var c=a[b];c.setAttribute("draggable",!1)}},drag:{start:function(a){var b=a.target;Wu.DomUtil.addClass(b,"dragged-ghost");var c=b.id;return this.drag.currentDragElement=b,this.drag.currentDragUuid=c,this.drag.startDragLevel=this.layers[c].item.pos,a.dataTransfer.setData("uuid",c),!1},drop:function(a){var b=a.dataTransfer.getData("uuid"),c=document.getElementById(b);Wu.DomUtil.removeClass(c,"dragged-ghost");var d=Array.prototype.slice.call(this._content.childNodes),e=d.indexOf(c),f=_.findIndex(this._project.store.layermenu,{uuid:b});return this._project.store.layermenu.move(f,e),this.save(),this.drag.currentDragElement=null,this.drag.currentDragLevel=null,this.movingX=!1,!1},over:function(a){a.preventDefault&&a.preventDefault(),this.movingX||(this.movingX=a.layerX);a.layerX-this.movingX;return!1},leave:function(a){var b=a.clientX,c=a.clientY,d=document.elementFromPoint(b,c),e=this.drag.currentDragElement,f=d.getAttribute("type");return"layerItem"==f?(this.drag.moveElementNextTo(e,d),!1):void 0},moveElementNextTo:function(a,b){b=b.parentNode,this.isBelow(a,b)?b.parentNode.insertBefore(a,b):b.parentNode.insertBefore(a,b.nextSibling)},isBelow:function(a,b){var c=a.parentNode;if(b.parentNode!=c)return!1;for(var d=a.previousSibling;d&&9!==d.nodeType;){if(d===b)return!0;d=d.previousSibling}return!1}},_isFolder:function(a){var b=this.layers[a.uuid];return b.layer?!1:!0},markInvalid:function(a){a.forEach(function(a){var b=this.layers[a.uuid].el;Wu.DomUtil.addClass(b,"invalidLayermenuitem")},this)},clearInvalid:function(){for(var a in this.layers){var b=this.layers[a];Wu.DomUtil.removeClass(b.el,"invalidLayermenuitem")}},checkLogic:function(){this.clearInvalid();var a=this._project.store.layermenu,b=[];return a.forEach(function(a,c,d){if(0==c)return 0!=a.pos?b.push(a):b;if(a.folder){var e=a.pos,f=d[c-1].pos;if(e>f)return b.push(a)}var e=parseInt(a.pos),f=parseInt(d[c-1].pos);return e>f&&!d[c-1].folder?b.push(a):parseInt(e)>parseInt(f+1)?b.push(a):void 0},this),this.markInvalid(b),b},updateLogic:function(){var a=this._project.store.layermenu;this._logic=this._logic||{},a.forEach(function(b,c){if(this._isFolder(b)){var d=b.pos,e=[],f=[],g=!1;if(_.each(a,function(a,c){if(b.uuid==a.uuid&&(g=!0),g){if(parseInt(a.pos)>parseInt(d)){var f=this.layers[a.uuid].el;e.push(f)}if(parseInt(a.pos)==parseInt(d)&&b.uuid!=a.uuid)return!1}},this),g=!1,_.each(a,function(a,c){if(g){if(parseInt(a.pos)==parseInt(d)+1){var e=this.layers[a.uuid].el;f.push(e)}if(parseInt(a.pos)==parseInt(d))return!1}b.uuid==a.uuid&&(g=!0)},this),this._logic[b.uuid])var h=this._logic[b.uuid].isOpen||!1;else var h=!0;this._logic[b.uuid]={toOpen:f,toClose:e,isOpen:h}}},this)},enforceLogic:function(a){var b=a.item.uuid,c=this._logic[b];if(c.isOpen){var d=c.toClose;d.forEach(function(a){Wu.DomUtil.addClass(a,"layeritem-closed"),Wu.DomUtil.removeClass(a,"layeritem-open");var b=a.id;this._logic[b]&&this._logic[b].isOpen&&(this._logic[b].isOpen=!1)},this),this._logic[b].isOpen=!1}else{var d=c.toOpen;d.forEach(function(a){Wu.DomUtil.removeClass(a,"layeritem-closed"),Wu.DomUtil.addClass(a,"layeritem-open")},this),this._logic[b].isOpen=!0}},closeAll:function(){this.updateLogic();for(var a in this._logic){var b=this.layers[a];b&&(this._logic[a].isOpen=!0,this.enforceLogic(b))}},openAll:function(){this.updateLogic();for(var a in this._logic){var b=this.layers[a];b&&(this._logic[a].isOpen=!1,this.enforceLogic(b))}},toggleFolder:function(a){this.updateLogic(),this.enforceLogic(a)},toggleLayer:function(a){if(!this.editMode){var b=a.layer;b?b.getTitle():"Folder";a.on?this.disableLayer(a):(this.enableLayer(a),Wu.Mixin.Events.fire("layerSelected",{detail:{layer:b}}))}},_enableLayer:function(a){var b=_.find(this.layers,function(b){return b.item.layer==a});return b?(Wu.DomUtil.addClass(b.el,"layer-active"),void(b.on=!0)):void 0},_enableDefaultLayer:function(a){this.enableLayer(a)},_enableLayerByUuid:function(a){var b=this._getLayermenuItem(a);b&&this.enableLayer(b)},enableLayer:function(a){var b=a.layer;return b?(b.add(),a.on=!0,Wu.DomUtil.addClass(a.el,"layer-active"),app.Chrome.Right.options.editingLayer=b.getUuid(),void Wu.Mixin.Events.fire("layerEnabled",{detail:{layer:b}})):this.toggleFolder(a)},disableLayer:function(a){var b=a.layer;b&&(this._disableLayer(b),app.Chrome.Right.options.editingLayer=!1,Wu.Mixin.Events.fire("layerDisabled",{detail:{layer:b}}))},_disableLayer:function(a){var b=this._getLayermenuItem(a.store.uuid);a.remove(),b.on=!1,Wu.DomUtil.removeClass(b.el,"layer-active")},_getLayermenuItem:function(a){var b=_.find(this.layers,function(b){return b.item.layer==a});return b},_getActiveLayers:function(){var a=_.filter(this.layers,function(a){return a.on});return a},onDelete:function(a){if(!a)return void 0;var b=a.getUuid(),c=this._getLayermenuItem(b);if(c){var d=c.el;d&&d.parentNode.removeChild(d)}},remove:function(a){var b=this.layers[a],c=b.el;c&&c.parentNode.removeChild(c);var d=b.layer;d&&d.remove(),delete this.layers[a],_.remove(this._project.store.layermenu,function(b){return b.uuid==a}),this.save()},removeLayermenuItem:function(){},removeLayer:function(a){},_remove:function(a){var b=this._getLayermenuItem(a);this.remove(b.item.uuid)},add:function(a){var b={uuid:"layerMenuItem-"+Wu.Util.guid(),layer:a.store.uuid,caption:a.store.title,pos:0,zIndex:1,opacity:1},c={item:b,layer:a};this._add(c),this._project.store.layermenu.push(b),this.save()},_add:function(a){var b=a.item,c=a.layer,d=c&&c.getTitle?c.getTitle():b.caption,e="layer-menu-item-wrap";c||(e+=" menufolder"),e+=" level-"+b.pos;var f=b.uuid,g=Wu.DomUtil.create("div",e,this._content);g.id=f,this.editMode?g.setAttribute("draggable",!0):g.setAttribute("draggable",!1);var h=Wu.DomUtil.create("div","layer-item-up",g),i=Wu.DomUtil.create("div","layer-item-down",g);if(!c)var j=Wu.DomUtil.create("div","layer-item-delete",g);if(c){var k=Wu.DomUtil.createId("div","layer-flyto-"+c.getUuid(),g);k.className="layer-menu-flyto",k.innerHTML='<i class="fa fa-search fly-to"></i>'}var l=Wu.DomUtil.create("div","layer-menu-item",g);if(l.setAttribute("type","layerItem"),l.innerHTML=d,Wu.DomEvent.on(h,"click",function(a){this.upFolder(f)},this),Wu.DomEvent.on(i,"click",function(a){this.downFolder(f)},this),c||(Wu.DomEvent.on(l,"dblclick",function(a){this._editFolderTitle(f)},this),Wu.DomEvent.on(j,"click",function(a){this.deleteMenuFolder(f)},this),Wu.DomEvent.on(j,"mousedown",Wu.DomEvent.stop,this)),Wu.DomEvent.on(h,"mousedown",Wu.DomEvent.stop,this),Wu.DomEvent.on(i,"mousedown",Wu.DomEvent.stop,this),Wu.DomEvent.on(g,"dragstart",this.drag.start,this),Wu.DomEvent.on(this._container,"touchstart mousedown click dblclick",Wu.DomEvent.stopPropagation,this),a.el=g,Wu.DomEvent.on(g,"mousedown",function(b){this.toggleLayer(a)},this),Wu.DomEvent.on(this._innerContainer,"dblclick",Wu.DomEvent.stop,this),c){var m=Wu.DomUtil.get("layer-flyto-"+c.getUuid());Wu.DomEvent.on(m,"mousedown",function(a){Wu.DomEvent.stop(a),c.flyTo()},this)}this.layers[b.uuid]=a},getLayers:function(){return this.layers},addMenuFolder:function(){this.addFolder()},_addMenuFolder:function(){this._addFolder()},addFolder:function(){var a={uuid:"layerMenuItem-"+Wu.Util.guid(),caption:"New folder",pos:0,folder:!0},b={item:a,layer:!1};this._add(b),this._project.store.layermenu.push(a),this.save()},_editFolderTitle:function(a){if(this.editMode&&!this.currentlyEditing){this.currentlyEditing=!0;var b=this.layers[a],c=b.el.children[3],d=c.innerHTML;c.innerHTML="";var e=Wu.DomUtil.create("input","layer-item-title-input");e.value=d,c.appendChild(e),e.focus(),Wu.DomEvent.on(e,"blur",function(){var b=e.value;Wu.DomUtil.remove(e),c.innerHTML=b;var d=_.findIndex(this._project.store.layermenu,{uuid:a});this._project.store.layermenu[d].caption=b,this.save();var f=this._project.store.layermenu[d].layer,g=this._project.getLayer(f),h=g?g.getFile():!1;h&&h.setName(b),g&&g.setTitle(b),this._updateControls(),this.currentlyEditing=!1},this),Wu.DomEvent.on(e,"keydown",function(a){(13==event.which||13==event.keyCode)&&e.blur(),(27==event.which||27==event.keyCode)&&e.blur()},this)}},_updateControls:function(){var a=app.MapPane._controls.layermenu;a&&a._refresh(!0);var b=app.MapPane._controls.inspect;b&&b._refresh(!0);var c=app.MapPane._controls.legends;c&&c._refresh(!0)},upFolder:function(a){var b=this.layers[a].el,c=_.findIndex(this._project.store.layermenu,{uuid:a}),d=parseInt(this._project.store.layermenu[c].pos),e=d+1;this._project.store.layermenu[c].pos=e,Wu.DomUtil.addClass(b,"level-"+e),Wu.DomUtil.removeClass(b,"level-"+d),this.save()},downFolder:function(a){var b=this.layers[a].el,c=_.findIndex(this._project.store.layermenu,{uuid:a}),d=parseInt(this._project.store.layermenu[c].pos),e=d-1;0>e&&(e=0),this._project.store.layermenu[c].pos=e,Wu.DomUtil.addClass(b,"level-"+e),Wu.DomUtil.removeClass(b,"level-"+d),this.save()},deleteMenuFolder:function(a){this.remove(a),app.Chrome.Top._showHideLayerButton()},save:function(){var a=this,b=this.checkLogic();return b.length?void 0:(this.saveTimer&&clearTimeout(this.saveTimer),void(this.saveTimer=setTimeout(function(){a._project._update("layermenu")},1e3)))},_setEnabledOnInit:function(a,b){var c=this._project.store.layermenu,d=-1;return c.forEach(function(b,c){b.layer==a&&(d=c)}),0>d?void 0:(this._project.store.layermenu[d].enabled=b,void this.save())}}),L.control.layermenu=function(a){return new L.Control.Layermenu(a)},L.Control.Description=Wu.Control.extend({type:"description",options:{position:"bottomright"},onAdd:function(a){var b="leaflet-control-description",c=L.DomUtil.create("div",b);this.options;return this._multipleLegendOuter=Wu.DomUtil.create("div","description-multiple-toggle-wrapper",c),this._multipleLegendInner=Wu.DomUtil.create("div","",this._multipleLegendOuter),this._content=Wu.DomUtil.create("div","description-control-content",c),this._outer=Wu.DomUtil.create("div","description-control-content-box",this._content),c},_initContainer:function(){this._container.style.display="none",this._inner=Wu.DomUtil.create("div","description-control-inner",this._outer),this._header=Wu.DomUtil.create("div","description-control-header-section",this._inner),this._toggle=Wu.DomUtil.create("div","description-control-header-toggle",this._multipleLegendOuter),this._description=Wu.DomUtil.create("div","description-control-description displayNone",this._inner),this._metaContainer=Wu.DomUtil.create("div","description-control-meta-container",this._inner),this.satelliteAngle=new Wu.satteliteAngle({angle:!1,path:!1,appendTo:this._inner}),this._legendContainer=Wu.DomUtil.create("div","description-control-legend-container",this._inner),this._copyright=Wu.DomUtil.create("div","description-copyright",this._outer,""),app.Tooltip.add(this._container,"Shows layer information",{"extends":"systyle",tipJoint:"left"}),this._addHooks()},_addHooks:function(){Wu.DomEvent.on(this._toggle,"click",this.toggle,this),Wu.DomEvent.on(this._container,"mousedown click dblclick",Wu.DomEvent.stopPropagation,this)},_isActive:function(){return this._project?this._project.getControls()[this.type]:!1},show:function(){this._container&&(this._isActive()?this._show():this._hide(),this.toggleScale(!0))},hide:function(){this._container&&this._hide()},_show:function(){this.refresh()},refresh:function(){this.showHide()},showHide:function(){return!this.layers||this.isEmpty(this.layers)?void this._hide():(this._container.style.display="block",void(this.isOpen=!0))},_hide:function(){this._container.style.display="none",this.isOpen=!1,this.toggleScale(!1)},_flush:function(){this.layers={},this._clear()},_clear:function(){this.isOpen=!1,this.toggleScale(!1)},_refresh:function(){this._added||this._addTo();var a=this._project.getControls()[this.type];return a?(this._flush(),void this._show()):this._hide()},_onLayerStyleEdited:function(a){var b=a.detail.layer;this._refreshLayer(b)},_addTo:function(){this.addTo(app._map),this._initContainer(),this._addHooks(),this._added=!0},_refreshLayer:function(a){this.layers[a.getUuid()]=a,this.setHTMLfromStore(a.getUuid()),this.updateMultiple(a.getUuid())},toggle:function(){this.isCollapsed||(this.isCollapsed=!1),this.isCollapsed?this.toggleOpen():this.toggleClose()},toggleOpen:function(){this.isCollapsed=!1,Wu.DomUtil.removeClass(this._legendContainer,"minimized"),Wu.DomUtil.removeClass(this._header,"minimized");var a=this._description.innerHTML;a&&""!=a&&Wu.DomUtil.removeClass(this._description,"displayNone"),Wu.DomUtil.removeClass(this._metaContainer,"displayNone"),Wu.DomUtil.removeClass(this._toggle,"legend-toggle-open"),this.satelliteAngle.closed||Wu.DomUtil.removeClass(this.satelliteAngle._innerContainer,"displayNone")},toggleClose:function(){this.isCollapsed=!0,Wu.DomUtil.addClass(this._legendContainer,"minimized"),Wu.DomUtil.addClass(this._header,"minimized"),Wu.DomUtil.addClass(this._description,"displayNone"),Wu.DomUtil.addClass(this._metaContainer,"displayNone"),Wu.DomUtil.addClass(this._toggle,"legend-toggle-open"),Wu.DomUtil.addClass(this.satelliteAngle._innerContainer,"displayNone")},_addLayer:function(a){this.layers=this.layers||{};var b=a.getUuid();this.layers[b]=a,this.setHTMLfromStore(b),this.updateMultiple(b)},_removeLayer:function(a){var b=a.getUuid();delete this.layers[b];for(var c in this.layers)break;c&&this.setHTMLfromStore(c),this.updateMultiple(c),this.refresh()},updateMultiple:function(a){this.isCollapsed&&Wu.DomUtil.addClass(this.satelliteAngle._innerContainer,"displayNone");var b=this._multipleLegendInner;b.innerHTML="";var c=0;for(var d in this.layers)c++;for(var e in this.layers){var f=this.layers[e];title=f.getTitle();var g=Wu.DomUtil.create("div","each-multiple-description",b,title);g.id="mulitidec_"+e,e==a?c>1?Wu.DomUtil.addClass(g,"active"):Wu.DomUtil.addClass(g,"one-layer"):(Wu.DomUtil.removeClass(g,"active"),Wu.DomUtil.removeClass(g,"one-layer")),Wu.DomEvent.on(g,"click",this.toggleLegend,this)}},toggleLegend:function(a){var b=a.target.id,c=b.slice(10,b.length);this.setHTMLfromStore(c),this.updateMultiple(c)},storeLegendData:function(a){var b=(a.getUuid(),{}),c=b.meta=a.getMeta();b.title=a.getTitle(),b.description=a.getDescription();var d=Math.floor(c.total_area/1e6*100)/100,e=c.row_count,f=(_.size(c.columns),c.size_bytes,this._parseStartEndDate(c));Wu.parse(a.store.style);return b.description_meta={"Number of points":e,"Covered area (km<sup>2</sup>)":d,"Start date":f.start,"End date":f.end},a.isPostgis()?b.legendHTML=this.createLegendHTML():b.legendHTML="",b},getLegend:function(a){if(a.isPostgis())var b=this.createLegendHTML();else var b="";return b},_getLegendCaption:function(a){var b=a.column;return b?"vel"==b||"mvel"==b?"Velocity (mm/year)":b:""},getMetaDescription:function(a){var b=a.getMeta(),c="items";"ST_Point"==b.geometry_type&&(c="points"),"ST_MultiPolygon"==b.geometry_type&&(c="polygons");var d=Math.floor(b.total_area/1e6*100)/100,e=b.row_count,f=this._parseStartEndDate(b);return description_meta={},description_meta["Number of "+c]=e,description_meta["Covered area (km<sup>2</sup>)"]=d,f.start!=f.end&&(description_meta["Start date"]=f.start,description_meta["End date"]=f.end),description_meta},setHTMLfromStore:function(a){var b=this._project.getLayer(a);if(b){this.buildLegendObject(b);var c=(b.getTitle(),b.getDescription()),d=this.getMetaDescription(b),e=this.getLegend(b),f=Wu.parse(b.getSatellitePosition()),g=f.angle,h=f.path;this.satelliteAngle.update({angle:g,path:h}),this.setDescriptionHTML(c),this.setMetaHTML(d),this.setLegendHTML(e)}},setMetaHTML:function(a){this._metaContainer.innerHTML="";for(var b in a)var c=a[b],d=Wu.DomUtil.create("div","legends-meta-line",this._metaContainer),e=Wu.DomUtil.create("div","legends-meta-key",d,b),f=Wu.DomUtil.create("div","legend-meta-valye",d,c)},setLegendHTML:function(a){this._legendContainer.innerHTML=a},setDescriptionHTML:function(a){a&&""==a||Wu.DomUtil.removeClass(this._description,"displayNone"),this.isCollapsed&&Wu.DomUtil.addClass(this._description,"displayNone"),this._description.innerHTML=a},_parseStartEndDate:function(a){function b(a,b){return a-b}var c=a.columns,d=[];for(var e in c)if(8==e.length){var f=moment(e,"YYYYMMDD"),g=f.format("x");if(f.isValid()){var h=parseInt(g);h>0&&d.push(h)}}d.sort(b);var i=d[0],j=d[d.length-1],k=moment(i).format("MMM Do YYYY"),l=moment(j).format("MMM Do YYYY"),m={start:k,end:l};return m},isEmpty:function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},toggleScale:function(a){app._map._controlCorners.topright&&(a?Wu.DomUtil.addClass(app._map._controlCorners.topright,"toggle-scale"):Wu.DomUtil.removeClass(app._map._controlCorners.topright,"toggle-scale"))},_on:function(){this._show()},_off:function(){this._hide()},buildLegendObject:function(a){if(a.isPostgis()){var b=Wu.parse(a.store.style),c=b.point,d=b.line,e=b.polygon;this.legendObj={layerName:a.getTitle(),point:{all:{},target:[]},polygon:{all:{},target:[]},line:{all:{},target:[]}},this.legendPoint(c),this.legendPolygon(e),this.legendLine(d)}},legendPoint:function(a){if(a.enabled){var b={};if(a.color.column){var c=a.color.column,d=a.color.value,e=a.color.range[0],f=a.color.range[1];b.color={},b.color.column=c,b.color.value=d,b.color.minRange=e,b.color.maxRange=f}else{var d=a.color.staticVal?a.color.staticVal:"red";
b.color={},b.color.column=!1,b.color.value=d}if(a.opacity.column){var c=a.opacity.column,e=a.opacity.range[0],f=a.opacity.range[1];b.opacity={},b.opacity.column=c,b.opacity.minRange=e,b.opacity.maxRange=f}else{if(a.opacity.staticVal||0==a.opacity.staticVal)var d=a.opacity.staticVal;else var d=1;b.opacity={},b.opacity.column=!1,b.opacity.value=d}if(a.pointsize.column){var c=a.pointsize.column,e=a.pointsize.range[0],f=a.pointsize.range[1];b.pointsize={},b.pointsize.column=c,b.pointsize.minRange=e,b.pointsize.maxRange=f}else{if(a.pointsize.staticVal||0==a.pointsize.staticVal)var d=a.pointsize.staticVal;else var d=1.2;b.pointsize={},b.pointsize.column=!1,b.pointsize.value=d}this.legendObj.point.all=b,a.targets&&a.targets.length>=1&&a.targets.forEach(function(a,b){var c=a.column,d=a.color,e=a.opacity,f=a.value,g=a.width,h=a.operator,i={column:c,color:d,opacity:e,value:f,width:g,operator:h};this.legendObj.point.target.push(i)}.bind(this))}},legendPolygon:function(a){if(a.enabled){var b={};if(a.color.column){var c=a.color.column,d=a.color.value,e=a.color.range[0],f=a.color.range[1];b.color={},b.color.column=c,b.color.value=d,b.color.minRange=e,b.color.maxRange=f}else{var d=a.color.staticVal?a.color.staticVal:"red";b.color={},b.color.column=!1,b.color.value=d}if(a.opacity.column){var c=a.opacity.column,d=a.opacity.value,e=a.opacity.range[0],f=a.opacity.range[1];b.opacity={},b.opacity.column=c,b.opacity.value=d,b.opacity.minRange=e,b.opacity.maxRange=f}else{if(a.opacity.staticVal||0==a.opacity.staticVal)var d=a.opacity.staticVal;else var d=1;b.opacity={},b.opacity.column=!1,b.opacity.value=d}this.legendObj.polygon.all=b,a.targets&&a.targets.length>=1&&a.targets.forEach(function(a,b){var c=a.column,d=a.color,e=a.opacity,f=a.value,g=a.operator,h={column:c,color:d,opacity:e,value:f,operator:g};this.legendObj.polygon.target.push(h)}.bind(this))}},legendLine:function(a){if(a.enabled){var b={};if(a.color.column){var c=a.color.column,d=a.color.value,e=a.color.range[0],f=a.color.range[1];b.color={},b.color.column=c,b.color.value=d,b.color.minRange=e,b.color.maxRange=f}else{var d=a.color.staticVal?a.color.staticVal:"red";b.color={},b.color.column=!1,b.color.value=d}if(a.opacity.column){var c=a.opacity.column,e=a.opacity.range[0],f=a.opacity.range[1];b.opacity={},b.opacity.column=c,b.opacity.minRange=e,b.opacity.maxRange=f}else{if(a.opacity.staticVal||0==a.opacity.staticVal)var d=a.opacity.staticVal;else var d=1;b.opacity={},b.opacity.column=!1,b.opacity.value=d}if(a.width.column){var c=a.width.column,e=a.width.range[0],f=a.width.range[1];b.width={},b.width.column=c,b.width.minRange=e,b.width.maxRange=f}else{if(a.width.staticVal||0==a.width.staticVal)var d=a.width.staticVal;else var d=5;b.width={},b.width.column=!1,b.width.value=d}this.legendObj.line.all=b,a.targets&&a.targets.length>=1&&a.targets.forEach(function(a,b){var c=a.column,d=a.color,e=a.opacity,f=a.value,g=a.width,h=a.operator,i={column:c,color:d,opacity:e,value:f,width:g,operator:h};this.legendObj.line.target.push(i)}.bind(this))}},createLegendHTML:function(){var a="",b=(this.legendObj.layerName,this.legendObj.polygon),c=this.legendObj.line,d=this.legendObj.point;return a+=this.pointsHTML(d),a+=this.polygonAndLinesHTML(b,c)},pointsHTML:function(a){var b="";a.target.forEach(function(a,c){var d=a.color,e=a.opacity,f=this.color2RGB(d),g="rgba("+f.r+","+f.g+","+f.b+","+e+");",h="background:"+g+"; ",i="",j=a.operator+" ";"= "!=j&&(i+=j),i+=a.value;var k=a.width;k>20&&(k=20),5>k&&(k=5),h+="width: "+k+"px; height: "+k+"px; border-radius: "+k+"px;";var l=10-k/2;h+="top: "+l+"px; left: "+l+"px; ",b+='<div class="legend-each-container">',b+='<div class="legend-each-name">'+i+"</div>",b+='<div class="legend-each-color" style="'+h+'"></div>',b+="</div>"}.bind(this));var c="",d=!1;if(a.all.color&&!a.all.color.column){var e=a.all.color.value,f=a.all.opacity.value,g=this.color2RGB(e),h="rgba("+g.r+","+g.g+","+g.b+","+f+");";c+="background:"+h+";";var i=a.all.pointsize.value;i>20&&(i=20),5>i&&(i=5),c+="width: "+i+"px; height: "+i+"px; border-radius: "+i+"px;";var j=10-i/2;c+="top: "+j+"px; left: "+j+"px; ",0!=f&&(d=!0)}if(d){var k=this.legendObj.layerName,l="All "+k;b+='<div class="legend-each-container">',b+='<div class="legend-each-name">'+l+"</div>",b+='<div class="legend-each-color" style="'+c+'"></div>',b+="</div>"}if(a.all.color&&a.all.color.column){var m=a.all.color.value,n=a.all.color.minRange,o=a.all.color.maxRange,p=a.all.color.column,q={colorStops:m,minVal:n,maxVal:o,bline:p},r=this.gradientLegend(q);b+=r}return b},polygonAndLinesHTML:function(a,b){var c="",d={};b.target.forEach(function(b,c){a.target.forEach(function(a,c){if(a.value==b.value){var e=b.color,f=b.opacity,g=b.width,h=this.color2RGB(e),i="rgba("+h.r+","+h.g+","+h.b+","+f+");",j="border: "+g/2+"px solid "+i,k=a.color,l=a.opacity,m=this.color2RGB(k),n="rgba("+m.r+","+m.g+","+m.b+","+l+");",o="background:"+n,p=j+o;d[b.value]=p}}.bind(this))}.bind(this)),b.target.forEach(function(a,b){if(!d[a.value]){var e=a.color,f=a.opacity,g=a.width,h=this.color2RGB(e),i="rgba("+h.r+","+h.g+","+h.b+","+f+");",j="border: "+g+"px solid "+i,k="",l=a.operator+" ";"= "!=l&&(k+=l),k+=a.value,c+='<div class="legend-each-container">',c+='<div class="legend-each-name">'+k+"</div>",c+='<div class="legend-each-color" style="'+j+'"></div>',c+="</div>"}}.bind(this)),a.target.forEach(function(a,b){if(d[a.value])var e=d[a.value];else var f=a.color,g=a.opacity,h=this.color2RGB(f),i="rgba("+h.r+","+h.g+","+h.b+","+g+");",e="background:"+i;var j="",k=a.operator+" ";"= "!=k&&(j+=k),j+=a.value,c+='<div class="legend-each-container">',c+='<div class="legend-each-name">'+j+"</div>",c+='<div class="legend-each-color" style="'+e+'"></div>',c+="</div>"}.bind(this));var e="",f=!1;if(a.all.color&&!a.all.color.column){var g=a.all.color.value,h=a.all.opacity.value,i=this.color2RGB(g),j="rgba("+i.r+","+i.g+","+i.b+","+h+");";e+="background:"+j,0!=h&&(f=!0)}if(b.all.color&&!b.all.color.column){var g=b.all.color.value,h=b.all.opacity.value,k=b.all.width.value,i=this.color2RGB(g),j="rgba("+i.r+","+i.g+","+i.b+","+h+");";e+="border: "+k+"px solid "+j,0!=h&&(f=!0)}if(f){var l=this.legendObj.layerName,m="All "+l;c+='<div class="legend-each-container">',c+='<div class="legend-each-name">'+m+"</div>",c+='<div class="legend-each-color" style="'+e+'"></div>',c+="</div>"}if(a.all.color&&a.all.color.column){var n=a.all.color.value,o=a.all.color.minRange,p=a.all.color.maxRange,q=a.all.color.column,r={colorStops:n,minVal:o,maxVal:p,bline:q},s=this.gradientLegend(r);c+=s}return c},gradientLegend:function(a){var b=a.colorStops,c="background: -webkit-linear-gradient(left, "+b.join()+");";c+="background: -o-linear-gradient(right, "+b.join()+");",c+="background: -moz-linear-gradient(right, "+b.join()+");",c+="background: linear-gradient(to right, "+b.join()+");";var d='<div class="info-legend-container">';return d+='<div class="info-legend-frame">',d+='<div class="info-legend-val info-legend-min-val">'+a.minVal+"</div>",d+='<div class="info-legend-val info-legend-max-val">'+a.maxVal+"</div>",d+='<div class="info-legend-gradient-container" style="'+c+'"></div>',d+="</div>",a.bline&&(d+='<div class="info-legend-gradient-bottomline"">'+a.bline+"</div>"),d+="</div>"},color2RGB:function(a){if("#"==a[0])return this.hex2RGB(a);if("rgba"==a.substring(0,3).toLowerCase()){var b=";"==a[a.length-1]?a.length-2:a.length-1,d=c.substring(5,b),e=d.split(","),f={r:e[0],g:e[1],b:e[2]};return f}if("rgb"==a.substring(0,2).toLowerCase()){var b=";"==a[a.length-1]?a.length-2:a.length-1,d=c.substring(4,b),e=d.split(","),f={r:e[0],g:e[1],b:e[2]};return f}var g=this.colorNameToHex(a);return this.hex2RGB(g)},hex2RGB:function(a){a=this.checkHex(a);var b=parseInt(a.substring(1,3),16),c=parseInt(a.substring(3,5),16),d=parseInt(a.substring(5,7),16),e={r:b,g:c,b:d};return e},checkHex:function(a){if(7==a.length)return a;if(4==a.length){var b=parseInt(a.substring(1,3),16),c=parseInt(a.substring(3,5),16),d=parseInt(a.substring(5,7),16);return"#"+b+b+c+c+d+d}},colorNameToHex:function(a){var b={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},c=a.toLowerCase();return b[c]?b[c]:"#000000"}}),L.control.description=function(a){return new L.Control.Description(a)},L.Control.Mouseposition=Wu.Control.extend({type:"mouseposition",options:{position:"topright",separator:",  ",emptyString:"Lat/Lng",lngFirst:!1,numDigits:3,lngFormatter:this.formatNum,latFormatter:this.formatNum,prefix:"",zoomLevel:!0},_on:function(){this._show()},_off:function(){this._hide()},_show:function(){this._container.style.display="inline-block"},_hide:function(){this._container.style.display="none"},_addTo:function(){this.addTo(app._map),this._added=!0},_refresh:function(){this._added||this._addTo();var a=this._project.getControls()[this.type];return a?void this._flush():this._hide()},_flush:function(){},onAdd:function(a){return this._map=a,this._container=L.DomUtil.create("div","leaflet-control-mouseposition"),this._container.innerHTML=this.options.emptyString,L.DomEvent.disableClickPropagation(this._container),a.on("mousemove",this._onMouseMove,this),this.options.zoomLevel&&(a.on("zoomend",this._updateZoom,this),this._updateZoom()),app.Tooltip.add(this._container,"Gives the coordinates of the mouse pointer",{"extends":"systyle",tipJoint:"bottom middle"}),this._container},_updateZoom:function(){this._zoom=this._map.getZoom()},onRemove:function(a){a.off("mousemove",this._onMouseMove,this),this.options.zoomLevel&&a.off("zoomend",this._updateZoom,this)},_onMouseMove:function(a){var b=this.formatNum(a.latlng.lng,this.options.numDigits),c=this.formatNum(a.latlng.lat,this.options.numDigits),d=this.options.lngFirst?b+this.options.separator+c:c+this.options.separator+b,e=this.options.prefix+" "+d;this.options.zoomLevel&&(e+=",  "+this._zoom),this._container.innerHTML=e},formatNum:function(a,b){var c=Math.pow(10,b||5),d=Math.round(a*c)/c,e=d.toString().split("."),f=e[1];if(!f)return"";for(var g=b-f.length,h=0;g>h;h++)f+="0";var i=e[0]+"."+f;return i}}),L.Map.mergeOptions({positionControl:!1}),L.Map.addInitHook(function(){this.options.positionControl&&(this.positionControl=new L.Control.MousePosition,this.addControl(this.positionControl))}),L.control.mouseposition=function(a){return new L.Control.MousePosition(a)},Wu.Style=Wu.Class.extend({currentTheme:"lightTheme",initialize:function(){this._styletag=Wu.DomUtil.get("styletag"),Wu.Mixin.Events.on("projectSelected",this._projectSelected,this)},_projectSelected:function(a){var b=a.detail.projectUuid;this._project=app.Projects[b],!this._project},setDarkTheme:function(){var a=document.createElement("link");a.rel="stylesheet",a.href=app.options.servers.portal+"css/darktheme.css",this._styletag.appendChild(a),this.setDarkThemeCartoCSS(),this.currentTheme="darkTheme"},setLightTheme:function(){this._styletag.innerHTML="",this.setLightThemeCartoCSS(),this.currentTheme="lightTheme"},setLightThemeCartoCSS:function(){var a=app.MapPane.getControls().cartocss;if(a){var b=Wu.DomUtil.get("cartoCSStheme");a._codeMirror.setOption("theme","default"),b.setAttribute("href",app.options.servers.portal+"js/lib/codemirror/mode/cartocss/codemirror.carto.css")}},setDarkThemeCartoCSS:function(){var a=app.MapPane.getControls().cartocss;if(a){var b=Wu.DomUtil.get("cartoCSStheme");a._codeMirror.setOption("theme","mbo"),b.setAttribute("href",app.options.servers.portal+"js/lib/codemirror/mode/cartocss/codemirror.carto.darktheme.css")}},getCurrentTheme:function(){return this.currentTheme},initSVGpatterns:function(){var a='<!-- SVG fill properties: url(#diagonal-dots) // url(#dots) url(#diagonal-circles) url(#diagonal-stripes) url(#grid) --><svg xmlns="http://www.w3.org/2000/svg"><defs><pattern id="diagonal-dots" x="0" y="0" width="11" height="11" patternUnits="userSpaceOnUse" patternTransform="rotate(45)"><circle cx="5" cy="5" r="4" style="stroke:none; fill:blue;" /></pattern></defs><defs><pattern id="dots" x="0" y="0" width="11" height="11" patternUnits="userSpaceOnUse"><circle cx="5" cy="5" r="4" style="stroke:none; fill:red;" /></pattern><pattern id="diagonal-circles" x="0" y="0" width="11" height="11" patternUnits="userSpaceOnUse" patternTransform="rotate(45)"><circle cx="5" cy="5" r="4" style="stroke-width:2; stroke:green; fill:none;" /></pattern><pattern id="diagonal-stripes" x="0" y="0" width="8" height="8" patternUnits="userSpaceOnUse" patternTransform="rotate(30)"><rect x="0" y="0" width="4" height="8" style="stroke:none; fill:purple;" /></pattern><pattern id="grid" x="0" y="0" width="10" height="10" patternUnits="userSpaceOnUse"><rect x="0" y="0" width="10" height="4" style="stroke:none; fill:orange;" /><rect x="3" y="3" width="4" height="10" style="stroke:none; fill:orange;" /></pattern></defs></svg>';this._styletag.innerHTML=a},phantomJS:function(){var a=document.createElement("link");a.rel="stylesheet",a.href=app.options.servers.portal+"css/phantomJS.css",this._styletag.appendChild(a)},phantomJSthumb:function(){var a=document.createElement("link");a.rel="stylesheet",a.href=app.options.servers.portal+"css/phantomJSthumb.css",this._styletag.appendChild(a)},setStyle:function(a,b){jss.set(a,b)},getStyle:function(a){return jss.getAll(a)}}),Wu.setStyle=Wu.Style.setStyle,Wu.getStyle=Wu.Style.getStyle,Wu.Tooltip=Wu.Class.extend({options:{fixed:!0,target:!0,tipJoint:"middle right",background:"#333",borderColor:"#333",className:"systip",delay:1},defaultStyle:{fixed:!0,target:!0,tipJoint:"middle right",background:"#333",borderColor:"#333",className:"systip",delay:1},initialize:function(){this.tips=[],Opentip.styles.systyle=this.defaultStyle},_isActive:function(){return!1},add:function(a,b,c){return},on:function(){},off:function(){this.tips.forEach(function(a){a.tip&&a.tip.deactivate()},this)},activate:function(){this.on()},deactivate:function(){this.off()}}),L.SpinningMap=L.Class.extend({options:{gl:!1,accessToken:null,layer:null,logo:"",content:"",container:"map",speed:1e3,tileFormat:"jpg70",position:{lat:59.91843,lng:10.74721,zoom:[15,17]},circle:{radius:120,color:"rgba(33,33,33,0.5)",border:{px:4,solid:"solid",color:"white"}},autoStart:!1,interactivity:!1,spinning:["spinning","spinning90","spinning270","spinning-reversed","spinning-reversed90","spinning-reversed270"],listeners:[{event:null,action:"changeView"}],duration:1e5},initialize:function(a){L.setOptions(this,a),L.mapbox.accessToken=this.options.accessToken,this.initLayout(),this.addHooks(),this.options.autoStart&&this.start()},initLayout:function(){this._wrapper=this.options.wrapper||L.DomUtil.create("div","spinning-wrapper",document.body),this._container=this.options.container,this._wrapper.appendChild(this._container),this.options.content&&this.initContent(),this._gl=this.options.gl&&mapboxgl.util.supported(),this._gl?this.initGLMap():this.initMap(),this._loginForm=L.DomUtil.get("login-form"),L.DomUtil.addClass(this._loginForm,this.options.logoBackgroundClass),this._logo=L.DomUtil.get("login-logo");var a='url("'+this.options.loginLogo+'")';this._logo.style.backgroundImage=a},initContent:function(){var a=this.options.content;this._wrapper.appendChild(a)},initMap:function(){this.setDimensions(),this.createMap(),this.options.circle&&this.createCircle(),L.DomEvent.on(window,"resize",this.setDimensions,this)},disable:function(){Wu.DomUtil.remove(this._wrapper),setTimeout(this.kill,1e3)},kill:function(){this._wrapper=null,delete this._wrapper,delete this._map,delete this._container,delete this},createMap:function(){var a=(this.options.position.lat,this.options.position.lng,this.options.position.zoom,this._map=L.mapbox.map(this._container,{attributionControl:!0}));L.mapbox.tileLayer(this.options.layer,{format:this.options.tileFormat}).addTo(a);this.changeView(),this.options.interactivity||(a.dragging.disable(),a.touchZoom.disable(),a.doubleClickZoom.disable(),a.scrollWheelZoom.disable(),a.boxZoom.disable(),a.keyboard.disable()),a.zoomControl.removeFrom(a)},setView:function(a,b,c){this._map.setView([a,b],c)},changeView:function(){var a=(this.options.position.lat,this.options.position.lng,this._getPlace());this.setView(a.lat,a.lng,a.zoom),this.stop(),this.start()},_getPlace:function(){var a=this._places[Math.floor(Math.random()*this._places.length)];return a},_places:[{lat:40.789,lng:-73.953,zoom:15},{lat:59.91843,lng:10.74721,zoom:14},{lat:37.789,lng:-122.4,zoom:16},{lat:35.71,lng:139.821,zoom:14},{lat:-2.68,lng:-65.915,zoom:8},{lat:15.089,lng:39.922,zoom:10}],addHooks:function(){this._map},removeHooks:function(){var a=this._map;a.off("resize",this._onResize.bind(this))},contentClick:function(){this._resetMoves(),this._gl&&this.changeViewGL()},_onResize:function(){},createCircle:function(){return},setDimensions:function(){var a=this._getDimensions();.125*a.width-a.width,.5*a.height-a.width},_getDimensions:function(a){var b=window,c=document,a=c.documentElement,d=c.getElementsByTagName("body")[0],e=b.innerWidth||a.clientWidth||d.clientWidth,f=b.innerHeight||a.clientHeight||d.clientHeight,c={height:f,width:e};return c},start:function(){},stop:function(){},_start:function(){this._direction=this._getDirection(),L.DomUtil.addClass(this._container,this._direction)},_stop:function(){L.DomUtil.removeClass(this._container,this._direction)},_getDirection:function(){var a=this.options.spinning,b=Math.floor(Math.random()*a.length);return a[b]},_getZoomLevel:function(a){var b=this.options.position.zoom[0],c=this.options.position.zoom[1],d=(Math.floor(Math.random()*(c-b)+b),[3,5,13,14]),e=d[Math.floor(Math.random()*d.length)],f=this._map._container.firstChild;return window._map=this._map,f.style="transform: rotate(90deg); left: 100%;",e},createGLmap:function(){var a=this.options.position.lat,b=this.options.position.lng,c=this._getZoomLevel(),d=this.options.accessToken,e=(this._container,this.options.layer);mapboxgl.accessToken=d;this._map=new mapboxgl.Map({container:this._container.id,style:{version:6,sources:{"simple-tiles":{tiles:"raster",url:"mapbox://"+e,tileSize:256,type:"raster"}},layers:[{id:"simple-tiles",type:"raster",source:"simple-tiles",minzoom:0,maxzoom:22}]},center:[a,b],zoom:c})},initGLMap:function(){this._extendMapboxGL(),this.createGLmap(),this.createCircle()},_extendMapboxGL:function(){mapboxgl.Map.prototype._normalizeBearing=function(a){return a}},panGL:function(){var a=this._container.offsetWidth,b=this._pan=.375*a;this._map.panBy([b,0],{duration:0})},restartGLRotation:function(){clearTimeout(this._rotationTimer),this.startGLRotation()},startGLRotation:function(){var a=this.options.duration,b=(new mapboxgl.LatLng(37.76,-122.44),this._container.offsetWidth,this._getOffset());this._deg||(this._deg=90),this._map.rotateTo(this._deg,{duration:a,offset:b,easing:function(a){return a}}),this._rotationTimer=setTimeout(this.startGLRotation.bind(this),a),this._deg=this._deg+90},changeViewGL:function(){var a=(this._map.getBearing(),this._bearing=this._bearing?this._bearing+90:90);this._bearing>=360&&(this._bearing=0);var b=this._getBearingOffset(a),c=this.options.position.lat,d=this.options.position.lng,e=this._getZoomLevel(this._map.getZoom());this._map.flyTo([c,d],e,a,{offset:b,speed:.8})},_getBearingOffset:function(a){var b=this._getOffset(),c=b[0];if(90==a)var d=[0,c];if(180==a)var d=[-c,0];if(270==a)var d=[0,-c];if(360==a||0==a)var d=[c,0];return d},_randomIntFromInterval:function(a,b){return Math.floor(Math.random()*(b-a+1)+a)},_getOffset:function(a){var b=this._container.offsetWidth,c=b*-.375;return a?[0,c]:[c,0]},_startGL:function(){this.panGL(),this.startGLRotation()},_stopGL:function(){}}),Wu.Popup={},Wu.Popup.Chart=L.Control.extend({includes:L.Mixin.Events,options:{minWidth:50,maxWidth:300,autoPan:!0,closeButton:!0,offset:[0,7],autoPanPadding:[0,0],autoPanPaddingTopLeft:L.point(10,40),autoPanPaddingBottomRight:L.point(10,20),keepInView:!1,className:"",zoomAnimation:!1,defaultPosition:{x:7,y:6}},initialize:function(a){L.setOptions(this,a),this._map=app._map,this._pane=this.options.appendTo,this._listen(),this._initLayout()},_addEvents:function(){this._map.on({preclick:this.close},this)},_removeEvents:function(){this._map.off({preclick:this.close},this)},_initLayout:function(){var a=this._container=Wu.DomUtil.create("div","leflet-container leaflet-popup leaflet-zoom-hide");if(this.options.closeButton){var b=this._closeButton=Wu.DomUtil.create("a","leaflet-popup-close-button",a);b.href="#close",b.innerHTML="&#215;",L.DomEvent.disableClickPropagation(b),L.DomEvent.on(b,"mouseup",this._onCloseButtonClick,this)}var c=this._wrapper=L.DomUtil.create("div","leaflet-popup-content-wrapper",a);this._initDraggable(),this._contentNode=L.DomUtil.create("div","leaflet-popup-content",c),L.DomEvent.disableScrollPropagation(this._contentNode),L.DomEvent.on(c,"contextmenu",L.DomEvent.stopPropagation)},_onCloseButtonClick:function(a){this.close(),L.DomEvent.stop(a)},_add:function(){this._pane.appendChild(this._container),this._addEvents(),this._added=!0},_remove:function(){if(this._added){try{this._pane.removeChild(this._container)}catch(a){}this._removeEvents()}},open:function(){this._added||this._add(),this._map.fire("popupopen")},close:function(){this._map.fire("popupclose"),this._remove()},getContent:function(){return this._content},setContent:function(a){return this._content=a,this.update(),this},update:function(){this._map&&(this._container.style.visibility="hidden",this._updateContent(),this._updatePosition(),this._container.style.visibility="")},_updateContent:function(){if(this._content)if("string"==typeof this._content)this._contentNode.appendChild(this._content);else{for(;this._contentNode.hasChildNodes();)this._contentNode.removeChild(this._contentNode.firstChild);this._contentNode.appendChild(this._content)}},_updatePosition:function(){var a=this.getSavedPosition();if(a)return this.setPosition(a);if(app.Chrome.Left._isOpen){var b=app.Chrome.Left.getDimensions(),c=b.width+10,d=this.options.defaultPosition.y,a={x:c,y:d};return this.setPosition(a)}if(app.Chrome.Right._isOpen){var b=app.Chrome.Right.getDimensions(),c=b.width+10,d=this.options.defaultPosition.y,a={x:c,y:d};return this.setPosition(a)}var a=this.options.defaultPosition;this.setPosition(a)},getSavedPosition:function(){var a=app.activeProject,b=a.getPopupPosition();return b},_initDraggable:function(){var a=Wu.DomUtil.create("div","leaflet-popup-drag",this._wrapper);Wu.DomEvent.on(a,"mousedown",this._dragStart,this)},_dragStart:function(a){var b={x:this._container.offsetLeft,y:this._container.offsetTop},c={x:a.x,y:a.y},d=b,e=c;this._mouseOffset={x:e.x-d.x,y:e.y-d.y},this._windowDimensions=this._getWindowDimensions(),this._ghost=Wu.DomUtil.create("div","leaflet-popup-ghost",app._appPane),Wu.DomEvent.on(this._ghost,"mouseup",this._dragStop,this),Wu.DomEvent.on(this._ghost,"mousemove",this._dragging,this)},_dragStop:function(a){Wu.DomEvent.off(this._ghost,"mouseup",this._dragStop,this),Wu.DomEvent.off(this._ghost,"mousemove",this._dragging,this),Wu.DomUtil.remove(this._ghost);var b=app.activeProject;b.setPopupPosition(this._lastPopupPos)},_dragging:function(a){var b=this._windowDimensions.height,c={x:a.offsetX-this._mouseOffset.x,y:b-(a.offsetY-this._mouseOffset.y)-this._container.offsetHeight};this.setPosition({x:c.x,y:c.y})},_getWindowDimensions:function(){var a={};return a.width=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,a.height=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,a},setPosition:function(a,b){this._container.style.left=a.x+"px",this._container.style.bottom=a.y+"px",this._lastPopupPos=a},_listen:function(){Wu.Mixin.Events.on("layerDeleted",this._onLayerDeleted,this),Wu.Mixin.Events.on("layerDisabled",this._onLayerDeleted,this)},_onLayerDeleted:function(){this.close()}}),Wu.popup=function(a,b){return new Wu.Popup.Chart(a,b)},Wu.Control.Chart=Wu.Control.extend({initialize:function(a){var b=a.multiPopUp,c=a.e;if(b){var d=this._getWuLayerFromPostGISLayer(b.layer_id);this.popupSettings=d.getTooltip();var e=this.multiPointPopUp(b)}else{if(!c)return;this.popupSettings=c.layer.getTooltip();var e=this.singlePopUp(c)}this._popup=null,e&&(this._popupContent||(this._popupContent=""),this._popupContent=e,this.openPopup(c,b))},openPopup:function(a,b){if(!this._popup){var c=this._createPopup(),d=this._popupContent,e=(app._map,this._project||app.activeProject,b?b.center:a.latlng);if(!d)return this._clearPopup();if(this._addPopupCloseEvent(),this._popup=c,c.setContent(d),c.open(),!b){var e=this._getMarkerPosition(e,a);this._addMarkerCircle(e)}}},_getMarkerPosition:function(a,b){return a},_addMarkerCircle:function(a){var b={radius:10,fillColor:"white",color:"white",weight:15,opacity:1,fillOpacity:.4};this.popUpMarkerCircle=L.circleMarker(a,b).addTo(app._map)},_addPopupCloseEvent:function(){if(!this._popInit){this._popInit=!0;var a=app._map;a.on("popupclose",this._clearPopup,this)}},_removePopupCloseEvent:function(){var a=app._map;a.off("popupclose",this._clearPopup,this)},_refresh:function(){this._popup&&this._popup._remove(),this._clearPopup(!1)},_clearPopup:function(a){a&&app.MapPane.getControls().draw._clearAll(),this._popupContent="",this._popup=null,this.popUpMarkerCircle&&app._map.removeLayer(this.popUpMarkerCircle),this._removePopupCloseEvent()},_createPopup:function(){if(this.popupSettings.timeSeries&&0!=this.popupSettings.timeSeries.enable)var a=400,b=200;else var a=200,b=200;var c=this._popup=Wu.popup({offset:[18,0],closeButton:!0,zoomAnimation:!1,maxWidth:a,minWidth:b,maxHeight:350,appendTo:app._appPane});return this.popupSettings.timeSeries&&0!=this.popupSettings.timeSeries.enable||Wu.DomUtil.addClass(c._container,"tiny-pop-up"),c},singlePopUp:function(a){var b=this.popupSettings.timeSeries&&1==this.popupSettings.timeSeries.enable,c=b?this.singleC3PopUp(a):this._createPopupContent(a);return c},_createPopupContent:function(a){var b={data:a.data,layer:a.layer,layerName:a.layer.store.title,meta:!1,popupSettings:this.popupSettings,d3array:{meta:[],xName:"field_x",yName:"mm",x:[],y:[],ticks:[],tmpTicks:[]},multiPopUp:!1};this._c3Obj=this.createC3dataObj(b);var c={headerMeta:this._c3Obj.d3array.meta,layerName:a.layer.store.title,areaSQ:!1,pointCount:!1,multiPopUp:!1,layer:a.layer},d=this.createHeader(c),e=this.createChartContainer(),f=this.createFooter(),g=Wu.DomUtil.create("div","popup-inner-content");return g.appendChild(d),g.appendChild(e),g.appendChild(f),g},singleC3PopUp:function(a){var b={data:a.data,layer:a.layer,meta:!1,popupSettings:this.popupSettings,d3array:{meta:[],xName:"field_x",yName:"mm",x:[],y:[],ticks:[],tmpTicks:[]}};this._c3Obj=this.createC3dataObj(b);var c={headerMeta:this._c3Obj.d3array.meta,layerName:a.layer.store.title,areaSQ:!1,pointCount:!1,multiPopUp:!1,layer:a.layer},d=Wu.DomUtil.create("div","popup-inner-content"),e=this.createHeader(c),f=this.createChartContainer(),g=this.createFooter();if(d.appendChild(e),d.appendChild(f),d.appendChild(g),this.popupSettings&&0!=this.popupSettings.timeSeries.enable){var h=this.C3Chart(this._c3Obj);this.chartTicks(this._c3Obj);f.appendChild(h)}return d},_calculateRegression:function(a){var b,a=this._c3object,c=[],d=_.clone(a.d3array.y);d.splice(0,1);var e=[];d.forEach(function(a){e.push(parseFloat(a))});var f=_.clone(a.d3array.x);f.splice(0,1),f.forEach(function(a,d){if(0==d)b=moment(a),c.push(0);else{var e=moment(a),f=e.diff(b,"days");c.push(f)}});var g=[],h=[];c.forEach(function(a,b){h.push(c[b]*e[b]),g.push(c[b]*c[b])});var i=0,j=0,k=0,l=0;c.forEach(function(a,b){i+=a}),e.forEach(function(a,b){j+=a}),g.forEach(function(a,b){k+=a}),h.forEach(function(a,b){l+=a});var m=e.length,n=(j*k-i*l)/(m*k-i*i),o=(m*l-i*j)/(m*k-i*i),p=n+o*c[0],q=n+o*c[c.length-1],r=["regression"];return e.forEach(function(a,b){if(0==b)r.push(p);else{var c=q/m*b;r.push(c)}}),r},multiPointPopUp:function(a){var b=a.average,c=a.center,d=this._getWuLayerFromPostGISLayer(a.layer_id),e=d.store.title,f=a.total_points;if(a.area<1e3)var g=Math.round(a.area),h=g+"m<sup>2</sup>";else var g=a.area/1e6,i=Math.floor(1e3*g)/1e3,h=i+"km<sup>2</sup>";var j={data:b,meta:!1,popupSettings:this.popupSettings,d3array:{meta:[],xName:"field_x",yName:"mm",x:[],y:[],ticks:[],tmpTicks:[]},multiPopUp:{center:c}};this._c3Obj=this.createC3dataObj(j);var k={headerMeta:this._c3Obj.d3array.meta,layerName:e,areaSQ:h,pointCount:f,multiPopUp:!0,layer:d},l=Wu.DomUtil.create("div","popup-inner-content"),m=this.createHeader(k),n=this.createChartContainer(),o=this.createFooter();if(l.appendChild(m),l.appendChild(n),l.appendChild(o),this.popupSettings.timeSeries&&1==this.popupSettings.timeSeries.enable){var p=this.C3Chart(this._c3Obj);this.chartTicks(this._c3Obj);n.appendChild(p)}return l},chartTicks:function(a){var b=a.d3array,c=(b.ticks,b.x[1]),d=b.x[b.x.length-1],e=moment(c).format("DD.MM.YYYY"),f=moment(d).format("DD.MM.YYYY");this._footerDates.innerHTML='<span class="start-date">'+e+'</span><span class="end-date">'+f+"</span>"},createFooter:function(){var a=this._footerContainer=Wu.DomUtil.create("div","c3-footer");this._footerDates=Wu.DomUtil.create("div","c3-footer-dates",a);return a},createChartContainer:function(){var a=this._chartContainer=Wu.DomUtil.create("div","c3-chart-container");return a},createHeader:function(a){var b=a.headerMeta,c=a.layerName,d=a.areaSQ,e=a.pointCount,f=a.multiPopUp;this.popupSettings.title&&""!=this.popupSettings.title&&(c=this.popupSettings.title);
var g=Wu.DomUtil.createId("div","c3-header-metacontainer");this.popupSettings.timeSeries&&0!=this.popupSettings.timeSeries.enable||(g.className="small-pop-up");var h=Wu.DomUtil.create("div","c3-header-wrapper",g);Wu.DomUtil.create("div","c3-header-layer-name",h,c);if(f){var i=a.layer.getMeta().geometry_type,j="items";"ST_Point"==i&&(j="points"),"ST_MultiPolygon"==i&&(j="polygons");var k="Sampling "+e+" "+j+" over approx. "+d;Wu.DomUtil.create("div","c3-point-count",h,k)}var l=0;return b.forEach(function(a,b){var c=a[0],d=a[1],e=this.popupSettings?this.popupSettings.metaFields[c]:!1;if(e&&"geom"!=c&&"the_geom_3857"!=c&&"the_geom_4326"!=c&&d&&0!=e.on){if(e.title&&""!=e.title)var f=e.title;else var f=c;l++;var h=100;if(h){var i=Math.floor(parseFloat(d)*h)/h;isNaN(i)||(d=i)}if(d){var j=Wu.DomUtil.create("div","c3-header-metapair metapair-"+l,g);Wu.DomUtil.create("div","c3-header-metakey",j,f),Wu.DomUtil.create("div","c3-header-metaval",j,d)}}}.bind(this)),g},C3Chart:function(a){var b=a.d3array,c=b.ticks,d=b.x,e=b.y,f=c[0],g=d[0];g>f&&c.splice(0,1);var h,i=Math.min.apply(null,e),j=Math.max.apply(null,e),k=a.popupSettings.timeSeries.minmaxRange;if(k)h=parseInt(k);else if(0>i){var l=Math.abs(i);h=l>j?l:j}else h=Math.floor(100*j)/100;this._range=h;var m=b.xName,n=b.yName;d.unshift(m),e.unshift(n),_columns=[d,e];var o=Wu.DomUtil.createId("div","c3-container");this._chart=c3.generate({interaction:!0,bindto:o,size:{height:200,width:430},point:{show:!1,r:3},grid:{y:{show:!0},x:{show:!0}},legend:{show:!1},zoom:{enabled:!1},data:{xs:{mm:"field_x",regression:"reg_x"},columns:_columns,colors:{mm:"#0000FF",regression:"#C83333"},types:{mm:"scatter",regression:"line"}},axis:{x:{type:"timeseries",localtime:!1,tick:{format:"%Y",values:[],multiline:!0}},y:{max:h,min:-h,tick:{format:function(a){return Math.floor(100*a)/100}}}},tooltip:{grouped:!0,format:{title:function(a){var b=moment(a).format("DD.MM.YYYY");return b}}},color:{pattern:["#000000"]}});return this._addChartEvents(o),this._addRegressionButton(),o},_addRegressionButton:function(){var a=Wu.DomUtil.create("div","regression-button-wrapper",this._footerContainer);this.regressionButton=new Wu.button({type:"switch",isOn:!1,right:!1,id:"regression-button",appendTo:a,fn:this._updateRegression.bind(this),className:"relative-switch"});var b=Wu.DomUtil.create("label","invite-permissions-label",a);b.htmlFor="regression",b.appendChild(document.createTextNode("Regression"))},_updateRegression:function(a){var b=a.target,c=b.getAttribute("on");if("false"!=c&&c)Wu.DomUtil.removeClass(b,"switch-on"),b.setAttribute("on","false"),this._chart.unload({ids:"regression"});else{Wu.DomUtil.addClass(b,"switch-on"),b.setAttribute("on","true");var d=this._calculateRegression(),e=this._c3Obj.d3array.x,f=[d[0],d[1],d[d.length-1]],g=["reg_x",e[1],e[e.length-1]];this._chart.load({columns:[g,f]}),app.Analytics.onEnabledRegression()}},_addChartEvents:function(a){Wu.DomEvent.on(a,"mousewheel",_.throttle(this._onChartMousemove,50),this)},_onChartMousemove:function(a){var a=window.event||a,b=Math.max(-1,Math.min(1,a.wheelDeltaY||-a.detail));if(0!=a.wheelDeltaY){var c=this._range/8;b>0?(this._range=this._range+=c,this._chart.axis.max(this._range),this._chart.axis.min(-this._range)):(this._range=this._range-=c,this._range<1&&(this._range=1),this._chart.axis.max(this._range),this._chart.axis.min(-this._range))}},createC3dataObj:function(a){var b=a.data,c=a.meta,d=a.d3array;if(c)for(var e in c.fields){var f=c.fields[e];if(f.on){var g=parseFloat(b[f.key]).toString().substring(0,10),h=f.title||f.key;this.C3dataObjBuilder(h,g,d)}}else for(var i in b){var g=parseFloat(b[i]).toString().substring(0,10);"NaN"==g&&(g=b[i]);var h=i;this.C3dataObjBuilder(h,g,d)}return this._c3object=a,a},C3dataObjBuilder:function(a,b,c){if(!this.popupSettings.timeSeries||!this.popupSettings.timeSeries[a]||this.popupSettings.timeSeries[a].on){var d=this._validateDateFormat(a);if(d){var e=new Date(d);c.x.push(e),c.y.push(b);var f=moment(d),g=new Date(f),h=!0;c.ticks.forEach(function(a){a==g&&(h=!1)}),h&&c.ticks.push(g)}else c.meta.push([a,b])}},_getWuLayerFromPostGISLayer:function(a){var b=app.activeProject.getLayers(),c=_.find(b,function(b){return b&&b.store&&b.store.data&&b.store.data.postgis?b.store.data.postgis.layer_id==a:!1});return c},_validateDateFormat:function(a){if("the_geom_3857"==a||"the_geom_4326"==a)return!1;if(a.length<6)return!1;if(!this._validate.onlyLetters(a)&&!this._validate.shortWithLetters(a)){var b=moment(a,["YYYYMMDD",moment.ISO_8601]).format("YYYY-MM-DD");if("Invalid date"!=b)return b;var b=moment(a).format("YYYY-MM-DD");return"Invalid date"!=b?b:!1}},_validate:{onlyLetters:function(a){var b=[];return _.each(a,function(a){isNaN(a)||b.push(a)}),b.length?!1:!0},shortWithLetters:function(a){var b=[];return _.each(a,function(a){isNaN(a)&&b.push(a)}),b.length&&a.length<7?!0:!1}}}),Wu.Model=Wu.Class.extend({initialize:function(a){Wu.setOptions(this,a),this._initialize(a),this._listen()},_listen:function(){Wu.Mixin.Events.on("projectSelected",this._projectSelected,this),Wu.Mixin.Events.on("editEnabled",this._editEnabled,this),Wu.Mixin.Events.on("editDisabled",this._editDisabled,this),Wu.Mixin.Events.on("layerEnabled",this._layerEnabled,this),Wu.Mixin.Events.on("layerDisabled",this._layerDisabled,this),Wu.Mixin.Events.on("fileImported",this._onFileImported,this),Wu.Mixin.Events.on("fileDeleted",this._onFileDeleted,this),Wu.Mixin.Events.on("layerAdded",this._onLayerAdded,this),Wu.Mixin.Events.on("layerEdited",this._onLayerEdited,this),Wu.Mixin.Events.on("layerDeleted",this._onLayerDeleted,this);var a="downloadReady-"+this.getUuid();Wu.Mixin.Events.on(a,this._onDownloadReady,this)},_projectSelected:function(a){var b=a.detail.projectUuid;b&&(this._project=app.activeProject=app.Projects[b],this._refresh())},_initialize:function(){},_initContainer:function(){},_editEnabled:function(){},_editDisabled:function(){},_layerEnabled:function(){},_layerDisabled:function(){},_updateView:function(){},_refresh:function(){},_onFileImported:function(){},_onFileDeleted:function(){},_onLayerAdded:function(){},_onLayerEdited:function(){},_onLayerDeleted:function(){},_onDownloadReady:function(){}}),Wu.Project=Wu.Class.extend({initialize:function(a){this.store={},Wu.extend(this.store,a),this.lastSaved={},this._initObjects()},_initObjects:function(){this.initRoles(),this.initFiles(),this.initLayers()},initRoles:function(){var a=this.store.roles;this._roles={},a&&_.each(a,function(a){this._roles[a.uuid]=new Wu.Role({role:a,project:this})},this)},initFiles:function(){var a=this.getFiles();this.files={},a&&a.forEach(function(a){this.files[a.uuid]=new Wu.Model.File(a)},this)},initLayers:function(){var a=this.store.layers;this.layers={},a&&a.forEach(function(a){var b=new Wu.createLayer(a);b&&(this.layers[a.uuid]=b)},this)},addLayers:function(a){a.forEach(function(a){this.addLayer(a)},this)},addLayer:function(a){var b=new Wu.createLayer(a);return b&&(this.layers[a.uuid]=b),b||!1},addBaseLayer:function(a){this.store.baseLayers.push(a),this._update("baseLayers")},removeBaseLayer:function(a){_.remove(this.store.baseLayers,function(b){return b.uuid==a.getUuid()}),this._update("baseLayers")},setBaseLayer:function(a){this.store.baseLayers=a,this._update("baseLayers")},createOSMLayer:function(a){var b=this._getOSMLayerTitle(),c=JSON.stringify({projectUuid:this.getUuid(),title:b});Wu.Util.postcb("/api/layers/osm/new",c,function(b,c){var d=b.addLayer(JSON.parse(c));a(null,d)},this)},_getOSMLayerTitle:function(){var a=_.filter(this.getLayers(),function(a){return a.store.data.osm}),b="Open Street Map",c=a.length;return c&&(b+=" #"+c),b},createLayerFromGeoJSON:function(a){var b=JSON.stringify({project:this.getUuid(),geojson:a,layerType:"geojson"});Wu.Util.postcb("/api/layers/new",b,this._createdLayerFromGeoJSON,this)},_createdLayerFromGeoJSON:function(a,b){JSON.parse(b)},createLayer:function(){},setActive:function(){this.select()},refresh:function(){this._refresh(),this._menuItem&&this._menuItem._markActive(),app.StatusPane.isOpen&&(app._map._controlCorners.topleft.style.opacity=0,app._map._controlCorners.topleft.style.display="none")},addNewLayer:function(a){this.addLayer(a)},_reset:function(){},_hardRefresh:function(){this._reset(),this.initFiles(),this.initLayers(),this.initRoles(),this._setUrl(),this.refreshSettings(),this.setColorTheme(),this._menuItem&&this._menuItem.update()},_refresh:function(){this._reset(),this.initRoles(),this._setUrl(),this.refreshSettings(),this.setColorTheme(),this._menuItem&&this._menuItem.update()},select:function(){app._headerPane&&Wu.DomUtil.removeClass(app._headerPane,"displayNone"),app.activeProject=this,this.selected=!0,this.refresh()},_setUrl:function(){var a="/";a+=this.store.slug,Wu.Util.setAddressBar(a)},setNewStore:function(a){this.store=a,this._initObjects()},setStore:function(a){this.store=a,this._hardRefresh()},setRolesStore:function(a){this.store.roles=a,this.initRoles()},setAccess:function(a){var b={project:this.getUuid(),access:a};Wu.Util.postcb("/api/project/setAccess",JSON.stringify(b),function(b,c){this.store.access=a}.bind(this),this)},addInvites:function(a){var b={project:this.getUuid(),access:a};Wu.Util.postcb("/api/project/addInvites",JSON.stringify(b),function(a,b){var c=Wu.parse(b);this.store.access=c}.bind(this),this)},getAccess:function(){return this.store.access},setMapboxAccount:function(a){this.store=a,this._refresh()},_update:function(a){var b={};b[a]=this.store[a],b.uuid=this.store.uuid;var c=JSON.stringify(b);this._save(c)},save:function(a){},_save:function(a){Wu.send("/api/project/update",a,this._saved.bind(this))},_saved:function(a,b){var c=Wu.parse(b);return c.error?app.feedback.setError({title:"Could not update project",description:c.error}):(app.setSaveStatus(),void Wu.Mixin.Events.fire("projectChanged",{detail:{projectUuid:this.getUuid()}}))},create:function(a,b){var c={name:this.store.name,description:this.store.description,keywords:this.store.keywords,position:this.store.position,access:this.store.access};Wu.post("/api/project/create",JSON.stringify(c),b.bind(a.context),this)},_unload:function(){app.MapPane._flush(),app.HeaderPane._flush(),this.selected=!1},_delete:function(a){var b=JSON.stringify({pid:this.store.uuid,projectUuid:this.store.uuid});Wu.Util.postcb("/api/project/delete",b,a||this._deleted,this)},_deleted:function(a,b){var c=app.options.servers.portal;a.getName();Wu.Util.setAddressBar(c),app.Projects[a.getUuid()]=null,delete app.Projects[a.getUuid()],app.activeProject&&app.activeProject.getUuid()==a.getUuid()&&(app.activeProject=null,a._unload(),Wu.Mixin.Events.fire("projectSelected",{detail:{projectUuid:!1}}),Wu.Mixin.Events.fire("projectDeleted",{detail:{projectUuid:a.getUuid()}})),a=null,delete a},saveColorTheme:function(){this.colorTheme=savedCSS,this._update("colorTheme")},setColorTheme:function(){this.colorTheme&&(savedCSS=this.colorTheme,Wu.Util.setColorTheme())},removeMapboxAccount:function(a){_.remove(this.store.connectedAccounts.mapbox,function(b){return b==a});this._update("connectedAccounts");var b=this.getLayers(),c=[];b.forEach(function(b){if(b.store.data&&b.store.data.mapbox){var d=b.store.data.mapbox,e=d.split(".")[0];e==a.username&&(this._removeLayer(b),c.push(b.getUuid()))}},this);var d={projectUuid:this.getUuid(),layerUuids:c},e=JSON.stringify(d);Wu.save("/api/layers/delete",e)},deleteLayer:function(a){var b={layerUuid:a.getUuid(),projectUuid:this.getUuid()};Wu.post("/api/layers/delete",JSON.stringify(b),function(b,c){if(b)return void 0;var d=Wu.parse(c);return d.error?void 0:(this._removeLayer(a),void Wu.Mixin.Events.fire("layerDeleted",{detail:{layer:this}}))}.bind(this))},removeLayer:function(a){var b=this.getLayer(a.uuid);this._removeLayer(b)},_removeLayer:function(a){_.remove(this.store.layermenu,function(b){return b.layer==a.getUuid()}),_.remove(this.store.baseLayers,function(b){return b.uuid==a.getUuid()});var b=app.MapPane.getControls().layermenu;b&&b.onDelete(a),a.remove();_.remove(this.store.layers,function(b){return b.uuid==a.getUuid()});delete this.layers[a.getUuid()],this._update("layermenu"),this._update("baseLayers")},getName:function(){return this.store.name},getTitle:function(){return this.getName()},getDescription:function(){return this.store.description},getLogo:function(){return this.store.logo},getUuid:function(){return this.store.uuid},getLastUpdated:function(){return this.store.lastUpdated},getClient:function(){},getClientUuid:function(){},getBaselayers:function(){return this.store.baseLayers},getLayermenuLayers:function(){return _.filter(this.store.layermenu,function(a){return!a.folder})},getLayers:function(){return _.toArray(this.layers)},getPostGISLayers:function(){var a=[];for(var b in this.layers){var c=this.layers[b];c.store&&c.store.data&&c.store.data.postgis&&a.push(c)}return a},getRasterLayers:function(){var a=[];for(var b in this.layers){var c=this.layers[b];c.store&&c.store.data&&c.store.data.raster&&a.push(c)}return a},getDataLayers:function(){var a=this.getPostGISLayers(),b=this.getRasterLayers(),c=a.concat(b);return c},getDeadLayers:function(){return _.filter(this.layers,function(a){return a?null==a.store.data:!0})},getActiveLayers:function(){var a=this.getBaselayers(),b=this.getLayermenuLayers(),c=a.concat(b),d=[];return c.forEach(function(a){if(!a.folder){var b=a.layer||a.uuid,c=this.layers[b];d.push(c)}},this),d},getLayer:function(a){return this.layers[a]},getPostGISLayer:function(a){return _.find(this.layers,function(b){return b.store&&b.store.data&&b.store.data.postgis?b.store.data.postgis.layer_id==a:void 0})},getStylableLayers:function(){var a=this.getActiveLayers(),b=_.filter(a,function(a){return a&&a.store?a.store.data.hasOwnProperty("geojson")?!0:a.store.data.hasOwnProperty("osm")?!0:a.store.data.hasOwnProperty("postgis")?!0:void 0:!1});return b},getLayerFromFile:function(a){return _.find(this.layers,function(b){return b.store.file==a})},getFiles:function(){return this.store.files},getFileObjects:function(){return this.files},getFileStore:function(a){var b=_.find(this.store.files,function(b){return b.uuid==a});return b},getFile:function(a){return this.files[a]},getBounds:function(){var a=this.store.bounds;return _.isEmpty(a)?!1:a},getState:function(){return this.store.state},getLatLngZoom:function(){var a={lat:this.store.position.lat,lng:this.store.position.lng,zoom:this.store.position.zoom};return a},getPosition:function(){return this.getLatLngZoom()},getCollections:function(){},getRoles:function(){return this._roles},getCategories:function(){return this.store.categories},addCategory:function(a){this.store.categories.push(a),this._update("categories")},removeCategory:function(a){_.remove(this.store.categories,function(b){return b.toLowerCase()==a.toLowerCase()}),this._update("categories")},getUsers:function(){var a=[],b=this._roles;return _.each(b,function(b){b.hasCapability("read_project")&&_.each(b.getMembers(),function(b){var c=app.Users[b];c&&a.push(c)})}),a},_filteredUsers:function(){var a=this.getUsers();return _.filter(a,function(a){return!app.Access.is.superAdmin(a)})},getSlug:function(){return this.store.slug},getSlugs:function(){var a={project:this.store.slug};return a},getUsersHTML:function(){var a=this._filteredUsers(),b="";return _.each(a,function(a){b+="<p>"+a.getFullName()+"</p>"}),b},getHeaderLogo:function(){if("darkTheme"===Wu.app.Style.getCurrentTheme())var a="/css/images/defaultProjectLogoLight.png";else if("lightTheme"===Wu.app.Style.getCurrentTheme())var a="/css/images/defaultProjectLogo.png";var b=this.store.header.logo;return b||(b=a),b},getHeaderLogoBg:function(){var a=this.store.header.logo;a||(a=this.store.logo);var b="url('"+a+"')";return b},getHeaderTitle:function(){return this.getName()},getHeaderSubtitle:function(){return this.store.header.subtitle},getHeaderHeight:function(){return parseInt(this.store.header.height)},getMapboxAccounts:function(){return this.store.connectedAccounts.mapbox},getControls:function(){var a=this.store.controls;return delete a.vectorstyle,a},getSettings:function(){return this.store.settings},clearPendingFiles:function(){this.store.pending=[],this._update("pending")},setPendingFile:function(a){this.store.pending.push(a),this._update("pending")},getPendingFiles:function(){return this.store.pending},removePendingFile:function(a){_.remove(this.store.pending,function(b){return b==a});this._update("pending")},setPopupPosition:function(a){this._popupPosition=a},getPopupPosition:function(){return this._popupPosition},setSettings:function(a){this.store.settings=a,this._update("settings")},setFile:function(a){this.store.files.push(a),this.files[a.uuid]=new Wu.Model.File(a)},setLogo:function(a){this.store.logo=a,this._update("logo")},setHeaderLogo:function(a){this.store.header.logo=a,this._update("header")},setHeaderTitle:function(a){this.store.header.title=a,this._update("header")},setHeaderSubtitle:function(a){this.store.header.subtitle=a,this._update("header")},setName:function(a){this.store.name=a,this._update("name"),this.setSlug(a)},setDescription:function(a){this.store.description=a,this._update("description")},setSlug:function(a){var b=a.replace(/\s+/g,"").toLowerCase();b=b.replace(/\W/g,""),b=Wu.Util.stripAccents(b),this.store.slug=b,this._update("slug"),this._setUrl()},setBounds:function(a){this.store.bounds=a,this._update("bounds")},setBoundsSW:function(a){this.store.bounds=this.store.bounds||{},this.store.bounds.southWest=a,this._update("bounds")},setBoundsNE:function(a){this.store.bounds=this.store.bounds||{},this.store.bounds.northEast=a,this._update("bounds")},setBoundsZoomMin:function(a){this.store.bounds=this.store.bounds||{},this.store.bounds.zoomMin=a,this._update("bounds")},setPosition:function(a){this.store.position=a,this._update("position")},setSidepane:function(a){this._menuItem=a},getSidepane:function(){return this._menuItem},removeFiles:function(a){return void 0},getGrandeFiles:function(){var a=this.getFiles(),b=this._formatGrandeFiles(a);return b},getGrandeImages:function(){var a=this.getFiles(),b=this._formatGrandeImages(a);return b},_formatGrandeImages:function(a){var b=[];return a.forEach(function(a){if("image"==a.type){var c="/pixels/"+a.uuid+"?width=75&height=50&access_token="+app.tokens.access_token,d="/pixels/"+a.uuid+"?width=200&height=200&access_token="+app.tokens.access_token,e={title:a.name,thumbnail:c,uuid:a.uuid,type:a.type,url:d};b.push(e)}},this),b},_formatGrandeFiles:function(a){var b=[];return a.forEach(function(a){var c="image"==a.type?"/pixels/"+a.uuid+"?width=50&height=50&access_token="+app.tokens.access_token:"",d="image"==a.type?"/images/":"/api/file/download/?file=",e=d+a.uuid+"&access_token="+app.tokens.access_token,f={title:a.name,thumbnail:c,uuid:a.uuid,type:a.type,url:e};b.push(f)},this),b},refreshSettings:function(){for(setting in this.getSettings())this.getSettings()[setting]?this["enable"+setting.camelize()]():this["disable"+setting.camelize()]()},toggleSetting:function(a){this._switchSetting(a),this.getSettings()[a]?this["enable"+a.camelize()]():this["disable"+a.camelize()]()},_switchSetting:function(a){this.store.settings[a]=!this.store.settings[a],this._update("settings")},enableDarkTheme:function(){app.Style.setDarkTheme()},disableDarkTheme:function(){app.Style.setLightTheme()},enableTooltips:function(){app.Tooltip.activate()},disableTooltips:function(){app.Tooltip.deactivate()},enableD3popup:function(){},disableD3popup:function(){},enableScreenshot:function(){},disableScreenshot:function(){},enableDocumentsPane:function(){},disableDocumentsPane:function(){},enableDataLibrary:function(){},disableDataLibrary:function(){},enableMediaLibrary:function(){},disableMediaLibrary:function(){},enableSocialSharing:function(){},disableSocialSharing:function(){},enableAutoHelp:function(){},disableAutoHelp:function(){},enableAutoAbout:function(){},disableAutoAbout:function(){},enableMapboxGL:function(){},disableMapboxGL:function(){},enableSaveState:function(){},disableSaveState:function(){},createProjectThumb:function(){this.setTempLogo(),app.setHash(function(a,b){var c=JSON.parse(b);c.dimensions={height:233,width:350},Wu.post("/api/util/createThumb",JSON.stringify(c),this.createdProjectThumb,this)}.bind(this),this)},createdProjectThumb:function(a,b){var c=JSON.parse(b),d=c.cropped,e=(c.fileUuid,"/images/"+d);a.setLogo(e),a.setHeaderLogo(e),a._menuItem.logo.style.backgroundImage="url("+a._getPixelLogo(e)+")",a.setTempLogo(),a==app.activeProject&&app.HeaderPane.addedLogo(d)},setThumbCreated:function(a){this.store.thumbCreated=a,this._update("thumbCreated")},getThumbCreated:function(){return this.store.thumbCreated},setTempLogo:function(){this._sidePaneLogoContainer.src=app.options.logos.projectDefault},_getPixelLogo:function(a){var b=a.split("/")[2],c="/pixels/image/"+b+"?width=90&height=60&format=png&access_token="+app.tokens.access_token;return c},selectProject:function(){Wu.Mixin.Events.fire("projectSelected",{detail:{projectUuid:this.getUuid()}})},isPublic:function(){var a=this.getAccess(),b=a.options.isPublic;return!!b},isDownloadable:function(){var a=this.getAccess(),b=a.options.download;return!!b},isShareable:function(){var a=this.getAccess(),b=a.options.share;return!!b},createdBy:function(){return this.store.createdBy},isEditor:function(a){return this.isEditable(a)},isSpectator:function(a){var a=a||app.Account,b=this.getAccess();return _.contains(b.read,a.getUuid())?!0:!1},isEditable:function(a){var a=a||app.Account,b=this.getAccess();return a.getUuid()==this.createdBy()?!0:_.contains(b.edit,a.getUuid())?!0:app.Account.isSuper()?!0:!1}}),Wu.Client=Wu.Class.extend({initialize:function(a){Wu.extend(this,a),this.options={},this.options.editMode=!1},setEditMode:function(){this.editMode=app.access.to.edit_client(this.getUuid())},setActive:function(){this.setEditMode(),this._setUrl(),this._isActive()||(Wu.app._activeClient=this)},_isActive:function(){return Wu.Util.isObject(Wu.app._activeClient)&&Wu.app._activeClient.uuid==this.uuid?!0:!1},_setUrl:function(){var a="/"+this.slug+"/";Wu.Util.setAddressBar(a)},_refreshUrl:function(){var a=app.activeProject?app.activeProject.getSlug():"",b="/"+this.slug+"/"+a;Wu.Util.setAddressBar(b)},update:function(a){var b={};b[a]=this[a],b.uuid=this.uuid;var c=JSON.stringify(b);this._save(c)},_save:function(a){Wu.send("/api/client/update",a,this._saved.bind(this))},_saved:function(a,b){var c=Wu.parse(b);if(c.error)return app.feedback.setError({title:"Client not updated",description:c.error});if(c.name){var d=c.name[0].name.replace(/\s+/g,"").toLowerCase();this.setSlug(d)}c.slug&&this._refreshUrl()},saveNew:function(){var a={name:this.name,description:this.description,keywords:this.keywords},b=JSON.stringify(a),c=Wu.app.SidePane.Clients;Wu.Util.postcb("/api/client/new",b,c._created,this)},destroy:function(){this._delete()},_delete:function(){var a=this,b={cid:a.uuid};b=JSON.stringify(b),Wu.Util.postcb("/api/client/delete",b,a._deleted,a)},_deleted:function(a,b){delete Wu.app.Clients[a.uuid]},getName:function(){return this.name},getTitle:function(){return this.getName()},getDescription:function(){return this.description},getLogo:function(){return this.logo},getPixelLogo:function(a){},getUuid:function(){return this.uuid},getSlug:function(){return this.slug},getProjects:function(){return _.filter(app.Projects,function(a){return a.getClientUuid()==this.getUuid()},this)},setName:function(a){this.name=a,this.update("name")},setDescription:function(a){this.description=a,this.update("description")},setLogo:function(a){this.logo=a,this.update("logo")},setSlug:function(a){this.slug=a,this.update("slug")}}),Wu.User=Wu.Class.extend({initialize:function(a){this.store=a,this.lastSaved=_.cloneDeep(a),this.initFiles(),this._listen()},_listen:function(){Wu.Mixin.Events.on("closeMenuTabs",this._onCloseMenuTabs,this)},initFiles:function(){var a=this.store.files;this._files={},a&&a.forEach(function(a){this._files[a.uuid]=new Wu.Model.File(a)},this)},isContact:function(){if(!app.Account)return void 0;if(this.getUuid()!=app.Account.getUuid()){var a=_.contains(app.Account.getContactListUuids(),this.getUuid());return a}},getContactListUuids:function(){var a=[];return this.getContactList().forEach(function(b){a.push(b.uuid)}),a},getContactList:function(){return this.store.contact_list},sendContactRequest:function(a){var b={contact:a.getUuid()};Wu.send("/api/user/requestContact",b,function(a,b){app.feedback.setMessage({title:"Friend request sent"})},this)},inviteToProjects:function(a){var b=this.getUuid(),c=this.getFullName(),d=a.edit.length+a.read.length,e={edit:a.edit,read:a.read,user:b};Wu.send("/api/user/inviteToProjects",e,function(a,b){var e=Wu.parse(b);app.feedback.setMessage({title:"Project invites sent!",description:c+" has been invited to "+d+" projects"}),e.projects.forEach(function(a){var b=app.Projects[a.project];b.store.access=a.access})}.bind(this),this)},getFiles:function(){return this._files},getFileStore:function(a){var b=_.find(this.store.files,function(b){return b.uuid==a});return b},getFile:function(a){return this._files[a]},setFile:function(a){return this.store.files.push(a),this._files[a.uuid]=new Wu.Model.File(a),this._files[a.uuid]},removeFile:function(a){var b=a.file_id;_.remove(this.store.files,function(a){return a.uuid==b});this._files[b]=null,delete this._files[b]},setLastName:function(a){this.store.lastName=a,this.save()},setFirstName:function(a){this.store.firstName=a,this.save()},setCompany:function(a){this.store.company=a,this.save()},setPosition:function(a){this.store.position=a,this.save()},setPhone:function(a){this.store.phone=a,this.save()},setMobile:function(a){this.store.mobile=a,this.save()},setEmail:function(a){this.store.local.email=a,this.save()},setKey:function(a,b){return"lastName"==a?this.setLastName(b):"firstName"==a?this.setFirstName(b):"company"==a?this.setCompany(b):"position"==a?this.setPosition(b):"mobile"==a?this.setMobile(b):"phone"==a?this.setPhone(b):"email"==a?this.setEmail(b):void 0},save:function(a){this._saveTimer&&clearTimeout(this._saveTimer);var b=this;this._saveTimer=setTimeout(function(){var a=b._findChanges();a&&b._save(a)},1e3)},_save:function(a){app.activeProject&&(a.project=app.activeProject.getUuid()),Wu.save("/api/user/update",JSON.stringify(a))},attachToApp:function(){app.Users[this.getUuid()]=this},deleteUser:function(a,b){delete app.Users[this.store.uuid];var c=this.store.uuid,d=JSON.stringify({uuid:c});Wu.Util.postcb("/api/user/delete",d,a[b],a)},getKey:function(a){return this.store[a]},getFirstName:function(){return this.store.firstName},getLastName:function(){return this.store.lastName},getFullName:function(){return this.store.firstName+" "+this.store.lastName},getName:function(){return this.getFullName()},getCompany:function(){return this.store.company},getPosition:function(){return this.store.position},getPhone:function(){return this.store.phone},getMobile:function(){return this.store.mobile},getEmail:function(){return this.store.local.email},getToken:function(){return this.store.token},getProjects:function(){var a=app.Projects,b=[];return app.access.is.admin(this)?_.values(a):(_.each(a,function(a){_.each(a.getRoles(),function(c){c.hasMember(this)&&!c.noRole()&&b.push(a)},this)},this),b)},getReadProjects:function(){var a=(app.Projects,_.filter(app.Projects,function(a){return _.contains(a.getAccess().read,this.getUuid())},this));return a},getEditProjects:function(){var a=(app.Projects,_.filter(app.Projects,function(a){return _.contains(a.getAccess().edit,this.getUuid())},this));return a},getUuid:function(){return this.store.uuid},setRoles:function(a){},getRoles:function(){return this._roles},_findChanges:function(){var a=_.cloneDeep(this.store),d=_.cloneDeep(this.lastSaved),e=[];for(c in a)if(_.isObject(a[c])){var f=a[c];for(b in f){f[b];if(h=_.isEqual(a[c][b],d[c][b]),!h){var g={};g[c]={},g[c][b]=a[c][b],e.push(g)}}}else{var h=_.isEqual(a[c],d[c]);if(!h){var g={};g[c]=a[c],e.push(g)}}if(0==e.length)return!1;var i={};return e.forEach(function(a){for(c in a)i[c]=a[c]},this),i.uuid=this.getUuid(),this.lastSaved=_.cloneDeep(this.store),i},logout:function(){confirm("Are you sure you want to log out?")&&this._logout()},_logout:function(){app.Socket.sendUserEvent({user:app.Account.getFullName(),event:"logged out.",description:"",timestamp:Date.now()}),window.location.href=app.options.servers.portal+"logout"},addAccountTab:function(){var a=app.Chrome.Top;this._accountTab=a._registerButton({name:"account",className:"chrome-button share",trigger:this._toggleAccountTab,context:this,project_dependent:!1}),this._accountTab.innerHTML='<i class="fa fa-user"></i>'},_toggleAccountTab:function(){this._accountTabOpen?this._closeAccountTab():this._openAccountTab()},_openAccountTab:function(){Wu.Mixin.Events.fire("closeMenuTabs"),this._accountDropdown=Wu.DomUtil.create("div","share-dropdown account-dropdown",app._appPane),this._accountName=Wu.DomUtil.create("div","share-item no-hover",this._accountDropdown,'<i class="fa fa-user logout-icon"></i>'+app.Account.getFullName()),this._logoutDiv=Wu.DomUtil.create("div","share-item",this._accountDropdown,'<i class="fa fa-sign-out logout-icon"></i>Log out'),Wu.DomEvent.on(this._logoutDiv,"click",this.logout,this),this._accountTabOpen=!0},_closeAccountTab:function(){this._accountTabOpen&&(Wu.DomEvent.off(this._logoutDiv,"click",this.logout,this),Wu.DomUtil.remove(this._accountDropdown),this._accountTabOpen=!1)},logout:function(){window.location.href="/logout"},_onCloseMenuTabs:function(){this._closeAccountTab()},isSuper:function(){return"super"==this.store.access.account_type}}),Wu.Model.Layer=Wu.Model.extend({type:"layer",options:{hoverTooltip:!0},_initialize:function(a){this.store=a,this.loaded=!1},addHooks:function(){this._setHooks("on")},removeHooks:function(){this._setHooks("off"),this._removeGridEvents()},_setHooks:function(a){Wu.DomEvent[a](this.layer,"load",this._onLayerLoaded,this),Wu.DomEvent[a](this.layer,"loading",this._onLayerLoading,this)},_unload:function(a){this.removeHooks()},_onLayerLoaded:function(){app._loaded.push(this.getUuid()),app._loaded=_.uniq(app._loaded)},_onLayerLoading:function(){app._loading.push(this.getUuid()),app._loading=_.uniq(app._loading)},initLayer:function(){this._inited=!0,this.addHooks()},add:function(a){this._isBase="baselayer"==a,this.addTo()},addTo:function(){this._inited||this.initLayer(),this._addTo(),this.addToControls()},_addTo:function(a){this._inited||this.initLayer();var b=app._map;b.addLayer(this.layer),this.gridLayer&&b.addLayer(this.gridLayer),app.MapPane.addActiveLayer(this),this._addToZIndex(a),this._added=!0,Wu.Mixin.Events.fire("layerEnabled",{detail:{layer:this}})},_addThin:function(){this._inited||this.initLayer();var a=app._map;a.addLayer(this.layer),this.layer.bringToFront(),this.gridLayer&&a.addLayer(this.gridLayer)},_removeThin:function(){this._inited||this.initLayer();var a=app._map;a.removeLayer(this.layer),this.gridLayer&&(this.gridLayer._flush(),a.hasLayer(this.gridLayer)&&a.removeLayer(this.gridLayer))},flyTo:function(){var a=this.getMeta().extent;if(a){var b=L.latLng(a[1],a[0]),c=L.latLng(a[3],a[2]),d=L.latLngBounds(b,c),e=app._map,f=parseInt(this.getMeta().row_count),g={};if(f>5e5){var h=e.getZoom();g.minZoom=h}e.fitBounds(d,g)}},addToControls:function(){this._isBase||(this._addToDescription(),this._addToLayermenu())},_addToLayermenu:function(){var a=app.MapPane.getControls().layermenu;a&&a._enableLayer(this.getUuid())},_addToLegends:function(){var a=app.MapPane.getControls().legends;a&&a.addLegend(this)},_addToInspect:function(){var a=app.MapPane.getControls().inspect;a&&a.addLayer(this)},_addToDescription:function(){var a=app.MapPane.getControls().description;if(a){a._addLayer(this);var b=app.activeProject,c=b.isEditor();this.store.description||c?a.show():a.hide()}},leafletEvent:function(a,b){this.layer.on(a,b)},_addToZIndex:function(a){"baselayer"==a&&(this._isBase=!0);var b=this._zx||this._getZX();this._isBase?b.b.add(this):b.l.add(this)},_removeFromZIndex:function(){var a=this._zx||this._getZX();this._isBase?a.b.remove(this):a.l.remove(this);
},_getZX:function(){return app.MapPane.getZIndexControls()},remove:function(a){var a=a||app._map;a.hasLayer(this.layer)&&a.removeLayer(this.layer),app.MapPane.removeActiveLayer(this),this.gridLayer&&(this.gridLayer._flush(),a.hasLayer(this.gridLayer)&&a.removeLayer(this.gridLayer)),this._removeFromZIndex();var b=app.MapPane.getControls().description;b&&b._removeLayer(this),this._added=!1},getActiveLayers:function(){return this._activeLayers},enable:function(){this.addTo()},disable:function(){this.remove()},setOpacity:function(a){this.opacity=a||1,this.layer.setOpacity(this.opacity)},getOpacity:function(){return this.opacity||1},getContainer:function(){return this.layer.getContainer()},getTitle:function(){return this.store.title},setTitle:function(a){this.store.title=a,this.save("title"),this.setLegendsTitle(a)},getDescription:function(){return this.store.description},setDescription:function(a){this.store.description=a,this.save("description")},getSatellitePosition:function(){return this.store.satellite_position},setSatellitePosition:function(a){this.store.satellite_position=a,this.save("satellite_position")},getCopyright:function(){return this.store.copyright},setCopyright:function(a){this.store.copyright=a,this.save("copyright")},getUuid:function(){return this.store.uuid},getFileUuid:function(){return this.store.file},getAttribution:function(){return this.store.attribution},getFile:function(){var a=this.getFileUuid(),b=_.find(app.Projects,function(b){return b.files[a]});return b?b.files[a]:!1},getProjectUuid:function(){return app.activeProject.store.uuid},setCartoid:function(a){this.store.data.cartoid=a,this.save("data")},getCartoid:function(){return this.store.data?this.store.data.cartoid:void 0},setLayerStyle:function(a,b){},setEditorStyle:function(a,b){},getEditorStyle:function(){return this.getDefaultEditorStyle()},getDefaultEditorStyle:function(){var a,b=this.getMeta(),c=b.columns;for(var d in c)a=d;var e={field:a,colors:["red","white","blue"],marker:{width:a,opacity:1}};return e},setCartoCSS:function(a,b){Wu.post("/api/layers/cartocss/set",JSON.stringify(a),b,this),this.setCartoid(a.cartoid)},getCartoCSS:function(a,b){var c={cartoid:a};Wu.post("/api/layers/cartocss/get",JSON.stringify(c),b,this)},getMeta:function(){var a=this.store.metadata;if(!a)return!1;var b=Wu.parse(a);return b},getMetaFields:function(){var a=this.getMeta();return a&&a.json&&a.json.vector_layers&&a.json.vector_layers[0]&&a.json.vector_layers[0].fields?a.json.vector_layers[0].fields:!1},reloadMeta:function(a){var b=JSON.stringify({fileUuid:this.getFileUuid(),layerUuid:this.getUuid()});Wu.post("/api/layer/reloadmeta",b,a||function(a,b){},this)},getTooltip:function(){var a=this.store.tooltip;if(!a)return!1;var b=Wu.parse(a);return b},setTooltip:function(a){this.store.tooltip=JSON.stringify(a),this.save("tooltip")},getStyling:function(){var a=this.store.style;if(!a)return!1;var b=Wu.parse(a);return b},setStyling:function(a){this.store.style=JSON.stringify(a),this.save("style")},getLegends:function(){var a=this.store.legends;return a?Wu.parse(a):!1},getActiveLegends:function(){var a=this.getLegends(),b=_.filter(a,function(a){return a.on});return b},setLegends:function(a){a&&(this.store.legends=JSON.stringify(a),this.save("legends"))},setLegendsTitle:function(a){var b=Wu.parse(this.store.legends);b[0]&&(b[0].value=a,this.setLegends(b))},setStyle:function(){},createLegends:function(a){var b=JSON.stringify({fileUuid:this.getFileUuid(),cartoid:this.getCartoid()});Wu.post("/api/layer/createlegends",b,a,this)},getFeaturesValues:function(a,b){if(!a||!b)return void 0;var c=JSON.stringify({fileUuid:this.getFileUuid(),cartoid:this.getCartoid()});Wu.post("/api/util/getfeaturesvalues",c,a.bind(b),this)},hide:function(){var a=this.getContainer();a.style.visibility="hidden"},show:function(){var a=this.getContainer();a.style.visibility="visible"},save:function(a){var b={};b[a]=this.store[a],b.layer=this.store.uuid,b.uuid=app.activeProject.getUuid(),this._save(b)},_save:function(a){var b=JSON.stringify(a);Wu.save("/api/layer/update",b)},_setZIndex:function(a){this.layer.setZIndex(a)},_addGridEvents:function(){this._setGridEvents("on")},_setGridEvents:function(a){var b=this.gridLayer;b&&a&&(b[a]("mousedown",this._gridOnMousedown,this),b[a]("mouseup",this._gridOnMouseup,this),b[a]("click",this._gridOnClick,this))},_removeGridEvents:function(){this._setGridEvents("off")},_flush:function(){this.remove(),app.MapPane._clearPopup(),this._removeGridEvents(),this.layer=null,this.gridLayer=null,this._inited=!1},downloadLayer:function(){},shareLayer:function(){},deleteLayer:function(){},isPostGIS:function(){return this.store.data&&this.store.data.postgis?!0:!1},isPostgis:function(){return this.isPostGIS()}}),Wu.PostGISLayer=Wu.Model.Layer.extend({initLayer:function(){this.update(),this.addHooks(),this._listenLocally(),this._inited=!0},_listenLocally:function(){Wu.DomEvent.on(this.layer,"load",this._onLayerLoaded,this),Wu.DomEvent.on(this.layer,"loading",this._onLayerLoading,this)},_onLayerLoading:function(){this._loadStart=Date.now()},_onLayerLoaded:function(){var a=Date.now()-this._loadStart;app.Analytics._eventLayerLoaded({layer:this.getTitle(),load_time:a})},update:function(a,b){var c=app._map;this.layer&&this._flush(),this._prepareRaster(),this._prepareGrid(),a&&a.enable&&(c.addLayer(this.layer),this.layer.bringToFront()),b&&b()},setStyle:function(a){return a?(this.store.data.postgis=a,void this.save("data")):void 0},updateStyle:function(a){var b=a.layerUuid,c=a.options;this.setStyle(c),this._refreshLayer(b),Wu.Mixin.Events.fire("layerStyleEdited",{detail:{layer:this}})},_getLayerUuid:function(){return this.store.data.postgis.layer_id},getCartoCSS:function(a,b){return this.store.data.postgis.cartocss},getSQL:function(){return this.store.data.postgis.sql},setFilter:function(a){this.store.filter=a,this.save("filter")},getFilter:function(){return this.store.filter},getPostGISData:function(){return this.store.data.postgis},_refreshLayer:function(a){this.layer.setOptions({layerUuid:a}),this.layer.redraw()},_prepareRaster:function(){var a=(this._fileUuid,app.options.servers.tiles.subdomains),b="?access_token="+app.tokens.access_token,c=(this._getLayerUuid(),app.options.servers.tiles.uri+"{layerUuid}/{z}/{x}/{y}.png"+b);this.layer=L.tileLayer(c,{layerUuid:this._getLayerUuid(),subdomains:a,maxRequests:0,maxZoom:19})},_invalidateTiles:function(){},_updateGrid:function(a){this.gridLayer&&this.gridLayer._update()},_prepareGrid:function(){var a=app.options.servers.utfgrid.subdomains,b="?access_token="+app.tokens.access_token,c=this._getLayerUuid(),d=app.options.servers.tiles.uri+"{layerUuid}/{z}/{x}/{y}.grid"+b;this.gridLayer=new L.UtfGrid(d,{useJsonP:!1,subdomains:a,maxRequests:0,requestTimeout:1e4,layerUuid:c,maxZoom:19}),this._addGridEvents()},_fetchData:function(a,b){var c=Object.keys(a.data),d=c[0],e=a.data[d],f=a.layer.store.data.postgis.layer_id,g={column:d,row:e,layer_id:f,access_token:app.tokens.access_token};Wu.send("/api/db/fetch",g,b,this)},_gridOnMousedown:function(a){},_gridOnMouseup:function(a){if(a.data){a.layer=this;var b=a.e.originalEvent;void 0===this._event||this._event.x==b.x||app.MapPane._clearPopup()}},_gridOnClick:function(a){a.data&&(app.MapPane._drawing||(a.layer=this,this._fetchData(a,function(b,c){var d=JSON.parse(c);a.data=d;var e=a.e.originalEvent;this._event={x:e.x,y:e.y},app.MapPane._addPopupContent(a),app.Analytics.onPointQuery(a)})))},downloadLayer:function(){var a={layer_id:this.getUuid(),socket_notification:!0};this._downloadingID=Wu.Util.createRandom(5),Wu.post("/api/layer/downloadDataset",JSON.stringify(a),function(a,b){app.feedback.setMessage({title:"Preparing download",description:"Hold tight! Your download will be ready in a minute.",id:this._downloadingID})})},_onDownloadReady:function(a){var b=a.detail,c=(b.file_id,b.finished,b.filepath),d=app.options.servers.portal;d+="api/file/download/",d+="?file="+c,d+="&type=shp",d+="&access_token="+app.tokens.access_token,window.open(d,"mywindow"),app.feedback.remove(this._downloadingID)},shareLayer:function(){},deleteLayer:function(){var a="Are you sure you want to delete this layer? \n - "+this.getTitle();if(!confirm(a))return void 0;var b=this.getUuid(),c=_.find(app.Projects,function(a){return a.layers[b]});c.deleteLayer(this)}}),Wu.RasterLayer=Wu.Model.Layer.extend({initialize:function(a){this.store=a,this.loaded=!1},initLayer:function(){this.update()},update:function(){app._map;this._fileUuid=this.store.file,this._defaultCartoid="raster",this._prepareRaster()},_prepareRaster:function(){var a=this._fileUuid,b=(this.store.data.cartoid||this._defaultCartoid,app.options.servers.tiles.uri),c=app.options.servers.tiles.subdomains,d="?access_token="+app.tokens.access_token,e=b+"{fileUuid}/{cartoid}/{z}/{x}/{y}.png"+d,f=this._getLayerUuid(),e=app.options.servers.subdomain+"overlay_tiles/{layerUuid}/{z}/{x}/{y}.png"+d;this.layer=L.tileLayer(e,{fileUuid:a,layerUuid:f,subdomains:c,maxRequests:0,tms:!0})},_getLayerUuid:function(){return this.store.data.raster},getMeta:function(){var a=this.store.metadata,b=Wu.parse(a);return b},getFileMeta:function(){var a=app.Account.getFile(this.store.file),b=a.store.data.raster.metadata,c=Wu.parse(b);return c},flyTo:function(){var a=this.getMeta().extent;if(a){var b=L.latLng(a[1],a[0]),c=L.latLng(a[3],a[2]),d=L.latLngBounds(b,c),e=app._map,f=parseInt(this.getMeta().row_count),g={};if(f>5e5){var h=e.getZoom();g.minZoom=h}e.fitBounds(d,g)}},deleteLayer:function(){var a="Are you sure you want to delete this layer? \n - "+this.getTitle();if(!confirm(a))return void 0;var b=this.getUuid(),c=_.find(app.Projects,function(a){return a.layers[b]});c.deleteLayer(this)},downloadLayer:function(){}}),Wu.MapboxLayer=Wu.Model.Layer.extend({type:"mapboxLayer",initLayer:function(){var a="https://{s}.tiles.mapbox.com/v4/{mapboxUri}/{z}/{x}/{y}.png?access_token={accessToken}";this.layer=L.tileLayer(a,{accessToken:this.store.accessToken,mapboxUri:this.store.data.mapbox}),this.addHooks(),this.loaded=!0,this._inited=!0}}),Wu.GoogleLayer=Wu.Model.Layer.extend({type:"googleLayer",options:{minZoom:0,maxZoom:20},initialize:function(a){this.store=a,this.loaded=!1},initLayer:function(){this.update()},update:function(){app._map;this._prepareRaster()},getTileType:function(){return this.store.tileType||"aerial"},_prepareRaster:function(){var a=this.getTileType(),b="?access_token="+app.tokens.access_token,c=app.options.servers.proxy.uri+"google/{type}/{z}/{x}/{y}.png"+b,d=app.options.servers.proxy.subdomains;this.layer=L.tileLayer(c,{type:a,subdomains:d,maxRequests:0,tms:!1,maxZoom:this.options.maxZoom,minZoom:this.options.minZoom})}}),Wu.NorkartLayer=Wu.Model.Layer.extend({type:"norkartLayer",options:{log_url:"https://www.webatlas.no/weblog/Log2.aspx?",current_mapstyle:1,tileformats:{vector:"png",aerial:"jpeg",hybrid:"jpeg"},customer_id:"systemapic",minZoom:0,maxZoom:20},initialize:function(a){this.store=a,this.loaded=!1},initLayer:function(){this.update()},update:function(){app._map;this._prepareRaster()},getTileType:function(){return this.store.tileType||"aerial"},_prepareRaster:function(){var a=this.getTileType(),b=this.options.tileformats[a],c="?access_token="+app.tokens.access_token,d=app.options.servers.proxy.uri+"norkart/{type}/{z}/{x}/{y}.{format}"+c,e=app.options.servers.proxy.subdomains;this.layer=L.tileLayer(d,{type:a,format:b,subdomains:e,maxRequests:0,tms:!1,maxZoom:this.options.maxZoom,minZoom:this.options.minZoom}),this._eventsAdded||this._addEvents(),this._logEvent||(this._logEvent=!0)},_addEvents:function(){app._map.on("zoomend",this._clearBackgroundCache.bind(this)),app._map.on("moveend",_.throttle(this.logMapRequest.bind(this),350)),this._eventsAdded=!0},_clearBackgroundCache:function(){var a=app._map.getZoom();a==this.options.minZoom-1&&this.layer&&this.layer._clearBgBuffer(),a==this.options.maxZoom+1&&this.layer&&this.layer._clearBgBuffer()},logMapRequest:function(){var a=app._map.getZoom();if(!(a>this.options.maxZoom||a<this.options.minZoom)){var b=app._map.getBounds(),c=b.getNorthWest().lng,d=b.getNorthWest().lat,e=b.getSouthEast().lng,f=b.getSouthEast().lat,g=document.createElement("img"),h=this.options.log_url+"WMS-REQUEST=BBOX="+c+","+f+","+e+","+d+"&MAPSTYLE="+this.options.current_mapstyle+"&CUSTOMER="+this.options.customer_id;g.src=h,g=null}},_getCopyrightText:function(){var a=this._map.getCenter(),b=this._map.getZoom(),c=["&copy; 2015 Norkart AS/Plan- og bygningsetaten, Oslo Kommune","&copy; 2015 Norkart AS/Geovekst og kommunene/OpenStreetMap/NASA, Meti","&copy; 2015 Norkart AS/Geovekst og kommunene/OpenStreetMap/NASA, Meti","&copy; 2015 Norkart AS/OpenStreetMap/EEA CLC2006"];if(b>=13){if(14>=b)try{if(this.t_containsPoint(a,L.Control.WAAttribution.t_norgeLat,L.Control.WAAttribution.t_norgeLon))return c[1]}catch(d){}else try{if(this.t_containsPoint(a,L.Control.WAAttribution.t_osloLat,L.Control.WAAttribution.t_osloLon))return c[0]}catch(d){}try{if(this.t_containsPoint(a,L.Control.WAAttribution.t_norgeLat,L.Control.WAAttribution.t_norgeLon))return c[1]}catch(d){}return c[3]}try{return this.t_containsPoint(a,L.Control.WAAttribution.t_norgeLat,L.Control.WAAttribution.t_norgeLon)?c[2]:c[3]}catch(d){}},t_containsPoint:function(a,b,c){var d,e=0,f=b.length,g=!1;for(d=0;f>d;d++)e++,e==f&&(e=0),(c[d]<a.lng&&c[e]>=a.lng||c[e]<a.lng&&c[d]>=a.lng)&&b[d]+(a.lng-c[d])/(c[e]-c[d])*(b[e]-b[d])<a.lat&&(g=!g);return g},statics:{t_osloLat:[59.81691,59.81734,59.81813,59.82537,59.82484,59.82298,59.82343,59.82494,59.82588,59.8262,59.82367,59.82349,59.82954,59.83053,59.83929,59.85107,59.87719,59.87593,59.88371,59.88441,59.89462,59.90941,59.91071,59.91407,59.9147,59.91405,59.91468,59.91632,59.91732,59.91797,59.91771,59.91876,59.92173,59.92246,59.9235,59.92441,59.92518,59.92709,59.92786,59.92963,59.93123,59.93255,59.93459,59.93579,59.93925,59.9424,59.9428,59.94566,59.94784,59.95187,59.9523,59.95303,59.95354,59.95371,59.95626,59.95723,59.95856,59.96163,59.96267,59.96483,59.96634,59.97051,59.97432,59.97661,59.97698,59.97671,59.9777,59.97674,59.97686,59.97754,59.9786,59.98552,59.99223,59.99403,59.99639,59.99672,59.99462,59.99365,59.99552,59.99804,60.00064,60.00014,59.99932,59.99977,59.99991,59.99936,60.0085,60.01579,60.01726,60.02602,60.03843,60.05177,60.06503,60.07624,60.07728,60.08286,60.09214,60.09394,60.10068,60.10983,60.11678,60.1287,60.13162,60.13459,60.13518,60.13277,60.13353,60.1258,60.12586,60.12531,60.12519,60.12286,60.12117,60.1194,60.11991,60.11966,60.12019,60.12059,60.12154,60.12172,60.12365,60.12504,60.12573,60.12526,60.12326,60.12303,60.12161,60.12081,60.11833,60.11285,60.11218,60.1118,60.10609,60.10496,60.10103,60.09955,60.09917,60.0986,60.09856,60.09777,60.09268,60.08689,60.08659,60.08403,60.07893,60.07827,60.07714,60.07484,60.0706,60.06755,60.06689,60.0661,60.06575,60.06421,60.06467,60.06436,60.06515,60.06489,60.06429,60.05371,60.04309,60.04054,60.03783,60.03693,60.03563,60.03328,60.03026,60.02976,60.02912,60.02736,60.0211,60.01813,60.01788,60.01734,60.01791,60.02211,60.02327,60.02315,60.02148,60.01985,60.0178,60.00969,60.00846,60.0061,59.99799,59.99815,59.99714,59.99964,60.00179,59.99616,59.99552,59.99566,59.99491,59.99301,59.98677,59.98558,59.98442,59.98078,59.98053,59.98072,59.98023,59.98099,59.98398,59.98455,59.98372,59.97712,59.97705,59.96955,59.96552,59.96286,59.95484,59.9526,59.95321,59.94924,59.94803,59.94694,59.94778,59.94687,59.94598,59.94572,59.94318,59.9418,59.94116,59.93486,59.92653,59.92045,59.91937,59.91228,59.91162,59.91127,59.90041,59.89682,59.88496,59.87528,59.86989,59.86475,59.8601,59.85206,59.84493,59.83684,59.83631,59.83489,59.8317,59.83133,59.82693,59.82773,59.82776,59.82679,59.8271,59.82629,59.82609,59.8262,59.82548,59.82368,59.82204,59.82102,59.81815,59.81703,59.81575,59.81434,59.81216,59.81104,59.81204,59.81297,59.81306,59.81232,59.80946,59.81198,59.81529,59.81685,59.81616,59.81699,59.81691],t_osloLon:[10.83369,10.83169,10.81725,10.81244,10.8045,10.79843,10.7892,10.78261,10.78091,10.77675,10.77244,10.77156,10.76478,10.76156,10.744,10.73995,10.73097,10.68893,10.66064,10.65808,10.65387,10.64777,10.64253,10.63988,10.63553,10.63506,10.63304,10.63298,10.63427,10.63309,10.63123,10.63006,10.62936,10.62578,10.62532,10.62596,10.62746,10.62543,10.62708,10.62647,10.63107,10.63299,10.63402,10.63531,10.63161,10.63341,10.63289,10.63581,10.63561,10.63387,10.63304,10.63403,10.63353,10.63205,10.63083,10.63175,10.62995,10.62758,10.62357,10.62444,10.62051,10.61817,10.61395,10.61045,10.60385,10.6037,10.59622,10.59395,10.59165,10.59027,10.59025,10.57878,10.5657,10.55948,10.55692,10.55585,10.55218,10.54912,10.54526,10.54399,10.5338,10.52968,10.52841,10.52754,10.52266,10.51795,10.50366,10.49021,10.48916,10.50276,10.52201,10.54276,10.56337,10.58077,10.59731,10.59278,10.59184,10.59212,10.58836,10.57999,10.57278,10.59522,10.60081,10.61047,10.61906,10.64515,10.68032,10.69737,10.69842,10.69986,10.70447,10.70493,10.70385,10.70726,10.71477,10.71615,10.71703,10.71688,10.7198,10.72497,10.73165,10.73248,10.73712,10.74026,10.74418,10.74689,10.7483,10.75123,10.75232,10.76785,10.7684,10.76621,10.75711,10.75593,10.75475,10.75534,10.75762,10.75796,10.75916,10.76205,10.7671,10.77063,10.77233,10.77481,10.77796,10.77902,10.77864,10.78232,10.7847,10.78802,10.79385,10.79691,10.80157,10.80937,10.81045,10.81208,10.81561,10.81927,10.81976,10.81656,10.81803,10.81696,10.8181,10.81464,10.8128,10.81205,10.81316,10.8124,10.8134,10.812,10.81542,10.81921,10.82064,10.82139,10.82217,10.8235,10.82526,10.82693,10.82875,10.82921,10.83204,10.83314,10.83571,10.83704,10.83808,10.8391,10.84252,10.84311,10.84959,10.85821,10.86331,10.86429,10.86605,10.86714,10.87516,10.8754,10.88293,10.89337,10.90433,10.90591,10.9074,10.91267,10.91629,10.9182,10.92565,10.93057,10.93106,10.93751,10.93807,10.93705,10.94129,10.94334,10.94433,10.95138,10.94763,10.94608,10.94499,10.94244,10.94272,10.94206,10.94584,10.94306,10.94246,10.92912,10.92148,10.91913,10.91781,10.91573,10.91481,10.91521,10.91188,10.91142,10.90762,10.90988,10.90715,10.90934,10.91233,10.92155,10.92651,10.93119,10.93367,10.9352,10.9366,10.933,10.92716,10.92303,10.91703,10.91477,10.91326,10.91079,10.91094,10.90679,10.90105,10.89649,10.89677,10.8918,10.89157,10.88907,10.8876,10.88294,10.88188,10.87985,10.87885,10.87378,10.86889,10.86313,10.85584,10.8479,10.84604,10.84597,10.8373,10.83566,10.83369],t_norgeLat:[69.11,69.09,69.04,69.04,69.09,69.1,69.12,69.18,69.19,69.2,69.22,69.23,69.26,69.27,69.28,69.28,69.31,69.3,69.27,69.24,69.24,69.15,69.13,69.13,69.12,69.11,69.09,69.02,69.01,68.96,68.96,68.93,68.93,68.91,68.85,68.83,68.82,68.8,68.79,68.75,68.74,68.72,68.72,68.72,68.73,68.74,68.74,68.74,68.73,68.71,68.7,68.69,68.69,68.69,68.68,68.68,68.63,68.63,68.63,68.64,68.64,68.64,68.66,68.66,68.67,68.67,68.68,68.69,68.7,68.7,68.7,68.7,68.71,68.71,68.75,68.78,68.82,68.84,68.83,68.83,68.83,68.81,68.8,68.79,68.76,68.76,68.75,68.74,68.73,68.73,68.73,68.71,68.69,68.68,68.66,68.65,68.65,68.66,68.64,68.63,68.63,68.62,68.61,68.59,68.56,68.56,68.56,68.55,68.55,68.56,68.57,68.58,68.59,68.59,68.6,68.61,68.61,68.61,68.61,68.62,68.62,68.62,68.62,68.62,68.62,68.62,68.62,68.62,68.63,68.63,68.64,68.64,68.65,68.66,68.66,68.67,68.68,68.69,68.69,68.7,68.7,68.71,68.71,68.72,68.73,68.74,68.75,68.8,68.8,68.8,68.81,68.82,68.83,68.84,68.84,68.85,68.85,68.86,68.86,68.86,68.87,68.88,68.88,68.88,68.88,68.89,68.89,68.89,68.89,68.9,68.9,68.9,68.9,68.9,68.9,68.89,68.89,68.89,68.89,68.89,68.88,68.88,68.88,68.89,68.89,68.89,68.9,68.9,68.92,68.93,68.94,68.94,68.95,68.99,69,69.01,69.01,69.02,69.11,69.12,69.14,69.15,69.17,69.18,69.19,69.2,69.22,69.23,69.23,69.25,69.26,69.27,69.27,69.28,69.28,69.29,69.3,69.3,69.31,69.31,69.34,69.34,69.35,69.36,69.36,69.37,69.38,69.39,69.39,69.4,69.41,69.42,69.42,69.43,69.43,69.44,69.45,69.46,69.47,69.48,69.49,69.51,69.52,69.53,69.55,69.56,69.57,69.58,69.59,69.61,69.63,69.65,69.65,69.65,69.66,69.67,69.68,69.68,69.69,69.7,69.71,69.72,69.73,69.73,69.74,69.74,69.75,69.75,69.77,69.8,69.81,69.82,69.83,69.85,69.86,69.88,69.89,69.9,69.91,69.92,69.94,69.96,69.96,69.95,69.95,69.95,69.94,69.95,69.95,69.96,69.96,69.95,69.95,69.94,69.93,69.93,69.93,69.93,69.94,69.94,69.94,69.93,69.93,69.92,69.91,69.91,69.91,69.92,69.93,69.93,69.93,69.95,69.95,69.95,69.95,69.96,69.96,69.97,69.98,69.98,69.99,69.99,69.99,70,70.01,70.02,70.02,70.02,70.02,70.03,70.03,70.04,70.05,70.06,70.06,70.07,70.08,70.07,70.06,70.06,70.07,70.07,70.08,70.09,70.09,70.09,70.05,70.04,70.04,70,69.92,69.9,69.89,69.88,69.87,69.87,69.86,69.85,69.83,69.82,69.79,69.78,69.69,69.69,69.68,69.67,69.57,69.55,69.53,69.52,69.51,69.49,69.48,69.47,69.46,69.41,69.4,69.31,69.28,69.23,69.22,69.19,69.18,69.16,69.14,69.13,69.12,69.11,69.1,69.09,69.08,69.06,69.05,69.04,69.04,69.02,69.02,69.01,69.02,69.02,69.03,69.03,69.06,69.07,69.11,69.12,69.15,69.18,69.21,69.23,69.24,69.24,69.25,69.25,69.26,69.27,69.29,69.3,69.31,69.31,69.31,69.31,69.33,69.33,69.31,69.32,69.32,69.33,69.35,69.37,69.37,69.39,69.39,69.4,69.4,69.41,69.42,69.42,69.42,69.42,69.41,69.41,69.4,69.41,69.41,69.41,69.42,69.43,69.43,69.43,69.44,69.45,69.46,69.47,69.47,69.47,69.49,69.51,69.52,69.52,69.53,69.53,69.55,69.56,69.58,69.59,69.6,69.62,69.63,69.64,69.64,69.64,69.64,69.65,69.66,69.67,69.67,69.65,69.63,69.63,69.63,69.62,69.61,69.59,69.54,69.54,69.54,69.54,69.54,69.54,69.54,69.54,69.53,69.53,69.53,69.56,69.56,69.57,69.58,69.59,69.61,69.64,69.65,69.66,69.67,69.68,69.67,69.67,69.68,69.69,69.69,69.7,69.7,69.71,69.72,69.72,69.73,69.78,69.78,69.79,69.78,69.78,69.77,69.77,69.76,69.76,69.76,69.79,69.79,69.79,69.98,70.01,70.12,70.12,70.11,70.14,70.24,70.35,70.36,70.4,70.44,70.47,70.5,70.54,70.65,70.67,70.83,70.87,70.94,70.95,71.02,71.12,71.28,71.3,71.32,71.33,71.35,71.36,71.38,71.38,71.34,71.31,71.31,71.3,71.29,71.27,71.19,71.11,70.99,70.98,70.9,70.85,70.79,70.7,70.63,70.56,70.48,70.39,70.35,70.17,70.07,69.99,69.81,69.75,69.71,69.7,69.65,69.6,69.52,69.51,69.39,69.35,69.32,69.25,69.25,69.18,69.08,69.07,69,68.9,68.85,68.76,68.73,68.61,68.54,68.46,68.46,68.4,68.39,68.34,68.29,68.24,68.15,68.12,68.1,68.01,67.87,67.82,67.78,67.7,67.7,67.62,67.59,67.54,67.47,67.44,67.39,67.34,67.02,66.82,66.71,66.67,66.4,66.19,65.97,65.7,65.57,65.54,65.5,65.47,65.35,65.27,65.05,64.99,64.87,64.78,64.73,64.55,64.36,64.24,64.14,64.04,63.77,63.7,63.58,63.43,63.34,63.31,63.27,63.26,63.25,63.19,63.18,63.15,63.09,63.02,63,62.97,62.93,62.81,62.75,62.67,62.62,62.47,62.43,62.38,62.29,62.18,62.15,62.03,61.85,61.78,61.71,61.68,61.55,61.54,61.49,61.35,61.23,61.16,61.07,61,60.83,60.81,60.72,60.69,60.57,60.51,60.44,60.41,60.39,60.31,60.23,60.17,60.1,60.07,60.05,59.91,59.87,59.79,59.76,59.72,59.68,59.67,59.56,59.56,59.5,59.44,59.36,59.31,59.27,59.22,59.18,59.14,59.12,59.07,59.04,59,58.96,58.92,58.81,58.78,58.76,58.65,58.62,58.6,58.55,58.53,58.5,58.44,58.4,58.36,58.33,58.28,58.16,58.08,58.07,58.06,58.03,58.02,57.97,57.91,57.88,57.88,57.82,57.79,57.77,57.76,57.76,57.76,57.76,57.77,57.78,57.79,57.8,57.83,57.85,57.9,57.92,57.94,57.98,58.02,58.04,58.08,58.13,58.15,58.17,58.25,58.39,58.42,58.43,58.52,58.6,58.67,58.72,58.72,58.73,58.74,58.76,58.77,58.77,58.76,58.76,58.89,58.94,58.96,58.98,58.99,59.01,59.08,59.08,59.09,59.09,59.09,59.09,59.1,59.1,59.1,59.1,59.1,59.1,59.1,59.08,59.08,59.07,59.06,59.06,59.04,59.04,59.03,59.02,59.01,58.99,58.99,58.98,58.97,58.95,58.94,58.93,58.92,58.89,58.89,58.89,58.89,58.89,58.88,58.88,58.88,58.88,58.88,58.88,58.88,58.89,58.89,58.89,58.88,58.88,58.89,58.89,58.89,58.89,58.9,58.9,58.9,58.9,58.9,58.91,58.92,58.92,58.93,58.93,58.94,58.95,58.96,58.98,58.99,59.01,59.01,59.03,59.03,59.04,59.05,59.06,59.07,59.09,59.09,59.1,59.11,59.12,59.12,59.13,59.14,59.15,59.16,59.17,59.18,59.19,59.2,59.21,59.22,59.22,59.23,59.23,59.24,59.25,59.27,59.29,59.31,59.32,59.32,59.33,59.34,59.34,59.35,59.38,59.4,59.41,59.42,59.42,59.43,59.44,59.46,59.47,59.48,59.5,59.51,59.54,59.55,59.56,59.57,59.58,59.59,59.6,59.61,59.61,59.62,59.62,59.63,59.63,59.64,59.64,59.64,59.64,59.64,59.64,59.65,59.65,59.66,59.67,59.68,59.69,59.69,59.69,59.69,59.69,59.69,59.7,59.71,59.72,59.73,59.75,59.75,59.76,59.77,59.78,59.79,59.8,59.82,59.83,59.83,59.83,59.84,59.84,59.85,59.85,59.86,59.87,59.87,59.87,59.88,59.89,59.89,59.9,59.9,59.89,59.89,59.89,59.89,59.89,59.89,59.89,59.89,59.89,59.89,59.89,59.89,59.9,59.9,59.9,59.91,59.93,59.93,59.94,59.94,59.95,59.96,59.96,59.97,59.98,59.98,59.99,60,60.01,60.02,60.02,60.03,60.04,60.05,60.06,60.07,60.09,60.13,60.14,60.15,60.16,60.19,60.22,60.23,60.24,60.25,60.26,60.28,60.3,60.31,60.32,60.33,60.33,60.34,60.35,60.36,60.36,60.37,60.38,60.39,60.39,60.4,60.41,60.43,60.44,60.48,60.51,60.52,60.53,60.54,60.55,60.57,60.59,60.6,60.61,60.61,60.62,60.63,60.64,60.65,60.66,60.67,60.68,60.7,60.71,60.73,60.75,60.79,60.83,60.84,60.85,60.86,60.87,60.88,60.89,60.9,60.91,60.92,60.92,60.94,60.97,60.98,60.99,61,61.01,61.03,61.04,61.04,61.04,61.04,61.05,61.05,61.05,61.05,61.05,61.05,61.05,61.05,61.05,61.05,61.05,61.06,61.06,61.06,61.07,61.08,61.09,61.09,61.1,61.12,61.14,61.19,61.22,61.24,61.26,61.27,61.29,61.31,61.32,61.36,61.37,61.39,61.4,61.42,61.43,61.48,61.53,61.55,61.57,61.57,61.57,61.57,61.57,61.56,61.56,61.56,61.58,61.59,61.6,61.62,61.62,61.63,61.69,61.7,61.72,61.75,61.75,61.77,61.8,61.82,61.83,61.85,61.87,61.88,61.89,61.91,62,62.12,62.15,62.17,62.18,62.2,62.22,62.25,62.26,62.27,62.27,62.38,62.39,62.4,62.41,62.46,62.52,62.58,62.59,62.61,62.62,62.63,62.66,62.68,62.69,62.71,62.71,62.74,62.76,62.83,62.84,62.88,62.9,62.94,62.96,62.97,62.98,62.99,63,63,63.01,63.02,63.04,63.05,63.12,63.17,63.26,63.27,63.28,63.33,63.33,63.34,63.34,63.35,63.35,63.39,63.48,63.55,63.56,63.59,63.63,63.65,63.72,63.72,63.73,63.75,63.76,63.78,63.79,63.82,63.83,63.85,63.85,63.89,63.93,63.93,63.96,63.97,63.99,64,64,64.01,64.03,64.03,64.04,64.04,64.05,64.07,64.08,64.09,64.09,64.09,64.09,64.1,64.07,64.05,64.05,64.03,64.03,64.02,64.01,64.01,64.03,64.05,64.06,64.09,64.11,64.13,64.15,64.16,64.19,64.2,64.2,64.23,64.3,64.36,64.37,64.38,64.38,64.4,64.44,64.46,64.48,64.48,64.5,64.5,64.55,64.55,64.57,64.58,64.61,64.63,64.71,64.79,64.81,64.82,64.84,64.85,64.86,64.88,64.91,64.94,64.96,64.97,64.98,64.98,65,65.05,65.07,65.1,65.12,65.13,65.14,65.17,65.19,65.23,65.25,65.28,65.3,65.34,65.36,65.4,65.43,65.44,65.45,65.48,65.49,65.5,65.51,65.53,65.58,65.59,65.63,65.64,65.66,65.67,65.69,65.72,65.73,65.75,65.79,65.8,65.81,65.86,65.87,65.89,65.9,65.92,65.95,66.02,66.07,66.1,66.13,66.13,66.14,66.14,66.14,66.14,66.14,66.16,66.18,66.24,66.24,66.28,66.32,66.34,66.35,66.38,66.4,66.4,66.43,66.43,66.45,66.46,66.47,66.48,66.5,66.53,66.53,66.57,66.58,66.59,66.61,66.62,66.62,66.65,66.66,66.67,66.68,66.7,66.78,66.78,66.85,66.87,66.88,66.91,66.93,66.96,66.96,66.97,66.98,66.98,66.99,67.01,67.02,67.04,67.04,67.06,67.14,67.15,67.16,67.2,67.2,67.22,67.24,67.25,67.27,67.27,67.28,67.29,67.35,67.37,67.41,67.43,67.45,67.48,67.49,67.51,67.52,67.53,67.53,67.53,67.56,67.57,67.57,67.59,67.6,67.64,67.66,67.67,67.69,67.71,67.73,67.74,67.74,67.76,67.77,67.78,67.79,67.8,67.81,67.83,67.84,67.86,67.87,67.92,67.93,67.94,67.94,67.96,67.96,67.99,68,68.05,68.05,68.06,68.07,68.08,68.08,68.1,68.11,68.12,68.12,68.12,68.11,68.09,68.08,68.07,68.05,68.05,68.01,68.01,68,67.97,67.97,68.05,68.06,68.13,68.15,68.18,68.19,68.2,68.22,68.31,68.32,68.34,68.36,68.37,68.41,68.43,68.52,68.54,68.55,68.57,68.58,68.58,68.54,68.53,68.51,68.51,68.52,68.52,68.52,68.51,68.5,68.5,68.5,68.49,68.47,68.44,68.42,68.41,68.38,68.38,68.37,68.36,68.35,68.35,68.39,68.39,68.4,68.41,68.42,68.42,68.44,68.46,68.49,68.5,68.52,68.53,68.55,68.56,68.57,68.59,68.59,68.6,68.61,68.63,68.67,68.68,68.7,68.73,68.74,68.75,68.76,68.77,68.77,68.81,68.85,68.86,68.88,68.89,68.91,68.92,68.92,68.93,68.93,68.97,69,69,69.03,69.05,69.06,69.06,69.06,69.06,69.06,69.06,69.05,69.06,69.06,69.06,69.06,69.07,69.11,69.12,69.1,69.1],t_norgeLon:[20.78,20.84,21.06,21.07,21.13,21.13,21.07,21.03,21.03,21.03,21.03,21.05,21.11,21.16,21.18,21.22,21.29,21.38,21.65,21.69,21.7,21.83,21.87,21.88,21.89,21.9,21.95,22.08,22.09,22.16,22.17,22.18,22.19,22.2,22.3,22.34,22.34,22.35,22.35,22.36,22.37,22.37,22.38,22.41,22.44,22.49,22.52,22.53,22.57,22.7,22.73,22.8,23.02,23.04,23.06,23.07,23.16,23.17,23.2,23.21,23.22,23.24,23.31,23.32,23.34,23.37,23.39,23.44,23.51,23.55,23.59,23.64,23.64,23.67,23.72,23.75,23.77,23.88,23.93,23.96,24,24.03,24.05,24.15,24.14,24.15,24.19,24.22,24.24,24.27,24.31,24.47,24.62,24.62,24.67,24.71,24.72,24.73,24.78,24.8,24.79,24.8,24.81,24.83,24.85,24.86,24.87,24.9,24.91,24.91,24.91,24.91,24.91,24.92,24.92,24.92,24.93,24.94,24.95,24.98,24.99,25,25.01,25.04,25.05,25.06,25.07,25.08,25.08,25.09,25.12,25.13,25.13,25.12,25.13,25.12,25.11,25.11,25.12,25.11,25.12,25.12,25.14,25.14,25.13,25.13,25.13,25.16,25.17,25.18,25.21,25.23,25.24,25.25,25.26,25.27,25.29,25.3,25.31,25.32,25.36,25.38,25.39,25.4,25.41,25.41,25.42,25.43,25.45,25.46,25.47,25.48,25.49,25.51,25.52,25.52,25.53,25.54,25.55,25.57,25.58,25.59,25.61,25.61,25.63,25.64,25.65,25.66,25.68,25.69,25.69,25.7,25.71,25.74,25.76,25.77,25.78,25.79,25.74,25.75,25.76,25.76,25.74,25.73,25.72,25.71,25.72,25.73,25.72,25.72,25.73,25.75,25.74,25.75,25.76,25.75,25.76,25.75,25.76,25.75,25.76,25.78,25.79,25.79,25.81,25.82,25.82,25.84,25.85,25.84,25.83,25.83,25.81,25.82,25.81,25.82,25.83,25.84,25.85,25.87,25.86,25.87,25.89,25.88,25.86,25.88,25.92,25.96,25.97,25.99,25.98,25.97,25.95,25.93,25.92,25.91,25.92,25.94,25.95,25.97,25.99,26,26.05,26.1,26.13,26.14,26.16,26.17,26.2,26.26,26.26,26.28,26.31,26.37,26.4,26.43,26.43,26.42,26.45,26.47,26.47,26.68,26.69,26.7,26.71,26.72,26.72,26.73,26.74,26.79,26.85,26.86,26.85,26.86,26.86,26.87,26.88,26.91,26.93,26.94,26.96,26.98,27,27.01,27.02,27.04,27.06,27.1,27.15,27.16,27.17,27.24,27.28,27.29,27.3,27.3,27.29,27.29,27.28,27.29,27.3,27.34,27.36,27.38,27.4,27.45,27.46,27.47,27.53,27.53,27.54,27.54,27.56,27.56,27.57,27.61,27.67,27.71,27.74,27.75,27.76,27.77,27.89,27.91,27.95,27.96,27.98,27.98,27.99,28.01,28.16,28.27,28.3,28.34,28.34,28.35,28.35,28.36,28.42,28.43,28.62,28.63,29.13,29.14,29.14,29.14,29.25,29.27,29.29,29.3,29.32,29.33,29.34,29.32,29.31,29.22,29.2,29.01,28.94,28.83,28.83,28.83,28.83,28.82,28.82,28.81,28.81,28.8,28.82,28.83,28.86,28.93,28.95,28.97,29.01,29.03,29.04,29.04,29.05,29.06,29.08,29.1,29.16,29.19,29.24,29.26,29.28,29.32,29.32,29.33,29.33,29.31,29.31,29.3,29.31,29.31,29.31,29.32,29.35,29.4,29.43,29.45,29.49,29.5,29.55,29.57,29.58,29.62,29.67,29.71,29.72,29.76,29.77,29.79,29.81,29.82,29.84,29.87,29.89,29.92,29.93,29.94,29.95,29.97,29.98,29.99,30.02,30.04,30.05,30.06,30.07,30.09,30.12,30.12,30.13,30.14,30.15,30.14,30.15,30.16,30.18,30.2,30.2,30.19,30.19,30.18,30.16,30.16,30.16,30.16,30.15,30.14,30.11,30.11,30.12,30.13,30.15,30.23,30.3,30.31,30.32,30.37,30.36,30.42,30.51,30.52,30.54,30.62,30.67,30.68,30.72,30.73,30.72,30.75,30.82,30.93,30.94,30.94,30.95,30.95,30.95,30.95,30.94,30.93,30.93,30.94,30.94,30.95,30.95,30.94,30.93,30.91,30.9,30.89,30.88,30.89,30.9,30.84,30.83,30.81,30.8,30.79,30.77,30.76,30.72,30.71,30.69,30.79,30.83,30.82,31.11,31.2,31.51,31.52,31.52,31.59,31.64,31.75,31.76,31.76,31.75,31.71,31.66,31.57,31.22,31.14,30.61,30.45,30.05,30.03,29.57,29.16,28.47,28.34,27.98,27.77,27.06,26.68,25.96,25.6,24.92,24.63,24.34,23.99,23.77,23.67,23.25,22.85,22.3,22.24,21.91,21.7,21.17,20.48,19.88,19.38,18.82,18.29,18.18,17.8,17.61,17.44,17.16,17.05,16.9,16.81,16.57,16.25,15.79,15.75,15.29,15.15,15.02,14.79,14.78,14.62,14.37,14.34,14.19,13.95,13.84,13.74,13.7,13.49,13.39,13.26,13.23,13.01,13,12.8,12.67,12.59,12.47,12.42,12.39,12.28,12.16,12.13,11.99,11.71,11.7,11.48,11.41,11.36,11.31,11.3,11.31,11.35,11.66,11.86,11.63,11.57,11.3,11.08,10.95,10.8,10.67,10.64,10.61,10.58,10.45,10.36,10.15,10.08,10,9.8,9.7,9.32,8.94,8.62,8.36,8.11,7.65,7.53,7.36,7.11,6.97,6.92,6.86,6.84,6.8,6.62,6.6,6.5,6.34,6.13,6.06,5.98,5.89,5.64,5.51,5.34,5.25,4.94,4.89,4.81,4.68,4.58,4.55,4.44,4.28,4.22,4.17,4.15,4.13,4.13,4.13,4.11,4.1,4.09,4.09,4.09,4.18,4.19,4.24,4.26,4.33,4.36,4.4,4.42,4.43,4.47,4.51,4.52,4.55,4.55,4.56,4.6,4.62,4.64,4.65,4.66,4.67,4.67,4.61,4.6,4.57,4.53,4.48,4.46,4.45,4.47,4.5,4.55,4.6,4.72,4.8,4.89,4.96,5.01,5.05,5.07,5.08,5.14,5.16,5.18,5.22,5.25,5.28,5.34,5.4,5.47,5.52,5.61,5.87,6.04,6.07,6.08,6.15,6.16,6.27,6.39,6.48,6.49,6.77,6.93,7.1,7.16,7.26,7.47,7.59,7.69,7.77,7.84,7.88,8.01,8.09,8.3,8.37,8.46,8.54,8.63,8.68,8.75,8.85,8.9,8.94,9.07,9.3,9.36,9.37,9.53,9.67,9.79,9.97,9.99,10.01,10.06,10.15,10.29,10.36,10.58,10.59,10.64,10.92,10.98,11.07,11.09,11.12,11.15,11.21,11.24,11.26,11.28,11.3,11.31,11.32,11.33,11.34,11.35,11.36,11.37,11.38,11.39,11.39,11.39,11.4,11.41,11.42,11.42,11.43,11.44,11.46,11.45,11.46,11.46,11.46,11.46,11.46,11.45,11.45,11.46,11.47,11.48,11.49,11.5,11.51,11.52,11.53,11.54,11.55,11.56,11.55,11.56,11.57,11.57,11.58,11.58,11.59,11.61,11.62,11.62,11.63,11.64,11.65,11.66,11.66,11.66,11.67,11.67,11.68,11.69,11.69,11.7,11.7,11.71,11.71,11.72,11.72,11.73,11.74,11.75,11.76,11.76,11.78,11.79,11.79,11.78,11.77,11.78,11.79,11.79,11.79,11.79,11.79,11.79,11.8,11.8,11.8,11.8,11.81,11.82,11.83,11.84,11.84,11.84,11.83,11.83,11.84,11.83,11.83,11.83,11.82,11.82,11.8,11.79,11.79,11.78,11.77,11.77,11.77,11.77,11.77,11.76,11.75,11.74,11.72,11.72,11.71,11.71,11.7,11.7,11.71,11.71,11.72,11.72,11.73,11.74,11.75,11.76,11.77,11.79,11.82,11.83,11.84,11.86,11.87,11.88,11.88,11.89,11.9,11.91,11.92,11.93,11.94,11.95,11.95,11.94,11.94,11.94,11.94,11.95,11.95,11.94,11.95,11.94,11.94,11.9,11.9,11.88,11.87,11.86,11.85,11.86,11.87,11.89,11.89,11.91,11.92,11.92,11.93,11.94,11.98,11.99,12.02,12.03,12.04,12.05,12.07,12.08,12.11,12.13,12.15,12.16,12.17,12.18,12.19,12.2,12.21,12.22,12.24,12.25,12.26,12.28,12.31,12.32,12.34,12.35,12.36,12.37,12.38,12.38,12.39,12.41,12.43,12.44,12.45,12.46,12.47,12.48,12.5,12.52,12.52,12.53,12.53,12.54,12.53,12.52,12.52,12.52,12.52,12.51,12.5,12.5,12.5,12.5,12.52,12.54,12.55,12.56,12.57,12.58,12.58,12.59,12.6,12.6,12.61,12.62,12.62,12.62,12.62,12.61,12.61,12.6,12.59,12.57,12.55,12.53,12.53,12.52,12.52,12.52,12.52,12.52,12.51,12.5,12.48,12.46,12.43,12.41,12.4,12.37,12.35,12.35,12.34,12.34,12.34,12.34,12.33,12.33,12.33,12.32,12.31,12.29,12.28,12.26,12.26,12.25,12.23,12.32,12.37,12.38,12.4,12.41,12.44,12.45,12.47,12.49,12.54,12.6,12.61,12.64,12.65,12.66,12.67,12.67,12.68,12.69,12.69,12.7,12.7,12.71,12.71,12.71,12.71,12.79,12.81,12.83,12.84,12.84,12.85,12.85,12.86,12.88,12.86,12.84,12.82,12.79,12.78,12.71,12.64,12.6,12.58,12.55,12.52,12.49,12.47,12.47,12.46,12.43,12.39,12.39,12.36,12.34,12.33,12.3,12.2,12.18,12.14,12.14,12.15,12.15,12.16,12.17,12.17,12.18,12.18,12.19,12.19,12.19,12.22,12.27,12.28,12.28,12.29,12.29,12.3,12.31,12.32,12.32,12.31,12.23,12.22,12.22,12.21,12.17,12.13,12.08,12.07,12.06,12.06,12.07,12.09,12.1,12.1,12.11,12.12,12.13,12.14,12.11,12.11,12.09,12.08,12.13,12.18,12.18,12.2,12.21,12.22,12.23,12.22,12.22,12.2,12.19,12.13,12.08,12,11.98,12,12.05,12.06,12.06,12.07,12.08,12.07,12.12,12.22,12.18,12.18,12.15,12.24,12.27,12.34,12.35,12.35,12.38,12.4,12.42,12.44,12.48,12.5,12.52,12.51,12.57,12.62,12.63,12.66,12.69,12.74,12.75,12.76,12.77,12.84,12.86,12.88,12.89,12.92,13.04,13.09,13.15,13.16,13.17,13.2,13.2,13.5,13.65,13.66,13.81,13.83,13.92,13.92,13.97,13.99,14.01,14.03,14.06,14.07,14.1,14.11,14.13,14.16,14.16,14.14,14.13,14.13,14.12,14.12,14.12,14.13,14.13,14.12,14.12,14.09,14.06,13.95,13.92,13.78,13.76,13.7,13.66,13.69,13.7,13.8,13.9,13.92,13.93,13.96,13.98,13.99,14.01,14.06,14.09,14.11,14.13,14.14,14.15,14.17,14.26,14.28,14.32,14.35,14.35,14.36,14.37,14.37,14.39,14.4,14.46,14.52,14.52,14.51,14.51,14.51,14.51,14.51,14.51,14.51,14.51,14.51,14.52,14.52,14.53,14.53,14.53,14.54,14.54,14.54,14.57,14.58,14.59,14.62,14.62,14.63,14.61,14.6,14.6,14.59,14.59,14.58,14.56,14.54,14.53,14.52,14.65,14.83,14.85,14.95,15,15.03,15.08,15.14,15.36,15.37,15.5,15.49,15.48,15.47,15.45,15.44,15.43,15.42,15.41,15.4,15.4,15.39,15.38,15.42,15.49,15.5,15.59,15.61,15.63,15.65,15.66,15.67,15.71,15.72,15.73,15.75,15.78,15.88,15.89,15.98,16.01,16.02,16.06,16.11,16.16,16.17,16.2,16.23,16.24,16.26,16.3,16.32,16.41,16.4,16.4,16.41,16.41,16.41,16.42,16.41,16.4,16.36,16.35,16.33,16.32,16.31,16.3,16.22,16.19,16.14,16.11,16.12,16.15,16.15,16.17,16.17,16.38,16.4,16.43,16.46,16.47,16.49,16.5,16.52,16.56,16.58,16.59,16.61,16.61,16.62,16.63,16.64,16.65,16.65,16.66,16.66,16.67,16.68,16.69,16.7,16.71,16.72,16.75,16.77,16.81,16.85,16.92,16.93,16.99,17.03,17.15,17.16,17.17,17.19,17.21,17.22,17.25,17.27,17.28,17.29,17.3,17.33,17.41,17.48,17.52,17.63,17.64,17.76,17.78,17.82,17.9,17.91,17.99,18.01,18.08,18.09,18.13,18.15,18.16,18.16,18.14,18.13,18.13,18.13,18.12,18.11,18.11,18.13,18.13,18.21,18.33,18.38,18.42,18.52,18.56,18.62,18.68,18.95,18.98,18.99,19.04,19.08,19.09,19.1,19.14,19.29,19.44,19.54,19.59,19.76,19.78,19.82,19.92,19.96,19.97,20,20.02,20.05,20.08,20.09,20.12,20.17,20.22,20.27,20.21,20.1,20.08,20.01,19.98,20.01,20.06,20.07,20.09,20.11,20.14,20.21,20.22,20.23,20.26,20.27,20.28,20.29,20.3,20.31,20.35,20.35,20.35,20.34,20.35,20.35,20.35,20.34,20.34,20.33,20.25,20.2,20.18,20.13,20.09,20.07,20.08,20.11,20.29,20.31,20.4,20.41,20.44,20.47,20.55,20.56,20.59,20.69,20.72,20.77,20.78]
}}),Wu.CartodbLayer=Wu.Model.Layer.extend({}),Wu.ErrorLayer=Wu.Model.Layer.extend({}),Wu.createLayer=function(a){return a.data?a.data.postgis&&a.data.postgis.file_id?new Wu.PostGISLayer(a):a.data.mapbox?new Wu.MapboxLayer(a):a.data.geojson?new Wu.CartoCSSLayer(a):a.data.osm?new Wu.OSMLayer(a):a.data.topojson?new Wu.TopojsonLayer(a):a.data.raster?new Wu.RasterLayer(a):a.data.norkart?new Wu.NorkartLayer(a):a.data.google?new Wu.GoogleLayer(a):new Wu.ErrorLayer:new Wu.ErrorLayer},L.TileLayer.include({setOptions:function(a){L.setOptions(this,a),this.redraw()}}),L.UtfGrid.include({setOptions:function(a){L.setOptions(this,a),this.redraw()}}),Wu.Model.File=Wu.Model.extend({_:"file",_initialize:function(a){this.store=a},getStore:function(){return this.store},getName:function(){return this.store.name},getTitle:function(){return this.getName()},getType:function(){return this.store.type},getUuid:function(){return this.store.uuid},getLastUpdated:function(){return this.store.lastUpdated},getKeywords:function(){return this.store.keywords},getFormat:function(){return this.store.format},getFileList:function(){return this.store.files},getDatasize:function(){return this.store.dataSize},getCreatedByName:function(){return this.store.createdByName},getCreatedBy:function(){return this.store.createdBy},getCreated:function(){return this.store.created},getCategory:function(){return this.store.category},getStatus:function(){return this.store.status},getVersion:function(){return this.store.version},getDescription:function(){return this.store.description},getLayer:function(){var a=this.getUuid(),b=_.find(app.Projects,function(b){return b.files[a]}),c=_.find(b.layers,function(b){return b.getFileUuid()==a});return c},getCopyright:function(){return this.store.copyright},setCopyright:function(a){this.store.copyright=a,this.save("copyright")},_addToProject:function(a){var b={projectUuid:a,fileUuid:this.getUuid()};Wu.Util.postcb("/api/file/addtoproject",JSON.stringify(b),function(a,b){})},setName:function(a){this.store.name=a,this.save("name")},setKeywords:function(a){this.store.keywords=a,this.save("keywords")},setTag:function(){this.save("keywords")},setFormat:function(a){this.store.format=a,this.save("format")},setCategory:function(a){this.store.category=a,this.save("category")},setStatus:function(a){this.store.status=a,this.save("status")},setVersion:function(a){this.store.version=a,this.save("version")},setDescription:function(a){this.store.description=a,this.save("description")},save:function(a){var b={};b[a]=this.store[a],b.uuid=this.store.uuid;var c=JSON.stringify(b);this._save(c)},_save:function(a){Wu.save("/api/file/update",a),app.setSaveStatus()},_deleteFile:function(){this._getLayers(function(a,b){var c=b.length,d=[];c&&b.forEach(function(a,b,c){d.push("- "+a.title)});var e="There exists "+c+" layers based on this dataset: \n"+d.join("\n")+"\n\nDeleting dataset will delete all layers. Are you sure?",f="Do you really want to delete dataset "+this.getName()+"?",g=c?e:f,h=confirm(g);if(!h)return void 0;var i=this._getLayerData();Wu.post("/api/file/delete",JSON.stringify(i),function(a,b){var c=Wu.parse(b);this._fileDeleted(c)}.bind(this))}.bind(this))},_fileDeleted:function(a){return a.error||!a.success?void 0:(app.Account.removeFile(a.removed.file),this._removeLayersLocally(a.removed.layers),void Wu.Mixin.Events.fire("fileDeleted",{detail:{fileUuid:"lol"}}))},_removeLayersLocally:function(a){a.forEach(function(a){var b=_.find(app.Projects,function(b){return b.getLayer(a.uuid)});b.removeLayer(a)}),Wu.Mixin.Events.fire("layerDeleted",{detail:{fileUuid:"lol"}})},_getLayers:function(a){var b=this._getLayerData();Wu.post("/api/file/getLayers",JSON.stringify(b),function(b,c){var d=Wu.parse(c);a(b,d)})},getPostGISData:function(){return this.store.data?this.store.data.postgis:!1},_getLayerData:function(){if(!this.store.data)return!1;if(this.store.data.postgis){var a={data:this.store.data.postgis,type:"postgis"};return a}if(this.store.data.raster){var a={data:this.store.data.raster,type:"raster"};return a}return!1},_shareFile:function(){},_createLayer:function(a){this._createDefaultLayer(a)},_downloadFile:function(){this._downloadDataset()},_downloadDataset:function(){var a={file_id:this.getUuid(),socket_notification:!0};this._downloadingID=Wu.Util.createRandom(5),Wu.post("/api/file/downloadDataset",JSON.stringify(a),function(a,b){app.feedback.setMessage({title:"Preparing download",description:"Hold tight! Your download will be ready in a minute.",id:this._downloadingID})}.bind(this))},_onDownloadReady:function(a){var b=a.detail,c=(b.file_id,b.finished,b.filepath),d=app.options.servers.portal;d+="api/file/download/",d+="?file="+c,d+="&type=shp",d+="&access_token="+app.tokens.access_token,window.open(d,"mywindow"),app.feedback.remove(this._downloadingID)},_getGeometryType:function(){var a=this.getMeta();return a.geometry_type},_getDefaultStyling:function(){var a=this._getGeometryType(),b=this._defaultStyling;return"ST_Point"==a&&(b.point.enabled=!0),"ST_MultiPolygon"==a&&(b.polygon.enabled=!0),"ST_LineString"==a&&(b.line.enabled=!0),b},_createDefaultCartocss:function(a,b){var c=app.Tools.Styler;c.createCarto(a,b)},_defaultStyling:{point:{enabled:!1,color:{column:!1,range:[-426.6,105.9],staticVal:"yellow",value:["#ff0000","#ffff00","#00ff00","#00ffff","#0000ff"]},opacity:{column:!1,range:[-426.6,105.9],value:.5},pointsize:{column:!1,range:[0,10],value:1}},polygon:{enabled:!1,color:{column:!1,range:[-426.6,105.9],staticVal:"red",value:["#ff0000","#ffff00","#00ff00","#00ffff","#0000ff"]},opacity:{column:!1,range:[-426.6,105.9],value:.5},line:{width:{column:!1,range:!1,value:1},opacity:{column:!1,range:[-426.6,105.9],value:.5},color:{column:!1,range:[-426.6,105.9],staticVal:"green",value:["#ff0000","#ffff00","#00ff00","#00ffff","#0000ff"]}}},line:{enabled:!1,width:{column:!1,range:!1,value:1},opacity:{column:!1,value:.5},color:{column:!1,range:[-426.6,105.9],staticVal:"green",value:["#ff0000","#ffff00","#00ff00","#00ffff","#0000ff"]}}},_getType:function(){return this.store.data&&this.store.data.postgis?"vector":this.store.data&&this.store.data.raster?"raster":!1},_createDefaultLayer:function(a){var b=this._getType();"vector"==b&&this._createDefaultVectorLayer(a),"raster"==b&&this._createDefaultRasterLayer(a)},_createDefaultRasterLayer:function(a){var b={file:this,project:a};this._requestDefaultRasterLayer(b)},_requestDefaultRasterLayer:function(a){var b=a.file,c=b.getUuid(),d=a.project,e={geom_column:"the_geom_3857",geom_type:"geometry",raster_band:"",srid:"",affected_tables:"",interactivity:"",attributes:"",access_token:app.tokens.access_token,cartocss_version:"2.0.1",file_id:c,return_model:!0,projectUuid:d.getUuid()};Wu.post("/api/db/createLayer",JSON.stringify(e),function(a,c){var e=Wu.parse(c),f={projectUuid:d.getUuid(),data:{raster:e.layerUuid},metadata:e.options.metadata,title:b.getName(),description:"Description: Layer created from "+b.getName(),file:b.getUuid()};this._createLayerModel(f,function(a,b){d.addLayer(b),app.feedback.setMessage({title:"Added layer"}),Wu.Mixin.Events.fire("layerAdded",{detail:{projectUuid:d.getUuid(),layerUuid:b.uuid}})})}.bind(this))},_createDefaultVectorLayer:function(a){var b=(this.getUuid(),this),c=this._getDefaultStyling();this._createDefaultCartocss(c,function(d,e){var f={file:b,defaultCartocss:e,project:a,defaultStyle:c};this._requestDefaultVectorLayer(f)}.bind(this))},_requestDefaultVectorLayer:function(a){var b=a.file,c=b.getUuid(),d=a.project,e=a.defaultCartocss,f=a.defaultStyle,g={geom_column:"the_geom_3857",geom_type:"geometry",raster_band:"",srid:"",affected_tables:"",interactivity:"",attributes:"",access_token:app.tokens.access_token,cartocss_version:"2.0.1",cartocss:e,sql:"(SELECT * FROM "+c+") as sub",file_id:c,return_model:!0,projectUuid:d.getUuid()};Wu.post("/api/db/createLayer",JSON.stringify(g),function(a,c){var e=Wu.parse(c),g={projectUuid:d.getUuid(),data:{postgis:e.options},metadata:e.options.metadata,title:b.getName(),description:"Description: Layer created from "+b.getName(),file:b.getUuid(),style:JSON.stringify(f)};this._createLayerModel(g,function(a,b){d.addLayer(b),app.feedback.setMessage({title:"Added layer"}),Wu.Mixin.Events.fire("layerAdded",{detail:{projectUuid:d.getUuid(),layerUuid:b.uuid}})})}.bind(this))},_createLayerModel:function(a,b){Wu.Util.postcb("/api/layers/new",JSON.stringify(a),function(a,c){var d=Wu.parse(c);b(null,d)}.bind(this))},getMeta:function(){if(!this.store.data.postgis)return!1;if(!this.store.data.postgis.metadata)return!1;var a=Wu.parse(this.store.data.postgis.metadata);return a},getRasterMeta:function(){if(!this.store.data.raster)return!1;if(!this.store.data.raster.metadata)return!1;var a=Wu.parse(this.store.data.raster.metadata);return a},getHistograms:function(){var a=this.getMeta();if(!a)return!1;var b=a.histogram;return b},getHistogram:function(a){var b=this.getHistograms();return b?b[a]:!1}}),Wu.Role=Wu.Class.extend({initialize:function(a){this.store=a.role,this._project=a.project},addMember:function(a,b){var c={user:a,project:this._project,role:this};app.access.addRoleMember(c,b)},noRole:function(){return"noRole"==this.store.slug},getName:function(){return this.store.name},getMembers:function(){return this.store.members},getCapabilities:function(){return this.store.capabilities},getUuid:function(){return this.store.uuid},getSlug:function(){return this.store.slug},hasMember:function(a){var b=_.contains(this.getMembers(),a.getUuid());return b?!0:!1},isMember:function(a){return _.contains(this.getMembers(),a.getUuid())},hasCapability:function(a){var b=this.getCapabilities();return b?this.getCapabilities()[a]:!1}}),Wu.Role.Super=Wu.Role.extend({addMember:function(a,b){var c={userUuid:a.getUuid(),roleUuid:this.getUuid()};Wu.send("/api/access/super/setrolemember",c,function(a,c){b(a,c)})}}),Wu.Role.Portal=Wu.Role.extend({addMember:function(a,b){var c={userUuid:a.getUuid(),roleUuid:this.getUuid()};Wu.send("/api/access/portal/setrolemember",c,function(a,c){b(a,c)})}}),Wu.List=Wu.Class.extend({canEdit:!1,folder:"Folder",initialize:function(a){this.searchField=a.searchfield,this.D3container=d3.select(a.container),this.listOptions=this.getListOptions(),this.listOptions.button&&(this.selectAllButton=Wu.DomUtil.create("div","item-select-button select-all-button",this.D3container[0][0])),this.setHooks("on")},setHooks:function(a){Wu.DomEvent[a](this.searchField,"keyup",this.searchList,this),this.listOptions.button&&Wu.DomEvent[a](this.selectAllButton,"mousedown",this.selectAllClick,this)},createFolder:function(){},openItemInfo:function(a){},refresh:function(a){},save:function(a){},stop:function(a){Wu.DomEvent.stopPropagation(a)},sortBy:function(a,b){var c=a.name;if(this.sortDirection||(this.sortDirection={}),0==this.sortDirection[c]){var d="desc";this.sortDirection[c]=!0}else{var d="asc";this.sortDirection[c]=!1}var e=this.listData,f=this.sortedData?this.sortedData:b.data2array(e);this.sortedData=b.sortData(f,{field:c,direction:d}),this.refreshTable()},updateTable:function(a){var b=a.context;a.reset&&(b.listData=a.listData,b.sortedData=null,b.listOptions.button.arr&&(b.listOptions.button.arr=[]),a.canEdit?(b.canEdit=a.canEdit,b.D3container.classed("canEdit",!0)):b.D3container.classed("canEdit",!1),b.refreshTable(b)),a.remove&&b.removeItems(a.remove),a.add&&b.addItems(a.add),a.tableSize&&(b.tableSize=a.tableSize,b.refreshTable(b))},refreshTable:function(a){var b=a?a:this;if(b.sortedData)var c=b.sortedData;else var d=b.listData,c=b.data2array(d);b.refresh(c)},sortData:function(a,b){var c=b.field,d=b.direction;return"asc"==d&&a.sort(function(a,b){return"createdDate"==c?new Date(a.file.store.created).getTime()-new Date(b.file.store.created).getTime():a.file.store[c]&&""!=a.file.store[c]&&" "!=a.file.store[c]?b.file.store[c]&&""!=b.file.store[c]&&" "!=b.file.store[c]?a.file.store[c]<b.file.store[c]?-1:a.file.store[c]>b.file.store[c]?1:0:-1:1}),"desc"==d&&a.sort(function(a,b){return"createdDate"==c?new Date(b.file.store.created).getTime()-new Date(a.file.store.created).getTime():a.file.store[c]&&""!=a.file.store[c]&&" "!=a.file.store[c]?b.file.store[c]&&""!=b.file.store[c]&&" "!=b.file.store[c]?a.file.store[c]>b.file.store[c]?-1:a.file.store[c]<b.file.store[c]?1:0:-1:1}),a},searchList:function(a){if(27==a.keyCode)return this.resetSearch();var b=this.searchField.value;this.listSearch(b)},resetSearch:function(){this.searchField.value=""},listSearch:function(a){var b=this,c=[],d=this.listData;for(f in d){var e=this.getSearchObj(f,d),g=a.toLowerCase();e.forEach(function(a){var d=a.value.toLowerCase(),e=d.match(g);e&&b.buildSearchString(c,a.location)})}var h=this.buildResultData(c);this.sortedData=this.data2array(h),this.unselectItems(),this.refreshTable()},unselectItems:function(){if(this.listOptions.button){var a=this.data2array(this.listData),b=this.sortedData,c=this.listOptions.button.arr,d=this;a.forEach(function(a){var e=!1;if(b.forEach(function(b){b.fileUuid==a.fileUuid&&(e=!0)}),!e){var f=!1;c.forEach(function(b){b==a.fileUuid&&(f=!0)}),f&&d.unSelectListItem(a.fileUuid,d)}})}},getSearchObj:function(a,b){var c=this.listOptions.searchFields,d=[],e=b[a].store;return c.forEach(function(b){if(e[b])if("object"==typeof e[b]){if(e[b].length>0){var c=e[b];c.forEach(function(b){if(b){var c={value:b,location:a};d.push(c)}})}}else{var f=e[b],g={value:f,location:a};d.push(g)}}),d},buildSearchString:function(a,b){var c=!0;a.forEach(function(a){a==b&&(c=!1)}),c&&a.push(b)},buildResultData:function(a){var b={},c=this.listData;for(f in c)a.forEach(function(a){f==a&&(b[f]=c[f])});return b},editField:function(a){var b=a.outerContext;b._D3input(a,b.updateAndRefresh)},_D3input:function(a,b){var c=Wu.DomUtil.create("input");return c.type="text",c.className="autocarto-input",c.value=a.value?a.value:"",a.context.innerHTML="",a.context.appendChild(c),c.focus(),c.setSelectionRange(0,0),document.addEventListener("keydown",function(a){13==a.keyCode&&c.blur()}),c.onblur=function(){b(c,a)},c},updateAndRefresh:function(a,b){var c=a.value;a.remove(),b.where[b.what]=c;var d=b.allDATA,e=b.outerContext;e._D3list(d);var f={},g=b.what;f[g]=c,f.uuid=b.uuid,f.key=g,f.value=c,f.id=b.uuid,e.save(f),app.setSaveStatus()},selectListItem:function(a,b){if(b.listOptions.button){var c=!1,d=b.listOptions.button.arr;d.forEach(function(b,d){b==a&&(c=d+1)}),c?d.splice(c-1,1):d.push(a),b.refreshTable()}},unSelectListItem:function(a,b){if(b.listOptions.button){var c=b.listOptions.button.arr;c.forEach(function(b,d){b==a&&c.splice(d,1)})}},dateHTML:function(a){var b,c=new Date(a.file.store.created),d=c.getDate(),e=c.getMonth()+1,f=c.getFullYear();1==e&&(b="Jan"),2==e&&(b="Feb"),3==e&&(b="Mar"),4==e&&(b="Apr"),5==e&&(b="May"),6==e&&(b="Jun"),7==e&&(b="Jul"),8==e&&(b="Aug"),9==e&&(b="Sep"),10==e&&(b="Oct"),11==e&&(b="Nov"),12==e&&(b="Dec");var g=b+" "+d+" "+f;return g},data2array:function(a){var b=[];for(f in a){var c={fileUuid:f,file:a[f]};b.push(c)}return b},_D3list:function(a){this._D3header(),this.listOptions.wrapper=this.listItemWrapper(a),this.selectButton(),this.listFolder(a),this.listTitle(a),this.initAttributes(a),this.openItemInfo(a)},_D3header:function(){var a=this.listOptions,b=(this.listOptions.titleSpace.name.field,this),c=a.attributes,d=[];c.forEach(function(c){var e=!0;a.attributes.forEach(function(a){c.name==a.name&&a.killOnSmall&&"small"==b.tableSize&&(e=!1)}),e&&d.push(c)});var e=this.D3container.selectAll(".d3-list-header").data([c]);e.enter().append("div").classed("d3-list-header",!0),e.exit().remove();var f=e.selectAll(".d3-list-header-item").data(function(a){return a});f.enter().append("div").attr("class",function(a){return"d3-list-header-item-"+a.niceName}).classed("d3-list-header-item",!0),f.html(function(a){return a.niceName}).attr("style",function(c,d){if(c.killOnSmall&&"small"==b.tableSize)return"display: none";if("Name"==c.niceName){var e=100;a.attributes.forEach(function(a){var c=!0;if(a.restrict?b.canEdit&&(c=!1):c=!1,a.killOnSmall&&"small"==b.tableSize&&(c=!0),a.width&&!c){var d;d=a.smallWidth&&!a.killOnSmall&&"small"==b.tableSize?a.smallWidth:a.width,e-=d}});var f="width: "+e+"%; left: 0%; ";b.listOptions.button||(f+="padding-left: 10px;")}else var f=b.getAttributeStyle(d);return f}).on("mousedown",function(a){b.sortBy(a,b)}),f.exit().remove()},listItemWrapper:function(a){var b=this,c=this.D3container.selectAll(".list-line").data(a);return c.enter().append("div"),c.attr("class",function(a){var c="list-line",d=b.checkSelected(a.fileUuid);return d&&(c+=" selected"),a.file.isProcessing&&(c+=" processing"),c}).attr("style",function(a){var c=b.checkOpenFileInfo(a.fileUuid,b);return c?"height: 240px; overflow: hidden;":void 0}),c.exit().remove(),c},listFolder:function(a){var b=this.listOptions.wrapper,c=(this.listOptions.titleSpace.name.field,this),d=b.selectAll(".list-folder-wrapper").data(function(a){return a.file.store.type==c.folder?[a]:[]});d.enter().append("div").classed("list-folder-wrapper",!0),d.on("click",function(a){c.listfolderToggle(a,c)}),d.attr("class",function(a){var b=c.checkFolderOpenState(a.fileUuid,c);return b?"list-folder-wrapper open-folder":"list-folder-wrapper"}),d.exit().remove()},selectButton:function(){var a=this.listOptions;if(a.button){var b=a.wrapper,c=a.button.fn,d=a.button.arr,e=this,f=b.selectAll(".item-select-button").data(function(a){return[a]});f.enter().append("div").classed("item-select-button",!0),f.on("mousedown",function(a){"item-select-button active"==this.className?(Wu.DomUtil.removeClass(this,"active"),a.checked=!0):(Wu.DomUtil.addClass(this,"active"),a.checked=!1);var b=a.fileUuid;c(b,e)}),f.attr("class",function(a){var b=!1;return d.forEach(function(c){a.fileUuid==c&&(b=!0)}),b?"item-select-button active":"item-select-button"}),f.exit().remove()}},listTitle:function(a){var b=this.listOptions.wrapper,c=this.listOptions.titleSpace.name.field,d=this,e=b.selectAll(".list-title-wrapper").data(function(a){return[a]});e.enter().append("div").classed("list-title-wrapper",!0),e.attr("style",function(a){var b="",c=d.getNameWidth(d);return c&&(b+="width:"+c+"%;"),a.file.store.type==d.folder&&(b+="padding-left: 115px;"),b}),e.exit().remove();var f=e.selectAll(".list-title").data(function(a){return[a]});f.enter().append("div").classed("list-title",!0),f.html(function(a){return a.file.store[c]}),this.listOptions.titleSpace.name.fn&&this.listOptions.titleSpace.name.ev&&f.on(this.listOptions.titleSpace.name.ev,function(b){d.listOptions.titleSpace.name.fn(a,b,this,d)}),f.exit().remove();var g=e.selectAll(".list-description").data(function(a){return[a]});if(g.enter().append("div").classed("list-description",!0),this.listOptions.titleSpace.description.fn&&this.listOptions.titleSpace.description.ev&&g.on(this.listOptions.titleSpace.description.ev,function(b){d.listOptions.titleSpace.description.fn(a,b,this,d)}),this.listOptions.titleSpace.description.killOnSmall&&"small"==this.tableSize&&g.classed("displayNone",!0),this.listOptions.titleSpace.description.killOnSmall&&"small"!=this.tableSize&&g.classed("displayNone",!1),g.html(function(a){var b=d.listOptions.titleSpace.description.html(a);return b}),g.exit().remove(),this.listOptions.fileInfo){var h=e.selectAll(".list-item-info").data(function(a){return[a]});h.enter().append("div").classed("list-item-info",!0),h.on("click",function(a){d.toggleFileInfo(a,d,h)}),f.exit().remove()}},initAttributes:function(a){var b=this.listOptions,c=this;c.listProcessing(a),b.attributes.forEach(function(b,d){if("Name"!=b.niceName){var e=!0;b.restrict&&!c.canEdit&&(e=!1),e&&c.listAttribute(d,a)}})},listProcessing:function(a,b){var c=this.listOptions,d=c.wrapper.selectAll(".list-process-grind").data(function(a){return a.file.isProcessing?[a]:[]});d.enter().append("div").classed("list-process-grind",!0),d.exit().remove()},listAttribute:function(a,b){var c=this.listOptions,d=this,e=c.attributes[a].name,f=c.attributes[a].fn,g=c.attributes[a].ev,h=this.getAttributeStyle(a),i=c.attributes[a].killOnSmall,j=c.wrapper.selectAll(".list-attribute-wrapper-"+e).data(function(a){return a.file.isProcessing?[]:i&&"small"==d.tableSize?[]:[a]});j.enter().append("div").classed("list-attribute-wrapper-"+e,!0).classed("list-attribute-wrapper",!0),j.attr("style",h),f&&j.on(g,function(a){f(b,a,this,d)}),j.exit().remove();var k=j.selectAll(".list-attribute-"+e).data(function(a){return[a]});k.enter().append("div").classed("list-attribute-"+e,!0).classed("list-attribute",!0),k.html(function(b){if(c.attributes[a].html){var f=c.attributes[a].html(b,d);return f?[f.camelize()]:[]}return b.file.store[e]?b.file.store[e].camelize():[]}),k.exit().remove()},updateProcessig:function(a,b){var c=a.selectAll(".list-process").data(function(a){return[a]});c.enter().append("div").classed("list-process",!0),c.exit().remove();var d=c.selectAll(".list-process-bar").data(function(a){return[a]});d.enter().append("div").classed("list-process-bar",!0),d.exit().remove();var e=d.selectAll(".list-process-bar-inner").data(function(a){return[a]});e.enter().append("div").classed("list-process-bar-inner",!0),e.attr("style",function(a){return"width:"+a.file.isProcessing.percent+"%"}),e.exit().remove();var f=c.selectAll(".list-process-no").data(function(a){return[a]});f.enter().append("div").classed("list-process-no",!0),f.html(function(a){return a.file.isProcessing.tiles}),f.exit().remove()},getNameWidth:function(a){var b=a.listOptions.attributes,c=100,a=this;return b.forEach(function(b){var d=!0;if(b.restrict?a.canEdit&&(d=!1):d=!1,b.killOnSmall&&"small"==a.tableSize&&(d=!0),!d&&b.width){var e;e=b.smallWidth&&!b.killOnSmall&&"small"==a.tableSize?b.smallWidth:b.width,c-=e}}),c},getAttributeStyle:function(a){var b=this,c=this.listOptions,d=c.attributes[a],e=d.width,f=d.restrict,g=a,h=0,i=0;d.smallWidth&&!d.killOnSmall&&"small"==b.tableSize&&(e=d.smallWidth),c.attributes.forEach(function(a,c){var d=!0;if(a.restrict?this.canEdit&&(d=!1):d=!1,a.killOnSmall&&"small"==b.tableSize&&(d=!0),!d){var e;e=a.smallWidth&&!a.killOnSmall&&"small"==b.tableSize?a.smallWidth:a.width,e&&c>=g&&(h+=e),e&&(i+=e)}},this);var j=i-10-(h-10),k="width: "+e+"%; right: "+j+"%;";return f&&!this.canEdit&&(k+=" display: none;"),k},selectAllClick:function(){if(this.listOptions.button){var a=this.data2array(this.listData);this.sortedData&&(a=this.sortedData);var b=this.listOptions.button.arr;b.length==a.length?(this.listOptions.button.arr=[],this.refreshTable()):(this.listOptions.button.arr=[],a.forEach(function(a){this.listOptions.button.arr.push(a.fileUuid)},this),this.refreshTable())}},checkSelected:function(a){if(this.listOptions.button){var b=this.listOptions.button.arr,c=!1;return b.forEach(function(b){b==a&&(c=!0)}),c}},checkFolderOpenState:function(a,b){if(!b.openFolders)return!1;var c=!1;return b.openFolders.forEach(function(b){b==a&&(c=!0)}),c},listfolderToggle:function(a,b){b.openFolders||(b.openFolders=[]);var c=!1;b.openFolders.forEach(function(b,d){b==a.fileUuid&&(c=d+1)}),c?b.openFolders.splice(c-1,1):b.openFolders.push(a.fileUuid),b.refreshTable()},checkOpenFileInfo:function(a,b){if(!b.showFileInfo)return!1;var c=!1;return b.showFileInfo.forEach(function(b){b==a&&(c=!0)}),c},toggleFileInfo:function(a,b,c){b.showFileInfo||(b.showFileInfo=[]);var d=!1;b.showFileInfo.forEach(function(b,c){b==a.fileUuid&&(d=c+1)}),d?b.showFileInfo.splice(d-1,1):b.showFileInfo.push(a.fileUuid),b.refreshTable()}}),Wu.UserList=Wu.List.extend({refresh:function(a){app.Dropzone&&app.Dropzone.disable(),this.canEdit?this.D3container.classed("canEdit",!0):this.D3container.classed("canEdit",!1),this.listData=app.Users,a&&this._D3list(a)},addItems:function(a){this.sortedData&&(this.sortedData=null),this.refreshTable()},removeItems:function(a){this.sortedData&&(this.sortedData=null),this.refreshTable()},save:function(a){var b=a.key,c=a.value?a.value:" ",d=a.id,e=app.Users[d];e.setKey(b,c)},getListOptions:function(){var a={fileInfo:!1,button:{fn:this.selectListItem,arr:[]},titleSpace:{name:{fn:this.lastNameFunction,ev:"dblclick",field:"lastName"},description:{fn:this.firstNameFunction,html:this.firstNameHtml,ev:"dblclick",field:"firstName"}},attributes:[{name:"lastName",niceName:"Name",fn:null,ev:null},{name:"access",niceName:"Access",fn:this.accessFunction,ev:"click",html:this.accessHtml,killOnSmall:!1,width:15,smallWidth:20},{name:"email",niceName:"Email",fn:null,ev:null,html:this.emailHtml,killOnSmall:!0,width:20},{name:"phone",niceName:"Phone",fn:this.phoneFunction,ev:"dblclick",html:this.phoneHtml,killOnSmall:!0,width:15},{name:"position",niceName:"Position",html:null,fn:this.positionFunction,ev:"dblclick",html:this.positionHtml,killOnSmall:!1,width:12,smallWidth:20},{name:"company",niceName:"Company",fn:this.companyFunction,ev:"dblclick",html:this.companyHtml,killOnSmall:!1,width:12,smallWidth:20}],searchFields:["lastName","firstName","company","position","phone","email","access"]};return a},lastNameFunction:function(a,b,c,d){if(d.canEdit){var e={outerContext:d,context:c,what:"lastName",allDATA:a,data:b,where:b.file.store,value:b.file.store.lastName,uuid:b.fileUuid};this.sortedData&&(e.allDATA=this.sortedData),d.editField(e)}},firstNameFunction:function(a,b,c,d){if(d.canEdit){var e={outerContext:d,context:c,what:"firstName",allDATA:a,data:b,where:b.file.store,value:b.file.store.firstName,uuid:b.fileUuid};this.sortedData&&(e.allDATA=this.sortedData),d.editField(e)}},companyFunction:function(a,b,c,d){if(d.canEdit){var e={outerContext:d,context:c,what:"company",allDATA:a,data:b,where:b.file.store,value:b.file.store.company,uuid:b.fileUuid};this.sortedData&&(e.allDATA=this.sortedData),d.editField(e)}},positionFunction:function(a,b,c,d){if(d.canEdit){var e={outerContext:d,context:c,what:"position",allDATA:a,data:b,where:b.file.store,value:b.file.store.position,uuid:b.fileUuid};this.sortedData&&(e.allDATA=this.sortedData),d.editField(e)}},phoneFunction:function(a,b,c,d){if(d.canEdit){var e={outerContext:d,context:c,what:"phone",allDATA:a,data:b,where:b.file.store,value:b.file.store.phone,uuid:b.fileUuid};this.sortedData&&(e.allDATA=this.sortedData),d.editField(e)}},accessFunction:function(a,b,c,d){if(d.canEdit){var e=b.fileUuid;app.SidePane.Users.editAccess(e)}},firstNameHtml:function(a){return a.file.store.firstName},companyHtml:function(a){var b=a.file.store.company;return b&&""!=b&&" "!=b?b:'<span class="grayed">Add company</span>'},positionHtml:function(a){var b=a.file.store.position;return b&&""!=b&&" "!=b?b:'<span class="grayed">Add position</span>'},phoneHtml:function(a){var b=a.file.store.phone;return b&&""!=b&&" "!=b?b:'<span class="grayed">Add phone number</span>'},emailHtml:function(a){return a.file.store.local.email},accessHtml:function(a,b){var c=b.listData;for(f in c)if(a.fileUuid==f)var d=c[f];if(d){var e='<div class="user-projects-button">',g="</div>",h=d.getProjects(),i=h?h.length:0,j=1==i?i+" project":i+" projects";0==i&&(j="Click to give access!");var k=e+j+g;return k}},getUser:function(a){var b=this.listData;for(f in b)if(a==f)return b[f]},getSelected:function(){var a=[],b=this.listOptions.button.arr,c=this.listData;for(f in c)b.forEach(function(b){b==f&&a.push(c[f])});return a}}),Wu.Access=Wu.Class.extend({initialize:function(a){app.access=this,this.store=a,this.roles.templates=a.templates,this._superRole=new Wu.Role.Super({role:app.options.json.access.superRole}),this._portalRole=new Wu.Role.Portal({role:app.options.json.access.portalRole})},addRoleMember:function(a,b){var c=a.user,d=a.project,e=a.role,f=app.access.get.role(a),g=f?f.getUuid():!1,h={userUuid:c.getUuid(),projectUuid:d.getUuid(),roleUuid:e.getUuid(),currentRoleUuid:g};Wu.send("/api/access/setrolemember",h,function(a,c){if(a)return b(a);var e=Wu.parse(c);return e?e.error?b(e.error):(d.setRolesStore(e.roles),void b(a,e)):b("Malformed response: "+c)})},get:{role:function(a){var b=a.project,c=a.user;if(app.access.is.superAdmin(c))return app.access._superRole;if(app.access.is.portalAdmin(c))return app.access._portalRole;var d=_.find(b.getRoles(),function(a){return a.hasMember(c)});return d},availableRoles:function(a){var b=app.Account,c=(a.user,a.project),d=a.noAdmins,e=app.access.get.role({user:b,project:c});if(!e.getCapabilities().delegate_to_user)return[];var f=app.access.filter.roles({role:e,project:c,noAdmins:d});return f},portalRole:function(){return app.options.json.access.portalRole},superRole:function(){return app.options.json.access.superRole}},filter:{roles:function(a){var b=a.role,c=(a.noAdmins,a.project),d=[];return _.each(c.getRoles(),function(a){var c=!1,e=a.getCapabilities();e||(c=!0),_.each(a.getCapabilities(),function(a,d){a&&(b.getCapabilities()[d]||(c=!0))}),c||d.push(a)}),d}},can:{delegate:function(a,b){return app.access.has.project_capability(a,b,"delegate_to_user")||app.access.is.portalAdmin(a)||app.access.is.superAdmin(a)}},as:{admin:function(a,b){if(app.access.is.superAdmin(a)){var c=app.access.get.superRole().capabilities;if(c[b])return!0}if(app.access.is.portalAdmin(a)){var c=app.access.get.portalRole().capabilities;if(c[b])return!0}return!1}},has:{project_capability:function(a,b,c){if(a&&b){var a=a||app.Account,d=b.getRoles(),e=!1;return _.each(d,function(b){b.hasMember(a)&&b.hasCapability(c)&&(e=!0)}),e}},capability:function(a,b){var c=a.getRoles(),d=!1;return _.each(c,function(c){c.hasMember(a)&&c.hasCapability(b)&&(d=!0)}),d}},is:{contained:function(a,b){return a.indexOf(b)>0},admin:function(a){var a=a||app.Account,b=app.access.is.portalAdmin(a),c=app.access.is.superAdmin(a);return b||c},portalAdmin:function(a){var a=a||app.Account;return app.access._portalRole.hasMember(a)},superAdmin:function(a){var a=a||app.Account;return app.access._superRole.hasMember(a)}},to:{create_project:function(a){var a=a||app.Account;return app.access.as.admin(a,"create_project")?!0:app.access.has.capability(a,"create_project")?!0:!1},edit_project:function(a,b){var b=b||app.Account;return app.access.as.admin(b,"edit_project")?!0:app.access.has.project_capability(b,a,"edit_project")?!0:!1},edit_other_project:function(a,b){var b=b||app.Account;return app.access.as.admin(b,"edit_other_project")?!0:!1},delete_project:function(a,b){var b=b||app.Account;return app.access.as.admin(b,"delete_project")?!0:app.access.has.project_capability(b,a,"delete_project")?!0:!1},delete_other_project:function(a,b){var b=b||app.Account;return app.access.as.admin(b,"delete_other_project")?!0:void 0},read_project:function(a,b){var b=b||app.Account;return app.access.has.project_capability(b,a,"read_project")?!0:!1},upload_file:function(a,b){var b=b||app.Account;return app.access.as.admin(b,"upload_file")?!0:app.access.has.project_capability(b,a,"upload_file")?!0:!1},download_file:function(a,b){var b=b||app.Account;return app.access.as.admin(b,"download_file")?!0:app.access.has.project_capability(b,a,"download_file")?!0:!1},create_version:function(a,b){var b=b||app.Account;return app.access.as.admin(b,"create_version")?!0:app.access.has.project_capability(b,a,"create_version")?!0:!1},delete_version:function(a,b){var b=b||app.Account;return app.access.as.admin(b,"delete_version")?!0:app.access.has.project_capability(b,a,"delete_version")?!0:!1},delete_other_version:function(a,b){var b=b||app.Account;return app.access.as.admin(b,"delete_other_version")?!0:!1},delete_file:function(a,b){var b=b||app.Account;return app.access.as.admin(b,"delete_file")?!0:app.access.has.project_capability(b,a,"delete_file")?!0:!1},delete_other_file:function(a,b){var b=b||app.Account;return app.access.as.admin(b,"delete_other_file")?!0:!1},create_user:function(a,b){var b=b||app.Account;return app.access.as.admin(b,"create_user")?!0:app.access.has.project_capability(b,a,"create_user")?!0:!1},edit_user:function(a,b){var b=b||app.Account;return app.access.as.admin(b,"edit_user")?!0:a&&app.access.has.project_capability(b,a,"edit_user")?!0:!1},edit_other_user:function(a){var a=a||app.Account;return app.access.as.admin(a,"edit_other_user")?!0:!1},delete_user:function(a){var a=a||app.Account;return app.access.as.admin(a,"delete_user")?!0:!1},delete_other_user:function(a){var a=a||app.Account;return app.access.as.admin(a,"delete_user")?!0:!1;
},share_project:function(a,b){var b=b||app.Account;return app.access.as.admin(b,"share_project")?!0:app.access.has.project_capability(b,a,"share_project")?!0:!1},read_analytics:function(a){var a=a||app.Account;return app.access.as.admin(a,"edit_user")?!0:!1},manage_analytics:function(a){var a=a||app.Account;return app.access.as.admin(a,"edit_user")?!0:!1},delegate_to_user:function(a,b){var b=b||app.Account;return app.access.as.admin(b,"delegate_to_user")?!0:app.access.has.project_capability(b,a,"delegate_to_user")?!0:!1}},roles:{templates:{}}}),Wu.Analytics=Wu.Class.extend({initialize:function(){this._listen()},_listen:function(){Wu.Mixin.Events.on("projectSelected",this._projectSelected,this),Wu.Mixin.Events.on("editEnabled",this._editEnabled,this),Wu.Mixin.Events.on("editDisabled",this._editDisabled,this),Wu.Mixin.Events.on("layerEnabled",this._layerEnabled,this),Wu.Mixin.Events.on("layerDisabled",this._layerDisabled,this),Wu.Mixin.Events.on("layerSelected",this._layerSelected,this),Wu.Mixin.Events.on("layerAdded",this._onLayerAdded,this),Wu.Mixin.Events.on("layerEdited",this._onLayerEdited,this),Wu.Mixin.Events.on("layerStyleEdited",this._onLayerStyleEdited,this),Wu.Mixin.Events.on("layerDeleted",this._onLayerDeleted,this),Wu.Mixin.Events.on("fileImported",this._onFileImported,this),Wu.Mixin.Events.on("fileDeleted",this._onFileDeleted,this),app._map&&(app._map.on("zoomstart",this._onZoomStart),app._map.on("zoomend",this._onZoomEnd)),window.addEventListener("unload",this._onUnload)},_editEnabled:function(){},_editDisabled:function(){},_layerEnabled:function(){},_layerDisabled:function(){},_updateView:function(){},_refresh:function(){},_onFileImported:function(){},_onFileDeleted:function(){},_onLayerAdded:function(){},_onLayerEdited:function(){},_onLayerStyleEdited:function(){},_onLayerDeleted:function(){},_onUnload:function(){app.Socket.sendUserEvent({user:app.Account.getFullName(),event:"exited.",description:"",timestamp:Date.now()})},_onZoomStart:function(){var a=app._map;app._eventZoom=a.getZoom()},_onZoomEnd:function(){var a=app._map,b=a.getZoom();app.Socket.sendUserEvent({user:app.Account.getFullName(),event:"zoomed",description:"from `"+app._eventZoom+" to "+b+"` ",timestamp:Date.now()})},_getPointKeys:function(){return["gid","vel","mvel","coherence"]},onInvite:function(a){var b=a.project_name,c=a.permissions;app.Socket.sendUserEvent({user:app.Account.getFullName(),event:"invited to project",description:b+" `("+c.join(", ")+")`",timestamp:Date.now()})},onScreenshot:function(a){var b=a.project_name,c=a.file_id;app.Socket.sendUserEvent({user:app.Account.getFullName(),event:"took a `screenshot` of project",description:b,timestamp:Date.now(),options:{screenshot:!0,file_id:c}})},onAttributionClick:function(){app.Socket.sendUserEvent({user:app.Account.getFullName(),event:"clicked",description:"Systemapic logo",timestamp:Date.now()})},onPolygonQuery:function(a){var b=a.result,c=b.total_points,d=b.area;d=d>1e6?"approx. "+parseInt(d/1e6)+" km2":"approx. "+parseInt(d)+" m2";var e="on "+a.layer_name;e+="\n     `total points: "+c+"` ",e+="\n     `area: "+d+"` ";var f=this._getPointKeys();f.forEach(function(a){b.average[a]&&(e+="\n     `"+a+": "+b.average[a]+"` ")}),app.Socket.sendUserEvent({user:app.Account.getFullName(),event:"queried polygon",description:e,timestamp:Date.now()})},onEnabledRegression:function(){app.Socket.sendUserEvent({user:app.Account.getFullName(),event:"viewed regression",description:"",timestamp:Date.now()})},_eventLayerLoaded:function(a){app.Socket.sendUserEvent({user:app.Account.getFullName(),event:"watched",description:"layer load for `"+a.load_time+"ms`",timestamp:Date.now()})},onPointQuery:function(a){var b=app._prevLatlng,c=a.latlng.toString();app._prevLatlng=a.latlng;var d=this._getPointKeys(),e="`at "+c+"` ";e+="\n     on "+a.layer.getTitle()+".",d.forEach(function(b){a.data[b]&&(e+="\n     `"+b+": "+a.data[b]+"` ")}),b&&(e+="\n      Distance from last query: `"+parseInt(a.latlng.distanceTo(b))+"meters`"),app.Socket.sendUserEvent({user:app.Account.getFullName(),event:"queried point",description:e,timestamp:Date.now()})},_layerSelected:function(a){var b=a.detail.layer;b&&app.Socket.sendUserEvent({user:app.Account.getFullName(),event:"selected",description:"`layer` "+b.getTitle(),timestamp:Date.now()})},_projectSelected:function(a){this._project=app.Projects[a.detail.projectUuid],this.setGaPageview(a.detail.projectUuid);var b=this._project?"`project` "+this._project.getName():"no project.";app.Socket.sendUserEvent({user:app.Account.getFullName(),event:"selected",description:b,timestamp:Date.now()})},set:function(a){Wu.send("/api/analytics/set",a,function(a,b){})},get:function(a){Wu.send("/api/analytics/get",a,function(a,b){})},setGaPageview:function(a){if(!app._isPhantom&&app.activeProject){var b=a?app.Projects[a]:app.activeProject,c=a?a:app.activeProject.getUuid(),d=b.getSlug(),e=b.getName(),e=b.getName(),f=app.options.servers.portal,d=b.getSlug(),g="/"+d,h=(app.Account.getUuid(),app.Account.getFullName()),i=Wu.version,j={hostname:f,page:g,title:e,dimension1:c,dimension6:e,dimension2:h,version:i},k=this.gaHeader(),l={userHeader:k,gaEvent:!1,gaPageview:j};this.set(JSON.stringify(l)),l=null,j=null,k=null}},setGaEvent:function(a){var b={};if(a[0]&&(b.eventCategory=a[0]),a[1]&&(b.eventAction=a[1]),a[2]&&(b.eventLabel=a[2]),a[3]&&(b.eventValue=a[3]),app.activeProject){var c=app.activeProject.getSlug(),d="/"+c;b.path=d}else b.path="/";var e=this.gaHeader(),f={userHeader:e,gaEvent:b,gaPageview:!1};this.set(JSON.stringify(f)),gaSendObject=null,a=null,e=null,f=null},gaHeader:function(){if(app.Account){var a=app.Account.getUuid();if(a){var b={trackingID:Wu.app.options.ga.id,clientID:a};return b}}}}),Wu.satteliteAngle=Wu.Class.extend({initialize:function(a){this.options=a,this.container=this.options.appendTo,this.initContent()},initContent:function(){this.color="#019688",this._innerContainer=Wu.DomUtil.create("div","d3-satellite-wrapper displayNone",this.container),this._header=Wu.DomUtil.create("div","satellite-measurement-geometry",this._innerContainer,"Measurement geometry")},update:function(a){var b=a.angle?a.angle:!1,c=a.path?a.path:!1;b||c?(this.closed=!1,Wu.DomUtil.removeClass(this._innerContainer,"displayNone")):(this.closed=!0,Wu.DomUtil.addClass(this._innerContainer,"displayNone")),this.initAngle(parseInt(b)),this.initCompass(parseInt(c))},initAngle:function(a){if(a){this.angleContainer&&(this.angleContainer.innerHTML="",this.angleContainer.remove()),this.angleContainer=Wu.DomUtil.createId("div","d3-satellite-angle-container",this._innerContainer);var b=.55,c=10,d=45,e=75,f=0>a?!0:!1,g=d3.select(this.angleContainer).append("svg").attr("width",(d+2*c)*b).attr("height",e*b+c);g.append("line").attr("x1",function(){return f?(d+c)*b:c*b}).attr("y1",c*b).attr("x2",function(){return f?(d+c)*b:c*b}).attr("y2",(e-c)*b).attr("stroke-width",1).attr("stroke","#999"),g.append("line").attr("x1",c*b).attr("y1",(e-c-1)*b).attr("x2",(d+c)*b).attr("y2",(e-c-1)*b).attr("stroke-width",1).attr("stroke","#999"),g.append("line").classed("angle-line",!0).attr("x1",function(){return f?(d+c)*b:c*b}).attr("y1",c*b).attr("x2",function(){return f?(d+c+a)*b:(a+c)*b}).attr("y2",(e-c-1)*b).attr("stroke-width",2).attr("stroke",this.color),g.append("circle").attr("cx",function(){return f?(d+c)*b:c*b}).attr("cy",c*b).attr("r",3).attr("fill","#FFF").attr("stroke-width",2).attr("stroke",this.color),g.append("text").attr("x",(d/2+c)*b).attr("y",(e+15)*b).attr("font-family","sans-serif").attr("font-size","10px").attr("font-weight",900).attr("fill","#999").attr("text-anchor","middle").text(function(){return f?-a+"°":a+"°"})}},initCompass:function(a){if(a){this.compassContainer&&(this.compassContainer.innerHTML="",this.compassContainer.remove()),this.compassContainer=Wu.DomUtil.createId("div","d3-satellite-angle-container",this._innerContainer);var b=.75,c=10,d=65,e=65,f=d3.select(this.compassContainer).append("svg").attr("width",d*b).attr("height",e*b+c),g=(f.append("text").attr("x",d/2*b).attr("y",(c+2)*b).attr("font-family","sans-serif").attr("font-size",10*b+"px").attr("fill","#999").attr("text-anchor","middle").text("N"),f.append("text").attr("x",d/2*b).attr("y",(e-5)*b).attr("font-family","sans-serif").attr("font-size",10*b+"px").attr("fill","#999").attr("text-anchor","middle").text("S"),f.append("text").attr("x",(c-2)*b).attr("y",(e/2+3)*b).attr("font-family","sans-serif").attr("font-size",10*b+"px").attr("fill","#999").attr("text-anchor","middle").text("W"),f.append("text").attr("x",(d-9)*b).attr("y",(e/2+3)*b).attr("font-family","sans-serif").attr("font-size",10*b+"px").attr("fill","#999").attr("text-anchor","middle").text("E"),f.append("line").attr("x1",(c+5)*b).attr("y1",e/2*b).attr("x2",(d-15)*b).attr("y2",e/2*b).attr("stroke-width",1).attr("stroke","#ccc"),f.append("line").attr("x1",d/2*b).attr("y1",(c+5)*b).attr("x2",d/2*b).attr("y2",(e-15)*b).attr("stroke-width",1).attr("stroke","#ccc"),f.append("circle").attr("cx",d/2*b).attr("cy",e/2*b).attr("r",(d/2-15)*b).attr("fill","transparent").attr("stroke-width",1).attr("stroke","#999"),f.append("g").attr("transform",function(){return"rotate("+a+", "+d/2*b+","+e/2*b+")"}));g.append("line").classed("angle-line",!0).attr("fill","white").attr("x1",d/2*b).attr("y1",c*b).attr("x2",d/2*b).attr("y2",(e-10)*b).attr("stroke-width",2).attr("stroke",this.color),g.append("path").attr("d",function(){var a=d/2,e=c-5,f="M"+a*b+","+e*b,g="L"+(a+4)*b+","+(e+6)*b,h="L"+(a-4)*b+","+(e+6)*b;return f+g+h+"Z"}).attr("stroke-width",0).attr("stroke","none").attr("fill",this.color),f.append("circle").classed("inner-circle",!0).attr("cx",d/2*b).attr("cy",e/2*b).attr("r",3).attr("fill","#FFF").attr("stroke-width",2).attr("stroke",this.color),f.append("text").attr("x",d/2*b).attr("y",(e+10)*b).attr("font-family","sans-serif").attr("font-size","10px").attr("font-weight",900).attr("fill","#999").attr("text-anchor","middle").text(a+"°")}}}),Wu.button=Wu.Class.extend({initialize:function(a){this.options=a,"switch"==a.type&&this.initSwitch(),"set"==a.type&&this.initSet(),"setclear"==a.type&&this.initSetClear(),"radio"==a.type&&this.initRadio(),"miniInput"==a.type&&this.initMiniInput(),"dropdown"==a.type&&this.initMiniDropDown(),"colorball"==a.type&&this.initColorBall(),"colorrange"==a.type&&this.initColorRange(),"dualinput"==a.type&&this.initDualInput(),"toggle"==a.type&&this.initToggleButton(),"clicker"==a.type&&this.initClicker()},initDualInput:function(){var a=this.options.appendTo,b=this.options.id,c=(this.options.right,this.options.value),d=this.options.minmax,e=this.options.tabindex;className=this.options.className,fn=this.options.fn;var f="chrome-field-mini-input mini-input-dual ";className&&(f+=className);var g=Wu.DomUtil.createId("input","field_mini_input_max_"+b,a);g.className=f,g.setAttribute("placeholder","auto"),g.setAttribute("tabindex",e[1]),d&&g.setAttribute("placeholder",d[1]),c&&(g.value=c[1]),Wu.DomEvent.on(g,"blur",function(){this.saveDualBlur(g,h,d[1],d[0],this.options)}.bind(this),this),g.onkeypress=this.forceNumeric,this.max=g;var h=Wu.DomUtil.createId("input","field_mini_input_min_"+b,a);h.className="chrome-field-mini-input mini-input-dual",h.setAttribute("placeholder","auto"),h.setAttribute("tabindex",e[0]),d&&h.setAttribute("placeholder",d[0]),c&&(h.value=c[0]),Wu.DomEvent.on(h,"blur",function(){this.saveDualBlur(g,h,d[1],d[0],this.options)}.bind(this),this),h.onkeypress=this.forceNumeric,this.min=h},saveDualBlur:function(a,b,c,d,e){var f=e.fn;e.key;f(a.value,b.value,c,d)},initColorRange:function(){var a=this.options.appendTo,b=this.options.id,c=(this.options.right,this.options.value),d=this.options.presetFn,e=this.options.className,f=this.options.customFn,g=this._gradientStyle(c),h="chrome-color-range-wrapper ";e&&(h+=e);var i=Wu.DomUtil.create("div",h,a);i.setAttribute("key",b);var j=Wu.DomUtil.create("div","chrome-color-range",i);j.id="chrome-color-range_"+b,j.setAttribute("key",b),j.setAttribute("style",g),this._color=j;var k=Wu.DomUtil.create("div","click-catcher displayNone",a);k.id="click-catcher-"+b,k.setAttribute("key",b),this._clicker=k;var l=Wu.DomUtil.create("div","chrome-color-selector-wrapper displayNone",i);l.id="chrome-color-selector-wrapper-"+b,this._colorSelectorWrapper=l;var m=Wu.DomUtil.create("div","chrome-color-ball-wrapper",l),n=Wu.DomUtil.create("div","chrome-color-ball color-range-ball rangeball-3",m);n.id="color-range-ball-3-"+b,n.style.background=c[4],n.setAttribute("hex",c[4]),this._colorball3=n;var o=Wu.DomUtil.create("div","chrome-color-ball color-range-ball rangeball-2",m);o.id="color-range-ball-2-"+b,o.style.background=c[2],o.setAttribute("hex",c[2]),this._colorball2=o;var p=Wu.DomUtil.create("div","chrome-color-ball color-range-ball rangeball-1",m);p.id="color-range-ball-1-"+b,p.style.background=c[0],p.setAttribute("hex",c[0]),this._colorball1=p,this.initSpectrum(this,c[0],p,b,f),this.initSpectrum(this,c[2],o,b,f),this.initSpectrum(this,c[4],n,b,f);var q=Wu.DomUtil.create("div","color-range-preset-wrapper",l),r=this.options.colors;this._presets=[],r.forEach(function(a,b){var c=this._gradientStyle(a),e=Wu.DomUtil.create("div","color-range-preset",q);e.id="color-range-preset-"+b,e.setAttribute("style",c),e.setAttribute("hex",a.join(",")),this._presets.push(e),Wu.DomEvent.on(e,"click",d)}.bind(this)),Wu.DomEvent.on(j,"click",function(a){Wu.DomUtil.removeClass(l,"displayNone"),Wu.DomUtil.removeClass(k,"displayNone")},this),Wu.DomEvent.on(k,"click",function(a){Wu.DomUtil.addClass(l,"displayNone"),Wu.DomUtil.addClass(k,"displayNone")},this)},toggleColorRange:function(a){var b=a.target.getAttribute("key"),c=Wu.DomUtil.get("chrome-color-selector-wrapper-"+b),d=Wu.DomUtil.get("click-catcher-"+b);Wu.DomUtil.removeClass(c,"displayNone"),Wu.DomUtil.removeClass(d,"displayNone")},stopEditingColorRange:function(a){var b=a.target.getAttribute("key"),c=Wu.DomUtil.get("chrome-color-selector-wrapper-"+b),d=Wu.DomUtil.get("click-catcher-"+b);Wu.DomUtil.addClass(c,"displayNone"),Wu.DomUtil.addClass(d,"displayNone")},_gradientStyle:function(a){var b="background: -webkit-linear-gradient(left, "+a.join()+");";return b+="background: -o-linear-gradient(right, "+a.join()+");",b+="background: -moz-linear-gradient(right, "+a.join()+");",b+="background: linear-gradient(to right, "+a.join()+");"},initColorBall:function(){var a=this.options.appendTo,b=this.options.id,c=this.options.fn,d=this.options.right,e=this.options.isOn,f=this.options.className,g=this.options.value,h="chrome-color-ball ";f&&(h+=f);var i=Wu.DomUtil.create("div",h,a);i.id="color_ball_"+b,i.style.background=g,this.color=i,e||Wu.DomUtil.addClass(i,"disable-color-ball"),d||Wu.DomUtil.addClass(i,"left-ball"),this.initSpectrum(g,i,b,c)},initSpectrum:function(a,b,c,d){$(b).spectrum({color:a,preferredFormat:"hex",showInitial:!0,showAlpha:!1,chooseText:"Choose",cancelText:"Cancel",containerClassName:"dark clip",change:function(a){var e=Math.round(a._r).toString(16),f=Math.round(a._g).toString(16),g=Math.round(a._b).toString(16);1==e.length&&(e+="0"),1==f.length&&(f+="0"),1==g.length&&(g+="0");var a="#"+e+f+g;b.style.background=a,d(a,c,b)}})},initMiniDropDown:function(){var a=this.options.appendTo,b=this.options.id,c=this.options.fn,d=(this.options.right,this.options.array),e=this.options.selected,f=this.options.reversed,g=this.options.className,h="chrome chrome-mini-dropdown active-field select-field-wrap ";g&&(h+=g);var i=this.container=Wu.DomUtil.create("div",h,a),j=this._select=Wu.DomUtil.create("select","active-field-select",i);j.setAttribute("key",b),f?e||Wu.DomUtil.addClass(i,"full-width"):e&&Wu.DomUtil.addClass(i,"full-width"),d.forEach(function(a,b){var c=Wu.DomUtil.create("option","active-layer-option",j);c.value=a,c.innerHTML=a,e?a==e&&(c.selected=!0):0==b&&(c.selected=!0)}),Wu.DomEvent.on(j,"change",c)},initMiniInput:function(){var a=this.options.appendTo,b=this.options.id,c=this.options.fn,d=this.options.value,e=this.options.placeholder,f=this.options.tabindex,g=this.options.right,h=this.options.className,i=this.options.isOn,j=this.options.allowText,k="chrome-field-mini-input ";h&&(k+=h);var l=Wu.DomUtil.createId("input","field_mini_input_"+b,a);l.className=k,l.setAttribute("placeholder",e),l.setAttribute("tabindex",f),this.input=l,d&&(l.value=d),0==d&&(l.value=d),g||Wu.DomUtil.addClass(l,"left-mini"),i||Wu.DomUtil.addClass(l,"left-mini-kill"),Wu.DomEvent.on(l,"blur",c),j||(l.onkeypress=this.forceNumeric)},initClicker:function(){var a=this.options.appendTo,b=(this.options.id,this.options.type,this.options.fn),c=this.options.array,d=this.options.selected||"=",e=this.options.className;this._cidx=_.findIndex(c,d),this._cidx>0&&(this._cidx=1);var f=this._button=Wu.DomUtil.create("div","clicker-button "+e,a,d);Wu.DomEvent.on(f,"click",function(a){this._cidx=this._cidx+1,this._cidx==c.length&&(this._cidx=0);var d=c[this._cidx];f.innerHTML=d,b(a,d)},this)},forceNumeric:function(a){return a.charCode>=45&&a.charCode<=57&&47!=a.charCode},initRadio:function(){var a=this.options.appendTo,b=this.options.id,c=(this.options.fn,this.options.className),d=this.options.isOn,e="layer-radio ";c&&(e+=c);var f=Wu.DomUtil.create("div",e,a);return f.id="radio_"+b,d?(Wu.DomUtil.addClass(f,"radio-on"),f.setAttribute("state","true")):f.setAttribute("state","false"),Wu.DomEvent.on(f,"click",this.toggleRadio,this),f},toggleRadio:function(a){var b=a.target,c=(b.getAttribute("key"),b.getAttribute("state"));"false"==c?(Wu.DomUtil.addClass(b,"radio-on"),b.setAttribute("state","true")):(Wu.DomUtil.removeClass(b,"radio-on"),b.setAttribute("state","false")),this.options.fn(a)},initSet:function(){var a=this.options.appendTo,b=this.options.id,c=this.options.className,d=(this.options.fn,"chrome-set ");c&&(d+=c);var e=Wu.DomUtil.create("div",d,a);return e.setAttribute("key",b),e.innerHTML="SET",Wu.DomEvent.on(e,"click",this.toggleSet,this),e},toggleSet:function(a){var b=a.target,c=b.getAttribute("key");this.options.fn(c)},initSetClear:function(){var a=this.options.appendTo,b=this.options.id,c=(this.options.fn,this.options.className),d=this.options.isOn,e="setClear ";c&&(e+=c);var f=Wu.DomUtil.create("div",e,a);return f.setAttribute("key",b),f.innerHTML="SET",d?(Wu.DomUtil.addClass(f,"setClear-on"),f.setAttribute("state","true"),f.innerHTML="CLEAR"):f.setAttribute("state","false"),Wu.DomEvent.on(f,"click",this.toggleSetClear,this),f},toggleSetClear:function(a){var b=a.target,c=(b.id,b.getAttribute("key")),d=b.getAttribute("state"),e="true"==d;if(e){Wu.DomUtil.removeClass(b,"setClear-on"),b.setAttribute("state","false"),b.innerHTML="SET";var f=!1}else{Wu.DomUtil.addClass(b,"setClear-on"),b.setAttribute("state","true"),b.innerHTML="CLEAR";var f=!0}this.options.fn(c,f)},initSwitch:function(){var a=this.options.isOn,b=this.options.right,c=this.options.id,d=this.options.appendTo,e=(this.options.fn,this.options.className),f=this.options.disabled;this.value=c;var g="chrome-switch-container";a&&(g+=" switch-on"),b&&(g+=" right-switch"),f&&(g+=" disabled-switch"),e&&(g+=" "+e);var h=this._switch=Wu.DomUtil.create("div",g,d);return h.setAttribute("key",c),h.id="switch_"+c,a?h.setAttribute("state","true"):h.setAttribute("state","false"),f||Wu.DomEvent.on(h,"click",this.toggleSwitch,this),h},toggleSwitch:function(a){var b=a.target.getAttribute("state"),c="true"==b;a.target.getAttribute("key");if(c){a.target.setAttribute("state","false"),Wu.DomUtil.removeClass(a.target,"switch-on");var d=!1}else{a.target.setAttribute("state","true"),Wu.DomUtil.addClass(a.target,"switch-on");var d=!0}this.options.fn(a,d)},initToggleButton:function(a){var b=this.options.option1,c=this.options.option2,d=this.options.id,e=this.options.appendTo,f=(this.options.fn,this.options.className),g=(this.options.selected,"chrome-toggle-button-container");f&&(g+=" "+f);var h=this._toggleButton=Wu.DomUtil.create("div",g,e);h.setAttribute("key",d),h.id="togglebutton_"+d;Wu.DomUtil.create("div","toggle-button-option-one",h,b),Wu.DomUtil.create("div","toggle-button-option-one",h,c)}}),Wu.fieldLine=Wu.Class.extend({initialize:function(a){this._initContent(a)},_initContent:function(a){var b=a.id,c=a.appendTo,d=a.title,e=a.fn,f=a.input,g=a.className?a.className:"",h=a.childWrapper,i="chrome-metafield-line "+g;if(this.container=Wu.DomUtil.create("div",i,c),this.container.id="field_wrapper_"+b,h&&(this.childWrapper=Wu.DomUtil.create("div","chrome-metafield-line-children",c),this.childWrapper.id=h),f){var j=Wu.DomUtil.createId("input","field_input_"+b,this.container);j.className="chrome-field-input",j.setAttribute("name","field_input_"+b),j.setAttribute("placeholder",b),d&&(j.value=d),Wu.DomEvent.on(j,"blur",e)}else{var j=Wu.DomUtil.create("div","chrome-field-line",this.container);j.innerHTML=d?d:b}return this.container}});var language={language:"eng",tooltips:{roles:{superAdmin:"Rules the kingdom.",portalAdmin:"Full access to everything.",projectOwner:"Can do everything with project, including deleting others's content.",projectEditor:"Can do everything with project, except deleting other's content and project.",projectManager:"Can read project and delegate users up to same level, but not edit.",projectCollaborator:"Can read and edit project, but not manage users.",projectReader:"Can read project only.",noRole:"No access to project or users.",dropdown:"Delegate a role to user for this project."}}};L._lastScroll=(new Date).getTime(),L.Map.ScrollWheelZoom.prototype._onWheelScroll=function(a){if(!((new Date).getTime()-L._lastScroll<200)){var b=L.DomEvent.getWheelDelta(a),c=this._map.options.wheelDebounceTime;this._delta+=b,this._lastMousePos=this._map.mouseEventToContainerPoint(a),this._startTime||(this._startTime=+new Date);var d=Math.max(c-(+new Date-this._startTime),0);clearTimeout(this._timer),L._lastScroll=(new Date).getTime(),this._timer=setTimeout(L.bind(this._performZoom,this),d),L.DomEvent.stop(a)}},L.Map.include({reframe:function(a){return this._loaded?(this._sizeChanged=!0,void this.fire("moveend")):this},fitBounds:function(a,b){b=b||{},a=a.getBounds?a.getBounds():L.latLngBounds(a);var c=L.point(b.paddingTopLeft||b.padding||[0,0]),d=L.point(b.paddingBottomRight||b.padding||[0,0]),e=this.getBoundsZoom(a,!1,c.add(d)),f=d.subtract(c).divideBy(2),g=this.project(a.getSouthWest(),e),h=this.project(a.getNorthEast(),e),i=this.unproject(g.add(h).divideBy(2).add(f),e);return e=b&&b.maxZoom?Math.min(b.maxZoom,e):e,e=b&&b.minZoom?Math.max(b.minZoom,e):e,this.setView(i,e,b)}}),L.Polygon.include({getCenter:function(){var a,b,c,d,e,f,g,h,i,j=this._rings[0],k=j.length;if(!k)return null;for(f=g=h=0,a=0,b=k-1;k>a;b=a++)c=j[a],d=j[b],e=c.y*d.x-d.y*c.x,g+=(c.x+d.x)*e,h+=(c.y+d.y)*e,f+=3*e;return i=0===f?j[0]:[g/f,h/f],this._map.layerPointToLatLng(i)}}),L.Icon.Default.imagePath="/css/images",Wu.TestSuite={projectMemoryLeak:function(a){var b=!0,c=0,a=a||5,d=setInterval(function(){var e=b?"project-aff995e7-c6de-4783-afb1-5f8a5bffae2f":"project-4ba8d217-6245-4311-8efc-c62eb0dbaa73";Wu.Mixin.Events.fire("projectSelected",{detail:{projectUuid:e}}),Wu.Mixin.Events.fire("projectSelected",{detail:{projectUuid:e}}),b=!b,c+=1,c>a&&clearInterval(d)},2e3)},layersMemoryLeak:function(a){var b=0,c=0,d=app.MapPane.getControls().layermenu,e=_.toArray(d.getLayers()),a=a||2*_.size(e),f=setInterval(function(){var g=e[c];d.toggleLayer(g),b+=1,b%2==0&&(c+=1),b>=a&&clearInterval(f)},1e3)}},Wu.version="1.3.0",Wu.App=Wu.Class.extend({_:"app",options:systemapicConfigOptions,language:language,_ready:!1,initialize:function(a){Wu.app=window.app=this,this.setAccessTokens(),app.Socket=new Wu.Socket,this._initErrorHandling(),Wu.setOptions(this,a),document.title=this.options.portalTitle,this.initServer(),this._initSniffers()},_initSniffers:function(){this.detectMobile(),this.sniffer=Sniffer(navigator.userAgent)},setAccessTokens:function(){app.tokens=window.tokens;app.tokens.access_token;Wu.send("/api/userinfo",{},function(a,b){401==a&&(window.location.href=app.options.servers.portal)})},_initErrorHandling:function(){window.onerror=this._onError},_onError:function(a,b,c,d,e){var f=e.stack,g=app.activeProject?app.activeProject.getTitle():"No active project",h=app.Account?app.Account.getName():"No username",i=JSON.stringify({message:a,file:b,line:c,user:h,stack:f,project:g});Wu.save("/api/error/log",i)},_checkForInvite:function(){var a=window.location.pathname;if(-1!=a.indexOf("/invite/")){var b=a.split("/").reverse()[0];b&&(this.options.invite_token=b)}},initServer:function(){this._checkForInvite();var a=JSON.stringify(this.options);Wu.post("api/portal",a,this.initServerResponse,this,this.options.servers.portal)},initServerResponse:function(a,b){var c=Wu.parse(b);a.initApp(c)},initApp:function(a){this.options.json=a,this._initAccess(),this._initObjects(),this._initContainer(),this._initChrome(),this._initPanes(),this._initView(),this._ready=!0,this._debug(),this._logEntry(),this.Analytics=new Wu.Analytics},_logEntry:function(){var a=this.sniffer.browser,b=this.sniffer.os,c=a.fullName+" "+a.majorVersion+"."+a.minorVersion,d=b.fullName+" "+b.majorVersion+"."+b.minorVersion;app.Socket.sendUserEvent({user:app.Account.getFullName(),event:"entered",description:"the wu: `"+c+"` on `"+d+"`",timestamp:Date.now()})},_initObjects:function(){this.Data=new Wu.Data,this.Controller=new Wu.Controller,this.Account=new Wu.User(this.options.json.account),this.Account.setRoles(this.options.json.roles),this.Users={},app.Account.getContactList().forEach(function(a){this.Users[a.uuid]=new Wu.User(a)},this),this.options.json.users.project_users.forEach(function(a){this.Users[a.uuid]||(this.Users[a.uuid]=new Wu.User(a))},this),this.Users[app.Account.getUuid()]=this.Account,this.Projects={},this.options.json.projects.forEach(function(a,b,c){this.Projects[a.uuid]=new Wu.Project(a,this)},this)},_initChrome:function(){this.Chrome={},this.Chrome.Top=new Wu.Chrome.Top,this.Chrome.Right=new Wu.Chrome.Right,this.Chrome.Left=new Wu.Chrome.Left},_initPanes:function(){this.Tooltip=new Wu.Tooltip,this.Style=new Wu.Style,this.ProgressBar=new Wu.ProgressPane({color:"white",addTo:this._appPane}),this.MapPane=new Wu.MapPane,this.FeedbackPane=new Wu.FeedbackPane,this.MapSettingsPane=new Wu.MapSettingsPane,this.Share=new Wu.Share,this.Account.addAccountTab()},_initView:function(){this._initInvite()||this._initLocation()||this._initHotlink()||app.Controller.openLastUpdatedProject()},_initInvite:function(){var a=this.options.json.invite;return a?(Wu.Mixin.Events.fire("projectSelected",{detail:{projectUuid:a.id}}),void app.feedback.setMessage({title:"Project access granted",description:"You've been given access to the project "+a.name})):!1},_initEvents:function(){},_getDimensions:function(a){var b=window,c=document,a=c.documentElement,d=c.getElementsByTagName("body")[0],e=b.innerWidth||a.clientWidth||d.clientWidth,f=b.innerHeight||a.clientHeight||d.clientHeight,c={height:f,width:e,e:a};return c},_initContainer:function(){var a=this.options.id;this._appPane=Wu.DomUtil.get(a)||Wu.DomUtil.createId("div",a||"app",document.body),this._mapContainer=Wu.DomUtil.createId("div","map-container",this._appPane)},_initAccess:function(){this.Access=new Wu.Access(this.options.json.access)},_initLocation:function(){var a=window.location.pathname,b=a.split("/")[1],c=a.split("/")[2],d=a.split("/")[3];window.location.search.split("?"),Wu.Util.parseUrl();if(!b||!c)return!1;var c=this._projectExists(c,b);return c?(this._setProject(c),d&&this._initHash(d,c),!0):(Wu.Util.setAddressBar(this.options.servers.portal),!1)},_setProject:function(a){Wu.Mixin.Events.fire("projectSelected",{detail:{projectUuid:a.getUuid()}})},_initHotlink:function(){if(Wu.parse(window.hotlink),!this.hotlink)return!1;var a=this._projectExists(this.hotlink.project,this.hotlink.client);return a?(this._setProject(a),!0):!1},_projectExists:function(a,b){var a=a||window.hotlink.project;for(p in Wu.app.Projects){var c=Wu.app.Projects[p];if(a==c.store.slug&&c._client.slug==b)return c}return!1},getPortalName:function(){return this.options.portalName},setStatus:function(a,b){},setSaveStatus:function(a){},_initHash:function(a,b){return this.getHash(a,b,this._renderHash),!0},getHash:function(a,b,c){Wu.post("/api/project/hash/get",JSON.stringify({projectUuid:b.getUuid(),id:a}),c,this)},_renderHash:function(a,b){var c=JSON.parse(b);c.error;var d=c.hash,e=d.project||c.project,f=app.Projects[e];f.selectProject(),app.MapPane.setPosition(d.position)},setHash:function(a,b){var c=app.MapPane.getControls().layermenu._getActiveLayers(),d=_.map(c,function(a){return a.item.layer}),b=b||app.activeProject;Wu.post("/api/project/hash/set",JSON.stringify({projectUuid:b.getUuid(),hash:{id:Wu.Util.createRandom(6),position:app.MapPane.getPosition(),layers:d}}),a,this)},phantomJS:function(a){var b=a.projectUuid,c=a.hash,d=a.thumb;if(!b)return!1;this._phantomHash=c;var e=app.Projects[b];return e?(c&&(e.selectProject(),app.MapPane.setPosition(c.position),c.layers.forEach(function(a){var b=e.getLayer(a),c=e.getBaselayers(),d=_.find(c,function(b){return b.uuid==a});d?b.add("baselayer"):b.add()},this)),d?app.Style.phantomJSthumb():app.Style.phantomJS(),void(app._isPhantom=!0)):!1},_setPhantomArgs:function(a){this._phantomArgs=a},phantomReady:function(){if(!app.activeProject)return!1;var a=_.size(this._phantomHash.layers),b=_.size(app.activeProject.getBaselayers()),c=a+b;return this._loaded&&this._loading?0==c?!0:0==this._loaded.length?!1:this._loaded.length==c?!0:!1:!1},_loaded:[],_loading:[],detectMobile:function(){if(L.Browser.mobile){Wu.app.mobile=!1,Wu.app.pad=!1;var a=screen.height,b=screen.width;if(Wu.app.nativeResolution=[a,b],a>=b)var c=b;else var c=a;if(450>c){Wu.app.mobile=!0;var d="mobilestyle.css"}else{Wu.app.pad=!0;var d="padstyle.css"}var e=document.getElementById("mobilestyle"),f='<link rel="stylesheet" href="'+app.options.servers.portal+"css/"+d+'">';e.innerHTML=f}},_debug:function(a){(a||this.debug)&&(this.debug=!0,app.Style.setStyle("img.leaflet-tile",{"border-top":"1px solid rgba(255, 0, 0, 0.65)","border-left":"1px solid rgba(255, 0, 0, 0.65)"}),app._map&&app._map.on("mousedown",function(a){var b=a.latlng.lat,c=a.latlng.lng,d=app._map.getZoom();this._getTileURL(b,c,d)},this),"undefined"==typeof Number.prototype.toRad&&(Number.prototype.toRad=function(){return this*Math.PI/180}))},_getTileURL:function(a,b,c){var d=parseInt(Math.floor((b+180)/360*(1<<c))),e=parseInt(Math.floor((1-Math.log(Math.tan(a.toRad())+1/Math.cos(a.toRad()))/Math.PI)/2*(1<<c)));return""+c+"/"+d+"/"+e}});